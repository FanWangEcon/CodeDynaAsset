
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Graph Cash-on-Hand Tomorrow, Value, Policy given (A,Z) States Today</title><meta name="generator" content="MATLAB 9.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-06-16"><meta name="DC.source" content="ff_az_vf_post_graph.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Graph Cash-on-Hand Tomorrow, Value, Policy given (A,Z) States Today</h1><!--introduction--><p><b>back to <a href="https://fanwangecon.github.io">Fan</a>'s <a href="https://fanwangecon.github.io/CodeDynaAsset/">Dynamic Assets Repository</a> Table of Content.</b></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">FF_AZ_VF_POST_GRAPH genereate 4 graphs</a></li><li><a href="#3">Default</a></li><li><a href="#4">Parse Parameters</a></li><li><a href="#5">Graphing COH today vs COH tomorrow</a></li><li><a href="#6">Graphing Values</a></li><li><a href="#7">Graphing Choice Levels</a></li><li><a href="#8">Graphing Choice Percentages</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> ff_az_vf_post_graph(varargin)
</pre><h2 id="2">FF_AZ_VF_POST_GRAPH genereate 4 graphs</h2><p>Generates four graphs:</p><div><ol><li>Cash-On-Hand Tomorrow given Cash-on-Hand Today</li><li>Value Function Graph</li><li>Policy Function Consumption and Asset Choices, Level and log</li><li>Consumption and Asset as Percentages</li></ol></div><p>Run this function directly with randomly generates matrixes for graphs and tables.</p><p>@param param_map container parameter container</p><p>@param support_map container support container</p><p>@param armt_map container container with states, choices and shocks grids that are inputs for grid based solution algorithm</p><p>@param result_map container contains policy function matrix, value function matrix, iteration results; als coh consumption and other matrixes</p><p>@example</p><pre>  ff_az_vf_post_graph(param_map, support_map, armt_map, func_map, result_map);</pre><p>@include</p><div><ul><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html">ffs_az_set_default_param</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_get_funcgrid.html">ffs_az_get_funcgrid</a></li></ul></div><h2 id="3">Default</h2><pre class="codeinput">params_len = length(varargin);
bl_input_override = 0;
<span class="keyword">if</span> (params_len == 6)
    bl_input_override = varargin{6};
<span class="keyword">end</span>

<span class="keyword">if</span> (bl_input_override)
    <span class="comment">% if invoked from outside overrid fully</span>
    [param_map, support_map, armt_map, func_map, result_map, ~] = varargin{:};
<span class="keyword">else</span>
    clear <span class="string">all</span>;
    close <span class="string">all</span>;

    <span class="comment">% internal invoke for testing</span>
    it_param_set = 4;
    bl_input_override = true;

    <span class="comment">% Get Parameters</span>
    [param_map, support_map] = ffs_az_set_default_param(it_param_set);
    [armt_map, func_map] = ffs_az_get_funcgrid(param_map, support_map, bl_input_override); <span class="comment">% 1 for override</span>

    <span class="comment">% Generate Default val and policy matrixes</span>
    params_group = values(armt_map, {<span class="string">'ar_a'</span>, <span class="string">'ar_z'</span>});
    [ar_a, ar_z] = params_group{:};
    params_group = values(func_map, {<span class="string">'f_util_standin'</span>, <span class="string">'f_cons'</span>, <span class="string">'f_coh'</span>});
    [f_util_standin, f_cons, f_coh] = params_group{:};

    <span class="comment">% Set Defaults</span>
    mt_val = f_util_standin(ar_z, ar_a');
    mt_pol_a = zeros(size(mt_val)) + ar_a'*(cumsum(sort(ar_z))/sum(ar_z)*0.4 + 0.4);
    mt_cons = f_cons(ar_z, ar_a', mt_pol_a);
    mt_coh = f_coh(ar_z, ar_a');

    <span class="comment">% Set Results Map</span>
    result_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
    result_map(<span class="string">'mt_val'</span>) = mt_val;
    result_map(<span class="string">'mt_pol_a'</span>) = mt_pol_a;
    result_map(<span class="string">'mt_cons'</span>) = mt_cons;
    result_map(<span class="string">'mt_coh'</span>) = mt_coh;
<span class="keyword">end</span>
</pre><h2 id="4">Parse Parameters</h2><pre class="codeinput"><span class="comment">% param_map</span>
params_group = values(param_map, {<span class="string">'it_z_n'</span>});
[it_z_n] = params_group{:};

<span class="comment">% support_map</span>
params_group = values(support_map, {<span class="string">'bl_graph_onebyones'</span>, <span class="string">'bl_graph_val'</span>, <span class="string">'bl_graph_pol_lvl'</span>, <span class="string">'bl_graph_pol_pct'</span>, <span class="string">'bl_graph_coh_t_coh'</span>});
[bl_graph_onebyones, bl_graph_val, bl_graph_pol_lvl, bl_graph_pol_pct, bl_graph_coh_t_coh] = params_group{:};
params_group = values(support_map, {<span class="string">'bl_img_save'</span>, <span class="string">'st_img_path'</span>, <span class="string">'st_img_prefix'</span>, <span class="string">'st_img_name_main'</span>, <span class="string">'st_img_suffix'</span>});
[bl_img_save, st_img_path, st_img_prefix, st_img_name_main, st_img_suffix] = params_group{:};
params_group = values(support_map, {<span class="string">'st_title_prefix'</span>});
[st_title_prefix] = params_group{:};

<span class="comment">% armt_map</span>
params_group = values(armt_map, {<span class="string">'ar_a'</span>, <span class="string">'ar_z'</span>});
[ar_a, ar_z] = params_group{:};

<span class="comment">% func_map</span>
params_group = values(func_map, {<span class="string">'f_coh'</span>});
[f_coh] = params_group{:};

<span class="comment">% result_map</span>
params_group = values(result_map, {<span class="string">'mt_cons'</span>, <span class="string">'mt_coh'</span>, <span class="string">'mt_val'</span>, <span class="string">'mt_pol_a'</span>});
[mt_cons, mt_coh, mt_val, mt_pol_a] = params_group{:};

<span class="comment">% How many zs to Graph</span>
ar_it_z_graph = ([1 round((it_z_n)/4) round(2*((it_z_n)/4)) round(3*((it_z_n)/4)) (it_z_n)]);
</pre><h2 id="5">Graphing COH today vs COH tomorrow</h2><p>This plots the cash-on-hand today vs cash-on-hand tomorrow. This is an important graph that is key for analyzing the asset distribution. We would like to see at each point of the current cash-on-hand, what are the cash-on-hand that are reachable tomorrow. Note, here we are not plottin gbased on probability density for each discretized state tomorrow, just which states are reacable, meaning which states given states have non-zero probability of been reached tomorrow.</p><p><img src="ff_az_vf_post_graph_eq03695594001949585650.png" alt="$$f(\Lambda(z',a') \mid \Lambda, z)$$" style="width:105px;height:16px;"></p><p>Three possible cases:</p><div><ol><li>next period cash-on-hand is always lower than current period cash-on-hand given policy function. This means it is not possible to exceed beyond this level of cash-on-hand in the stationary distribution. If we start mass lower than this level of cash-on-hand, it will never exceed this.</li><li>next period cash-on-hand is always higher than current period cash-on-hand. Stationary distribution will never go below this level.</li><li>next period cash-on-hand is identical to today cash on hand. This is an absorbing state.</li></ol></div><p>The dimensionality of the graph is as follows:</p><div><ol><li>a_n by z_n state space and corresonding policy function</li><li>all a_n and z_n combinations, one array, policy array, than given that, the cash-on-hand next period. meshed a_n and z_n with each other, crossed with another z_n.</li><li>each color a different future z_n</li></ol></div><pre class="codeinput"><span class="keyword">if</span> (bl_graph_coh_t_coh)

    <span class="comment">% 1. Single Array A' Next Period and COH today</span>
    ar_pol_a_full = mt_pol_a(:);
    ar_coh_full = mt_coh(:);

    <span class="comment">% 2. COH Next Period</span>
    mt_coh_next = f_coh(ar_z, ar_pol_a_full);

    <span class="comment">% 3. Start Figure</span>
    <span class="keyword">if</span>(~bl_graph_onebyones)
        figure(<span class="string">'PaperPosition'</span>, [0 0 21 4]);
        ar_sub_j = 1:1:3;
    <span class="keyword">else</span>
        ar_sub_j = [3 2];
    <span class="keyword">end</span>

    <span class="keyword">for</span> sub_j = ar_sub_j

        <span class="comment">% 4. Legends and values</span>
        <span class="keyword">if</span> (ismember(sub_j, [2]))
            bl_log_coh = 1;
        <span class="keyword">else</span>
            bl_log_coh = 0;
        <span class="keyword">end</span>

        <span class="keyword">if</span> (sub_j==1)

            mt_outcome = mt_coh_next;
            ar_xvar = ar_coh_full;

            st_y_label = <span class="string">'cash-on-hand t+1 = coh(a''(a,z), z'')'</span>;
            st_x_label = <span class="string">'cash-on-hand t = coh(a,z)'</span>;
            st_title = <span class="string">'coh(a''(coh(a,z),z), z''): reachable coh'' given coh'</span>;
            st_legend_loc = <span class="string">'southeast'</span>;

        <span class="keyword">end</span>
        <span class="keyword">if</span> (sub_j==2)

            mt_outcome = log(mt_coh_next - min(ar_a) + 1);
            ar_xvar = log(ar_coh_full - min(ar_a) + 1);

            st_y_label = <span class="string">'log(COH'' - min(a'') + 1)'</span>;
            st_x_label = <span class="string">'log(COH)'</span>;
            st_title = <span class="string">'coh(a''(coh(a,z),z), z''): reachable coh'' given coh'</span>;
            st_legend_loc = <span class="string">'southeast'</span>;

        <span class="keyword">end</span>
        <span class="keyword">if</span> (sub_j==3)

            mt_outcome = mt_coh_next - ar_coh_full;
            ar_xvar = ar_coh_full;

            st_y_label = <span class="string">'coh(a''(a,z), z'') - coh(a,z)'</span>;
            st_x_label = <span class="string">'COH(a,z)'</span>;
            st_title = <span class="string">'coh''(a'',z''|a,z) - coh(a,z): reachable coh'' given coh'</span>;
            st_legend_loc = <span class="string">'southwest'</span>;

        <span class="keyword">end</span>

        <span class="comment">% 5. Start Figure</span>
        <span class="keyword">if</span> (~bl_graph_onebyones)
            subplot(1,3,sub_j)
        <span class="keyword">else</span>
            figure(<span class="string">'PaperPosition'</span>, [0 0 7 4]);
        <span class="keyword">end</span>
        hold <span class="string">on</span>;

        <span class="comment">% 7. Color</span>
        clr = jet(length(ar_z));
        <span class="keyword">for</span> m = 1:length(ar_z)
            <span class="comment">% scatter</span>
            fig_cur_z = scatter(ar_xvar, mt_outcome(:,m), 1, <span class="keyword">...</span>
                <span class="string">'MarkerEdgeColor'</span>, clr(m,:), <span class="string">'MarkerFaceAlpha'</span>, 0.1, <span class="keyword">...</span>
                <span class="string">'MarkerFaceColor'</span>, clr(m,:), <span class="string">'MarkerEdgeAlpha'</span>, 0.1);
            chart(m) = fig_cur_z;
        <span class="keyword">end</span>

        <span class="comment">% 8. Legends</span>
        legend2plot = fliplr([1 round(length(ar_z)/4) round((2*length(ar_z))/4) round((3*length(ar_z))/4)  length(ar_z)]);
        legendCell = cellstr(num2str(ar_z', <span class="string">'shock next=%3.2f'</span>));
        legend(chart(legend2plot), legendCell(legend2plot), <span class="string">'Location'</span>, st_legend_loc);

        <span class="comment">% 9. Titling etc</span>
        grid <span class="string">on</span>;
        title([st_title_prefix st_title]);
        ylabel(st_y_label);
        xlabel({st_x_label <span class="keyword">...</span>
                <span class="string">'if coh''&lt; coh or coh'' &gt; coh for all z, Pstationary(coh) = 0'</span>, <span class="keyword">...</span>
                <span class="string">'if coh''==coh for all z, Pstationary(coh) = Degenerate'</span>})
        <span class="keyword">if</span> (bl_log_coh == 0)
            xline0 = xline(0);
            xline0.HandleVisibility = <span class="string">'off'</span>;

            yline0 = yline(0);
            yline0.HandleVisibility = <span class="string">'off'</span>;
        <span class="keyword">else</span>
            xline0 = xline(log(0 - min(ar_a) + 1));
            xline0.HandleVisibility = <span class="string">'off'</span>;

            yline0 = yline(log(0 - min(ar_a) + 1));
            yline0.HandleVisibility = <span class="string">'off'</span>;
        <span class="keyword">end</span>


        <span class="comment">% 45 Degree Line</span>
        <span class="keyword">if</span> (sub_j~=3)
            hline = refline([1 0]);
            hline.Color = <span class="string">'k'</span>;
            hline.LineStyle = <span class="string">':'</span>;
            hline.HandleVisibility = <span class="string">'off'</span>;
            hline.LineWidth = 2.5;
        <span class="keyword">end</span>

        grid <span class="string">on</span>;
        grid <span class="string">minor</span>;
    <span class="keyword">end</span>

    <span class="comment">% save file</span>
    <span class="keyword">if</span> (bl_img_save)
        mkdir(support_map(<span class="string">'st_img_path'</span>));
        st_file_name = [st_img_prefix st_img_name_main <span class="string">'_coh'</span> st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="ff_az_vf_post_graph_01.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_02.png" alt=""> <h2 id="6">Graphing Values</h2><p><img src="ff_az_vf_post_graph_eq17689686927844300531.png" alt="$$V(a, z)$$" style="width:43px;height:15px;"></p><pre class="codeinput"><span class="keyword">if</span> (bl_graph_val)

    <span class="keyword">if</span> (~bl_graph_onebyones)
        figure(<span class="string">'PaperPosition'</span>, [0 0 14 4]);
    <span class="keyword">end</span>

    <span class="keyword">for</span> sub_j=1:1:2

        mt_outcome = mt_val;
        st_y_label = <span class="string">'V(a, z)'</span>;

        <span class="keyword">if</span> (~bl_graph_onebyones)
            subplot(1,2,sub_j)
        <span class="keyword">else</span>
            figure(<span class="string">'PaperPosition'</span>, [0 0 7 4]);
        <span class="keyword">end</span>
        hold <span class="string">on</span>;

        clr = jet(length(ar_it_z_graph));
        i_ctr = 0;
        <span class="keyword">for</span> i = ar_it_z_graph
            i_ctr = i_ctr + 1;

            <span class="keyword">if</span> (sub_j == 1)
                ar_x = ar_a;
            <span class="keyword">else</span>
                ar_x = log(ar_a - min(ar_a) + 1);
            <span class="keyword">end</span>

            ar_y = mt_outcome(:, i);
            scatter(ar_x, ar_y, 5, <span class="keyword">...</span>
                <span class="string">'MarkerEdgeColor'</span>, clr(i_ctr,:), <span class="keyword">...</span>
                <span class="string">'MarkerFaceColor'</span>, clr(i_ctr,:));
        <span class="keyword">end</span>

        grid <span class="string">on</span>;
        grid <span class="string">minor</span>;
        title([st_title_prefix <span class="string">'V(a, z)'</span>])
        ylabel(st_y_label)

        <span class="keyword">if</span> (sub_j == 1)
            xlabel({<span class="string">'Asset (a) State'</span>})
        <span class="keyword">else</span>
            xlabel({<span class="string">'log(a - min(a) + 1)'</span>})
        <span class="keyword">end</span>

        legendCell = cellstr(num2str(ar_z', <span class="string">'shock=%3.2f'</span>));
        legend(legendCell(ar_it_z_graph), <span class="string">'Location'</span>,<span class="string">'southeast'</span>);

        <span class="comment">% mark y = 0</span>
        yline0 = yline(0);
        yline0.HandleVisibility = <span class="string">'off'</span>;

        <span class="comment">% mark a = 0</span>
        <span class="keyword">if</span> (sub_j == 1)
            xline0 = xline(0);
        <span class="keyword">else</span>
            xline0 = xline(log(0 - min(ar_a) + 1));
        <span class="keyword">end</span>
        xline0.HandleVisibility = <span class="string">'off'</span>;

    <span class="keyword">end</span>

    <span class="comment">% save file</span>
    <span class="keyword">if</span> (bl_img_save)
        mkdir(support_map(<span class="string">'st_img_path'</span>));
        st_file_name = [st_img_prefix st_img_name_main <span class="string">'_val'</span> st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="ff_az_vf_post_graph_03.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_04.png" alt=""> <h2 id="7">Graphing Choice Levels</h2><p><img src="ff_az_vf_post_graph_eq05796879393858969175.png" alt="$$a''(\Lambda(a,z), z)$$&#xA;$$c(\Lambda(a,z), z)$$" style="width:161px;height:16px;"></p><pre class="codeinput"><span class="keyword">if</span> (bl_graph_pol_lvl)

    <span class="keyword">if</span> (~bl_graph_onebyones)
        figure(<span class="string">'PaperPosition'</span>, [0 0 14 8]);
        ar_sub_j = 1:1:4;
    <span class="keyword">else</span>
        ar_sub_j = [1 3 2 4];
    <span class="keyword">end</span>

    <span class="keyword">for</span> sub_j = ar_sub_j

        <span class="keyword">if</span> (sub_j==1 || sub_j == 3)

            <span class="comment">% asset choice</span>
            mt_outcome = mt_pol_a;

        <span class="keyword">end</span>
        <span class="keyword">if</span> (sub_j==2 || sub_j == 4)

            <span class="comment">% consumption choice</span>
            mt_outcome = mt_cons;

            <span class="comment">% for borrowing models consumption could be at cmin, and next</span>
            <span class="comment">% period a' choice given default is a'=0, using the consumption</span>
            <span class="comment">% equation, this leads to not cmin but a negative consumption</span>
            <span class="comment">% level. so here adjust negative consumption to 0</span>
            mt_outcome(mt_cons &lt;0) = 0;

        <span class="keyword">end</span>

        <span class="keyword">if</span> (~bl_graph_onebyones)
            subplot(2,2,sub_j)
        <span class="keyword">else</span>
            figure(<span class="string">'PaperPosition'</span>, [0 0 7 4]);
        <span class="keyword">end</span>
        hold <span class="string">on</span>;

        clr = jet(length(ar_it_z_graph));
        i_ctr = 0;
        <span class="keyword">for</span> i = ar_it_z_graph
            i_ctr = i_ctr + 1;
            ar_opti_curz = mt_outcome(:, i);

            <span class="keyword">if</span> (sub_j==1 || sub_j == 2)
                <span class="comment">% levels</span>
                ar_a_curz_use = ar_a';
                ar_opti_curz_use = ar_opti_curz';
            <span class="keyword">elseif</span> (sub_j==3 || sub_j == 4)
                <span class="comment">% logs</span>
                ar_a_curz_use = log(ar_a' - min(ar_a) + 1);
                <span class="keyword">if</span> (sub_j==3)
                    <span class="comment">% borrow save</span>
                    ar_opti_curz_use = log(ar_opti_curz' - min(ar_a) + 1);
                <span class="keyword">end</span>
                <span class="keyword">if</span> (sub_j == 4)
                    <span class="comment">% consumption</span>
                    ar_opti_curz_use = log(ar_opti_curz' + 1);
                <span class="keyword">end</span>
            <span class="keyword">end</span>

            scatter(ar_a_curz_use, ar_opti_curz_use, 5, <span class="keyword">...</span>
                <span class="string">'MarkerEdgeColor'</span>, clr(i_ctr,:), <span class="keyword">...</span>
                <span class="string">'MarkerFaceColor'</span>, clr(i_ctr,:));
        <span class="keyword">end</span>

        <span class="keyword">if</span> (sub_j==1)
            st_y_label = <span class="string">'Savings/Borrowing'</span>;
            st_x_label = {<span class="string">'Asset (a) State'</span><span class="keyword">...</span>
                <span class="string">'if a''(a,z)&gt;=a for all z, dist. shifts up'</span><span class="keyword">...</span>
                <span class="string">'if a''(a,z)&lt;=a for all z, dist. shifts down'</span>};
        <span class="keyword">end</span>
        <span class="keyword">if</span> (sub_j==2)
            st_y_label = <span class="string">'Consumption (br cmin set to 0)'</span>;
            st_x_label = <span class="string">'Asset (a) State'</span>;
        <span class="keyword">end</span>
        <span class="keyword">if</span> (sub_j==3)
            st_y_label = <span class="string">'log(SaveBorr - min(a) + 1)'</span>;
            st_x_label = {<span class="string">'log(Asset State - min(a) + 1)'</span><span class="keyword">...</span>
                <span class="string">'if a''(a,z)&gt;=a for all z, dist. shifts up'</span><span class="keyword">...</span>
                <span class="string">'if a''(a,z)&lt;=a for all z, dist. shifts down'</span>};
        <span class="keyword">end</span>
        <span class="keyword">if</span> (sub_j==4)
            st_y_label = <span class="string">'log(Consumption + 1) (br cmin set to 0)'</span>;
            st_x_label = <span class="string">'log(Asset State - min(a) + 1)'</span>;
        <span class="keyword">end</span>


        grid <span class="string">on</span>;
        legendCell = cellstr(num2str(ar_z', <span class="string">'shock=%3.2f'</span>));
        title([st_title_prefix st_y_label]);
        ylabel(st_y_label);
        xlabel(st_x_label);

        legend(legendCell(ar_it_z_graph), <span class="string">'Location'</span>,<span class="string">'northwest'</span>);

        hline = refline([1 0]);
        hline.Color = <span class="string">'k'</span>;
        hline.LineStyle = <span class="string">':'</span>;
        hline.HandleVisibility = <span class="string">'off'</span>;

        <span class="keyword">if</span> (sub_j==3 || sub_j == 4)
            xline0 = xline(log(0-min(ar_a)+1));
            xline0.HandleVisibility = <span class="string">'off'</span>;
            yline0 = yline(log(0+1));
            yline0.HandleVisibility = <span class="string">'off'</span>;
        <span class="keyword">else</span>
            xline0 = xline(0);
            xline0.HandleVisibility = <span class="string">'off'</span>;
            yline0 = yline(0);
            yline0.HandleVisibility = <span class="string">'off'</span>;
        <span class="keyword">end</span>
        grid <span class="string">on</span>;
        grid <span class="string">minor</span>;

    <span class="keyword">end</span>

    <span class="comment">% save file</span>
    <span class="keyword">if</span> (bl_img_save)
        mkdir(support_map(<span class="string">'st_img_path'</span>));
        st_file_name = [st_img_prefix st_img_name_main <span class="string">'_pol_lvl'</span> st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="ff_az_vf_post_graph_05.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_06.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_07.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_08.png" alt=""> <h2 id="8">Graphing Choice Percentages</h2><pre class="codeinput"><span class="keyword">if</span> (bl_graph_pol_pct)

    <span class="keyword">if</span>(~bl_graph_onebyones)
        figure(<span class="string">'PaperPosition'</span>, [0 0 14 8]);
        ar_sub_j = 1:1:4;
    <span class="keyword">else</span>
        ar_sub_j = [1 3 2 4];
    <span class="keyword">end</span>

    <span class="keyword">for</span> sub_j = ar_sub_j

        mt_outcome = zeros(size(mt_pol_a));
        mt_it_borr_idx = (mt_pol_a &lt; 0);

        <span class="keyword">if</span> (ismember(sub_j, [1,2]))
            bl_log_coh = 0;
            st_sv_suffix = <span class="string">'_xcoh'</span>;
            st_title_suffix = <span class="string">' (x=coh)'</span>;
        <span class="keyword">else</span>
            bl_log_coh = 1;
            st_sv_suffix = <span class="string">'_logxcoh'</span>;
            st_title_suffix = <span class="string">' (x=log(coh))'</span>;
        <span class="keyword">end</span>

        <span class="keyword">if</span> (sub_j==1 || sub_j==3)
            mt_outcome(mt_it_borr_idx) = -mt_pol_a(mt_it_borr_idx)./min(ar_a);
            mt_outcome(~mt_it_borr_idx) = mt_pol_a(~mt_it_borr_idx)./mt_coh(~mt_it_borr_idx);
            st_y_label = <span class="string">'aprime/min(ar_a) if br; aprime/cashonhand if sv'</span>;
            st_legend_loc = <span class="string">'southeast'</span>;
            st_title = <span class="string">'Save/Borrow % of Borrow Limit or COH'</span>;
        <span class="keyword">end</span>
        <span class="keyword">if</span> (sub_j==2 || sub_j==4)

            mt_cons_use = mt_cons;
            mt_cons_use(mt_cons &lt;0) = 0;

            mt_outcome(mt_it_borr_idx) = mt_cons_use(mt_it_borr_idx)./(mt_coh(mt_it_borr_idx) - mt_pol_a(mt_it_borr_idx));
            mt_outcome(~mt_it_borr_idx) = mt_cons_use(~mt_it_borr_idx)./mt_coh(~mt_it_borr_idx);
            st_y_label = <span class="string">'c/(coh-aprime) if br; c/cashonhand if sv'</span>;
            st_legend_loc = <span class="string">'northeast'</span>;
            st_title = <span class="string">'Consumption Choice As Fraction'</span>;
        <span class="keyword">end</span>

        <span class="keyword">if</span> (~bl_graph_onebyones)
            subplot(2,2,sub_j)
        <span class="keyword">else</span>
            figure(<span class="string">'PaperPosition'</span>, [0 0 7 4]);
        <span class="keyword">end</span>
        hold <span class="string">on</span>;

        clr = jet(length(ar_it_z_graph));
        i_ctr = 0;
        <span class="keyword">for</span> i = ar_it_z_graph

            i_ctr = i_ctr + 1;
            ar_opti_curz = mt_outcome(:, i);

            <span class="keyword">if</span> (bl_log_coh == 0)
                ar_x = ar_a;
            <span class="keyword">else</span>
                ar_x = log(ar_a - min(ar_a) + 1);
            <span class="keyword">end</span>

            scatter(ar_x, ar_opti_curz, 5, <span class="keyword">...</span>
                <span class="string">'MarkerEdgeColor'</span>, clr(i_ctr,:), <span class="keyword">...</span>
                <span class="string">'MarkerFaceColor'</span>, clr(i_ctr,:));
        <span class="keyword">end</span>

        grid <span class="string">on</span>;

        title([st_title_prefix st_title st_title_suffix])
        ylabel(st_y_label)

        legendCell = cellstr(num2str(ar_z', <span class="string">'shock=%3.2f'</span>));

        xlabel({<span class="string">'Asset State'</span>})
        legend(legendCell(ar_it_z_graph), <span class="string">'Location'</span>, st_legend_loc);
        <span class="comment">%         xlim([min(ar_coh_curz)+1.5 15]);</span>

        <span class="keyword">if</span> (bl_log_coh == 0)
            xline0 = xline(0);
            xline0.HandleVisibility = <span class="string">'off'</span>;
        <span class="keyword">else</span>
            xline0 = xline(log(0-min(ar_a)+1));
            xline0.HandleVisibility = <span class="string">'off'</span>;
        <span class="keyword">end</span>

        yline0 = yline(0);
        yline0.HandleVisibility = <span class="string">'off'</span>;
        yline0 = yline(1);
        yline0.HandleVisibility = <span class="string">'off'</span>;

        <span class="comment">% for save/borrow 100 and -100 percent</span>
        <span class="keyword">if</span> (sub_j==1)
            yline0 = yline(-1);
            yline0.HandleVisibility = <span class="string">'off'</span>;
        <span class="keyword">end</span>

        grid <span class="string">on</span>;
        grid <span class="string">minor</span>;
    <span class="keyword">end</span>

    <span class="comment">% save file</span>
    <span class="keyword">if</span> (bl_img_save)
        mkdir(support_map(<span class="string">'st_img_path'</span>));
        st_file_name = [st_img_prefix st_img_name_main <span class="string">'_pol_pct'</span> st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="ff_az_vf_post_graph_09.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_10.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_11.png" alt=""> <img vspace="5" hspace="5" src="ff_az_vf_post_graph_12.png" alt=""> <pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Graph Cash-on-Hand Tomorrow, Value, Policy given (A,Z) States Today
% *back to <https://fanwangecon.github.io Fan>'s
% <https://fanwangecon.github.io/CodeDynaAsset/ Dynamic Assets Repository>
% Table of Content.*

%%
function ff_az_vf_post_graph(varargin)
%% FF_AZ_VF_POST_GRAPH genereate 4 graphs
% Generates four graphs:
%
% # Cash-On-Hand Tomorrow given Cash-on-Hand Today
% # Value Function Graph
% # Policy Function Consumption and Asset Choices, Level and log
% # Consumption and Asset as Percentages
%
% Run this function directly with randomly generates matrixes for graphs
% and tables.
%
% @param param_map container parameter container
%
% @param support_map container support container
%
% @param armt_map container container with states, choices and shocks
% grids that are inputs for grid based solution algorithm
%
% @param result_map container contains policy function matrix, value
% function matrix, iteration results; als coh consumption and other matrixes
%
% @example
%
%    ff_az_vf_post_graph(param_map, support_map, armt_map, func_map, result_map);
%
% @include
%
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html ffs_az_set_default_param>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_get_funcgrid.html ffs_az_get_funcgrid>
%

%% Default

params_len = length(varargin);
bl_input_override = 0;
if (params_len == 6)
    bl_input_override = varargin{6};
end

if (bl_input_override)
    % if invoked from outside overrid fully
    [param_map, support_map, armt_map, func_map, result_map, ~] = varargin{:};
else
    clear all;
    close all;
    
    % internal invoke for testing
    it_param_set = 4;
    bl_input_override = true;
    
    % Get Parameters
    [param_map, support_map] = ffs_az_set_default_param(it_param_set);
    [armt_map, func_map] = ffs_az_get_funcgrid(param_map, support_map, bl_input_override); % 1 for override
    
    % Generate Default val and policy matrixes
    params_group = values(armt_map, {'ar_a', 'ar_z'});
    [ar_a, ar_z] = params_group{:};
    params_group = values(func_map, {'f_util_standin', 'f_cons', 'f_coh'});
    [f_util_standin, f_cons, f_coh] = params_group{:};
    
    % Set Defaults
    mt_val = f_util_standin(ar_z, ar_a');
    mt_pol_a = zeros(size(mt_val)) + ar_a'*(cumsum(sort(ar_z))/sum(ar_z)*0.4 + 0.4);
    mt_cons = f_cons(ar_z, ar_a', mt_pol_a);
    mt_coh = f_coh(ar_z, ar_a');
    
    % Set Results Map
    result_map = containers.Map('KeyType','char', 'ValueType','any');
    result_map('mt_val') = mt_val;
    result_map('mt_pol_a') = mt_pol_a;
    result_map('mt_cons') = mt_cons;
    result_map('mt_coh') = mt_coh;
end

%% Parse Parameters

% param_map
params_group = values(param_map, {'it_z_n'});
[it_z_n] = params_group{:};

% support_map
params_group = values(support_map, {'bl_graph_onebyones', 'bl_graph_val', 'bl_graph_pol_lvl', 'bl_graph_pol_pct', 'bl_graph_coh_t_coh'});
[bl_graph_onebyones, bl_graph_val, bl_graph_pol_lvl, bl_graph_pol_pct, bl_graph_coh_t_coh] = params_group{:};
params_group = values(support_map, {'bl_img_save', 'st_img_path', 'st_img_prefix', 'st_img_name_main', 'st_img_suffix'});
[bl_img_save, st_img_path, st_img_prefix, st_img_name_main, st_img_suffix] = params_group{:};
params_group = values(support_map, {'st_title_prefix'});
[st_title_prefix] = params_group{:};

% armt_map
params_group = values(armt_map, {'ar_a', 'ar_z'});
[ar_a, ar_z] = params_group{:};

% func_map
params_group = values(func_map, {'f_coh'});
[f_coh] = params_group{:};

% result_map
params_group = values(result_map, {'mt_cons', 'mt_coh', 'mt_val', 'mt_pol_a'});
[mt_cons, mt_coh, mt_val, mt_pol_a] = params_group{:};

% How many zs to Graph
ar_it_z_graph = ([1 round((it_z_n)/4) round(2*((it_z_n)/4)) round(3*((it_z_n)/4)) (it_z_n)]);


%% Graphing COH today vs COH tomorrow
% This plots the cash-on-hand today vs cash-on-hand tomorrow. This is an
% important graph that is key for analyzing the asset distribution. We
% would like to see at each point of the current cash-on-hand, what are the
% cash-on-hand that are reachable tomorrow. Note, here we are not plottin
% gbased on probability density for each discretized state tomorrow, just
% which states are reacable, meaning which states given states have
% non-zero probability of been reached tomorrow.
%
% $$f(\Lambda(z',a') \mid \Lambda, z)$$
%
% Three possible cases:
%
% # next period cash-on-hand is always lower than current period
% cash-on-hand given policy function. This means it is not possible to
% exceed beyond this level of cash-on-hand in the stationary distribution.
% If we start mass lower than this level of cash-on-hand, it will never
% exceed this.
% # next period cash-on-hand is always higher than current period
% cash-on-hand. Stationary distribution will never go below this level.
% # next period cash-on-hand is identical to today cash on hand. This is an
% absorbing state.
%
% The dimensionality of the graph is as follows:
%
% # a_n by z_n state space and corresonding policy function
% # all a_n and z_n combinations, one array, policy array, than given that,
% the cash-on-hand next period. meshed a_n and z_n with each other, crossed
% with another z_n.
% # each color a different future z_n
%

if (bl_graph_coh_t_coh)
    
    % 1. Single Array A' Next Period and COH today
    ar_pol_a_full = mt_pol_a(:);
    ar_coh_full = mt_coh(:);
    
    % 2. COH Next Period
    mt_coh_next = f_coh(ar_z, ar_pol_a_full);
    
    % 3. Start Figure
    if(~bl_graph_onebyones)
        figure('PaperPosition', [0 0 21 4]);
        ar_sub_j = 1:1:3;
    else
        ar_sub_j = [3 2];
    end
    
    for sub_j = ar_sub_j
        
        % 4. Legends and values
        if (ismember(sub_j, [2]))
            bl_log_coh = 1;
        else
            bl_log_coh = 0;
        end
        
        if (sub_j==1)
            
            mt_outcome = mt_coh_next;
            ar_xvar = ar_coh_full;
            
            st_y_label = 'cash-on-hand t+1 = coh(a''(a,z), z'')';
            st_x_label = 'cash-on-hand t = coh(a,z)';
            st_title = 'coh(a''(coh(a,z),z), z''): reachable coh'' given coh';
            st_legend_loc = 'southeast';
            
        end
        if (sub_j==2)
            
            mt_outcome = log(mt_coh_next - min(ar_a) + 1);
            ar_xvar = log(ar_coh_full - min(ar_a) + 1);
            
            st_y_label = 'log(COH'' - min(a'') + 1)';
            st_x_label = 'log(COH)';
            st_title = 'coh(a''(coh(a,z),z), z''): reachable coh'' given coh';
            st_legend_loc = 'southeast';
            
        end
        if (sub_j==3)
            
            mt_outcome = mt_coh_next - ar_coh_full;
            ar_xvar = ar_coh_full;
            
            st_y_label = 'coh(a''(a,z), z'') - coh(a,z)';
            st_x_label = 'COH(a,z)';
            st_title = 'coh''(a'',z''|a,z) - coh(a,z): reachable coh'' given coh';
            st_legend_loc = 'southwest';
            
        end
        
        % 5. Start Figure
        if (~bl_graph_onebyones)
            subplot(1,3,sub_j)
        else
            figure('PaperPosition', [0 0 7 4]);
        end
        hold on;
        
        % 7. Color
        clr = jet(length(ar_z));
        for m = 1:length(ar_z)
            % scatter
            fig_cur_z = scatter(ar_xvar, mt_outcome(:,m), 1, ...
                'MarkerEdgeColor', clr(m,:), 'MarkerFaceAlpha', 0.1, ...
                'MarkerFaceColor', clr(m,:), 'MarkerEdgeAlpha', 0.1);
            chart(m) = fig_cur_z;
        end
        
        % 8. Legends
        legend2plot = fliplr([1 round(length(ar_z)/4) round((2*length(ar_z))/4) round((3*length(ar_z))/4)  length(ar_z)]);
        legendCell = cellstr(num2str(ar_z', 'shock next=%3.2f'));
        legend(chart(legend2plot), legendCell(legend2plot), 'Location', st_legend_loc);
        
        % 9. Titling etc
        grid on;
        title([st_title_prefix st_title]);
        ylabel(st_y_label);
        xlabel({st_x_label ...
                'if coh''< coh or coh'' > coh for all z, Pstationary(coh) = 0', ...
                'if coh''==coh for all z, Pstationary(coh) = Degenerate'})
        if (bl_log_coh == 0)
            xline0 = xline(0);
            xline0.HandleVisibility = 'off';
            
            yline0 = yline(0);
            yline0.HandleVisibility = 'off';
        else
            xline0 = xline(log(0 - min(ar_a) + 1));
            xline0.HandleVisibility = 'off';
            
            yline0 = yline(log(0 - min(ar_a) + 1));
            yline0.HandleVisibility = 'off';
        end
        
        
        % 45 Degree Line
        if (sub_j~=3)        
            hline = refline([1 0]);
            hline.Color = 'k';
            hline.LineStyle = ':';
            hline.HandleVisibility = 'off';
            hline.LineWidth = 2.5;
        end
        
        grid on;
        grid minor;
    end
    
    % save file
    if (bl_img_save)
        mkdir(support_map('st_img_path'));
        st_file_name = [st_img_prefix st_img_name_main '_coh' st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    end
    
end

%% Graphing Values
%
% $$V(a, z)$$
%

if (bl_graph_val)
    
    if (~bl_graph_onebyones)
        figure('PaperPosition', [0 0 14 4]);
    end
    
    for sub_j=1:1:2
        
        mt_outcome = mt_val;
        st_y_label = 'V(a, z)';
        
        if (~bl_graph_onebyones)
            subplot(1,2,sub_j)
        else
            figure('PaperPosition', [0 0 7 4]);
        end
        hold on;
        
        clr = jet(length(ar_it_z_graph));
        i_ctr = 0;
        for i = ar_it_z_graph
            i_ctr = i_ctr + 1;
            
            if (sub_j == 1)
                ar_x = ar_a;
            else
                ar_x = log(ar_a - min(ar_a) + 1);
            end
            
            ar_y = mt_outcome(:, i);
            scatter(ar_x, ar_y, 5, ...
                'MarkerEdgeColor', clr(i_ctr,:), ...
                'MarkerFaceColor', clr(i_ctr,:));
        end
        
        grid on;
        grid minor;
        title([st_title_prefix 'V(a, z)'])
        ylabel(st_y_label)
        
        if (sub_j == 1)
            xlabel({'Asset (a) State'})
        else
            xlabel({'log(a - min(a) + 1)'})
        end
        
        legendCell = cellstr(num2str(ar_z', 'shock=%3.2f'));
        legend(legendCell(ar_it_z_graph), 'Location','southeast');
        
        % mark y = 0
        yline0 = yline(0);
        yline0.HandleVisibility = 'off';
        
        % mark a = 0
        if (sub_j == 1)
            xline0 = xline(0);
        else
            xline0 = xline(log(0 - min(ar_a) + 1));
        end
        xline0.HandleVisibility = 'off';
        
    end
    
    % save file
    if (bl_img_save)
        mkdir(support_map('st_img_path'));
        st_file_name = [st_img_prefix st_img_name_main '_val' st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    end
    
end

%% Graphing Choice Levels
%
% $$a''(\Lambda(a,z), z)$$
% $$c(\Lambda(a,z), z)$$
%

if (bl_graph_pol_lvl)
    
    if (~bl_graph_onebyones)
        figure('PaperPosition', [0 0 14 8]);
        ar_sub_j = 1:1:4;
    else
        ar_sub_j = [1 3 2 4];
    end
    
    for sub_j = ar_sub_j
        
        if (sub_j==1 || sub_j == 3)
            
            % asset choice
            mt_outcome = mt_pol_a;
            
        end
        if (sub_j==2 || sub_j == 4)
            
            % consumption choice
            mt_outcome = mt_cons;
            
            % for borrowing models consumption could be at cmin, and next
            % period a' choice given default is a'=0, using the consumption
            % equation, this leads to not cmin but a negative consumption
            % level. so here adjust negative consumption to 0
            mt_outcome(mt_cons <0) = 0;
            
        end
        
        if (~bl_graph_onebyones)
            subplot(2,2,sub_j)
        else
            figure('PaperPosition', [0 0 7 4]);
        end
        hold on;
        
        clr = jet(length(ar_it_z_graph));
        i_ctr = 0;
        for i = ar_it_z_graph
            i_ctr = i_ctr + 1;
            ar_opti_curz = mt_outcome(:, i);
            
            if (sub_j==1 || sub_j == 2)
                % levels
                ar_a_curz_use = ar_a';
                ar_opti_curz_use = ar_opti_curz';
            elseif (sub_j==3 || sub_j == 4)
                % logs
                ar_a_curz_use = log(ar_a' - min(ar_a) + 1);
                if (sub_j==3)
                    % borrow save
                    ar_opti_curz_use = log(ar_opti_curz' - min(ar_a) + 1);
                end
                if (sub_j == 4)
                    % consumption
                    ar_opti_curz_use = log(ar_opti_curz' + 1);
                end
            end
            
            scatter(ar_a_curz_use, ar_opti_curz_use, 5, ...
                'MarkerEdgeColor', clr(i_ctr,:), ...
                'MarkerFaceColor', clr(i_ctr,:));
        end
        
        if (sub_j==1)
            st_y_label = 'Savings/Borrowing';
            st_x_label = {'Asset (a) State'...
                'if a''(a,z)>=a for all z, dist. shifts up'...
                'if a''(a,z)<=a for all z, dist. shifts down'};
        end
        if (sub_j==2)
            st_y_label = 'Consumption (br cmin set to 0)';
            st_x_label = 'Asset (a) State';
        end
        if (sub_j==3)
            st_y_label = 'log(SaveBorr - min(a) + 1)';
            st_x_label = {'log(Asset State - min(a) + 1)'...
                'if a''(a,z)>=a for all z, dist. shifts up'...
                'if a''(a,z)<=a for all z, dist. shifts down'};
        end
        if (sub_j==4)
            st_y_label = 'log(Consumption + 1) (br cmin set to 0)';
            st_x_label = 'log(Asset State - min(a) + 1)';
        end
        
        
        grid on;
        legendCell = cellstr(num2str(ar_z', 'shock=%3.2f'));
        title([st_title_prefix st_y_label]);
        ylabel(st_y_label);
        xlabel(st_x_label);
        
        legend(legendCell(ar_it_z_graph), 'Location','northwest');
        
        hline = refline([1 0]);
        hline.Color = 'k';
        hline.LineStyle = ':';
        hline.HandleVisibility = 'off';
        
        if (sub_j==3 || sub_j == 4)
            xline0 = xline(log(0-min(ar_a)+1));
            xline0.HandleVisibility = 'off';
            yline0 = yline(log(0+1));
            yline0.HandleVisibility = 'off';
        else
            xline0 = xline(0);
            xline0.HandleVisibility = 'off';
            yline0 = yline(0);
            yline0.HandleVisibility = 'off';
        end
        grid on;
        grid minor;
        
    end
    
    % save file
    if (bl_img_save)
        mkdir(support_map('st_img_path'));
        st_file_name = [st_img_prefix st_img_name_main '_pol_lvl' st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    end
    
end

%% Graphing Choice Percentages

if (bl_graph_pol_pct)
    
    if(~bl_graph_onebyones)
        figure('PaperPosition', [0 0 14 8]);
        ar_sub_j = 1:1:4;
    else
        ar_sub_j = [1 3 2 4];
    end
    
    for sub_j = ar_sub_j
        
        mt_outcome = zeros(size(mt_pol_a));
        mt_it_borr_idx = (mt_pol_a < 0);
        
        if (ismember(sub_j, [1,2]))
            bl_log_coh = 0;
            st_sv_suffix = '_xcoh';
            st_title_suffix = ' (x=coh)';
        else
            bl_log_coh = 1;
            st_sv_suffix = '_logxcoh';
            st_title_suffix = ' (x=log(coh))';
        end
        
        if (sub_j==1 || sub_j==3)
            mt_outcome(mt_it_borr_idx) = -mt_pol_a(mt_it_borr_idx)./min(ar_a);
            mt_outcome(~mt_it_borr_idx) = mt_pol_a(~mt_it_borr_idx)./mt_coh(~mt_it_borr_idx);
            st_y_label = 'aprime/min(ar_a) if br; aprime/cashonhand if sv';
            st_legend_loc = 'southeast';
            st_title = 'Save/Borrow % of Borrow Limit or COH';
        end
        if (sub_j==2 || sub_j==4)
            
            mt_cons_use = mt_cons;
            mt_cons_use(mt_cons <0) = 0;
            
            mt_outcome(mt_it_borr_idx) = mt_cons_use(mt_it_borr_idx)./(mt_coh(mt_it_borr_idx) - mt_pol_a(mt_it_borr_idx));
            mt_outcome(~mt_it_borr_idx) = mt_cons_use(~mt_it_borr_idx)./mt_coh(~mt_it_borr_idx);
            st_y_label = 'c/(coh-aprime) if br; c/cashonhand if sv';
            st_legend_loc = 'northeast';
            st_title = 'Consumption Choice As Fraction';
        end
        
        if (~bl_graph_onebyones)
            subplot(2,2,sub_j)
        else
            figure('PaperPosition', [0 0 7 4]);
        end
        hold on;
        
        clr = jet(length(ar_it_z_graph));
        i_ctr = 0;
        for i = ar_it_z_graph
            
            i_ctr = i_ctr + 1;
            ar_opti_curz = mt_outcome(:, i);
            
            if (bl_log_coh == 0)
                ar_x = ar_a;
            else
                ar_x = log(ar_a - min(ar_a) + 1);
            end
            
            scatter(ar_x, ar_opti_curz, 5, ...
                'MarkerEdgeColor', clr(i_ctr,:), ...
                'MarkerFaceColor', clr(i_ctr,:));
        end
        
        grid on;
        
        title([st_title_prefix st_title st_title_suffix])
        ylabel(st_y_label)
        
        legendCell = cellstr(num2str(ar_z', 'shock=%3.2f'));
        
        xlabel({'Asset State'})
        legend(legendCell(ar_it_z_graph), 'Location', st_legend_loc);
        %         xlim([min(ar_coh_curz)+1.5 15]);
        
        if (bl_log_coh == 0)
            xline0 = xline(0);
            xline0.HandleVisibility = 'off';
        else
            xline0 = xline(log(0-min(ar_a)+1));
            xline0.HandleVisibility = 'off';
        end
        
        yline0 = yline(0);
        yline0.HandleVisibility = 'off';
        yline0 = yline(1);
        yline0.HandleVisibility = 'off';
        
        % for save/borrow 100 and -100 percent
        if (sub_j==1)
            yline0 = yline(-1);
            yline0.HandleVisibility = 'off';
        end
        
        grid on;
        grid minor;
    end
    
    % save file
    if (bl_img_save)
        mkdir(support_map('st_img_path'));
        st_file_name = [st_img_prefix st_img_name_main '_pol_pct' st_img_suffix];
        saveas(gcf, strcat(st_img_path, st_file_name));
    end
    
end


end

##### SOURCE END #####
--></body></html>