
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Simulate Savings Model Along Various Parameter Arrays</title><meta name="generator" content="MATLAB 9.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-07-20"><meta name="DC.source" content="ff_az_test_gen.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Simulate Savings Model Along Various Parameter Arrays</h1><!--introduction--><p><b>back to <a href="https://fanwangecon.github.io">Fan</a>'s <a href="https://fanwangecon.github.io/CodeDynaAsset/">Dynamic Assets Repository</a> Table of Content.</b></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">FF_AZ_TEST_GEN post solution simulation</a></li><li><a href="#3">Default Parameter Loops</a></li><li><a href="#4">Default Parameters</a></li><li><a href="#5">Array Parameters</a></li><li><a href="#6">Default</a></li><li><a href="#7">Parse Inputs</a></li><li><a href="#8">Parse Generate or Get Current</a></li><li><a href="#9">Store Mat Strings</a></li><li><a href="#10">Set Solve Sizes</a></li><li><a href="#11">Parase Preference and Shock Parameters</a></li><li><a href="#12">Display support_map</a></li><li><a href="#13">Generate New or Obtain Existing Mat</a></li><li><a href="#14">Initialize Storage</a></li><li><a href="#15">Simulate 1: Cross Simulation, fix one point, extend parameters in each direction</a></li><li><a href="#16">Simulate 2: Full Grid Simulation, Simulate Along Full Grid</a></li><li><a href="#17">Save Mat</a></li><li><a href="#20">Simulate Model given Parameter and Process Results</a></li><li><a href="#22">Reset Parameters that are determined by other parameters</a></li><li><a href="#23">Simulate Model</a></li><li><a href="#24">Store Results to Table</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> [tb_outcomes, support_map, param_desc_map] = ff_az_test_gen(varargin)
</pre><h2 id="2">FF_AZ_TEST_GEN post solution simulation</h2><p>Simulate the model along various dimensions</p><p>@param bl_simu_cross boolean cross vs gridd simulation. cross: with (x,y), vary X fixing y, vary Y fixing x. grid: all (x,y) \in (X,Y)</p><p>@param it_size_type integer:  param_map support_map param_tstar_map param_desc_map # it_size_type = 1 is quick grid # it_size_type = 2 is standard grid # it_size_type = 3 is denser grid</p><p>@param cl_st_param_keys cell string cell array container parameters that we are simulating over</p><p>@param param_map container parameter container</p><p>@param support_map container support container</p><p>@param param_tstar_map container map of arrays with keys that are parameter keys. This could be specified outside with array values to override defaults here.</p><p>@param param_desc_map container map of strings for each parameter key.</p><p>@param tb_outcomes table table of simulation outcomes for various statistics for each set of parameters. Columns are statistics, rows are outcome variables, groups of rows are different simulations.</p><p>@include</p><div><ul><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html">ff_az_vf_vecsv</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vecsv.html">ff_az_ds_vecsv</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html">ffs_az_set_default_param</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_get_funcgrid.html">ffs_az_get_funcgrid</a></li></ul></div><p>@seealso</p><div><ul><li><i>SPEED</i> savings only overall benchmark speed testing: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_speed/html/fsi_az_ds_vecsv_speed.html">fsi_az_ds_vecsv_speed</a></li><li><i>PREFERENCE</i> savings only preference testing: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_pref/html/fsi_az_ds_vecsv_pref.html">fsi_az_ds_vecsv_pref</a></li><li><i>PREFERENCE</i> savings only preference testing cross: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_pref/html/fsi_az_ds_vecsv_pref_cross.html">fsi_az_ds_vecsv_pref_cross</a></li><li><i>SHOCK</i> savings only shock testing: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_shock/html/fsi_az_ds_vecsv_shock.html">fsi_az_ds_vecsv_shock</a></li><li><i>SHOCK</i> savings only shock testing cross: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_shock/html/fsi_az_ds_vecsv_shock_cross.html">fsi_az_ds_vecsv_shock_cross</a></li><li><i>PRICE</i> savings only wage and interest rate testing cross: adjust wage and savings rate <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_price/html/fsi_az_ds_vecsv_price_cross.html">fsi_az_ds_vecsv_price_cross</a></li></ul></div><h2 id="3">Default Parameter Loops</h2><pre class="codeinput"><span class="comment">% Loops to Vary for Simulations Below</span>
it_size_type = 2;
cl_st_param_keys = {<span class="string">'fl_crra'</span>, <span class="string">'fl_beta'</span>};
bl_simu_cross = true; <span class="comment">% if false, simu full grid</span>
</pre><h2 id="4">Default Parameters</h2><pre class="codeinput"><span class="comment">% Base parameters call</span>
it_param_set = 9;
[param_map, support_map] = ffs_az_set_default_param(it_param_set);

<span class="comment">% Timer</span>
support_map(<span class="string">'bl_timer'</span>) = true;

<span class="comment">% Mat Storage</span>
support_map(<span class="string">'bl_mat_test'</span>) = true;
st_matimg_path_root = support_map(<span class="string">'st_matimg_path_root'</span>);
<span class="comment">% test_borinf for default: cl_st_param_keys = [3, 8, 9]</span>
support_map(<span class="string">'st_mat_test_path'</span>) = [st_matimg_path_root <span class="string">'/test/ff_az_ds_vecsv/mat/'</span>];

<span class="comment">% Generate or Load</span>
<span class="comment">% if bl_replacefile is true, that means even if file already exists,</span>
<span class="comment">% generaet new. bl_replacefile is false, then if false does not exist</span>
<span class="comment">% generate, if file exists does not generate.</span>
support_map(<span class="string">'bl_replacefile'</span>) = true;
support_map(<span class="string">'bl_display_simu_stats'</span>) = true;
</pre><h2 id="5">Array Parameters</h2><pre class="codeinput">ls_st_param_key = {<span class="string">'fl_crra'</span>, <span class="string">'fl_beta'</span>, <span class="keyword">...</span>
                    <span class="string">'fl_w'</span>, <span class="string">'fl_r_save'</span>, <span class="keyword">...</span>
                    <span class="string">'fl_z_rho'</span>, <span class="string">'fl_z_sig'</span>, <span class="keyword">...</span>
                    <span class="string">'fl_a_max'</span>, <span class="string">'it_z_n'</span>, <span class="string">'it_a_n'</span>};

param_tstar_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
it_simu_vec_len = 5;
param_tstar_map(ls_st_param_key{1}) = linspace(1, 5, it_simu_vec_len);
param_tstar_map(ls_st_param_key{2}) = linspace(0.87, 0.97, it_simu_vec_len);
param_tstar_map(ls_st_param_key{3}) = linspace(1.1, 1.4, it_simu_vec_len);
param_tstar_map(ls_st_param_key{4}) = linspace(0.01, 0.04, it_simu_vec_len);
param_tstar_map(ls_st_param_key{5}) = linspace(0, 0.99, it_simu_vec_len);
param_tstar_map(ls_st_param_key{6}) = linspace(0.01, 0.5, it_simu_vec_len);
param_tstar_map(ls_st_param_key{7}) = linspace(50, 80, it_simu_vec_len);
param_tstar_map(ls_st_param_key{8}) = unique(round(linspace(5, 25, it_simu_vec_len)));
param_tstar_map(ls_st_param_key{9}) = unique(round(linspace(100, 2500, it_simu_vec_len)));

param_desc_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
param_desc_map(ls_st_param_key{1}) = {<span class="string">'CRRA'</span>};
param_desc_map(ls_st_param_key{2}) = {<span class="string">'Discount'</span>};
param_desc_map(ls_st_param_key{3}) = {<span class="string">'Wage'</span>};
param_desc_map(ls_st_param_key{4}) = {<span class="string">'Save Interest'</span>};
param_desc_map(ls_st_param_key{5}) = {<span class="string">'Shock Persistence'</span>};
param_desc_map(ls_st_param_key{6}) = {<span class="string">'Shock SD'</span>};
param_desc_map(ls_st_param_key{7}) = {<span class="string">'Max Asset Bound'</span>};
param_desc_map(ls_st_param_key{8}) = {<span class="string">'Shock Grid N'</span>};
param_desc_map(ls_st_param_key{9}) = {<span class="string">'Asset Grid N'</span>};
</pre><h2 id="6">Default</h2><pre class="codeinput">default_params = {bl_simu_cross it_size_type cl_st_param_keys <span class="keyword">...</span>
                    param_map support_map param_tstar_map param_desc_map};
</pre><h2 id="7">Parse Inputs</h2><p>override default set above if any parameters are updated</p><pre class="codeinput">params_len = length(varargin);
[default_params{1:params_len}] = varargin{:};

bl_simu_cross = default_params{1};
it_size_type = default_params{2};
cl_st_param_keys = default_params{3};

param_map = [param_map; default_params{4}];
support_map = [support_map; default_params{5}];
param_tstar_map = [param_tstar_map; default_params{6}];
param_desc_map = [param_desc_map; default_params{7}];

<span class="comment">% Generate additional Elements of param_map for container map display</span>
param_map(<span class="string">'it_size_type'</span>) = it_size_type;
param_map(<span class="string">'cl_st_param_keys'</span>) = cl_st_param_keys;
ar_param_keys_idx = cell2mat(cellfun(@(m) find(strcmp(ls_st_param_key, m)), <span class="keyword">...</span>
    cl_st_param_keys, <span class="string">'UniformOutput'</span>, false));
param_map(<span class="string">'ar_param_keys_idx'</span>) = ar_param_keys_idx;
</pre><h2 id="8">Parse Generate or Get Current</h2><p>if bl_gen = true, generate, if bl_gen = false, get saved file and output. If bl_replacefile is true, that means the existing file must be replaced, which will set bl_gen to true</p><pre class="codeinput">params_group = values(support_map, <span class="keyword">...</span>
    {<span class="string">'bl_replacefile'</span>, <span class="string">'bl_display_simu_stats'</span>});
[bl_replacefile, bl_display_simu_stats] = params_group{:};
</pre><h2 id="9">Store Mat Strings</h2><div><ol><li><i>it_total_length</i>: this is the total length of all selected arrays</li><li><i>ar_param_keys_idx</i>: these are the linear index of the selected keys among all possible keys</li></ol></div><pre class="codeinput">it_total_length = sum(cell2mat(cellfun(@(m) length(param_tstar_map(m)), <span class="keyword">...</span>
                                cl_st_param_keys, <span class="string">'UniformOutput'</span>, false)));

support_map(<span class="string">'st_mat_test_prefix'</span>) = [<span class="string">''</span>];
support_map(<span class="string">'st_mat_test_name_main'</span>) = [<span class="string">'r'</span>];
support_map(<span class="string">'st_mat_test_suffix'</span>) = [<span class="string">'_g'</span> strrep(num2str(ar_param_keys_idx), <span class="string">'  '</span>, <span class="string">''</span>) <span class="keyword">...</span>
                                     <span class="string">'_c'</span> num2str(bl_simu_cross) <span class="string">'t'</span> num2str(it_size_type) <span class="keyword">...</span>
                                     <span class="string">'l'</span> num2str(it_total_length)];
</pre><h2 id="10">Set Solve Sizes</h2><pre class="codeinput"><span class="keyword">if</span> (it_size_type == 1)

    <span class="comment">% Basic Test Run</span>
    param_map(<span class="string">'it_z_n'</span>) = 11;
    param_map(<span class="string">'it_a_n'</span>) = 100;

<span class="keyword">elseif</span> (it_size_type == 2)

    <span class="comment">% Full Run</span>

<span class="keyword">elseif</span> (it_size_type == 3)

    <span class="comment">% Denser Run</span>
    param_map(<span class="string">'it_z_n'</span>) = 27;
    param_map(<span class="string">'it_a_n'</span>) = 2250;

<span class="keyword">end</span>
</pre><h2 id="11">Parase Preference and Shock Parameters</h2><pre class="codeinput"><span class="comment">% support map</span>
params_group = values(support_map, {<span class="string">'bl_mat_test'</span>, <span class="string">'st_mat_test_path'</span>, <span class="string">'st_mat_test_prefix'</span>, <span class="string">'st_mat_test_name_main'</span>, <span class="string">'st_mat_test_suffix'</span>});
[bl_mat_test, st_mat_test_path, st_mat_test_prefix, st_mat_test_name_main, st_mat_test_suffix] = params_group{:};
</pre><h2 id="12">Display support_map</h2><pre class="codeinput">fft_container_map_display(support_map);
fft_container_map_display(param_map);
fft_container_map_display(param_tstar_map);
</pre><pre class="codeoutput">----------------------------------------
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Begin: Show all key and value pairs from container
CONTAINER NAME: SUPPORT_MAP
----------------------------------------
  Map with properties:

        Count: 47
      KeyType: char
    ValueType: any

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
----------------------------------------
----------------------------------------
pos = 1 ; key = bl_display ; val = false
pos = 2 ; key = bl_display_defparam ; val = false
pos = 3 ; key = bl_display_dist ; val = false
pos = 4 ; key = bl_display_final ; val = false
pos = 5 ; key = bl_display_final_dist ; val = true
pos = 6 ; key = bl_display_final_dist_detail ; val = false
pos = 7 ; key = bl_display_funcgrids ; val = false
pos = 8 ; key = bl_display_simu_stats ; val = true
pos = 9 ; key = bl_graph ; val = true
pos = 10 ; key = bl_graph_coh_t_coh ; val = false
pos = 11 ; key = bl_graph_funcgrids ; val = false
pos = 12 ; key = bl_graph_onebyones ; val = true
pos = 13 ; key = bl_graph_pol_lvl ; val = false
pos = 14 ; key = bl_graph_pol_pct ; val = false
pos = 15 ; key = bl_graph_val ; val = false
pos = 16 ; key = bl_img_save ; val = false
pos = 17 ; key = bl_mat ; val = false
pos = 18 ; key = bl_mat_test ; val = true
pos = 19 ; key = bl_post ; val = true
pos = 20 ; key = bl_profile ; val = false
pos = 21 ; key = bl_profile_dist ; val = false
pos = 22 ; key = bl_replacefile ; val = true
pos = 23 ; key = bl_time ; val = false
pos = 24 ; key = bl_timer ; val = true
pos = 25 ; key = it_display_every ; val = 20
pos = 26 ; key = it_display_final_colmax ; val = 12
pos = 27 ; key = it_display_final_rowmax ; val = 100
pos = 28 ; key = it_display_summmat_colmax ; val = 5
pos = 29 ; key = it_display_summmat_rowmax ; val = 5
pos = 30 ; key = st_img_name_main ; val = _default
pos = 31 ; key = st_img_path ; val = C:/Users/fan/CodeDynaAsset//m_az//solve/img/
pos = 32 ; key = st_img_prefix ; val = 
pos = 33 ; key = st_img_suffix ; val = _p9.png
pos = 34 ; key = st_mat_name_main ; val = _default
pos = 35 ; key = st_mat_path ; val = C:/Users/fan/CodeDynaAsset//m_az//solve/mat/
pos = 36 ; key = st_mat_prefix ; val = 
pos = 37 ; key = st_mat_suffix ; val = _p9
pos = 38 ; key = st_mat_test_name_main ; val = r
pos = 39 ; key = st_mat_test_path ; val = C:/Users/fan/CodeDynaAsset//m_az//test/ff_az_ds_vecsv/mat/
pos = 40 ; key = st_mat_test_prefix ; val = 
pos = 41 ; key = st_mat_test_suffix ; val = _g12_c1t2l10
pos = 42 ; key = st_matimg_path_root ; val = C:/Users/fan/CodeDynaAsset//m_az/
pos = 43 ; key = st_profile_name_main ; val = _default
pos = 44 ; key = st_profile_path ; val = C:/Users/fan/CodeDynaAsset//m_az//solve/profile/
pos = 45 ; key = st_profile_prefix ; val = 
pos = 46 ; key = st_profile_suffix ; val = _p9
pos = 47 ; key = st_title_prefix ; val = 
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Scalars in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                                    i     idx    value
                                    __    ___    _____

    bl_display                       1     1        0 
    bl_display_defparam              2     2        0 
    bl_display_dist                  3     3        0 
    bl_display_final                 4     4        0 
    bl_display_final_dist            5     5        1 
    bl_display_final_dist_detail     6     6        0 
    bl_display_funcgrids             7     7        0 
    bl_display_simu_stats            8     8        1 
    bl_graph                         9     9        1 
    bl_graph_coh_t_coh              10    10        0 
    bl_graph_funcgrids              11    11        0 
    bl_graph_onebyones              12    12        1 
    bl_graph_pol_lvl                13    13        0 
    bl_graph_pol_pct                14    14        0 
    bl_graph_val                    15    15        0 
    bl_img_save                     16    16        0 
    bl_mat                          17    17        0 
    bl_mat_test                     18    18        1 
    bl_post                         19    19        1 
    bl_profile                      20    20        0 
    bl_profile_dist                 21    21        0 
    bl_replacefile                  22    22        1 
    bl_time                         23    23        0 
    bl_timer                        24    24        1 
    it_display_every                25    25       20 
    it_display_final_colmax         26    26       12 
    it_display_final_rowmax         27    27      100 
    it_display_summmat_colmax       28    28        5 
    it_display_summmat_rowmax       29    29        5 

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Strings in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                             i     idx
                             __    ___

    st_img_name_main          1    30 
    st_img_path               2    31 
    st_img_prefix             3    32 
    st_img_suffix             4    33 
    st_mat_name_main          5    34 
    st_mat_path               6    35 
    st_mat_prefix             7    36 
    st_mat_suffix             8    37 
    st_mat_test_name_main     9    38 
    st_mat_test_path         10    39 
    st_mat_test_prefix       11    40 
    st_mat_test_suffix       12    41 
    st_matimg_path_root      13    42 
    st_profile_name_main     14    43 
    st_profile_path          15    44 
    st_profile_prefix        16    45 
    st_profile_suffix        17    46 
    st_title_prefix          18    47 

----------------------------------------
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Begin: Show all key and value pairs from container
CONTAINER NAME: PARAM_MAP
----------------------------------------
  Map with properties:

        Count: 27
      KeyType: char
    ValueType: any

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
----------------------------------------
----------------------------------------
pos = 1 ; key = ar_param_keys_idx ;rown= 1 ,coln= 2
ar_param_keys_idx :mu= 1.5 ,sd= 0.70711 ,min= 1 ,max= 2
               zi_1_c1    zi_2_c2
               _______    _______

    zi_1_r1       1          2   

pos = 2 ; key = bl_loglin ; val = false
pos = 3 ; key = cl_st_param_keys ; val = fl_crra
pos = 4 ; key = fl_a_max ; val = 50
pos = 5 ; key = fl_a_min ; val = 0
pos = 6 ; key = fl_b_bd ; val = 0
pos = 7 ; key = fl_beta ; val = 0.94
pos = 8 ; key = fl_crra ; val = 1.5
pos = 9 ; key = fl_loglin_threshold ; val = 1
pos = 10 ; key = fl_nan_replace ; val = -9999
pos = 11 ; key = fl_r_save ; val = 0.025
pos = 12 ; key = fl_tol_dist ; val = 1e-05
pos = 13 ; key = fl_tol_pol ; val = 1e-05
pos = 14 ; key = fl_tol_val ; val = 1e-05
pos = 15 ; key = fl_w ; val = 1.28
pos = 16 ; key = fl_z_mu ; val = 0
pos = 17 ; key = fl_z_rho ; val = 0.8
pos = 18 ; key = fl_z_sig ; val = 0.2
pos = 19 ; key = it_a_n ; val = 750
pos = 20 ; key = it_maxiter_dist ; val = 1000
pos = 21 ; key = it_maxiter_val ; val = 1000
pos = 22 ; key = it_size_type ; val = 2
pos = 23 ; key = it_tol_pol_nochange ; val = 25
pos = 24 ; key = it_trans_power_dist ; val = 1000
pos = 25 ; key = it_z_n ; val = 15
pos = 26 ; key = st_analytical_stationary_type ; val = eigenvector
pos = 27 ; key = st_model ; val = az
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Matrix in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                         i    idx    rowN    colN    mean      std      min    max
                         _    ___    ____    ____    ____    _______    ___    ___

    ar_param_keys_idx    1     1      1       2      1.5     0.70711     1      2 

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Scalars in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                           i     idx    value
                           __    ___    _____

    bl_loglin               1     2         0
    fl_a_max                2     4        50
    fl_a_min                3     5         0
    fl_b_bd                 4     6         0
    fl_beta                 5     7      0.94
    fl_crra                 6     8       1.5
    fl_loglin_threshold     7     9         1
    fl_nan_replace          8    10     -9999
    fl_r_save               9    11     0.025
    fl_tol_dist            10    12     1e-05
    fl_tol_pol             11    13     1e-05
    fl_tol_val             12    14     1e-05
    fl_w                   13    15      1.28
    fl_z_mu                14    16         0
    fl_z_rho               15    17       0.8
    fl_z_sig               16    18       0.2
    it_a_n                 17    19       750
    it_maxiter_dist        18    20      1000
    it_maxiter_val         19    21      1000
    it_size_type           20    22         2
    it_tol_pol_nochange    21    23        25
    it_trans_power_dist    22    24      1000
    it_z_n                 23    25        15

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Strings in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                                     i    idx
                                     _    ___

    cl_st_param_keys                 1     3 
    st_analytical_stationary_type    2    26 
    st_model                         3    27 

----------------------------------------
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Begin: Show all key and value pairs from container
CONTAINER NAME: PARAM_TSTAR_MAP
----------------------------------------
  Map with properties:

        Count: 9
      KeyType: char
    ValueType: any

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
----------------------------------------
----------------------------------------
pos = 1 ; key = fl_a_max ;rown= 1 ,coln= 5
fl_a_max :mu= 65 ,sd= 11.8585 ,min= 50 ,max= 80
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1      50        57.5        65        72.5        80   

pos = 2 ; key = fl_beta ;rown= 1 ,coln= 5
fl_beta :mu= 0.92 ,sd= 0.039528 ,min= 0.87 ,max= 0.97
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1     0.87       0.895      0.92       0.945      0.97  

pos = 3 ; key = fl_crra ;rown= 1 ,coln= 5
fl_crra :mu= 3 ,sd= 1.5811 ,min= 1 ,max= 5
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1       1          2          3          4          5   

pos = 4 ; key = fl_r_save ;rown= 1 ,coln= 5
fl_r_save :mu= 0.025 ,sd= 0.011859 ,min= 0.01 ,max= 0.04
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1     0.01      0.0175      0.025     0.0325      0.04  

pos = 5 ; key = fl_w ;rown= 1 ,coln= 5
fl_w :mu= 1.25 ,sd= 0.11859 ,min= 1.1 ,max= 1.4
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1      1.1       1.175      1.25       1.325       1.4  

pos = 6 ; key = fl_z_rho ;rown= 1 ,coln= 5
fl_z_rho :mu= 0.495 ,sd= 0.39133 ,min= 0 ,max= 0.99
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1       0       0.2475      0.495     0.7425      0.99  

pos = 7 ; key = fl_z_sig ;rown= 1 ,coln= 5
fl_z_sig :mu= 0.255 ,sd= 0.19369 ,min= 0.01 ,max= 0.5
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1     0.01      0.1325      0.255     0.3775       0.5  

pos = 8 ; key = it_a_n ;rown= 1 ,coln= 5
it_a_n :mu= 1300 ,sd= 948.6833 ,min= 100 ,max= 2500
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1      100        700       1300       1900       2500  

pos = 9 ; key = it_z_n ;rown= 1 ,coln= 5
it_z_n :mu= 15 ,sd= 7.9057 ,min= 5 ,max= 25
               zi_1_c1    zi_2_c2    zi_3_c3    zi_4_c4    zi_5_c5
               _______    _______    _______    _______    _______

    zi_1_r1       5         10         15         20         25   

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Matrix in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                 i    idx    rowN    colN    mean       std       min     max 
                 _    ___    ____    ____    _____    ________    ____    ____

    fl_a_max     1     1      1       5         65      11.859      50      80
    fl_beta      2     2      1       5       0.92    0.039528    0.87    0.97
    fl_crra      3     3      1       5          3      1.5811       1       5
    fl_r_save    4     4      1       5      0.025    0.011859    0.01    0.04
    fl_w         5     5      1       5       1.25     0.11859     1.1     1.4
    fl_z_rho     6     6      1       5      0.495     0.39133       0    0.99
    fl_z_sig     7     7      1       5      0.255     0.19369    0.01     0.5
    it_a_n       8     8      1       5       1300      948.68     100    2500
    it_z_n       9     9      1       5         15      7.9057       5      25

</pre><h2 id="13">Generate New or Obtain Existing Mat</h2><p>Mat file folder and mat file name</p><pre class="codeinput"><span class="keyword">if</span> ~exist(st_mat_test_path,<span class="string">'dir'</span>); mkdir(st_mat_test_path); <span class="keyword">end</span>
st_file_name = [st_mat_test_prefix st_mat_test_name_main st_mat_test_suffix <span class="string">'.mat'</span>];
st_file_path_full = [st_mat_test_path, st_file_name];

bl_mat_exists = isfile(st_file_path_full);

<span class="keyword">if</span> ( ~bl_replacefile &amp;&amp; bl_mat_exists )

    st_loaded = load(st_file_path_full, <span class="string">'tb_outcomes'</span>);
    tb_outcomes = st_loaded.tb_outcomes;

<span class="keyword">else</span>
</pre><h2 id="14">Initialize Storage</h2><pre class="codeinput">    disp(<span class="string">'---------------------------'</span>);
    disp(<span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>);
    disp([<span class="string">'Vary These Parameters:'</span> cl_st_param_keys]);
    disp(<span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>);
    disp(<span class="string">'---------------------------'</span>);

    <span class="comment">% cl_tb_outcomes_meansdperc_wthinfo = cell([length(cl_st_param_keys), 1]);</span>
    tb_outcomes = [];
</pre><pre class="codeoutput">---------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxx
    'Vary These Paramet&#8230;'    'fl_crra'    'fl_beta'

xxxxxxxxxxxxxxxxxxxxxxxxxxx
---------------------------
</pre><h2 id="15">Simulate 1: Cross Simulation, fix one point, extend parameters in each direction</h2><p>Given X and Y parameters, simulate along an array of x values fixing y value, then simulate along an array of y values fixing x value. Along the x and y grid, this produces a <i>cross</i> of simulated points. The intersection of the array arrays, the center of the cross could be some benchmark parameter value, or perhaps some estimated/calibrated parameter value point.</p><pre class="codeinput">    <span class="keyword">if</span> (bl_simu_cross)

        <span class="keyword">for</span> it_pcombi_ctr = 1:length(cl_st_param_keys)

            st_param_key = cl_st_param_keys{it_pcombi_ctr};

            <span class="comment">% Display Current Parameter been Varied</span>
            <span class="comment">% Parameter Key for Paraemter Getting Updated</span>
            ar_param_values = param_tstar_map(st_param_key);
            st_param_desc = param_desc_map(st_param_key);
            fl_param_val_benchmark = param_map(st_param_key);

            disp(<span class="string">'---------------------------'</span>);
            disp(<span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>);
            disp([<span class="string">'Vary '</span> st_param_desc <span class="string">' ('</span> st_param_key <span class="string">'): '</span> num2str(ar_param_values)]);
            <span class="keyword">for</span> it_param_all_ctr = 1:length(ls_st_param_key)
                disp([ ls_st_param_key{it_param_all_ctr} <span class="string">':'</span> num2str(param_map(ls_st_param_key{it_param_all_ctr}))]);
            <span class="keyword">end</span>
            disp(<span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>);

            <span class="comment">% Simulate Model over Parameter Array Values</span>
            <span class="keyword">for</span> it_cur_param = 1:1:length(ar_param_values)

                <span class="comment">% Adjust Value for Current Parameter been Varied</span>
                fl_param_val = ar_param_values(it_cur_param);
                param_map(st_param_key) = fl_param_val;
                disp([<span class="string">'xxxxx '</span> st_param_key <span class="string">' = '</span> num2str(fl_param_val) <span class="string">' xxxxx'</span>]);

                <span class="comment">% Simulate Model</span>
                ar_simu_info = [find(strcmp(ls_st_param_key, st_param_key)), <span class="keyword">...</span>
                    it_cur_param, cell2mat(values(param_map, cl_st_param_keys))];
                cl_col_names = [{<span class="string">'it_test_grp'</span>, <span class="string">'it_cur_param'</span>} cl_st_param_keys];
                [tb_outcomes_simu, variablenames] = simu_model_gen_stats(param_map, support_map, ar_simu_info, cl_col_names);
                tb_outcomes_simu.Properties.RowNames = <span class="keyword">...</span>
                    strcat(variablenames, <span class="string">'_p'</span>, num2str(it_pcombi_ctr), <span class="string">'v'</span>, num2str(it_cur_param));
                var_param_key = repmat({st_param_key}, [length(variablenames),1]);
                tb_outcomes_simu = addvars(tb_outcomes_simu, variablenames, var_param_key, <span class="string">'Before'</span>, 1);

                <span class="comment">% Combine Results from Different Parameters in Shared Table</span>
                <span class="keyword">if</span> (it_pcombi_ctr == 1 &amp;&amp; it_cur_param == 1)
                    tb_outcomes = tb_outcomes_simu;
                <span class="keyword">else</span>
                    tb_outcomes = [tb_outcomes; tb_outcomes_simu];
                <span class="keyword">end</span>

            <span class="keyword">end</span>

            <span class="comment">% Reset Base Parameters, parameters already grabbed out, updating</span>
            param_map(st_param_key) = fl_param_val_benchmark;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><pre class="codeoutput">---------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxx
    'Vary '    'CRRA'    ' ('    'fl_crra'    '): '    '1  2  3  4  5'

fl_crra:1.5
fl_beta:0.94
fl_w:1.28
fl_r_save:0.025
fl_z_rho:0.8
fl_z_sig:0.2
fl_a_max:50
it_z_n:15
it_a_n:750
xxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxx fl_crra = 1 xxxxx
</pre><h2 id="16">Simulate 2: Full Grid Simulation, Simulate Along Full Grid</h2><p>To explore the effects of parameters on model outcomes, simulate the model along full grids. Given X and Y parameters, this means simulate at all possible combinations of X and Y arrays.</p><pre class="codeinput">    <span class="keyword">if</span> (~bl_simu_cross)
        <span class="comment">% Get Arrays to be Meshed in Cells</span>
        cl_ar_param_subset_values = values(param_tstar_map, cl_st_param_keys);

        <span class="comment">% Generate all possible combinations of parameters subsets</span>
        cl_mt_all = cl_ar_param_subset_values;
        [cl_mt_all{:}] = ndgrid(cl_ar_param_subset_values{:});
        mt_param_vals_combi = cell2mat(cellfun(@(m) m(:), cl_mt_all, <span class="string">'uni'</span>, 0));

        <span class="comment">% Sizes</span>
        it_test_combi_n = size(mt_param_vals_combi,1);

        <span class="comment">% Convert from Matrix to Table for Clarity</span>
        tb_pvals_combi = array2table(mt_param_vals_combi);
        tb_pvals_combi.Properties.VariableNames = ls_st_param_key(cl_st_param_keys);
        tb_pvals_combi.Properties.RowNames = strcat(<span class="string">'j='</span>, string(1:size(mt_param_vals_combi,1)));
        clear <span class="string">mt_param_vals_combi</span>;

        <span class="comment">% Display</span>
        disp(head(tb_pvals_combi, 10));
        disp(tail(tb_pvals_combi, 10));

        <span class="keyword">for</span> it_pcombi_ctr = 1:it_test_combi_n

            tb_row_param_adj_cur = tb_pvals_combi(it_pcombi_ctr, :);

            disp([<span class="string">'xxxxx Shift to: xxxxx'</span>]);
            disp(tb_row_param_adj_cur)

            <span class="comment">% Display Current Parameter been Varied</span>
            <span class="keyword">for</span> st_param_key = cl_st_param_keys
                param_map(st_param_key{1}) = tb_row_param_adj_cur{1, st_param_key};
            <span class="keyword">end</span>

            <span class="comment">% Simulate Model</span>
            ar_simu_info = [it_pcombi_ctr, cell2mat(values(param_map, cl_st_param_keys))];
            cl_col_names = [{<span class="string">'it_pcombi_ctr'</span>} cl_st_param_keys];
            [tb_outcomes_simu, variablenames] = simu_model_gen_stats(param_map, support_map, ar_simu_info, cl_col_names);
            tb_outcomes_simu.Properties.RowNames = strcat(variablenames, <span class="string">'_v'</span>, num2str(it_pcombi_ctr));
            tb_outcomes_simu = addvars(tb_outcomes_simu, variablenames, <span class="string">'Before'</span>, 1);

            <span class="comment">% Combine Results from Different Parameters in Shared Table</span>
            <span class="keyword">if</span> (it_pcombi_ctr == 1)
                tb_outcomes = tb_outcomes_simu;
            <span class="keyword">else</span>
                tb_outcomes = [tb_outcomes; tb_outcomes_simu];
            <span class="keyword">end</span>

        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">% Table Output</span>
    <span class="keyword">if</span> (bl_display_simu_stats)
        disp(<span class="string">'-------------------------'</span>);
        disp(<span class="string">'xxxxxx tb_outcomes xxxxxx'</span>);
        disp(head(tb_outcomes, 10));
        disp(tail(tb_outcomes, 10));
    <span class="keyword">end</span>
</pre><pre class="codeoutput">-------------------------
xxxxxx tb_outcomes xxxxxx
                        variablenames    var_param_key    it_test_grp    it_cur_param    fl_crra    fl_beta     mean        sd       coefofvar      min       max       pYis0      pYls0     pYgr0     pYisMINY      pYisMAXY       p0_1        p1          p5         p10        p15         p20         p25        p35        p50         p65        p75       p80        p85       p90       p95       p99      p99_9 
                        _____________    _____________    ___________    ____________    _______    _______    _______    _______    _________    _______    ______    ________    _____    _______    _________    ___________    _______    _______    ________    _______    ________    ________    _______    _______    ________    _______    _______    ______    _______    ______    ______    ______    ______

    cl_mt_pol_a_p1v1    'cl_mt_pol_a'      'fl_crra'           1              1             1        0.94      0.39061    0.70074      1.7939           0    48.598     0.39645      0      0.60355      0.39645     2.7479e-36          0          0           0          0           0           0          0          0    0.066756    0.26702    0.46729    0.6008    0.86782    1.2016    1.8692    3.3378    5.3405
    cl_mt_coh_p1v1      'cl_mt_coh'        'fl_crra'           1              1             1        0.94       1.6804     1.0129     0.60276     0.44468    54.536           0      0            1    0.0025817     2.7479e-36    0.44468    0.59175     0.68262    0.78744     0.90837     0.90837     1.0479     1.1821      1.3944      1.677     2.0102    2.2244     2.5398    2.9616    3.7143    5.4955    7.7401
    cl_mt_pol_c_p1v1    'cl_mt_pol_c'      'fl_crra'           1              1             1        0.94       1.2898    0.37696     0.29227     0.44468    5.9377           0      0            1    0.0025817     2.7479e-36    0.44468    0.59175     0.68262    0.78744     0.90837     0.90837     1.0479     1.1163      1.2789     1.4117     1.5468    1.6247     1.6744    1.8084    1.9368    2.2175    2.4964
    cl_mt_pol_a_p1v2    'cl_mt_pol_a'      'fl_crra'           1              2             2        0.94        1.341     1.6059      1.1976           0        50     0.14762      0      0.85238      0.14762    -5.2804e-36          0          0           0          0    0.066756    0.066756    0.13351    0.40053     0.80107     1.4019     1.9359    2.3364     2.8037    3.4713    4.6729    7.2096    10.481
    cl_mt_coh_p1v2      'cl_mt_coh'        'fl_crra'           1              2             2        0.94       2.6545     1.8815     0.70878     0.44468    54.536           0      0            1    0.0018409     1.5116e-35    0.44468    0.59175     0.78744    0.90837      1.0479      1.1821     1.2772     1.5953      2.0971     2.8038     3.4471    3.8665     4.4139    5.1666    6.4512    9.2454    12.746
    cl_mt_pol_c_p1v2    'cl_mt_pol_c'      'fl_crra'           1              2             2        0.94       1.3135     0.3224     0.24545     0.44468    4.5358           0      0            1    0.0018409     1.5116e-35    0.44468    0.59175     0.78744    0.90837     0.97846      1.0479     1.1182     1.2031      1.3039     1.4283     1.5229    1.5935     1.6353    1.7216    1.8334    2.0753    2.3262
    cl_mt_pol_a_p1v3    'cl_mt_pol_a'      'fl_crra'           1              3             3        0.94       2.4357     2.3673      0.9719           0        50    0.049666      0      0.95033     0.049666     1.5116e-19          0          0    0.066756    0.13351     0.33378     0.46729    0.66756     1.0681      1.7356     2.6702     3.4713    4.0721     4.7397    5.6742    7.2096    10.481    14.753
    cl_mt_coh_p1v3      'cl_mt_coh'        'fl_crra'           1              3             3        0.94       3.7766     2.6281     0.69588     0.44468    54.536           0      0            1    0.0010806      3.075e-20    0.44468    0.66017     0.90837     1.1163      1.3669      1.5953     1.8138     2.2839      3.1006      4.127     5.0209    5.6297     6.3298    7.3473    8.9984    12.488    16.946
    cl_mt_pol_c_p1v3    'cl_mt_pol_c'      'fl_crra'           1              3             3        0.94       1.3409    0.29467     0.21975     0.44468    4.5358           0      0            1    0.0010806      3.075e-20    0.44468    0.65149     0.85587    0.97801      1.0512      1.1246     1.1437     1.2271      1.3515     1.4562     1.5451     1.583     1.6486    1.7087    1.8172    2.0387    2.2793
    cl_mt_pol_a_p1v4    'cl_mt_pol_a'      'fl_crra'           1              4             4        0.94       3.6456     3.0477       0.836           0        50    0.017458      0      0.98254     0.017458     1.4012e-13          0          0     0.20027    0.46729     0.80107      1.0681     1.3351     1.9359      2.8705     4.0721     5.1402    5.8077     6.6756    7.8104    9.6796    13.551    18.625

                        variablenames    var_param_key    it_test_grp    it_cur_param    fl_crra    fl_beta     mean        sd       coefofvar      min       max       pYis0      pYls0     pYgr0      pYisMINY      pYisMAXY       p0_1        p1         p5         p10        p15        p20         p25         p35        p50         p65        p75        p80        p85       p90       p95       p99      p99_9 
                        _____________    _____________    ___________    ____________    _______    _______    _______    _______    _________    _______    ______    ________    _____    _______    __________    ___________    _______    _______    _______    _______    _______    ________    ________    _______    ________    _______    _______    _______    _______    ______    ______    ______    ______

    cl_mt_pol_c_p2v2    'cl_mt_pol_c'      'fl_beta'           2              2            1.5       0.895      1.2846    0.40112     0.31226     0.44468    7.2728           0      0            1       0.00268    -3.1624e-38    0.44468    0.59175    0.68262    0.78744    0.90837     0.90837     0.97679     1.0479      1.2088     1.3961     1.5418     1.6135     1.7237    1.8005    1.9557    2.3294     2.665
    cl_mt_pol_a_p2v3    'cl_mt_pol_a'      'fl_beta'           2              3            1.5        0.92     0.40859     0.7045      1.7242           0    48.531     0.38605      0      0.61395       0.38605    -2.4207e-34          0          0          0          0          0           0           0          0    0.066756    0.26702    0.53405    0.66756    0.93458    1.2684    1.8692    3.3378    5.2737
    cl_mt_coh_p2v3      'cl_mt_coh'        'fl_beta'           2              3            1.5        0.92      1.6988     1.0188     0.59973     0.44468    54.536           0      0            1     0.0025648    -2.4207e-34    0.44468    0.59175    0.68262    0.78744    0.90837     0.90837      1.0479     1.1847      1.3944      1.709     2.0608     2.2773     2.5665    2.9878    3.7405    5.5087    7.6983
    cl_mt_pol_c_p2v3    'cl_mt_pol_c'      'fl_beta'           2              3            1.5        0.92      1.2902    0.37555     0.29107     0.44468    6.0044           0      0            1     0.0025648    -2.4207e-34    0.44468    0.59175    0.68262    0.78744    0.90837     0.90837      1.0479     1.1163      1.2789       1.42     1.5485     1.6252     1.6694    1.7938    1.9402    2.2209    2.4979
    cl_mt_pol_a_p2v4    'cl_mt_pol_a'      'fl_beta'           2              4            1.5       0.945      1.0308     1.3631      1.3224           0    49.866     0.18721      0      0.81279       0.18721    -4.3701e-35          0          0          0          0          0    0.066756    0.066756    0.20027     0.53405     1.0013     1.4686     1.8024     2.2029    2.8037    3.8718    6.2083    9.1455
    cl_mt_coh_p2v4      'cl_mt_coh'        'fl_beta'           2              4            1.5       0.945      2.3366     1.6448     0.70394     0.44468    54.536           0      0            1     0.0021034    -4.3701e-35    0.44468    0.59175    0.78744    0.90837    0.97679      1.0479      1.1847     1.3944      1.8246     2.4208      2.977     3.3609     3.8399    4.5241    5.6873    8.2303    11.446
    cl_mt_pol_c_p2v4    'cl_mt_pol_c'      'fl_beta'           2              4            1.5       0.945      1.3058    0.33496     0.25653     0.44468    4.6693           0      0            1     0.0021034    -4.3701e-35    0.44468    0.59175    0.75104    0.85754    0.92596      1.0479      1.0495     1.1964      1.3293     1.4211     1.5301     1.5863     1.6619     1.717    1.8617    2.0854    2.3457
    cl_mt_pol_a_p2v5    'cl_mt_pol_a'      'fl_beta'           2              5            1.5        0.97      5.4081     4.7673     0.88152           0        50    0.025303      0       0.9747      0.025303     1.2197e-07          0          0    0.13351    0.53405    0.93458      1.3351      1.8024     2.6702      4.2056     6.0748     7.8104     8.8785     10.147    11.949     14.82    20.961    28.772
    cl_mt_coh_p2v5      'cl_mt_coh'        'fl_beta'           2              5            1.5        0.97      6.8233     5.0167     0.73523     0.44468    54.536           0      0            1    0.00057637     6.7203e-09    0.51297    0.68262     1.1296     1.5997     2.0742      2.5506      3.0295      3.988      5.6323      7.614      9.393     10.488     11.815    13.693    16.673    23.012      31.1
    cl_mt_pol_c_p2v5    'cl_mt_pol_c'      'fl_beta'           2              5            1.5        0.97      1.4152    0.27424     0.19378     0.44468    4.5358           0      0            1    0.00057637     6.7203e-09    0.51297    0.68262      0.968     1.0619     1.1463      1.2041      1.2422     1.3216      1.4183     1.5159     1.5952     1.6331     1.6877    1.7595    1.8589    2.0683    2.3223

</pre><h2 id="17">Save Mat</h2><pre class="codeinput">    <span class="keyword">if</span> (bl_mat_test)
        clear <span class="string">armt_map</span> <span class="string">result_map</span>
        <span class="keyword">if</span> ~exist(st_mat_test_path,<span class="string">'dir'</span>); mkdir(st_mat_test_path); <span class="keyword">end</span>
        st_file_name = [st_mat_test_prefix st_mat_test_name_main st_mat_test_suffix];
        save(strcat(st_mat_test_path, st_file_name));
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2 id="20">Simulate Model given Parameter and Process Results</h2><pre class="codeinput"><span class="keyword">function</span> [tb_outcomes_simu, variablenames] = simu_model_gen_stats(param_map, support_map, ar_simu_info, cl_col_names)
</pre><pre class="codeinput">cl_st_param_keys = param_map(<span class="string">'cl_st_param_keys'</span>);
</pre><h2 id="22">Reset Parameters that are determined by other parameters</h2><pre class="codeinput">it_a_n = param_map(<span class="string">'it_a_n'</span>);
it_z_n = param_map(<span class="string">'it_z_n'</span>);
disp([<span class="string">'xxxxx it_a_n = '</span> num2str(it_a_n) <span class="string">', it_z_n = '</span> num2str(it_z_n) <span class="string">' xxxxx'</span>]);
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><pre class="codeoutput">xxxxx it_a_n = 750, it_z_n = 15 xxxxx
</pre><h2 id="23">Simulate Model</h2><pre class="codeinput">[armt_map, func_map] = ffs_az_get_funcgrid(param_map, support_map);
result_map = ff_az_vf_vecsv(param_map, support_map, armt_map, func_map);
result_map = ff_az_ds_vecsv(param_map, support_map, armt_map, func_map, result_map);
</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean        sd       coefofvar      min       max       pYis0     pYls0     pYgr0     pYisMINY      pYisMAXY      p0_1        p1         p5         p10        p15        p20       p25       p35        p50         p65        p75       p80        p85       p90       p95       p99      p99_9 
                   _______    _______    _________    _______    ______    _______    _____    _______    _________    __________    _______    _______    _______    _______    _______    _______    ______    ______    ________    _______    _______    ______    _______    ______    ______    ______    ______

    cl_mt_pol_a    0.39061    0.70074      1.7939           0    48.598    0.39645      0      0.60355      0.39645    2.7479e-36          0          0          0          0          0          0         0         0    0.066756    0.26702    0.46729    0.6008    0.86782    1.2016    1.8692    3.3378    5.3405
    cl_mt_coh       1.6804     1.0129     0.60276     0.44468    54.536          0      0            1    0.0025817    2.7479e-36    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    1.0479    1.1821      1.3944      1.677     2.0102    2.2244     2.5398    2.9616    3.7143    5.4955    7.7401
    cl_mt_pol_c     1.2898    0.37696     0.29227     0.44468    5.9377          0      0            1    0.0025817    2.7479e-36    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    1.0479    1.1163      1.2789     1.4117     1.5468    1.6247     1.6744    1.8084    1.9368    2.2175    2.4964

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean       sd      coefofvar      min       max       pYis0     pYls0     pYgr0     pYisMINY      pYisMAXY       p0_1        p1         p5         p10        p15         p20         p25        p35        p50       p65       p75       p80       p85       p90       p95       p99      p99_9 
                   ______    ______    _________    _______    ______    _______    _____    _______    _________    ___________    _______    _______    _______    _______    ________    ________    _______    _______    _______    ______    ______    ______    ______    ______    ______    ______    ______

    cl_mt_pol_a     1.341    1.6059      1.1976           0        50    0.14762      0      0.85238      0.14762    -5.2804e-36          0          0          0          0    0.066756    0.066756    0.13351    0.40053    0.80107    1.4019    1.9359    2.3364    2.8037    3.4713    4.6729    7.2096    10.481
    cl_mt_coh      2.6545    1.8815     0.70878     0.44468    54.536          0      0            1    0.0018409     1.5116e-35    0.44468    0.59175    0.78744    0.90837      1.0479      1.1821     1.2772     1.5953     2.0971    2.8038    3.4471    3.8665    4.4139    5.1666    6.4512    9.2454    12.746
    cl_mt_pol_c    1.3135    0.3224     0.24545     0.44468    4.5358          0      0            1    0.0018409     1.5116e-35    0.44468    0.59175    0.78744    0.90837     0.97846      1.0479     1.1182     1.2031     1.3039    1.4283    1.5229    1.5935    1.6353    1.7216    1.8334    2.0753    2.3262

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean       sd       coefofvar      min       max       pYis0      pYls0     pYgr0     pYisMINY      pYisMAXY      p0_1        p1          p5         p10        p15        p20        p25       p35       p50       p65       p75       p80       p85       p90       p95       p99      p99_9 
                   ______    _______    _________    _______    ______    ________    _____    _______    _________    __________    _______    _______    ________    _______    _______    _______    _______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______

    cl_mt_pol_a    2.4357     2.3673      0.9719           0        50    0.049666      0      0.95033     0.049666    1.5116e-19          0          0    0.066756    0.13351    0.33378    0.46729    0.66756    1.0681    1.7356    2.6702    3.4713    4.0721    4.7397    5.6742    7.2096    10.481    14.753
    cl_mt_coh      3.7766     2.6281     0.69588     0.44468    54.536           0      0            1    0.0010806     3.075e-20    0.44468    0.66017     0.90837     1.1163     1.3669     1.5953     1.8138    2.2839    3.1006     4.127    5.0209    5.6297    6.3298    7.3473    8.9984    12.488    16.946
    cl_mt_pol_c    1.3409    0.29467     0.21975     0.44468    4.5358           0      0            1    0.0010806     3.075e-20    0.44468    0.65149     0.85587    0.97801     1.0512     1.1246     1.1437    1.2271    1.3515    1.4562    1.5451     1.583    1.6486    1.7087    1.8172    2.0387    2.2793

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean       sd      coefofvar      min       max       pYis0      pYls0     pYgr0     pYisMINY      pYisMAXY      p0_1        p1         p5         p10        p15       p20       p25       p35       p50       p65       p75       p80       p85       p90       p95       p99      p99_9 
                   ______    ______    _________    _______    ______    ________    _____    _______    _________    __________    _______    _______    _______    _______    _______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______

    cl_mt_pol_a    3.6456    3.0477       0.836           0        50    0.017458      0      0.98254     0.017458    1.4012e-13          0          0    0.20027    0.46729    0.80107    1.0681    1.3351    1.9359    2.8705    4.0721    5.1402    5.8077    6.6756    7.8104    9.6796    13.551    18.625
    cl_mt_coh      5.0168    3.3019     0.65817     0.44468    54.536           0      0            1    0.0005419     1.875e-14    0.51297    0.75104     1.1616     1.5268     1.8822    2.2155    2.5532    3.1931    4.2682    5.5683    6.6827    7.4158    8.3141    9.5169    11.462    15.602    20.827
    cl_mt_pol_c    1.3711    0.2794     0.20377     0.44468    4.5358           0      0            1    0.0005419     1.875e-14    0.51297    0.68262    0.91004     1.0111     1.0736     1.148    1.1763    1.2555    1.3732      1.48    1.5497    1.6064    1.6519     1.732    1.8334    2.0408    2.2622

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean       sd       coefofvar      min       max       pYis0      pYls0     pYgr0      pYisMINY      pYisMAXY      p0_1        p1         p5        p10       p15       p20       p25       p35       p50       p65       p75       p80       p85       p90       p95       p99      p99_9 
                   ______    _______    _________    _______    ______    ________    _____    _______    __________    __________    ______    ________    _______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______

    cl_mt_pol_a    4.9436       3.69     0.74641           0        50    0.005859      0      0.99414      0.005859    8.8021e-11         0    0.066756    0.53405    1.0013    1.4019    1.8024    2.1362    2.9372    4.1389    5.6075    6.8758    7.6769    8.6782    9.9466     12.15    16.622    22.363
    cl_mt_coh      6.3472     3.9417       0.621     0.44468    54.536           0      0            1    0.00025955    8.1479e-12    0.5814     0.88789     1.5268    2.0742    2.5506    2.9682    3.3876    4.2195    5.5612    7.0825    8.4421    9.2715    10.338     11.72    13.967    18.681    24.599
    cl_mt_pol_c    1.4036    0.27131     0.19329     0.44468    4.5358           0      0            1    0.00025955    8.1479e-12    0.5814     0.78744    0.96858    1.0696    1.1441    1.1704    1.2297    1.2998    1.3957    1.4958    1.5796     1.622    1.6866     1.745    1.8571     2.052     2.289

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                     mean        sd       coefofvar      min       max       pYis0     pYls0     pYgr0     pYisMINY      pYisMAXY      p0_1        p1         p5         p10        p15        p20        p25       p35       p50       p65        p75         p80         p85        p90        p95       p99      p99_9 
                   ________    _______    _________    _______    ______    _______    _____    _______    _________    __________    _______    _______    _______    _______    _______    _______    _______    ______    ______    ______    ________    ________    _______    _______    _______    ______    ______

    cl_mt_pol_a    0.083735    0.23518      2.8087           0    45.995    0.74808      0      0.25192      0.74808    3.4466e-36          0          0          0          0          0          0          0         0         0         0    0.066756    0.066756    0.13351    0.26702    0.46729    1.2016    2.2029
    cl_mt_coh        1.3658     0.6001     0.43937     0.44468    54.536          0      0            1    0.0027041    3.4466e-36    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    0.90837    1.0479    1.2088    1.3944      1.6085       1.677     1.8555     2.1292     2.5376     3.564    4.8641
    cl_mt_pol_c      1.2821    0.41818     0.32617     0.44468    8.5411          0      0            1    0.0027041    3.4466e-36    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    0.90837    1.0479    1.2088    1.3944      1.6085      1.6102     1.7888     1.8606     2.0124    2.3992    2.7801

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean       sd       coefofvar      min       max       pYis0     pYls0     pYgr0     pYisMINY     pYisMAXY       p0_1        p1         p5         p10        p15        p20        p25       p35       p50        p65         p75        p80        p85       p90        p95       p99      p99_9 
                   ______    _______    _________    _______    ______    _______    _____    _______    ________    ___________    _______    _______    _______    _______    _______    _______    _______    ______    ______    ________    _______    _______    _______    ______    _______    ______    ______

    cl_mt_pol_a    0.1837    0.40215      2.1892           0    47.263    0.58423      0      0.41577    0.58423     -3.1624e-38          0          0          0          0          0          0          0         0         0    0.066756    0.20027    0.26702    0.40053    0.6008    0.93458    2.0027    3.3378
    cl_mt_coh      1.4683    0.74402     0.50673     0.44468    54.536          0      0            1    0.00268     -3.1624e-38    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    0.97679    1.0479    1.2088      1.4825     1.7365     1.8822     2.0875    2.4029     2.9482    4.2617    5.8926
    cl_mt_pol_c    1.2846    0.40112     0.31226     0.44468    7.2728          0      0            1    0.00268     -3.1624e-38    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    0.97679    1.0479    1.2088      1.3961     1.5418     1.6135     1.7237    1.8005     1.9557    2.3294     2.665

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean        sd       coefofvar      min       max       pYis0     pYls0     pYgr0     pYisMINY      pYisMAXY       p0_1        p1         p5         p10        p15        p20       p25       p35        p50         p65        p75        p80        p85       p90       p95       p99      p99_9 
                   _______    _______    _________    _______    ______    _______    _____    _______    _________    ___________    _______    _______    _______    _______    _______    _______    ______    ______    ________    _______    _______    _______    _______    ______    ______    ______    ______

    cl_mt_pol_a    0.40859     0.7045      1.7242           0    48.531    0.38605      0      0.61395      0.38605    -2.4207e-34          0          0          0          0          0          0         0         0    0.066756    0.26702    0.53405    0.66756    0.93458    1.2684    1.8692    3.3378    5.2737
    cl_mt_coh       1.6988     1.0188     0.59973     0.44468    54.536          0      0            1    0.0025648    -2.4207e-34    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    1.0479    1.1847      1.3944      1.709     2.0608     2.2773     2.5665    2.9878    3.7405    5.5087    7.6983
    cl_mt_pol_c     1.2902    0.37555     0.29107     0.44468    6.0044          0      0            1    0.0025648    -2.4207e-34    0.44468    0.59175    0.68262    0.78744    0.90837    0.90837    1.0479    1.1163      1.2789       1.42     1.5485     1.6252     1.6694    1.7938    1.9402    2.2209    2.4979

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean       sd       coefofvar      min       max       pYis0     pYls0     pYgr0     pYisMINY      pYisMAXY       p0_1        p1         p5         p10        p15        p20         p25         p35        p50       p65       p75       p80       p85       p90       p95       p99      p99_9 
                   ______    _______    _________    _______    ______    _______    _____    _______    _________    ___________    _______    _______    _______    _______    _______    ________    ________    _______    _______    ______    ______    ______    ______    ______    ______    ______    ______

    cl_mt_pol_a    1.0308     1.3631      1.3224           0    49.866    0.18721      0      0.81279      0.18721    -4.3701e-35          0          0          0          0          0    0.066756    0.066756    0.20027    0.53405    1.0013    1.4686    1.8024    2.2029    2.8037    3.8718    6.2083    9.1455
    cl_mt_coh      2.3366     1.6448     0.70394     0.44468    54.536          0      0            1    0.0021034    -4.3701e-35    0.44468    0.59175    0.78744    0.90837    0.97679      1.0479      1.1847     1.3944     1.8246    2.4208     2.977    3.3609    3.8399    4.5241    5.6873    8.2303    11.446
    cl_mt_pol_c    1.3058    0.33496     0.25653     0.44468    4.6693          0      0            1    0.0021034    -4.3701e-35    0.44468    0.59175    0.75104    0.85754    0.92596      1.0479      1.0495     1.1964     1.3293    1.4211    1.5301    1.5863    1.6619     1.717    1.8617    2.0854    2.3457

</pre><pre class="codeoutput">xxx All Variables PERCENTILES AND STATS xxx
tb_outcomes_meansdperc: mean, sd, percentiles
                    mean       sd       coefofvar      min       max       pYis0      pYls0    pYgr0      pYisMINY      pYisMAXY      p0_1        p1         p5         p10        p15       p20       p25       p35       p50       p65       p75       p80       p85       p90       p95       p99      p99_9 
                   ______    _______    _________    _______    ______    ________    _____    ______    __________    __________    _______    _______    _______    _______    _______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______    ______

    cl_mt_pol_a    5.4081     4.7673     0.88152           0        50    0.025303      0      0.9747      0.025303    1.2197e-07          0          0    0.13351    0.53405    0.93458    1.3351    1.8024    2.6702    4.2056    6.0748    7.8104    8.8785    10.147    11.949     14.82    20.961    28.772
    cl_mt_coh      6.8233     5.0167     0.73523     0.44468    54.536           0      0           1    0.00057637    6.7203e-09    0.51297    0.68262     1.1296     1.5997     2.0742    2.5506    3.0295     3.988    5.6323     7.614     9.393    10.488    11.815    13.693    16.673    23.012      31.1
    cl_mt_pol_c    1.4152    0.27424     0.19378     0.44468    4.5358           0      0           1    0.00057637    6.7203e-09    0.51297    0.68262      0.968     1.0619     1.1463    1.2041    1.2422    1.3216    1.4183    1.5159    1.5952    1.6331    1.6877    1.7595    1.8589    2.0683    2.3223

</pre><h2 id="24">Store Results to Table</h2><pre class="codeinput"><span class="comment">% Append Simulation Loop Statistics</span>
tb_outcomes_meansdperc = result_map(<span class="string">'tb_outcomes_meansdperc'</span>);
tb_simu_info = array2table(ar_simu_info + zeros([size(tb_outcomes_meansdperc,1), length(ar_simu_info)]));
tb_simu_info.Properties.VariableNames = cl_col_names;
variablenames = tb_outcomes_meansdperc.Properties.RowNames;
tb_simu_info.Properties.RowNames = (variablenames);

<span class="comment">% Table</span>
tb_outcomes_simu = [tb_simu_info tb_outcomes_meansdperc];
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><pre class="codeoutput">xxxxx fl_crra = 2 xxxxx
xxxxx fl_crra = 3 xxxxx
xxxxx fl_crra = 4 xxxxx
xxxxx fl_crra = 5 xxxxx
---------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxx
  Columns 1 through 5

    'Vary '    'Discount'    ' ('    'fl_beta'    '): '

  Column 6

    '0.87       0.895 &#8230;'

fl_crra:1.5
fl_beta:0.94
fl_w:1.28
fl_r_save:0.025
fl_z_rho:0.8
fl_z_sig:0.2
fl_a_max:50
it_z_n:15
it_a_n:750
xxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxx fl_beta = 0.87 xxxxx
xxxxx fl_beta = 0.895 xxxxx
xxxxx fl_beta = 0.92 xxxxx
xxxxx fl_beta = 0.945 xxxxx
xxxxx fl_beta = 0.97 xxxxx
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Simulate Savings Model Along Various Parameter Arrays
% *back to <https://fanwangecon.github.io Fan>'s
% <https://fanwangecon.github.io/CodeDynaAsset/ Dynamic Assets Repository>
% Table of Content.*
  
%%
function [tb_outcomes, support_map, param_desc_map] = ff_az_test_gen(varargin)
%% FF_AZ_TEST_GEN post solution simulation
% Simulate the model along various dimensions
%
% @param bl_simu_cross boolean cross vs gridd simulation. cross: with
% (x,y), vary X fixing y, vary Y fixing x. grid: all (x,y) \in (X,Y)
%
% @param it_size_type integer: 
%  param_map support_map param_tstar_map param_desc_map
% # it_size_type = 1 is quick grid
% # it_size_type = 2 is standard grid
% # it_size_type = 3 is denser grid
%
% @param cl_st_param_keys cell string cell array container parameters that
% we are simulating over
%
% @param param_map container parameter container
%
% @param support_map container support container
%
% @param param_tstar_map container map of arrays with keys that are
% parameter keys. This could be specified outside with array values to
% override defaults here. 
%
% @param param_desc_map container map of strings for each parameter key.
%
% @param tb_outcomes table table of simulation outcomes for various
% statistics for each set of parameters. Columns are statistics, rows are
% outcome variables, groups of rows are different simulations.
%
% @include
%
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html ff_az_vf_vecsv>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vecsv.html ff_az_ds_vecsv>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html ffs_az_set_default_param>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_get_funcgrid.html ffs_az_get_funcgrid>
%
% @seealso
%
% * _SPEED_ savings only overall benchmark speed testing: <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_speed/html/fsi_az_ds_vecsv_speed.html fsi_az_ds_vecsv_speed>
% * _PREFERENCE_ savings only preference testing: <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_pref/html/fsi_az_ds_vecsv_pref.html fsi_az_ds_vecsv_pref>
% * _PREFERENCE_ savings only preference testing cross:
% <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_pref/html/fsi_az_ds_vecsv_pref_cross.html fsi_az_ds_vecsv_pref_cross>
% * _SHOCK_ savings only shock testing: <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_shock/html/fsi_az_ds_vecsv_shock.html fsi_az_ds_vecsv_shock>
% * _SHOCK_ savings only shock testing cross:
% <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_shock/html/fsi_az_ds_vecsv_shock_cross.html fsi_az_ds_vecsv_shock_cross>
% * _PRICE_ savings only wage and interest rate testing cross: adjust wage and savings rate
% <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_price/html/fsi_az_ds_vecsv_price_cross.html fsi_az_ds_vecsv_price_cross>
%

%% Default Parameter Loops

% Loops to Vary for Simulations Below
it_size_type = 2;
cl_st_param_keys = {'fl_crra', 'fl_beta'};
bl_simu_cross = true; % if false, simu full grid

%% Default Parameters

% Base parameters call
it_param_set = 9;
[param_map, support_map] = ffs_az_set_default_param(it_param_set);

% Timer
support_map('bl_timer') = true;

% Mat Storage
support_map('bl_mat_test') = true;
st_matimg_path_root = support_map('st_matimg_path_root');
% test_borinf for default: cl_st_param_keys = [3, 8, 9]
support_map('st_mat_test_path') = [st_matimg_path_root '/test/ff_az_ds_vecsv/mat/'];

% Generate or Load
% if bl_replacefile is true, that means even if file already exists,
% generaet new. bl_replacefile is false, then if false does not exist
% generate, if file exists does not generate.
support_map('bl_replacefile') = true;
support_map('bl_display_simu_stats') = true;

%% Array Parameters

ls_st_param_key = {'fl_crra', 'fl_beta', ...
                    'fl_w', 'fl_r_save', ...
                    'fl_z_rho', 'fl_z_sig', ...
                    'fl_a_max', 'it_z_n', 'it_a_n'};

param_tstar_map = containers.Map('KeyType','char', 'ValueType','any');
it_simu_vec_len = 5;
param_tstar_map(ls_st_param_key{1}) = linspace(1, 5, it_simu_vec_len);
param_tstar_map(ls_st_param_key{2}) = linspace(0.87, 0.97, it_simu_vec_len);
param_tstar_map(ls_st_param_key{3}) = linspace(1.1, 1.4, it_simu_vec_len);
param_tstar_map(ls_st_param_key{4}) = linspace(0.01, 0.04, it_simu_vec_len);
param_tstar_map(ls_st_param_key{5}) = linspace(0, 0.99, it_simu_vec_len);
param_tstar_map(ls_st_param_key{6}) = linspace(0.01, 0.5, it_simu_vec_len);
param_tstar_map(ls_st_param_key{7}) = linspace(50, 80, it_simu_vec_len);
param_tstar_map(ls_st_param_key{8}) = unique(round(linspace(5, 25, it_simu_vec_len)));
param_tstar_map(ls_st_param_key{9}) = unique(round(linspace(100, 2500, it_simu_vec_len)));

param_desc_map = containers.Map('KeyType','char', 'ValueType','any');
param_desc_map(ls_st_param_key{1}) = {'CRRA'};
param_desc_map(ls_st_param_key{2}) = {'Discount'};
param_desc_map(ls_st_param_key{3}) = {'Wage'};
param_desc_map(ls_st_param_key{4}) = {'Save Interest'};
param_desc_map(ls_st_param_key{5}) = {'Shock Persistence'};
param_desc_map(ls_st_param_key{6}) = {'Shock SD'};
param_desc_map(ls_st_param_key{7}) = {'Max Asset Bound'};
param_desc_map(ls_st_param_key{8}) = {'Shock Grid N'};
param_desc_map(ls_st_param_key{9}) = {'Asset Grid N'};

%% Default

default_params = {bl_simu_cross it_size_type cl_st_param_keys ...
                    param_map support_map param_tstar_map param_desc_map};

%% Parse Inputs
% override default set above if any parameters are updated

params_len = length(varargin);
[default_params{1:params_len}] = varargin{:};

bl_simu_cross = default_params{1};
it_size_type = default_params{2};
cl_st_param_keys = default_params{3};

param_map = [param_map; default_params{4}];
support_map = [support_map; default_params{5}];
param_tstar_map = [param_tstar_map; default_params{6}];
param_desc_map = [param_desc_map; default_params{7}];

% Generate additional Elements of param_map for container map display
param_map('it_size_type') = it_size_type;
param_map('cl_st_param_keys') = cl_st_param_keys;
ar_param_keys_idx = cell2mat(cellfun(@(m) find(strcmp(ls_st_param_key, m)), ...
    cl_st_param_keys, 'UniformOutput', false));
param_map('ar_param_keys_idx') = ar_param_keys_idx;

%% Parse Generate or Get Current
% if bl_gen = true, generate, if bl_gen = false, get saved file and output.
% If bl_replacefile is true, that means the existing file must be replaced,
% which will set bl_gen to true

params_group = values(support_map, ...
    {'bl_replacefile', 'bl_display_simu_stats'});
[bl_replacefile, bl_display_simu_stats] = params_group{:};

%% Store Mat Strings
%
% # _it_total_length_: this is the total length of all selected arrays
% # _ar_param_keys_idx_: these are the linear index of the selected keys
% among all possible keys
%

it_total_length = sum(cell2mat(cellfun(@(m) length(param_tstar_map(m)), ...
                                cl_st_param_keys, 'UniformOutput', false)));

support_map('st_mat_test_prefix') = [''];
support_map('st_mat_test_name_main') = ['r'];
support_map('st_mat_test_suffix') = ['_g' strrep(num2str(ar_param_keys_idx), '  ', '') ...
                                     '_c' num2str(bl_simu_cross) 't' num2str(it_size_type) ...
                                     'l' num2str(it_total_length)];

%% Set Solve Sizes

if (it_size_type == 1)
    
    % Basic Test Run
    param_map('it_z_n') = 11;
    param_map('it_a_n') = 100;
        
elseif (it_size_type == 2)
    
    % Full Run
    
elseif (it_size_type == 3)
    
    % Denser Run
    param_map('it_z_n') = 27;
    param_map('it_a_n') = 2250;
    
end

%% Parase Preference and Shock Parameters

% support map
params_group = values(support_map, {'bl_mat_test', 'st_mat_test_path', 'st_mat_test_prefix', 'st_mat_test_name_main', 'st_mat_test_suffix'});
[bl_mat_test, st_mat_test_path, st_mat_test_prefix, st_mat_test_name_main, st_mat_test_suffix] = params_group{:};

%% Display support_map

fft_container_map_display(support_map);
fft_container_map_display(param_map);
fft_container_map_display(param_tstar_map);

%% Generate New or Obtain Existing Mat
% Mat file folder and mat file name

if ~exist(st_mat_test_path,'dir'); mkdir(st_mat_test_path); end
st_file_name = [st_mat_test_prefix st_mat_test_name_main st_mat_test_suffix '.mat'];
st_file_path_full = [st_mat_test_path, st_file_name];

bl_mat_exists = isfile(st_file_path_full);

if ( ~bl_replacefile && bl_mat_exists )
    
    st_loaded = load(st_file_path_full, 'tb_outcomes');
    tb_outcomes = st_loaded.tb_outcomes; 
    
else
    %% Initialize Storage
    
    disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
    disp('xxxxxxxxxxxxxxxxxxxxxxxxxxx');
    disp(['Vary These Parameters:' cl_st_param_keys]);
    disp('xxxxxxxxxxxxxxxxxxxxxxxxxxx');
    disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
    
    % cl_tb_outcomes_meansdperc_wthinfo = cell([length(cl_st_param_keys), 1]);
    tb_outcomes = [];
    
    %% Simulate 1: Cross Simulation, fix one point, extend parameters in each direction
    % Given X and Y parameters, simulate along an array of x values fixing y
    % value, then simulate along an array of y values fixing x value. Along the
    % x and y grid, this produces a _cross_ of simulated points. The
    % intersection of the array arrays, the center of the cross could be some
    % benchmark parameter value, or perhaps some estimated/calibrated parameter
    % value point.
    %
    
    if (bl_simu_cross)
        
        for it_pcombi_ctr = 1:length(cl_st_param_keys)
            
            st_param_key = cl_st_param_keys{it_pcombi_ctr};
            
            % Display Current Parameter been Varied
            % Parameter Key for Paraemter Getting Updated
            ar_param_values = param_tstar_map(st_param_key);
            st_param_desc = param_desc_map(st_param_key);
            fl_param_val_benchmark = param_map(st_param_key);
            
            disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
            disp('xxxxxxxxxxxxxxxxxxxxxxxxxxx');
            disp(['Vary ' st_param_desc ' (' st_param_key '): ' num2str(ar_param_values)]);
            for it_param_all_ctr = 1:length(ls_st_param_key)
                disp([ ls_st_param_key{it_param_all_ctr} ':' num2str(param_map(ls_st_param_key{it_param_all_ctr}))]);
            end
            disp('xxxxxxxxxxxxxxxxxxxxxxxxxxx');
            
            % Simulate Model over Parameter Array Values
            for it_cur_param = 1:1:length(ar_param_values)
                
                % Adjust Value for Current Parameter been Varied
                fl_param_val = ar_param_values(it_cur_param);
                param_map(st_param_key) = fl_param_val;
                disp(['xxxxx ' st_param_key ' = ' num2str(fl_param_val) ' xxxxx']);
                
                % Simulate Model
                ar_simu_info = [find(strcmp(ls_st_param_key, st_param_key)), ...
                    it_cur_param, cell2mat(values(param_map, cl_st_param_keys))];
                cl_col_names = [{'it_test_grp', 'it_cur_param'} cl_st_param_keys];
                [tb_outcomes_simu, variablenames] = simu_model_gen_stats(param_map, support_map, ar_simu_info, cl_col_names);
                tb_outcomes_simu.Properties.RowNames = ...
                    strcat(variablenames, '_p', num2str(it_pcombi_ctr), 'v', num2str(it_cur_param));
                var_param_key = repmat({st_param_key}, [length(variablenames),1]);
                tb_outcomes_simu = addvars(tb_outcomes_simu, variablenames, var_param_key, 'Before', 1);
                
                % Combine Results from Different Parameters in Shared Table
                if (it_pcombi_ctr == 1 && it_cur_param == 1)
                    tb_outcomes = tb_outcomes_simu;
                else
                    tb_outcomes = [tb_outcomes; tb_outcomes_simu];
                end
                
            end
            
            % Reset Base Parameters, parameters already grabbed out, updating
            param_map(st_param_key) = fl_param_val_benchmark;
        end
    end
    
    %% Simulate 2: Full Grid Simulation, Simulate Along Full Grid
    % To explore the effects of parameters on model outcomes, simulate the
    % model along full grids. Given X and Y parameters, this means simulate at
    % all possible combinations of X and Y arrays.
    %
    
    if (~bl_simu_cross)
        % Get Arrays to be Meshed in Cells
        cl_ar_param_subset_values = values(param_tstar_map, cl_st_param_keys);
        
        % Generate all possible combinations of parameters subsets
        cl_mt_all = cl_ar_param_subset_values;
        [cl_mt_all{:}] = ndgrid(cl_ar_param_subset_values{:});
        mt_param_vals_combi = cell2mat(cellfun(@(m) m(:), cl_mt_all, 'uni', 0));
        
        % Sizes
        it_test_combi_n = size(mt_param_vals_combi,1);
        
        % Convert from Matrix to Table for Clarity
        tb_pvals_combi = array2table(mt_param_vals_combi);
        tb_pvals_combi.Properties.VariableNames = ls_st_param_key(cl_st_param_keys);
        tb_pvals_combi.Properties.RowNames = strcat('j=', string(1:size(mt_param_vals_combi,1)));
        clear mt_param_vals_combi;
        
        % Display
        disp(head(tb_pvals_combi, 10));
        disp(tail(tb_pvals_combi, 10));
        
        for it_pcombi_ctr = 1:it_test_combi_n
            
            tb_row_param_adj_cur = tb_pvals_combi(it_pcombi_ctr, :);
            
            disp(['xxxxx Shift to: xxxxx']);
            disp(tb_row_param_adj_cur)
            
            % Display Current Parameter been Varied
            for st_param_key = cl_st_param_keys
                param_map(st_param_key{1}) = tb_row_param_adj_cur{1, st_param_key};
            end
            
            % Simulate Model
            ar_simu_info = [it_pcombi_ctr, cell2mat(values(param_map, cl_st_param_keys))];
            cl_col_names = [{'it_pcombi_ctr'} cl_st_param_keys];
            [tb_outcomes_simu, variablenames] = simu_model_gen_stats(param_map, support_map, ar_simu_info, cl_col_names);
            tb_outcomes_simu.Properties.RowNames = strcat(variablenames, '_v', num2str(it_pcombi_ctr));
            tb_outcomes_simu = addvars(tb_outcomes_simu, variablenames, 'Before', 1);
            
            % Combine Results from Different Parameters in Shared Table
            if (it_pcombi_ctr == 1)
                tb_outcomes = tb_outcomes_simu;
            else
                tb_outcomes = [tb_outcomes; tb_outcomes_simu];
            end
            
        end
    end
    
    % Table Output
    if (bl_display_simu_stats)
        disp('REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-');
        disp('xxxxxx tb_outcomes xxxxxx');
        disp(head(tb_outcomes, 10));
        disp(tail(tb_outcomes, 10));
    end
    
    %% Save Mat
    if (bl_mat_test)
        clear armt_map result_map
        if ~exist(st_mat_test_path,'dir'); mkdir(st_mat_test_path); end
        st_file_name = [st_mat_test_prefix st_mat_test_name_main st_mat_test_suffix];
        save(strcat(st_mat_test_path, st_file_name));
    end
    
end

end

%% Simulate Model given Parameter and Process Results
function [tb_outcomes_simu, variablenames] = simu_model_gen_stats(param_map, support_map, ar_simu_info, cl_col_names)

cl_st_param_keys = param_map('cl_st_param_keys');

%% Reset Parameters that are determined by other parameters
it_a_n = param_map('it_a_n');
it_z_n = param_map('it_z_n');
disp(['xxxxx it_a_n = ' num2str(it_a_n) ', it_z_n = ' num2str(it_z_n) ' xxxxx']);

%% Simulate Model
[armt_map, func_map] = ffs_az_get_funcgrid(param_map, support_map);
result_map = ff_az_vf_vecsv(param_map, support_map, armt_map, func_map);
result_map = ff_az_ds_vecsv(param_map, support_map, armt_map, func_map, result_map);

%% Store Results to Table

% Append Simulation Loop Statistics
tb_outcomes_meansdperc = result_map('tb_outcomes_meansdperc');
tb_simu_info = array2table(ar_simu_info + zeros([size(tb_outcomes_meansdperc,1), length(ar_simu_info)]));
tb_simu_info.Properties.VariableNames = cl_col_names;
variablenames = tb_outcomes_meansdperc.Properties.RowNames;
tb_simu_info.Properties.RowNames = (variablenames);

% Table
tb_outcomes_simu = [tb_simu_info tb_outcomes_meansdperc];
end

##### SOURCE END #####
--></body></html>