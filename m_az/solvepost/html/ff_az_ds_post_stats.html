
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Generate Statistics from Prob Mass Function over States</title><meta name="generator" content="MATLAB 9.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-07-23"><meta name="DC.source" content="ff_az_ds_post_stats.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Generate Statistics from Prob Mass Function over States</h1><!--introduction--><p><b>back to <a href="https://fanwangecon.github.io">Fan</a>'s <a href="https://fanwangecon.github.io/CodeDynaAsset/">Dynamic Assets Repository</a> Table of Content.</b></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">FF_AZ_DS_POST_STATS post ff_az_ds statistics generation</a></li><li><a href="#3">Default</a></li><li><a href="#4">Parse</a></li><li><a href="#5"><b>f(y), f(c), f(a)</b>: Generate Key Distributional Statistics for Each outcome</a></li><li><a href="#7"><b>f(y), f(c), f(a)</b>: Find p(outcome(states)), proability mass function for each outcome</a></li><li><a href="#8"><b>f(y), f(c), f(a)</b>: Compute Statistics for outcomes</a></li><li><a href="#9"><b>f(y), f(c), f(a)</b>: Store Statistics Specific to Each Outcome</a></li><li><a href="#11">Covariance and Correlation</a></li><li><a href="#12"><b>f(y), f(c), f(a)</b>: Store Statistics Shared Table All Outcomes</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> [result_map] = ff_az_ds_post_stats(varargin)
</pre><h2 id="2">FF_AZ_DS_POST_STATS post ff_az_ds statistics generation</h2><p>Having derived f(a,z) the probability mass function of the joint discrete random variables, we now obtain distributional statistics. Note that we know f(a,z), and we also know relevant policy functions a'(a,z), c(a,z), or other policy functions. We can simulate any choices that are a function of the random variables (a,z), using f(a,z)</p><p>parameter structure provides a list of</p><div><ol><li>from result_map('ar_st_pol_names'), get list of outcome matrix on state space</li><li>simulate each outcome using f(a,z) for probability draws</li><li>compute key statistics: (1) mean (expectation=sum) (2) sd (3) min and max (4) iqr (5) fraction = 0 (6) percentiles including: 99.9, 99, 95, every 5 in between 5, 1, 0.01.</li></ol></div><p>Uses fake binomial data when file is invoke with defaults.</p><p>@param param_map container parameter container</p><p>@param support_map container support container</p><p>@param result_map container contains policy function matrix, value function matrix, iteration results</p><p>@param mt_dist_az matrix N by M where N are asset states and M are shock states, the f(a,z) probability mass function derived earlier in ff_az_ds or ff_az_ds_vec</p><p>@return result_map container with statistics added to result_map</p><div><ul><li>the first element of each of these cell array is y(a,z), the outcome/choice at the state space points</li><li>the second element of the cell is another container, which contains statistics computed for f(y) based on y(a,z) and f(a,z), f(y) is the probability mass function for outcome y given the stationary distribution f(a,z). The second element container also includes f(y) itself as well as f(y,z).</li><li>additionally, result_map also stores some of the statistics for different variables jointly together. (a) <b>tb_outcomes_meansdperc</b>: where each row is a different outcome of the model, and each table column stores a different statistics of interest. (b) <b>tb_outcomes_fracheld</b>: which measures the fraction of asset held by different people.</li></ul></div><p>@example</p><pre>  bl_input_override = true;
  result_map = ff_az_ds_post_stats(support_map, result_map, mt_dist_az, bl_input_override);</pre><p>@include</p><div><ul><li><a href="https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html">fft_disc_rand_var_stats</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html">fft_disc_rand_var_mass2outcomes</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2covcor.html">fft_disc_rand_var_mass2covcor</a></li></ul></div><h2 id="3">Default</h2><p>use binomial as test case, z maps to binomial win prob, remember binom approximates normal.</p><pre class="codeinput">params_len = length(varargin);
bl_input_override = 0;
<span class="keyword">if</span> (params_len == 4)
    bl_input_override = varargin{4};
<span class="keyword">end</span>

<span class="keyword">if</span> (bl_input_override)
    <span class="comment">% if invoked from outside overrid fully</span>
    [support_map, result_map, mt_dist_az, ~] = varargin{:};
    bl_display_final_dist_detail_local = false;
<span class="keyword">else</span>
    clear <span class="string">all</span>;
    close <span class="string">all</span>;

    it_states = 6;
    it_shocks = 5;
    fl_binom_n = it_states-1;
    ar_binom_p = (1:(it_shocks))./(it_shocks+2);
    ar_binom_x = (0:1:(it_states-1)) -3;

    <span class="comment">% f(z)</span>
    ar_binom_p_prob = binopdf(0:(it_shocks-1), it_shocks-1, 0.5);
    <span class="comment">% f(a,z), mass for a, z</span>
    mt_dist_az = zeros([it_states, it_shocks]);
    <span class="keyword">for</span> it_z=1:it_shocks
        <span class="comment">% f(a|z)</span>
        f_a_condi_z = binopdf(ar_binom_x - min(ar_binom_x), fl_binom_n, ar_binom_p(it_z));
        <span class="comment">% f(z)</span>
        f_z = ar_binom_p_prob(it_z);
        <span class="comment">% f(a,z)=f(a|z)*f(z)</span>
        mt_dist_az(:, it_z) = f_a_condi_z*f_z;
    <span class="keyword">end</span>

    <span class="comment">% y(a,z), some non-smooth structure</span>
    rng(123);
    mt_pol_a = ar_binom_x' - 0.01*ar_binom_x'.^2  + ar_binom_p - 0.5*ar_binom_p.^2 + rand([it_states, it_shocks]);
    mt_pol_a = round(mt_pol_a*3);

    rng(456);
    mt_pol_c = 10 -(mt_pol_a) + 15*(rand([it_states, it_shocks])-0.5);

    <span class="comment">% Generate result_map</span>
    result_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
    result_map(<span class="string">'cl_mt_pol_a'</span>) = {mt_pol_a, zeros(1)};
    result_map(<span class="string">'cl_mt_pol_c'</span>) = {mt_pol_c, zeros(1)};
    result_map(<span class="string">'ar_st_pol_names'</span>) = [<span class="string">"cl_mt_pol_a"</span>, <span class="string">"cl_mt_pol_c"</span>];

    <span class="comment">% support_map</span>
    support_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
    support_map(<span class="string">'bl_display_final_dist'</span>) = true;
    support_map(<span class="string">'bl_display_final_dist_detail'</span>) = true;
    bl_display_final_dist_detail_local = true;
<span class="keyword">end</span>
</pre><h2 id="4">Parse</h2><pre class="codeinput"><span class="comment">% support_map</span>
params_group = values(support_map, {<span class="string">'bl_display_final_dist'</span>, <span class="string">'bl_display_final_dist_detail'</span>});
[bl_display_final_dist, bl_display_final_dist_detail] = params_group{:};
<span class="keyword">if</span> (bl_display_final_dist_detail)
    bl_display_drvstats = true;
<span class="keyword">else</span>
    bl_display_drvstats = false;
<span class="keyword">end</span>

<span class="comment">% result_map</span>
params_group = values(result_map, {<span class="string">'ar_st_pol_names'</span>});
[ar_st_pol_names] = params_group{:};
</pre><h2 id="5"><b>f(y), f(c), f(a)</b>: Generate Key Distributional Statistics for Each outcome</h2><p>Loop over outcomes, see end of <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html">ff_az_vf_vecsv</a> where these are created</p><pre class="codeinput"><span class="keyword">for</span> it_outcome_ctr=1:length(ar_st_pol_names)
</pre><h2 id="7"><b>f(y), f(c), f(a)</b>: Find p(outcome(states)), proability mass function for each outcome</h2><p>Using from tools: <a href="https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html">fft_disc_rand_var_mass2outcomes</a>, compute unique sorted outcomes for y(a,z) and find:</p><p><img src="ff_az_ds_post_stats_eq07860812722477683876.png" alt="$$ p(y,z) = \sum_{a} \left(1\left\{Y(a,z)=y\right\} \cdot p(a,z) \right)$$" style="width:242px;height:31px;"></p><p><img src="ff_az_ds_post_stats_eq08810890118983211153.png" alt="$$ p(y,a) = \sum_{z} \left(1\left\{Y(a,z)=y\right\} \cdot p(a,z) \right)$$" style="width:242px;height:31px;"></p><p><img src="ff_az_ds_post_stats_eq16910297080260075404.png" alt="$$ p(Y=y) = \sum_{a,z} \left( 1\left\{Y(a,z)=y\right\} \cdot p(a,z) \right)$$" style="width:259px;height:33px;"></p><p>note: sum(mt_dist_az, 2) = result_map('cl_mt_pol_a'){2}, but not at small simulation grids. These two might be different because pol_a is based on a choices, mt_dist_az is based on a states</p><p>see end of <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html">ff_az_vf_vecsv</a> outcomes in result_map are cells with two elements, first element is y(a,z), second element will be f(y) and y, generated here.</p><pre class="codeinput">    st_cur_output_key = ar_st_pol_names(it_outcome_ctr);
    cl_mt_choice_cur = result_map(st_cur_output_key);
    mt_choice_cur = cl_mt_choice_cur{1};

    <span class="comment">% run function from tools: fft_disc_rand_var_mass2outcomes</span>
    <span class="comment">% &lt;https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html&gt;</span>
    bl_input_override = true;
    [ar_choice_prob_byY, ar_choice_unique_sorted_byY, mt_choice_prob_byYZ, mt_choice_prob_byYA] = <span class="keyword">...</span>
        fft_disc_rand_var_mass2outcomes(st_cur_output_key, mt_choice_cur, mt_dist_az, bl_input_override);
</pre><h2 id="8"><b>f(y), f(c), f(a)</b>: Compute Statistics for outcomes</h2><p>Using from tools: <a href="https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html">fft_disc_rand_var_stats</a>, compute these outcomes:</p><div><ul><li>$\mu_Y = E(Y) = \sum_{y} p(Y=y) \cdot y $</li><li><img src="ff_az_ds_post_stats_eq03728111283668325077.png" alt="$\sigma_Y = \sqrt{ \sum_{y} p(Y=y) \cdot \left( y - \mu_y \right)^2}$" style="width:202px;height:27px;"></li><li><img src="ff_az_ds_post_stats_eq05433369603455155594.png" alt="$p(y=0)$" style="width:53px;height:15px;"></li><li><img src="ff_az_ds_post_stats_eq09585247606302904929.png" alt="$p(y=\max(y))$" style="width:91px;height:15px;"></li><li>percentiles: <img src="ff_az_ds_post_stats_eq09488738859326996168.png" alt="$min_{y} \left\{ P(Y \le y) - percentile \mid P(Y \le y) \ge percentile \right\}$" style="width:352px;height:15px;"></li><li>fraction of outcome held by up to percentiles: <img src="ff_az_ds_post_stats_eq11722476300337688867.png" alt="$E(Y<y)/E(Y)$" style="width:103px;height:15px;"></li></ul></div><pre class="codeinput">    <span class="comment">% run function fft_disc_rand_var_stats.m from tools:</span>
    <span class="comment">% &lt;https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html&gt;</span>
    [ds_stats_map] = fft_disc_rand_var_stats(st_cur_output_key, ar_choice_unique_sorted_byY', ar_choice_prob_byY', bl_display_drvstats);

    <span class="comment">% prcess results</span>
    <span class="comment">% retrieve scalar statistics:</span>
    fl_choice_mean = ds_stats_map(<span class="string">'fl_choice_mean'</span>);
    fl_choice_sd = ds_stats_map(<span class="string">'fl_choice_sd'</span>);
    fl_choice_coefofvar = ds_stats_map(<span class="string">'fl_choice_coefofvar'</span>);
    fl_choice_min = ds_stats_map(<span class="string">'fl_choice_min'</span>);
    fl_choice_max = ds_stats_map(<span class="string">'fl_choice_max'</span>);
    fl_choice_prob_zero = ds_stats_map(<span class="string">'fl_choice_prob_zero'</span>);
    fl_choice_prob_below_zero = ds_stats_map(<span class="string">'fl_choice_prob_below_zero'</span>);
    fl_choice_prob_above_zero = ds_stats_map(<span class="string">'fl_choice_prob_above_zero'</span>);
    fl_choice_prob_min = ds_stats_map(<span class="string">'fl_choice_prob_min'</span>);
    fl_choice_prob_max = ds_stats_map(<span class="string">'fl_choice_prob_max'</span>);
    <span class="comment">% retrieve distributional array stats</span>
    ar_choice_percentiles = ds_stats_map(<span class="string">'ar_choice_percentiles'</span>);
    ar_choice_perc_fracheld = ds_stats_map(<span class="string">'ar_choice_perc_fracheld'</span>);
</pre><pre class="codeoutput">----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Summary Statistics for: cl_mt_pol_a
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
----------------------------------------
fl_choice_mean
   -0.1108

fl_choice_sd
    4.1239

fl_choice_coefofvar
  -37.2149

fl_choice_prob_zero
    0.0643

fl_choice_prob_below_zero
    0.5487

fl_choice_prob_above_zero
    0.3871

fl_choice_prob_max
    0.0273

tb_disc_cumu
    cl_mt_pol_aDiscreteVal    cl_mt_pol_aDiscreteValProbMass     CDF      cumsumFrac
    ______________________    ______________________________    ______    __________

              -7                         0.051764               5.1764      3.2699  
              -6                         0.050217               10.198      5.9889  
              -5                          0.10978               21.176      10.942  
              -4                        0.0014875               21.324      10.996  
              -3                          0.11706               33.031      14.165  
              -2                        0.0080324               33.834       14.31  
              -1                          0.21033               54.867      16.208  
               0                         0.064259               61.293      16.208  
               2                         0.049682               66.261      15.311  
               3                         0.096388                 75.9      12.702  

    cl_mt_pol_aDiscreteVal    cl_mt_pol_aDiscreteValProbMass     CDF      cumsumFrac
    ______________________    ______________________________    ______    __________

              -1                           0.21033              54.867      16.208  
               0                          0.064259              61.293      16.208  
               2                          0.049682              66.261      15.311  
               3                          0.096388                75.9      12.702  
               4                          0.085679              84.468      9.6092  
               5                          0.065337              91.002      6.6611  
               6                          0.057231              96.725      3.5623  
               7                         0.0054218              97.267      3.2198  
               8                        3.7187e-06              97.267      3.2196  
               9                          0.027329                 100           1  

tb_prob_drv
    percentiles    cl_mt_pol_aDiscreteValPercentileValues    fracOfSumHeldBelowThisPercentile
    ___________    ______________________________________    ________________________________

        0.1                          -7                                   3.2699             
          1                          -7                                   3.2699             
          5                          -7                                   3.2699             
         10                          -6                                   5.9889             
         15                          -5                                   10.942             
         20                          -5                                   10.942             
         25                          -3                                   14.165             
         35                          -1                                   16.208             
         50                          -1                                   16.208             
         65                           2                                   15.311             
         75                           3                                   12.702             
         80                           4                                   9.6092             
         85                           5                                   6.6611             
         90                           5                                   6.6611             
         95                           6                                   3.5623             
         99                           9                                        1             
       99.9                           9                                        1             

</pre><pre class="codeoutput">----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Summary Statistics for: cl_mt_pol_c
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
----------------------------------------
fl_choice_mean
    8.8423

fl_choice_sd
    6.5845

fl_choice_coefofvar
    0.7447

fl_choice_prob_zero
     0

fl_choice_prob_below_zero
    0.0273

fl_choice_prob_above_zero
    0.9727

fl_choice_prob_max
    0.0465

tb_disc_cumu
    cl_mt_pol_cDiscreteVal    cl_mt_pol_cDiscreteValProbMass     CDF      cumsumFrac 
    ______________________    ______________________________    ______    ___________

            -6.3772                       0.015232              1.5232      -0.010985
            -4.4805                       0.011621              2.6853      -0.016874
           -0.72091                     0.00047599              2.7329      -0.016913
            0.14102                       0.057119              8.4448      -0.016002
            0.27238                       0.085679              17.013      -0.013362
            0.50318                       0.023242              19.337       -0.01204
             2.7525                        0.02975              22.312     -0.0027791
             3.5617                     3.7187e-06              22.312     -0.0027776
             4.0352                      0.0059499              22.907    -6.2407e-05
             5.1855                      0.0054218              23.449      0.0031172

    cl_mt_pol_cDiscreteVal    cl_mt_pol_cDiscreteValProbMass     CDF      cumsumFrac
    ______________________    ______________________________    ______    __________

            13.231                       0.028917               65.473     0.36675  
            13.357                       0.018593               67.332     0.39484  
            13.799                        0.12852               80.184     0.59539  
            13.901                       0.000119               80.196     0.59558  
             15.71                       0.024097               82.605     0.63839  
            16.255                      0.0080324               83.409     0.65316  
            16.887                       0.092967               92.705      0.8307  
            18.136                       0.022848                94.99     0.87756  
             19.35                      0.0036146               95.352     0.88547  
            21.786                       0.046484                  100           1  

tb_prob_drv
    percentiles    cl_mt_pol_cDiscreteValPercentileValues    fracOfSumHeldBelowThisPercentile
    ___________    ______________________________________    ________________________________

        0.1                       -6.3772                                -0.010985           
          1                       -6.3772                                -0.010985           
          5                       0.14102                                -0.016002           
         10                       0.27238                                -0.013362           
         15                       0.27238                                -0.013362           
         20                        2.7525                               -0.0027791           
         25                        5.2138                                 0.041007           
         35                        6.2166                                   0.1181           
         50                        6.5321                                   0.1893           
         65                        13.231                                  0.36675           
         75                        13.799                                  0.59539           
         80                        13.799                                  0.59539           
         85                        16.887                                   0.8307           
         90                        16.887                                   0.8307           
         95                         19.35                                  0.88547           
         99                        21.786                                        1           
       99.9                        21.786                                        1           

</pre><h2 id="9"><b>f(y), f(c), f(a)</b>: Store Statistics Specific to Each Outcome</h2><p>see intro section</p><pre class="codeinput">    <span class="comment">% Append prob mass functions to ds_stats_map</span>
    ds_stats_map(<span class="string">'mt_choice_prob_byYZ'</span>) = mt_choice_prob_byYZ;
    ds_stats_map(<span class="string">'mt_choice_prob_byYA'</span>) = mt_choice_prob_byYA;
    ds_stats_map(<span class="string">'ar_choice_unique_sorted_byY'</span>) = ar_choice_unique_sorted_byY;
    ds_stats_map(<span class="string">'ar_choice_prob_byY'</span>) = ar_choice_prob_byY;
    <span class="comment">% ds_stats_map is second element of cell for the key for the variable</span>
    <span class="comment">% in result_map</span>
    cl_mt_choice_cur{2} = ds_stats_map;
    result_map(st_cur_output_key) = cl_mt_choice_cur;

    <span class="comment">% key stats</span>
    ar_keystats = [fl_choice_mean fl_choice_sd fl_choice_coefofvar fl_choice_min fl_choice_max <span class="keyword">...</span>
        fl_choice_prob_zero fl_choice_prob_below_zero fl_choice_prob_above_zero <span class="keyword">...</span>
        fl_choice_prob_min fl_choice_prob_max ar_choice_percentiles];
    cl_outcome_names(it_outcome_ctr) = st_cur_output_key;
    <span class="keyword">if</span> (it_outcome_ctr == 1)
        mt_outcomes_meansdperc = ar_keystats;
        mt_outcomes_fracheld = ar_choice_perc_fracheld;
    <span class="keyword">else</span>
        mt_outcomes_meansdperc = [mt_outcomes_meansdperc; ar_keystats];
        mt_outcomes_fracheld = [mt_outcomes_fracheld; ar_choice_perc_fracheld];
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>

<span class="keyword">if</span> (bl_display_final_dist || bl_display_final_dist_detail)

    tb_outcomes_meansdperc = array2table(mt_outcomes_meansdperc);
    ar_fl_percentiles = ds_stats_map(<span class="string">'ar_fl_percentiles'</span>);
    cl_col_names = [<span class="string">'mean'</span>, <span class="string">'sd'</span>, <span class="string">'coefofvar'</span>, <span class="string">'min'</span>, <span class="string">'max'</span>, <span class="keyword">...</span>
                    <span class="string">'pYis0'</span>, <span class="string">'pYls0'</span>, <span class="string">'pYgr0'</span>, <span class="string">'pYisMINY'</span>, <span class="string">'pYisMAXY'</span>, <span class="keyword">...</span>
                    strcat(<span class="string">'p'</span>, string(ar_fl_percentiles))];
    tb_outcomes_meansdperc.Properties.VariableNames = matlab.lang.makeValidName(cl_col_names);
    tb_outcomes_meansdperc.Properties.RowNames = matlab.lang.makeValidName(cl_outcome_names);

    <span class="keyword">if</span> (bl_display_final_dist_detail_local)
        disp(<span class="string">'xxx tb_outcomes_meansdperc: mean, sd, percentiles xxx'</span>)
        disp(rows2vars(tb_outcomes_meansdperc));
    <span class="keyword">end</span>

    <span class="comment">% Process Aset Held by up to percentiles</span>
    tb_outcomes_fracheld = array2table(mt_outcomes_fracheld);
    cl_col_names = [strcat(<span class="string">'fracByP'</span>, string(ar_fl_percentiles))];
    tb_outcomes_fracheld.Properties.VariableNames = matlab.lang.makeValidName(cl_col_names);
    tb_outcomes_fracheld.Properties.RowNames = matlab.lang.makeValidName(cl_outcome_names);

    <span class="keyword">if</span> (bl_display_final_dist_detail_local)
        disp(<span class="string">'xxx tb_outcomes_fracheld: fraction of asset/income/etc held by hh up to this percentile xxx'</span>)
        disp(rows2vars(tb_outcomes_fracheld));
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><pre class="codeoutput">xxx tb_outcomes_meansdperc: mean, sd, percentiles xxx
    OriginalVariableNames    cl_mt_pol_a    cl_mt_pol_c
    _____________________    ___________    ___________

         'mean'               -0.11081         8.8423  
         'sd'                   4.1239         6.5845  
         'coefofvar'           -37.215        0.74466  
         'min'                      -7        -6.3772  
         'max'                       9         21.786  
         'pYis0'              0.064259              0  
         'pYls0'               0.54867       0.027329  
         'pYgr0'               0.38707        0.97267  
         'pYisMINY'           0.051764       0.015232  
         'pYisMAXY'           0.027329       0.046484  
         'p0_1'                     -7        -6.3772  
         'p1'                       -7        -6.3772  
         'p5'                       -7        0.14102  
         'p10'                      -6        0.27238  
         'p15'                      -5        0.27238  
         'p20'                      -5         2.7525  
         'p25'                      -3         5.2138  
         'p35'                      -1         6.2166  
         'p50'                      -1         6.5321  
         'p65'                       2         13.231  
         'p75'                       3         13.799  
         'p80'                       4         13.799  
         'p85'                       5         16.887  
         'p90'                       5         16.887  
         'p95'                       6          19.35  
         'p99'                       9         21.786  
         'p99_9'                     9         21.786  

xxx tb_outcomes_fracheld: fraction of asset/income/etc held by hh up to this percentile xxx
    OriginalVariableNames    cl_mt_pol_a    cl_mt_pol_c
    _____________________    ___________    ___________

        'fracByP0_1'           3.2699        -0.010985 
        'fracByP1'             3.2699        -0.010985 
        'fracByP5'             3.2699        -0.016002 
        'fracByP10'            5.9889        -0.013362 
        'fracByP15'            10.942        -0.013362 
        'fracByP20'            10.942       -0.0027791 
        'fracByP25'            14.165         0.041007 
        'fracByP35'            16.208           0.1181 
        'fracByP50'            16.208           0.1893 
        'fracByP65'            15.311          0.36675 
        'fracByP75'            12.702          0.59539 
        'fracByP80'            9.6092          0.59539 
        'fracByP85'            6.6611           0.8307 
        'fracByP90'            6.6611           0.8307 
        'fracByP95'            3.5623          0.88547 
        'fracByP99'                 1                1 
        'fracByP99_9'               1                1 

</pre><h2 id="11">Covariance and Correlation</h2><p>Having computed elsewhere E(X), E(Y), and SD(X), SD(Y), and given X(a,z) and Y(a,z), which are the optimal choices along the endogenous state space grid a, and the exogenous state space grid z, and given also f(a,z), the probability mass function over (a,z), we compute covariance and correlation between outcomes X and Y.</p><div><ul><li>Covariance</li></ul></div><p><img src="ff_az_ds_post_stats_eq05840240166657787077.png" alt="$$\mathrm{Cov}\left(x,y\right) = \sum_{a} \sum_{z} f(a,z) \cdot \left( x(a,z) - \mu_x \right) \cdot \left( y(a,z) - \mu_y \right)$$" style="width:361px;height:31px;"></p><div><ul><li>Correlation</li></ul></div><p><img src="ff_az_ds_post_stats_eq16097707096021807928.png" alt="$$\rho_{x,y} = \frac{\mathrm{Cov}\left(x,y\right)}{\sigma_x \cdot \sigma_y}$$" style="width:105px;height:35px;"></p><pre class="codeinput"><span class="keyword">for</span> it_outcome_x_ctr=1:length(ar_st_pol_names)

    st_cur_output_x_key = ar_st_pol_names(it_outcome_x_ctr);

    cl_mt_choice_cur = result_map(st_cur_output_x_key);
    ds_stats_map = cl_mt_choice_cur{2};

    cl_mt_choice_cur = result_map(st_cur_output_x_key);
    mt_choice_x_bystates = cl_mt_choice_cur{1};
    fl_choice_x_mean = ds_stats_map(<span class="string">'fl_choice_mean'</span>);
    fl_choice_x_sd = ds_stats_map(<span class="string">'fl_choice_sd'</span>);

    ar_covvar = zeros([1,length(ar_st_pol_names)*2]);
    ar_st_covvar = strings([1,length(ar_st_pol_names)*2]);
    <span class="keyword">for</span> it_outcome_y_ctr=1:length(ar_st_pol_names)

        st_cur_output_y_key = ar_st_pol_names(it_outcome_y_ctr);

        cl_mt_choice_cur = result_map(st_cur_output_y_key);
        ds_stats_map = cl_mt_choice_cur{2};

        cl_mt_choice_cur = result_map(st_cur_output_y_key);
        mt_choice_y_bystates = cl_mt_choice_cur{1};
        fl_choice_y_mean = ds_stats_map(<span class="string">'fl_choice_mean'</span>);
        fl_choice_y_sd = ds_stats_map(<span class="string">'fl_choice_sd'</span>);

        covvar_input_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
        covvar_input_map(<span class="string">'mt_choice_x_bystates'</span>) = mt_choice_x_bystates;
        covvar_input_map(<span class="string">'mt_choice_y_bystates'</span>) = mt_choice_y_bystates;
        covvar_input_map(<span class="string">'mt_dist_bystates'</span>) = mt_dist_az;
        covvar_input_map(<span class="string">'fl_choice_x_mean'</span>) = fl_choice_x_mean;
        covvar_input_map(<span class="string">'fl_choice_x_sd'</span>) = fl_choice_x_sd;
        covvar_input_map(<span class="string">'fl_choice_y_mean'</span>) = fl_choice_y_mean;
        covvar_input_map(<span class="string">'fl_choice_y_sd'</span>) = fl_choice_y_sd;

        [fl_cov_xy, fl_cor_xy] = fft_disc_rand_var_mass2covcor(covvar_input_map);

        <span class="comment">% only include the y name, x name is from the row</span>
        st_x_y_cov = strjoin([<span class="string">"fl_cov_"</span> st_cur_output_y_key], <span class="string">''</span>);
        st_x_y_cor = strjoin([<span class="string">"fl_cor_"</span> st_cur_output_y_key], <span class="string">''</span>);
        ds_stats_map(st_x_y_cov) = fl_cov_xy;
        ds_stats_map(st_x_y_cor) = fl_cor_xy;

        ar_covvar(it_outcome_y_ctr*2-1) = fl_cov_xy;
        ar_covvar(it_outcome_y_ctr*2) = fl_cor_xy;
        ar_st_covvar(it_outcome_y_ctr*2-1) = string(st_x_y_cov);
        ar_st_covvar(it_outcome_y_ctr*2) = string(st_x_y_cor);

        cl_mt_choice_cur{2} = ds_stats_map;
        result_map(st_cur_output_y_key) = cl_mt_choice_cur;
    <span class="keyword">end</span>

    <span class="keyword">if</span> (it_outcome_x_ctr == 1)
        mt_outcomes_covvar = ar_covvar;
    <span class="keyword">else</span>
        mt_outcomes_covvar = [mt_outcomes_covvar; ar_covvar];
    <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">if</span> (bl_display_final_dist || bl_display_final_dist_detail)

    tb_outcomes_covvar = array2table(mt_outcomes_covvar);
    tb_outcomes_covvar.Properties.VariableNames = matlab.lang.makeValidName(ar_st_covvar);
    tb_outcomes_covvar.Properties.RowNames = matlab.lang.makeValidName(cl_outcome_names);

    <span class="keyword">if</span> (bl_display_final_dist_detail_local)
        disp(<span class="string">'xxx tb_outcomes_covvar: variance correlation xxx'</span>)
        disp(rows2vars(tb_outcomes_covvar));
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><pre class="codeoutput">xxx tb_outcomes_covvar: variance correlation xxx
    OriginalVariableNames    cl_mt_pol_a    cl_mt_pol_c
    _____________________    ___________    ___________

    'fl_cov_cl_mt_pol_a'        17.007        -22.084  
    'fl_cor_cl_mt_pol_a'             1       -0.81327  
    'fl_cov_cl_mt_pol_c'       -22.084         43.356  
    'fl_cor_cl_mt_pol_c'      -0.81327              1  

</pre><h2 id="12"><b>f(y), f(c), f(a)</b>: Store Statistics Shared Table All Outcomes</h2><pre class="codeinput"><span class="comment">% Add to result_map</span>
mt_outcomes = [mt_outcomes_meansdperc, mt_outcomes_covvar, mt_outcomes_fracheld];
result_map(<span class="string">'mt_outcomes'</span>) = mt_outcomes;

<span class="keyword">if</span> (bl_display_final_dist || bl_display_final_dist_detail)

    tb_outcomes = [tb_outcomes_meansdperc, tb_outcomes_covvar, tb_outcomes_fracheld];
    result_map(<span class="string">'tb_outcomes'</span>) = tb_outcomes;

    <span class="keyword">if</span> (bl_display_final_dist_detail)
        disp(rows2vars(tb_outcomes));
    <span class="keyword">else</span>
        disp(tb_outcomes);
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><pre class="codeoutput">    OriginalVariableNames    cl_mt_pol_a    cl_mt_pol_c
    _____________________    ___________    ___________

    'mean'                    -0.11081          8.8423 
    'sd'                        4.1239          6.5845 
    'coefofvar'                -37.215         0.74466 
    'min'                           -7         -6.3772 
    'max'                            9          21.786 
    'pYis0'                   0.064259               0 
    'pYls0'                    0.54867        0.027329 
    'pYgr0'                    0.38707         0.97267 
    'pYisMINY'                0.051764        0.015232 
    'pYisMAXY'                0.027329        0.046484 
    'p0_1'                          -7         -6.3772 
    'p1'                            -7         -6.3772 
    'p5'                            -7         0.14102 
    'p10'                           -6         0.27238 
    'p15'                           -5         0.27238 
    'p20'                           -5          2.7525 
    'p25'                           -3          5.2138 
    'p35'                           -1          6.2166 
    'p50'                           -1          6.5321 
    'p65'                            2          13.231 
    'p75'                            3          13.799 
    'p80'                            4          13.799 
    'p85'                            5          16.887 
    'p90'                            5          16.887 
    'p95'                            6           19.35 
    'p99'                            9          21.786 
    'p99_9'                          9          21.786 
    'fl_cov_cl_mt_pol_a'        17.007         -22.084 
    'fl_cor_cl_mt_pol_a'             1        -0.81327 
    'fl_cov_cl_mt_pol_c'       -22.084          43.356 
    'fl_cor_cl_mt_pol_c'      -0.81327               1 
    'fracByP0_1'                3.2699       -0.010985 
    'fracByP1'                  3.2699       -0.010985 
    'fracByP5'                  3.2699       -0.016002 
    'fracByP10'                 5.9889       -0.013362 
    'fracByP15'                 10.942       -0.013362 
    'fracByP20'                 10.942      -0.0027791 
    'fracByP25'                 14.165        0.041007 
    'fracByP35'                 16.208          0.1181 
    'fracByP50'                 16.208          0.1893 
    'fracByP65'                 15.311         0.36675 
    'fracByP75'                 12.702         0.59539 
    'fracByP80'                 9.6092         0.59539 
    'fracByP85'                 6.6611          0.8307 
    'fracByP90'                 6.6611          0.8307 
    'fracByP95'                 3.5623         0.88547 
    'fracByP99'                      1               1 
    'fracByP99_9'                    1               1 

</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><pre class="codeoutput">
ans = 

  Map with properties:

        Count: 5
      KeyType: char
    ValueType: any

</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Generate Statistics from Prob Mass Function over States
% *back to <https://fanwangecon.github.io Fan>'s
% <https://fanwangecon.github.io/CodeDynaAsset/ Dynamic Assets Repository>
% Table of Content.*

%%
function [result_map] = ff_az_ds_post_stats(varargin)
%% FF_AZ_DS_POST_STATS post ff_az_ds statistics generation 
% Having derived f(a,z) the probability mass function of the joint discrete
% random variables, we now obtain distributional statistics. Note that we
% know f(a,z), and we also know relevant policy functions a'(a,z), c(a,z),
% or other policy functions. We can simulate any choices that are a
% function of the random variables (a,z), using f(a,z)
%
% parameter structure provides a list of
%
% # from result_map('ar_st_pol_names'), get list of outcome matrix on state
% space
% # simulate each outcome using f(a,z) for probability draws
% # compute key statistics: (1) mean (expectation=sum) (2) sd (3) min and
% max (4) iqr (5) fraction = 0 (6) percentiles including: 99.9, 99, 95,
% every 5 in between 5, 1, 0.01.
%
% Uses fake binomial data when file is invoke with defaults.
%
% @param param_map container parameter container
%
% @param support_map container support container
%
% @param result_map container contains policy function matrix, value
% function matrix, iteration results
%
% @param mt_dist_az matrix N by M where N are asset states and M are shock
% states, the f(a,z) probability mass function derived earlier in ff_az_ds
% or ff_az_ds_vec
%
% @return result_map container with statistics added to result_map
%
% * the first element of each of these cell array is y(a,z), the
% outcome/choice at the state space points
% * the second element of the cell is another container, which contains
% statistics computed for f(y) based on y(a,z) and f(a,z), f(y) is the
% probability mass function for outcome y given the stationary distribution
% f(a,z). The second element container also includes f(y) itself as well as
% f(y,z).
% * additionally, result_map also stores some of the statistics for
% different variables jointly together. (a) *tb_outcomes_meansdperc*: where
% each row is a different outcome of the model, and each table column
% stores a different statistics of interest. (b) *tb_outcomes_fracheld*:
% which measures the fraction of asset held by different people.
%
% @example
%
%    bl_input_override = true;
%    result_map = ff_az_ds_post_stats(support_map, result_map, mt_dist_az, bl_input_override);
%
% @include
%
% * <https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html fft_disc_rand_var_stats>
% * <https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html fft_disc_rand_var_mass2outcomes>
% * <https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2covcor.html fft_disc_rand_var_mass2covcor>
%

%% Default
% use binomial as test case, z maps to binomial win prob, remember binom
% approximates normal.

params_len = length(varargin);
bl_input_override = 0;
if (params_len == 4)
    bl_input_override = varargin{4};
end

if (bl_input_override)
    % if invoked from outside overrid fully
    [support_map, result_map, mt_dist_az, ~] = varargin{:};
    bl_display_final_dist_detail_local = false;
else
    clear all;
    close all;
    
    it_states = 6;
    it_shocks = 5;
    fl_binom_n = it_states-1;
    ar_binom_p = (1:(it_shocks))./(it_shocks+2);
    ar_binom_x = (0:1:(it_states-1)) -3;
    
    % f(z)
    ar_binom_p_prob = binopdf(0:(it_shocks-1), it_shocks-1, 0.5);
    % f(a,z), mass for a, z
    mt_dist_az = zeros([it_states, it_shocks]);
    for it_z=1:it_shocks
        % f(a|z)
        f_a_condi_z = binopdf(ar_binom_x - min(ar_binom_x), fl_binom_n, ar_binom_p(it_z));
        % f(z)
        f_z = ar_binom_p_prob(it_z);
        % f(a,z)=f(a|z)*f(z)
        mt_dist_az(:, it_z) = f_a_condi_z*f_z;
    end
    
    % y(a,z), some non-smooth structure
    rng(123);    
    mt_pol_a = ar_binom_x' - 0.01*ar_binom_x'.^2  + ar_binom_p - 0.5*ar_binom_p.^2 + rand([it_states, it_shocks]);
    mt_pol_a = round(mt_pol_a*3);

    rng(456);
    mt_pol_c = 10 -(mt_pol_a) + 15*(rand([it_states, it_shocks])-0.5);
        
    % Generate result_map
    result_map = containers.Map('KeyType','char', 'ValueType','any');
    result_map('cl_mt_pol_a') = {mt_pol_a, zeros(1)};
    result_map('cl_mt_pol_c') = {mt_pol_c, zeros(1)};
    result_map('ar_st_pol_names') = ["cl_mt_pol_a", "cl_mt_pol_c"];
    
    % support_map
    support_map = containers.Map('KeyType','char', 'ValueType','any');    
    support_map('bl_display_final_dist') = true;
    support_map('bl_display_final_dist_detail') = true;
    bl_display_final_dist_detail_local = true;
end

%% Parse

% support_map
params_group = values(support_map, {'bl_display_final_dist', 'bl_display_final_dist_detail'});
[bl_display_final_dist, bl_display_final_dist_detail] = params_group{:};
if (bl_display_final_dist_detail)
    bl_display_drvstats = true;
else
    bl_display_drvstats = false;
end

% result_map
params_group = values(result_map, {'ar_st_pol_names'});
[ar_st_pol_names] = params_group{:};

%% *f(y), f(c), f(a)*: Generate Key Distributional Statistics for Each outcome
% Loop over outcomes, see end of
% <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html
% ff_az_vf_vecsv> where these are created
for it_outcome_ctr=1:length(ar_st_pol_names)

    %% *f(y), f(c), f(a)*: Find p(outcome(states)), proability mass function for each outcome
    % Using from tools:
    % <https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html
    % fft_disc_rand_var_mass2outcomes>, compute unique sorted outcomes for
    % y(a,z) and find:
    %
    % $$ p(y,z) = \sum_{a} \left(1\left\{Y(a,z)=y\right\} \cdot p(a,z) \right)$$
    %
    % $$ p(y,a) = \sum_{z} \left(1\left\{Y(a,z)=y\right\} \cdot p(a,z) \right)$$
    %
    % $$ p(Y=y) = \sum_{a,z} \left( 1\left\{Y(a,z)=y\right\} \cdot p(a,z) \right)$$
    %
    % note: sum(mt_dist_az, 2) = result_map('cl_mt_pol_a'){2}, but not at
    % small simulation grids. These two might be different because pol_a is
    % based on a choices, mt_dist_az is based on a states
    %
    % see end of
    % <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html
    % ff_az_vf_vecsv> outcomes in result_map are cells with two elements,
    % first element is y(a,z), second element will be f(y) and y, generated
    % here.
    %

    st_cur_output_key = ar_st_pol_names(it_outcome_ctr);
    cl_mt_choice_cur = result_map(st_cur_output_key);
    mt_choice_cur = cl_mt_choice_cur{1};

    % run function from tools: fft_disc_rand_var_mass2outcomes
    % <https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html>
    bl_input_override = true;
    [ar_choice_prob_byY, ar_choice_unique_sorted_byY, mt_choice_prob_byYZ, mt_choice_prob_byYA] = ...
        fft_disc_rand_var_mass2outcomes(st_cur_output_key, mt_choice_cur, mt_dist_az, bl_input_override);

    %% *f(y), f(c), f(a)*: Compute Statistics for outcomes
    % Using from tools:
    % <https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html
    % fft_disc_rand_var_stats>, compute these outcomes:
    %
    % * $\mu_Y = E(Y) = \sum_{y} p(Y=y) \cdot y $
    % * $\sigma_Y = \sqrt{ \sum_{y} p(Y=y) \cdot \left( y - \mu_y \right)^2}$
    % * $p(y=0)$
    % * $p(y=\max(y))$
    % * percentiles: $min_{y} \left\{ P(Y \le y) - percentile \mid P(Y \le y) \ge percentile \right\}$
    % * fraction of outcome held by up to percentiles: $E(Y<y)/E(Y)$
    %

    % run function fft_disc_rand_var_stats.m from tools:
    % <https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html>
    [ds_stats_map] = fft_disc_rand_var_stats(st_cur_output_key, ar_choice_unique_sorted_byY', ar_choice_prob_byY', bl_display_drvstats);

    % prcess results
    % retrieve scalar statistics:
    fl_choice_mean = ds_stats_map('fl_choice_mean');
    fl_choice_sd = ds_stats_map('fl_choice_sd');
    fl_choice_coefofvar = ds_stats_map('fl_choice_coefofvar');
    fl_choice_min = ds_stats_map('fl_choice_min');
    fl_choice_max = ds_stats_map('fl_choice_max');    
    fl_choice_prob_zero = ds_stats_map('fl_choice_prob_zero');
    fl_choice_prob_below_zero = ds_stats_map('fl_choice_prob_below_zero');
    fl_choice_prob_above_zero = ds_stats_map('fl_choice_prob_above_zero');        
    fl_choice_prob_min = ds_stats_map('fl_choice_prob_min');
    fl_choice_prob_max = ds_stats_map('fl_choice_prob_max');
    % retrieve distributional array stats
    ar_choice_percentiles = ds_stats_map('ar_choice_percentiles');
    ar_choice_perc_fracheld = ds_stats_map('ar_choice_perc_fracheld');

    %% *f(y), f(c), f(a)*: Store Statistics Specific to Each Outcome
    % see intro section

    % Append prob mass functions to ds_stats_map
    ds_stats_map('mt_choice_prob_byYZ') = mt_choice_prob_byYZ;
    ds_stats_map('mt_choice_prob_byYA') = mt_choice_prob_byYA;
    ds_stats_map('ar_choice_unique_sorted_byY') = ar_choice_unique_sorted_byY;
    ds_stats_map('ar_choice_prob_byY') = ar_choice_prob_byY;
    % ds_stats_map is second element of cell for the key for the variable
    % in result_map
    cl_mt_choice_cur{2} = ds_stats_map;
    result_map(st_cur_output_key) = cl_mt_choice_cur;

    % key stats
    ar_keystats = [fl_choice_mean fl_choice_sd fl_choice_coefofvar fl_choice_min fl_choice_max ...
        fl_choice_prob_zero fl_choice_prob_below_zero fl_choice_prob_above_zero ...
        fl_choice_prob_min fl_choice_prob_max ar_choice_percentiles];
    cl_outcome_names(it_outcome_ctr) = st_cur_output_key;
    if (it_outcome_ctr == 1)
        mt_outcomes_meansdperc = ar_keystats;
        mt_outcomes_fracheld = ar_choice_perc_fracheld;
    else
        mt_outcomes_meansdperc = [mt_outcomes_meansdperc; ar_keystats];
        mt_outcomes_fracheld = [mt_outcomes_fracheld; ar_choice_perc_fracheld];
    end

end

if (bl_display_final_dist || bl_display_final_dist_detail)
    
    tb_outcomes_meansdperc = array2table(mt_outcomes_meansdperc);
    ar_fl_percentiles = ds_stats_map('ar_fl_percentiles');
    cl_col_names = ['mean', 'sd', 'coefofvar', 'min', 'max', ...
                    'pYis0', 'pYls0', 'pYgr0', 'pYisMINY', 'pYisMAXY', ...
                    strcat('p', string(ar_fl_percentiles))];
    tb_outcomes_meansdperc.Properties.VariableNames = matlab.lang.makeValidName(cl_col_names);
    tb_outcomes_meansdperc.Properties.RowNames = matlab.lang.makeValidName(cl_outcome_names);
    
    if (bl_display_final_dist_detail_local)    
        disp('xxx tb_outcomes_meansdperc: mean, sd, percentiles xxx')
        disp(rows2vars(tb_outcomes_meansdperc));
    end

    % Process Aset Held by up to percentiles    
    tb_outcomes_fracheld = array2table(mt_outcomes_fracheld);
    cl_col_names = [strcat('fracByP', string(ar_fl_percentiles))];
    tb_outcomes_fracheld.Properties.VariableNames = matlab.lang.makeValidName(cl_col_names);
    tb_outcomes_fracheld.Properties.RowNames = matlab.lang.makeValidName(cl_outcome_names);
    
    if (bl_display_final_dist_detail_local)    
        disp('xxx tb_outcomes_fracheld: fraction of asset/income/etc held by hh up to this percentile xxx')
        disp(rows2vars(tb_outcomes_fracheld));
    end
    
end

%% Covariance and Correlation
% Having computed elsewhere E(X), E(Y), and SD(X), SD(Y), and given X(a,z)
% and Y(a,z), which are the optimal choices along the endogenous state
% space grid a, and the exogenous state space grid z, and given also
% f(a,z), the probability mass function over (a,z), we compute covariance
% and correlation between outcomes X and Y. 
%
% * Covariance
%
% $$\mathrm{Cov}\left(x,y\right) = \sum_{a} \sum_{z} f(a,z) \cdot \left( x(a,z) - \mu_x \right) \cdot \left( y(a,z) - \mu_y \right)$$
%
% * Correlation
%
% $$\rho_{x,y} = \frac{\mathrm{Cov}\left(x,y\right)}{\sigma_x \cdot \sigma_y}$$

for it_outcome_x_ctr=1:length(ar_st_pol_names)
        
    st_cur_output_x_key = ar_st_pol_names(it_outcome_x_ctr);
    
    cl_mt_choice_cur = result_map(st_cur_output_x_key);
    ds_stats_map = cl_mt_choice_cur{2};

    cl_mt_choice_cur = result_map(st_cur_output_x_key);
    mt_choice_x_bystates = cl_mt_choice_cur{1};    
    fl_choice_x_mean = ds_stats_map('fl_choice_mean');
    fl_choice_x_sd = ds_stats_map('fl_choice_sd');    
    
    ar_covvar = zeros([1,length(ar_st_pol_names)*2]);
    ar_st_covvar = strings([1,length(ar_st_pol_names)*2]);
    for it_outcome_y_ctr=1:length(ar_st_pol_names)

        st_cur_output_y_key = ar_st_pol_names(it_outcome_y_ctr);

        cl_mt_choice_cur = result_map(st_cur_output_y_key);
        ds_stats_map = cl_mt_choice_cur{2};

        cl_mt_choice_cur = result_map(st_cur_output_y_key);
        mt_choice_y_bystates = cl_mt_choice_cur{1};        
        fl_choice_y_mean = ds_stats_map('fl_choice_mean');
        fl_choice_y_sd = ds_stats_map('fl_choice_sd');
        
        covvar_input_map = containers.Map('KeyType','char', 'ValueType','any');
        covvar_input_map('mt_choice_x_bystates') = mt_choice_x_bystates;
        covvar_input_map('mt_choice_y_bystates') = mt_choice_y_bystates;
        covvar_input_map('mt_dist_bystates') = mt_dist_az;
        covvar_input_map('fl_choice_x_mean') = fl_choice_x_mean;
        covvar_input_map('fl_choice_x_sd') = fl_choice_x_sd;
        covvar_input_map('fl_choice_y_mean') = fl_choice_y_mean;
        covvar_input_map('fl_choice_y_sd') = fl_choice_y_sd;
        
        [fl_cov_xy, fl_cor_xy] = fft_disc_rand_var_mass2covcor(covvar_input_map);
        
        % only include the y name, x name is from the row
        st_x_y_cov = strjoin(["fl_cov_" st_cur_output_y_key], '');
        st_x_y_cor = strjoin(["fl_cor_" st_cur_output_y_key], '');
        ds_stats_map(st_x_y_cov) = fl_cov_xy;
        ds_stats_map(st_x_y_cor) = fl_cor_xy;
        
        ar_covvar(it_outcome_y_ctr*2-1) = fl_cov_xy;
        ar_covvar(it_outcome_y_ctr*2) = fl_cor_xy;
        ar_st_covvar(it_outcome_y_ctr*2-1) = string(st_x_y_cov);
        ar_st_covvar(it_outcome_y_ctr*2) = string(st_x_y_cor);
        
        cl_mt_choice_cur{2} = ds_stats_map;
        result_map(st_cur_output_y_key) = cl_mt_choice_cur;        
    end    
    
    if (it_outcome_x_ctr == 1)
        mt_outcomes_covvar = ar_covvar;
    else
        mt_outcomes_covvar = [mt_outcomes_covvar; ar_covvar];
    end
    
end

if (bl_display_final_dist || bl_display_final_dist_detail)
    
    tb_outcomes_covvar = array2table(mt_outcomes_covvar);
    tb_outcomes_covvar.Properties.VariableNames = matlab.lang.makeValidName(ar_st_covvar);
    tb_outcomes_covvar.Properties.RowNames = matlab.lang.makeValidName(cl_outcome_names);
    
    if (bl_display_final_dist_detail_local)    
        disp('xxx tb_outcomes_covvar: variance correlation xxx')
        disp(rows2vars(tb_outcomes_covvar));
    end
    
end

%% *f(y), f(c), f(a)*: Store Statistics Shared Table All Outcomes

% Add to result_map
mt_outcomes = [mt_outcomes_meansdperc, mt_outcomes_covvar, mt_outcomes_fracheld];
result_map('mt_outcomes') = mt_outcomes;

if (bl_display_final_dist || bl_display_final_dist_detail)
    
    tb_outcomes = [tb_outcomes_meansdperc, tb_outcomes_covvar, tb_outcomes_fracheld];
    result_map('tb_outcomes') = tb_outcomes;        
    
    if (bl_display_final_dist_detail)
        disp(rows2vars(tb_outcomes));
    else
        disp(tb_outcomes);
    end
    
end
end

##### SOURCE END #####
--></body></html>