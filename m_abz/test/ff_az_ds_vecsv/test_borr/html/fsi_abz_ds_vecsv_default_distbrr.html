
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>With Interest Rate Shocks, What is the Distribution of the Borrowing Interest Rate</title><meta name="generator" content="MATLAB 9.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-08-07"><meta name="DC.source" content="fsi_abz_ds_vecsv_default_distbrr.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>With Interest Rate Shocks, What is the Distribution of the Borrowing Interest Rate</h1><!--introduction--><p><b>back to <a href="https://fanwangecon.github.io">Fan</a>'s <a href="https://fanwangecon.github.io/CodeDynaAsset/">Dynamic Assets Repository</a> Table of Content.</b></p><p>@seealso</p><div><ul><li>test speed: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_speed/html/fsi_abz_ds_vecsv_speed.html">fsi_abz_ds_vecsv_speed</a></li><li>test joint <b>RANDOM</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_joint/html/fsi_abz_ds_vecsv_joint_rand.html">fsi_abz_ds_vecsv_joint_rand</a></li></ul></div><div><ul><li>test price no default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_price/html/fsi_abz_ds_vecsv_price_nbc_cross.html">fsi_abz_ds_vecsv_price_nbc_cross</a></li><li>test price default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_price/html/fsi_abz_ds_vecsv_price_default_cross.html">fsi_abz_ds_vecsv_price_default_cross</a></li></ul></div><div><ul><li>test interest rate no default: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc.html">fsi_abz_ds_vecsv_nbc</a></li><li>test interest rate no default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc_cross.html">fsi_abz_ds_vecsv_nbc_cross</a></li><li>test interest rate no default <b>GRID</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc_grid.html">fsi_abz_ds_vecsv_nbc_grid</a></li><li>test interest rate default: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default.html">fsi_abz_ds_vecsv_default</a></li><li>test interest rate default <b>V(a,z)</b> Comparison: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default_compaz.html">fsi_abz_ds_vecsv_default_compaz</a></li><li>test interest rate default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default_cross.html">fsi_abz_ds_vecsv_default_cross</a></li><li>test interest rate default <b>GRID</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default_grid.html">fsi_abz_ds_vecsv_default_grid</a></li></ul></div><div><ul><li>test shock default (very low cmin): <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default_lowcmin.html">fsi_abz_ds_vecsv_shk_default_lowcmin</a></li><li>test shock no default: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_nbc.html">fsi_abz_ds_vecsv_shk_nbc</a></li><li>test shock no default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_nbc_cross.html">fsi_abz_ds_vecsv_shk_nbc_cross</a></li><li>test shock default: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default.html">fsi_abz_ds_vecsv_shk_default</a></li><li>test shock default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default_cross.html">fsi_abz_ds_vecsv_shk_default_cross</a></li></ul></div><div><ul><li>test preference no default: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_nbc.html">fsi_abz_ds_vecsv_pref_nbc</a></li><li>test preference no default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_nbc_cross.html">fsi_abz_ds_vecsv_pref_nbc_cross</a></li><li>test preference default: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default.html">fsi_abz_ds_vecsv_pref_default</a></li><li>test preference default <b>CROSS</b>: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default_cross.html">fsi_abz_ds_vecsv_pref_default_cross</a></li><li>test preference default (very low cmin): <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default_lowcmin.html">fsi_abz_ds_vecsv_pref_default_lowcmin</a></li></ul></div><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Solve the Model</a></li><li><a href="#2">Obtain The Joint Distribution of Shocks and Savings/Borrowing</a></li><li><a href="#3">Marginal Distributional of Realized Borrowing Interest Rate</a></li><li><a href="#4">Frac of Borrower for each R: P(a &lt;= 0 | z)</a></li><li><a href="#5">Graph</a></li></ul></div><h2 id="1">Solve the Model</h2><p>Wide interest rate difference between min and max, uniform exogenous distribution.</p><pre class="codeinput">clear <span class="string">all</span>;
close <span class="string">all</span>;

it_param_set = 9;
[param_map, support_map] = ffs_abz_set_default_param(it_param_set);
<span class="comment">% param_map('it_a_n') = 50;</span>
<span class="comment">% param_map('it_z_wage_n') = 15;</span>
param_map(<span class="string">'fl_z_r_borr_max'</span>) = 0.50;
param_map(<span class="string">'fl_z_r_borr_min'</span>) = 0.00;
<span class="comment">% param_map('st_z_r_borr_drv_prb_type') = 'unif';</span>
param_map(<span class="string">'st_z_r_borr_drv_prb_type'</span>) = <span class="string">'unif'</span>;
<span class="comment">% param_map('fl_z_r_borr_poiss_mean') = 10;</span>
param_map(<span class="string">'fl_z_r_borr_n'</span>) = 15;
param_map(<span class="string">'it_z_n'</span>) = param_map(<span class="string">'it_z_wage_n'</span>) * param_map(<span class="string">'fl_z_r_borr_n'</span>);

[armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map);
result_map = ff_abz_vf_vecsv(param_map, support_map, armt_map, func_map);
result_map = ff_az_ds_vecsv(param_map, support_map, armt_map, func_map, result_map);
</pre><pre class="codeoutput">Elapsed time is 18.751154 seconds.
Elapsed time is 48.188193 seconds.
                    mean       sd       coefofvar      min       max       pYis0       pYls0       pYgr0      pYisMINY      pYisMAXY        p0_1         p1           p5         p10        p15        p20        p25         p35        p50        p65       p75       p80       p85       p90       p95       p99      p99_9     fl_cov_cl_mt_val    fl_cor_cl_mt_val    fl_cov_cl_mt_pol_a    fl_cor_cl_mt_pol_a    fl_cov_cl_mt_coh    fl_cor_cl_mt_coh    fl_cov_cl_mt_pol_c    fl_cor_cl_mt_pol_c    fracByP0_1      fracByP1       fracByP5     fracByP10     fracByP15     fracByP20     fracByP25     fracByP35    fracByP50    fracByP65    fracByP75    fracByP80    fracByP85    fracByP90    fracByP95    fracByP99    fracByP99_9
                   ______    _______    _________    _______    ______    _______    _________    _______    __________    ___________    ________    _________    ________    _______    _______    _______    ________    _______    _______    _______    ______    ______    ______    ______    ______    ______    ______    ________________    ________________    __________________    __________________    ________________    ________________    __________________    __________________    ___________    ___________    __________    __________    __________    __________    __________    _________    _________    _________    _________    _________    _________    _________    _________    _________    ___________

    cl_mt_val      3.1995      1.643     0.51351     -18.519    14.897          0     0.019248    0.98075    4.3953e-12    -5.2878e-35     -1.8002     -0.62557     0.28635     1.1389     1.4318     1.9591      1.9803     2.7385     3.1357     3.7797    4.3132    4.5532    4.9143    5.3215    5.9502    7.0885    8.1805         2.6993                   1               1.5788               0.78191               1.4798             0.70622              0.57217               0.99367          -0.00067087     -0.0040562    -0.0026623        0.0181      0.032661      0.079252      0.093494     0.18667      0.29779      0.46322      0.58939      0.65585      0.73385      0.80884      0.89763      0.97633       0.99734  
    cl_mt_pol_a    0.8659      1.229      1.4193      -6.557    48.412    0.16861      0.04284    0.78855    5.2025e-12    -5.2878e-35    -0.20568    -0.086712           0          0          0          0    0.020638    0.16817    0.38947    0.75831    1.2009     1.496    1.8648    2.4549    3.4139    5.6269    8.3563         1.5788             0.78191               1.5104                     1               1.5259             0.97352              0.34276               0.79576           -0.0003154     -0.0016358    -0.0034988    -0.0034988    -0.0034988    -0.0034988    -0.0014641    0.015835     0.054796      0.14903      0.26322      0.34955      0.43602      0.56896      0.73179      0.92345       0.98916  
    cl_mt_coh      1.2072     1.2754      1.0564      -6.557     50.64    0.01124    0.0069353    0.98182      4.42e-12     1.8295e-35    -0.13007            0    0.091429    0.18286     0.2638    0.32534     0.40269    0.52401    0.73677     1.1447    1.5808    1.8709    2.2771    2.8504    3.8368    6.0876    8.9292         1.4798             0.70622               1.5259               0.97352               1.6265                   1              0.32449               0.72598          -0.00015061    -0.00034518     0.0016025     0.0077435      0.016098      0.028278      0.043822    0.082239       0.1603      0.27453      0.38654      0.45755      0.54277      0.64849      0.78471       0.9394       0.99174  
    cl_mt_pol_c    1.3013    0.35047     0.26932        0.01    4.8668          0            0          1    7.0231e-11    -5.2878e-35     0.46518      0.54193     0.71274    0.80847    0.96021    0.98747       1.045     1.1855     1.2951     1.4128    1.5103    1.5951    1.6839    1.7777    1.8899     2.117    2.3938        0.57217             0.99367              0.34276               0.79576              0.32449             0.72598              0.12283                     1           0.00033915      0.0040513      0.023875      0.059899       0.08984       0.14074       0.16471     0.25987      0.39194       0.5529      0.66434      0.73114      0.78749      0.85261      0.92212      0.98282       0.99811  

</pre><h2 id="2">Obtain The Joint Distribution of Shocks and Savings/Borrowing</h2><p>Even though the interest rate is exogenous, borrowing and savings decisions are endogenous and are a function of the borrowing rate. The realized borrowing interest rate distribution is only for households that are borrowing.</p><pre class="codeinput">ar_a = armt_map(<span class="string">'ar_a'</span>);
ar_z_r_borr_mesh_wage = armt_map(<span class="string">'ar_z_r_borr_mesh_wage'</span>);
ar_z_wage_mesh_r_borr = armt_map(<span class="string">'ar_z_wage_mesh_r_borr'</span>);
ar_z_r_borr_prob = armt_map(<span class="string">'ar_z_r_borr_prob'</span>);
ar_z_r_borr = armt_map(<span class="string">'ar_z_r_borr'</span>);

tb_outcomes = result_map(<span class="string">'tb_outcomes'</span>);
cl_mt_pol_a = result_map(<span class="string">'cl_mt_pol_a'</span>);
ds_stats_pol_a_map = cl_mt_pol_a{2};
ds_stats_pol_a_map_keys = ds_stats_pol_a_map.keys;

mt_choice_prob_byYZ = ds_stats_pol_a_map(<span class="string">'mt_choice_prob_byYZ'</span>);
ar_choice_unique_sorted_byY = ds_stats_pol_a_map(<span class="string">'ar_choice_unique_sorted_byY'</span>);

<span class="comment">% disp(mt_choice_prob_byYZ);</span>
<span class="keyword">if</span> (norm(sum(mt_choice_prob_byYZ,<span class="string">'all'</span>) - 1) &lt;= -1e-12)
    error(<span class="string">'error:sum(mt_choice_prob_byYZ,''all'') ~= 1'</span>);
<span class="keyword">end</span>
</pre><h2 id="3">Marginal Distributional of Realized Borrowing Interest Rate</h2><p>Adding up across borrowing levels for each borrowing rate shock</p><pre class="codeinput">it_z_wage_n = param_map(<span class="string">'it_z_wage_n'</span>);
fl_z_r_borr_n = param_map(<span class="string">'fl_z_r_borr_n'</span>);
[it_mt_row_n, it_mt_col_n] = size(mt_choice_prob_byYZ);

mt_choice_prob_byYrZ = zeros(it_mt_row_n, fl_z_r_borr_n);
ar_z_r_borr_dup = zeros(1, fl_z_r_borr_n);
<span class="keyword">for</span> it_z_r_borr_ctr=1:1:fl_z_r_borr_n

    it_start_col = it_z_wage_n*(it_z_r_borr_ctr-1) + 1;
    it_end_col = it_start_col + it_z_wage_n - 1;

    ar_z_r_borr_dup(it_z_r_borr_ctr) = ar_z_r_borr_mesh_wage(it_start_col);
    mt_choice_prob_byYrZ(:, it_z_r_borr_ctr) = sum(mt_choice_prob_byYZ(:, it_start_col:it_end_col),2);
<span class="keyword">end</span>


<span class="comment">% R must equal to what was set</span>
<span class="keyword">if</span> (ar_z_r_borr_dup ~= ar_z_r_borr)
    error(<span class="string">'error:ar_z_r_borr_dup ~= ar_z_r_borr'</span>);
<span class="keyword">end</span>

<span class="comment">% Sum Up Marginal Probability f(z), must equal to</span>
<span class="keyword">if</span> (norm(sum(mt_choice_prob_byYrZ,1)- ar_z_r_borr_prob) &lt;= -1e-12)
    error(<span class="string">'error:sum(mt_choice_prob_byYrZ,1) ~= ar_z_r_borr_prob'</span>);
<span class="keyword">end</span>

<span class="keyword">if</span> (norm(sum(mt_choice_prob_byYrZ,<span class="string">'all'</span>) - 1) &lt;= -1e-12)
    error(<span class="string">'error:sum(mt_choice_prob_byYrZ,''all'') ~= 1'</span>);
<span class="keyword">end</span>
</pre><h2 id="4">Frac of Borrower for each R: P(a &lt;= 0 | z)</h2><pre class="codeinput">ar_it_choice_unique_sorted_byY_neg = (ar_choice_unique_sorted_byY &lt; 0);
mt_choice_prob_byYrZ_borr = mt_choice_prob_byYrZ(ar_it_choice_unique_sorted_byY_neg,:);

<span class="comment">% ar_p_a_le_zr_r_borr = sum(P(a, z) 1(a &lt;=0))</span>
ar_p_a_le_zr_r_borr = sum(mt_choice_prob_byYrZ_borr, 1);

<span class="comment">% ar_p_a_le_zr_r_borr = sum(P( z | a &lt;=0))</span>
ar_p_r_borr = ar_p_a_le_zr_r_borr/sum(ar_p_a_le_zr_r_borr);

<span class="comment">% ar_e_a_le_zr_r_borr = sum(a*P(a, z) 1(a &lt;=0))</span>
ar_Ebr_le_zr_r_borr = sum((ar_choice_unique_sorted_byY(ar_choice_unique_sorted_byY &lt; 0) <span class="keyword">...</span>
                          + zeros(1,fl_z_r_borr_n)) .* mt_choice_prob_byYrZ_borr, 1);

<span class="comment">% share of total borrowing by r</span>
ar_Ebr_share_r_borr = ar_Ebr_le_zr_r_borr/sum(ar_Ebr_le_zr_r_borr);


disp(ar_z_r_borr_dup);
disp(ar_z_r_borr_prob);
disp(ar_p_r_borr);
disp(ar_Ebr_share_r_borr);
</pre><pre class="codeoutput">  Columns 1 through 7

         0    0.0357    0.0714    0.1071    0.1429    0.1786    0.2143

  Columns 8 through 14

    0.2500    0.2857    0.3214    0.3571    0.3929    0.4286    0.4643

  Column 15

    0.5000

  Columns 1 through 7

    0.0667    0.0667    0.0667    0.0667    0.0667    0.0667    0.0667

  Columns 8 through 14

    0.0667    0.0667    0.0667    0.0667    0.0667    0.0667    0.0667

  Column 15

    0.0667

  Columns 1 through 7

    0.2010    0.1838    0.1128    0.0966    0.0966    0.0635    0.0466

  Columns 8 through 14

    0.0453    0.0362    0.0233    0.0231    0.0203    0.0201    0.0185

  Column 15

    0.0126

  Columns 1 through 7

    0.2063    0.1849    0.1133    0.0984    0.0890    0.0593    0.0463

  Columns 8 through 14

    0.0442    0.0367    0.0253    0.0245    0.0205    0.0191    0.0178

  Column 15

    0.0144

</pre><h2 id="5">Graph</h2><pre class="codeinput">figure();
hold <span class="string">on</span>;
bar(ar_z_r_borr', [ar_z_r_borr_prob;ar_p_r_borr;ar_Ebr_share_r_borr]');
legend({<span class="string">'exogenous borrow rate distribution'</span>, <span class="string">'borrow rate distribution conditional on borrowing'</span>, <span class="string">'borrow volumn conditional on rate'</span>}, <span class="keyword">...</span>
        <span class="string">'Location'</span>, <span class="string">'northeast'</span>, <span class="string">'color'</span>, <span class="string">'none'</span>);
title({<span class="string">'Model With Exogenous Uniform Interest Rate Shocks'</span>, <span class="string">'Borrowing is Endogenous, Realized R dist. differs from exo rate dist'</span>})
ylabel(<span class="string">'Fractions'</span>)
xlabel(<span class="string">'Borrowing Interest Rates'</span>)
grid <span class="string">on</span>;
grid <span class="string">minor</span>;
</pre><img vspace="5" hspace="5" src="fsi_abz_ds_vecsv_default_distbrr_01.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% With Interest Rate Shocks, What is the Distribution of the Borrowing Interest Rate
% *back to <https://fanwangecon.github.io Fan>'s
% <https://fanwangecon.github.io/CodeDynaAsset/ Dynamic Assets Repository>
% Table of Content.*
%
% @seealso
%
% * test speed: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_speed/html/fsi_abz_ds_vecsv_speed.html fsi_abz_ds_vecsv_speed>
% * test joint *RANDOM*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_joint/html/fsi_abz_ds_vecsv_joint_rand.html fsi_abz_ds_vecsv_joint_rand>
%
% * test price no default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_price/html/fsi_abz_ds_vecsv_price_nbc_cross.html fsi_abz_ds_vecsv_price_nbc_cross>
% * test price default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_price/html/fsi_abz_ds_vecsv_price_default_cross.html fsi_abz_ds_vecsv_price_default_cross>
%
% * test interest rate no default: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc.html fsi_abz_ds_vecsv_nbc>
% * test interest rate no default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc_cross.html fsi_abz_ds_vecsv_nbc_cross>
% * test interest rate no default *GRID*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc_grid.html fsi_abz_ds_vecsv_nbc_grid>
% * test interest rate default: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default.html fsi_abz_ds_vecsv_default>
% * test interest rate default *V(a,z)* Comparison: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default_compaz.html fsi_abz_ds_vecsv_default_compaz>
% * test interest rate default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default_cross.html fsi_abz_ds_vecsv_default_cross>
% * test interest rate default *GRID*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default_grid.html fsi_abz_ds_vecsv_default_grid>
%
% * test shock default (very low cmin): <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default_lowcmin.html fsi_abz_ds_vecsv_shk_default_lowcmin>
% * test shock no default: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_nbc.html fsi_abz_ds_vecsv_shk_nbc>
% * test shock no default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_nbc_cross.html fsi_abz_ds_vecsv_shk_nbc_cross>
% * test shock default: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default.html fsi_abz_ds_vecsv_shk_default>
% * test shock default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default_cross.html fsi_abz_ds_vecsv_shk_default_cross>
%
% * test preference no default: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_nbc.html fsi_abz_ds_vecsv_pref_nbc>
% * test preference no default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_nbc_cross.html fsi_abz_ds_vecsv_pref_nbc_cross>
% * test preference default: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default.html fsi_abz_ds_vecsv_pref_default>
% * test preference default *CROSS*: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default_cross.html fsi_abz_ds_vecsv_pref_default_cross>
% * test preference default (very low cmin): <https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default_lowcmin.html fsi_abz_ds_vecsv_pref_default_lowcmin>
%

%% Solve the Model
% Wide interest rate difference between min and max, uniform exogenous
% distribution.

clear all;
close all;

it_param_set = 9;
[param_map, support_map] = ffs_abz_set_default_param(it_param_set);
% param_map('it_a_n') = 50;
% param_map('it_z_wage_n') = 15;
param_map('fl_z_r_borr_max') = 0.50;
param_map('fl_z_r_borr_min') = 0.00;
% param_map('st_z_r_borr_drv_prb_type') = 'unif';
param_map('st_z_r_borr_drv_prb_type') = 'unif';
% param_map('fl_z_r_borr_poiss_mean') = 10;
param_map('fl_z_r_borr_n') = 15;
param_map('it_z_n') = param_map('it_z_wage_n') * param_map('fl_z_r_borr_n');

[armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map);
result_map = ff_abz_vf_vecsv(param_map, support_map, armt_map, func_map);
result_map = ff_az_ds_vecsv(param_map, support_map, armt_map, func_map, result_map);

%% Obtain The Joint Distribution of Shocks and Savings/Borrowing
% Even though the interest rate is exogenous, borrowing and savings
% decisions are endogenous and are a function of the borrowing rate. The
% realized borrowing interest rate distribution is only for households that
% are borrowing. 

ar_a = armt_map('ar_a');
ar_z_r_borr_mesh_wage = armt_map('ar_z_r_borr_mesh_wage');
ar_z_wage_mesh_r_borr = armt_map('ar_z_wage_mesh_r_borr');
ar_z_r_borr_prob = armt_map('ar_z_r_borr_prob');
ar_z_r_borr = armt_map('ar_z_r_borr');

tb_outcomes = result_map('tb_outcomes');
cl_mt_pol_a = result_map('cl_mt_pol_a');
ds_stats_pol_a_map = cl_mt_pol_a{2};
ds_stats_pol_a_map_keys = ds_stats_pol_a_map.keys;

mt_choice_prob_byYZ = ds_stats_pol_a_map('mt_choice_prob_byYZ');
ar_choice_unique_sorted_byY = ds_stats_pol_a_map('ar_choice_unique_sorted_byY');

% disp(mt_choice_prob_byYZ);
if (norm(sum(mt_choice_prob_byYZ,'all') - 1) <= -1e-12)    
    error('error:sum(mt_choice_prob_byYZ,''all'') ~= 1');
end

%% Marginal Distributional of Realized Borrowing Interest Rate
% Adding up across borrowing levels for each borrowing rate shock

it_z_wage_n = param_map('it_z_wage_n');
fl_z_r_borr_n = param_map('fl_z_r_borr_n');
[it_mt_row_n, it_mt_col_n] = size(mt_choice_prob_byYZ);

mt_choice_prob_byYrZ = zeros(it_mt_row_n, fl_z_r_borr_n);
ar_z_r_borr_dup = zeros(1, fl_z_r_borr_n);
for it_z_r_borr_ctr=1:1:fl_z_r_borr_n
    
    it_start_col = it_z_wage_n*(it_z_r_borr_ctr-1) + 1;
    it_end_col = it_start_col + it_z_wage_n - 1;
    
    ar_z_r_borr_dup(it_z_r_borr_ctr) = ar_z_r_borr_mesh_wage(it_start_col);
    mt_choice_prob_byYrZ(:, it_z_r_borr_ctr) = sum(mt_choice_prob_byYZ(:, it_start_col:it_end_col),2);
end


% R must equal to what was set
if (ar_z_r_borr_dup ~= ar_z_r_borr)
    error('error:ar_z_r_borr_dup ~= ar_z_r_borr');
end

% Sum Up Marginal Probability f(z), must equal to 
if (norm(sum(mt_choice_prob_byYrZ,1)- ar_z_r_borr_prob) <= -1e-12)
    error('error:sum(mt_choice_prob_byYrZ,1) ~= ar_z_r_borr_prob');
end

if (norm(sum(mt_choice_prob_byYrZ,'all') - 1) <= -1e-12)
    error('error:sum(mt_choice_prob_byYrZ,''all'') ~= 1');
end

%% Frac of Borrower for each R: P(a <= 0 | z)

ar_it_choice_unique_sorted_byY_neg = (ar_choice_unique_sorted_byY < 0);
mt_choice_prob_byYrZ_borr = mt_choice_prob_byYrZ(ar_it_choice_unique_sorted_byY_neg,:);

% ar_p_a_le_zr_r_borr = sum(P(a, z) 1(a <=0))
ar_p_a_le_zr_r_borr = sum(mt_choice_prob_byYrZ_borr, 1);

% ar_p_a_le_zr_r_borr = sum(P( z | a <=0))
ar_p_r_borr = ar_p_a_le_zr_r_borr/sum(ar_p_a_le_zr_r_borr);

% ar_e_a_le_zr_r_borr = sum(a*P(a, z) 1(a <=0))
ar_Ebr_le_zr_r_borr = sum((ar_choice_unique_sorted_byY(ar_choice_unique_sorted_byY < 0) ...
                          + zeros(1,fl_z_r_borr_n)) .* mt_choice_prob_byYrZ_borr, 1);
                      
% share of total borrowing by r
ar_Ebr_share_r_borr = ar_Ebr_le_zr_r_borr/sum(ar_Ebr_le_zr_r_borr);

                      
disp(ar_z_r_borr_dup);
disp(ar_z_r_borr_prob);
disp(ar_p_r_borr);
disp(ar_Ebr_share_r_borr);

%% Graph 

figure();
hold on;
bar(ar_z_r_borr', [ar_z_r_borr_prob;ar_p_r_borr;ar_Ebr_share_r_borr]');
legend({'exogenous borrow rate distribution', 'borrow rate distribution conditional on borrowing', 'borrow volumn conditional on rate'}, ...
        'Location', 'northeast', 'color', 'none');
title({'Model With Exogenous Uniform Interest Rate Shocks', 'Borrowing is Endogenous, Realized R dist. differs from exo rate dist'})
ylabel('Fractions')
xlabel('Borrowing Interest Rates')
grid on;
grid minor;
##### SOURCE END #####
--></body></html>