
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Solve Save + Borr Dynamic Programming Problem (Loop)</title><meta name="generator" content="MATLAB 9.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-07-25"><meta name="DC.source" content="ff_abz_vf.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Solve Save + Borr Dynamic Programming Problem (Loop)</h1><!--introduction--><p><b>back to <a href="https://fanwangecon.github.io">Fan</a>'s <a href="https://fanwangecon.github.io/CodeDynaAsset/">Dynamic Assets Repository</a> Table of Content.</b></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">FF_ABZ_VF solve infinite horizon exo shock + endo asset problem</a></li><li><a href="#3">Default</a></li><li><a href="#4">Parse Parameters 1</a></li><li><a href="#5">Parse Parameters 2</a></li><li><a href="#6">Display Parameters</a></li><li><a href="#7">Initialize Output Matrixes</a></li><li><a href="#8">Initialize Convergence Conditions</a></li><li><a href="#9">Iterate Value Function</a></li><li><a href="#11">Iterate over a and z states</a></li><li><a href="#13">Store Optimal Choices and Value Given(a,z)</a></li><li><a href="#15">Check Tolerance and Continuation</a></li><li><a href="#17">Process Optimal Choices</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> result_map = ff_abz_vf(varargin)
</pre><h2 id="2">FF_ABZ_VF solve infinite horizon exo shock + endo asset problem</h2><p>This program solves the infinite horizon dynamic single asset and single shock problem with loops. This file contains codes that processes borrowing.</p><p>The borrowing problem is very similar to the savings problem. The code could be identical if one does not have to deal with default. The main addition here in comparison to the savings only code <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html">ff_az_vf</a> is the ability to deal with default.</p><p>@param param_map container parameter container</p><p>@param support_map container support container</p><p>@param armt_map container container with states, choices and shocks grids that are inputs for grid based solution algorithm</p><p>@param func_map container container with function handles for consumption cash-on-hand etc.</p><p>@return result_map container contains policy function matrix, value function matrix, iteration results, and policy function, value function and iteration results tables.</p><p>keys included in result_map:</p><div><ul><li>mt_val matrix states_n by shock_n matrix of converged value function grid</li><li>mt_pol_a matrix states_n by shock_n matrix of converged policy function grid</li><li>ar_val_diff_norm array if bl_post = true it_iter_last by 1 val function difference between iteration</li><li>ar_pol_diff_norm array if bl_post = true it_iter_last by 1 policy function difference between iterations</li><li>mt_pol_perc_change matrix if bl_post = true it_iter_last by shock_n the proportion of grid points at which policy function changed between current and last iteration for each element of shock</li></ul></div><p>@example</p><pre>  % Get Default Parameters
  it_param_set = 2;
  [param_map, support_map] = ffs_abz_set_default_param(it_param_set);
  % Chnage param_map keys for borrowing
  param_map('fl_b_bd') = -20; % borrow bound
  param_map('bl_default') = false; % true if allow for default
  param_map('fl_c_min') = 0.0001; % u(c_min) when default
  % Change Keys in param_map
  param_map('it_a_n') = 500;
  param_map('fl_z_r_borr_n') = 5;
  param_map('it_z_wage_n') = 15;
  param_map('it_z_n') = param_map('it_z_wage_n') * param_map('fl_z_r_borr_n');
  param_map('fl_a_max') = 100;
  param_map('fl_w') = 1.3;
  % Change Keys support_map
  support_map('bl_display') = false;
  support_map('bl_post') = true;
  support_map('bl_display_final') = false;
  % Call Program with external parameters that override defaults.
  ff_abz_vf(param_map, support_map);</pre><p>@include</p><div><ul><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html">ffs_abz_set_default_param</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_get_funcgrid.html">ffs_abz_get_funcgrid</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post.html">ff_az_vf_post</a></li></ul></div><p>@seealso</p><div><ul><li>save loop: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html">ff_az_vf</a></li><li>save vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vec.html">ff_az_vf_vec</a></li><li>save optimized-vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html">ff_az_vf_vecsv</a></li><li>save + borr loop: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html">ff_abz_vf</a></li><li>save + borr vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html">ff_abz_vf_vec</a></li><li>save + borr optimized-vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vecsv.html">ff_abz_vf_vecsv</a></li></ul></div><h2 id="3">Default</h2><div><ul><li>it_param_set = 1: quick test</li><li>it_param_set = 2: benchmark run</li><li>it_param_set = 3: benchmark profile</li><li>it_param_set = 4: press publish button</li></ul></div><pre class="codeinput">it_param_set = 4;
bl_input_override = true;
[param_map, support_map] = ffs_abz_set_default_param(it_param_set);

<span class="comment">% Note: param_map and support_map can be adjusted here or outside to override defaults</span>
param_map(<span class="string">'it_a_n'</span>) = 75;
param_map(<span class="string">'fl_z_r_borr_n'</span>) = 3;
param_map(<span class="string">'it_z_wage_n'</span>) = 5;
param_map(<span class="string">'it_z_n'</span>) = param_map(<span class="string">'it_z_wage_n'</span>) * param_map(<span class="string">'fl_z_r_borr_n'</span>);
<span class="comment">% param_map('fl_r_save') = 0.025;</span>
<span class="comment">% param_map('fl_r_borr') = 0.035;</span>

[armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override); <span class="comment">% 1 for override</span>
default_params = {param_map support_map armt_map func_map};
</pre><h2 id="4">Parse Parameters 1</h2><pre class="codeinput"><span class="comment">% if varargin only has param_map and support_map,</span>
params_len = length(varargin);
[default_params{1:params_len}] = varargin{:};
param_map = [param_map; default_params{1}];
support_map = [support_map; default_params{2}];
<span class="keyword">if</span> params_len &gt;= 1 &amp;&amp; params_len &lt;= 2
    <span class="comment">% If override param_map, re-generate armt and func if they are not</span>
    <span class="comment">% provided</span>
    bl_input_override = true;
    [armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override);
<span class="keyword">else</span>
    <span class="comment">% Override all</span>
    armt_map = [armt_map; default_params{3}];
    func_map = [func_map; default_params{4}];
<span class="keyword">end</span>

<span class="comment">% append function name</span>
st_func_name = <span class="string">'ff_abz_vf'</span>;
support_map(<span class="string">'st_profile_name_main'</span>) = [st_func_name support_map(<span class="string">'st_profile_name_main'</span>)];
support_map(<span class="string">'st_mat_name_main'</span>) = [st_func_name support_map(<span class="string">'st_mat_name_main'</span>)];
support_map(<span class="string">'st_img_name_main'</span>) = [st_func_name support_map(<span class="string">'st_img_name_main'</span>)];
</pre><h2 id="5">Parse Parameters 2</h2><pre class="codeinput"><span class="comment">% armt_map</span>
params_group = values(armt_map, {<span class="string">'ar_a'</span>, <span class="string">'mt_z_trans'</span>, <span class="string">'ar_z_r_borr_mesh_wage'</span>, <span class="string">'ar_z_wage_mesh_r_borr'</span>});
[ar_a, mt_z_trans, ar_z_r_borr_mesh_wage, ar_z_wage_mesh_r_borr] = params_group{:};

<span class="comment">% func_map</span>
params_group = values(func_map, {<span class="string">'f_util_log'</span>, <span class="string">'f_util_crra'</span>, <span class="string">'f_cons_checkcmin'</span>, <span class="string">'f_coh'</span>, <span class="string">'f_cons_coh'</span>});
[f_util_log, f_util_crra, f_cons_checkcmin, f_coh, f_cons_coh] = params_group{:};

<span class="comment">% param_map</span>
params_group = values(param_map, {<span class="string">'it_a_n'</span>, <span class="string">'it_z_n'</span>, <span class="string">'fl_crra'</span>, <span class="string">'fl_beta'</span>, <span class="string">'fl_c_min'</span>,<span class="keyword">...</span>
    <span class="string">'fl_nan_replace'</span>, <span class="string">'bl_default'</span>, <span class="string">'fl_default_aprime'</span>});
[it_a_n, it_z_n, fl_crra, fl_beta, fl_c_min, <span class="keyword">...</span>
    fl_nan_replace, bl_default, fl_default_aprime] = params_group{:};
params_group = values(param_map, {<span class="string">'it_maxiter_val'</span>, <span class="string">'fl_tol_val'</span>, <span class="string">'fl_tol_pol'</span>, <span class="string">'it_tol_pol_nochange'</span>});
[it_maxiter_val, fl_tol_val, fl_tol_pol, it_tol_pol_nochange] = params_group{:};

<span class="comment">% support_map</span>
params_group = values(support_map, {<span class="string">'bl_profile'</span>, <span class="string">'st_profile_path'</span>, <span class="keyword">...</span>
    <span class="string">'st_profile_prefix'</span>, <span class="string">'st_profile_name_main'</span>, <span class="string">'st_profile_suffix'</span>,<span class="keyword">...</span>
    <span class="string">'bl_time'</span>, <span class="string">'bl_display_defparam'</span>, <span class="string">'bl_display'</span>, <span class="string">'it_display_every'</span>, <span class="string">'bl_post'</span>});
[bl_profile, st_profile_path, <span class="keyword">...</span>
    st_profile_prefix, st_profile_name_main, st_profile_suffix, <span class="keyword">...</span>
    bl_time, bl_display_defparam, bl_display, it_display_every, bl_post] = params_group{:};
</pre><h2 id="6">Display Parameters</h2><pre class="codeinput"><span class="keyword">if</span>(bl_display_defparam)
    fft_container_map_display(param_map);
    fft_container_map_display(support_map);
<span class="keyword">end</span>
</pre><pre class="codeoutput">----------------------------------------
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Begin: Show all key and value pairs from container
CONTAINER NAME: PARAM_MAP
----------------------------------------
  Map with properties:

        Count: 35
      KeyType: char
    ValueType: any

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
----------------------------------------
----------------------------------------
pos = 1 ; key = bl_b_is_principle ; val = true
pos = 2 ; key = bl_default ; val = true
pos = 3 ; key = bl_loglin ; val = false
pos = 4 ; key = fl_a_max ; val = 50
pos = 5 ; key = fl_a_min ; val = 0
pos = 6 ; key = fl_b_bd ; val = -20
pos = 7 ; key = fl_beta ; val = 0.94
pos = 8 ; key = fl_c_min ; val = 0.01
pos = 9 ; key = fl_crra ; val = 1.5
pos = 10 ; key = fl_default_aprime ; val = 0
pos = 11 ; key = fl_loglin_threshold ; val = 1
pos = 12 ; key = fl_nan_replace ; val = -99999
pos = 13 ; key = fl_r_save ; val = 0.025
pos = 14 ; key = fl_tol_dist ; val = 1e-05
pos = 15 ; key = fl_tol_pol ; val = 1e-05
pos = 16 ; key = fl_tol_val ; val = 1e-05
pos = 17 ; key = fl_w ; val = 1.28
pos = 18 ; key = fl_z_r_borr_max ; val = 0.095
pos = 19 ; key = fl_z_r_borr_min ; val = 0.025
pos = 20 ; key = fl_z_r_borr_n ; val = 3
pos = 21 ; key = fl_z_r_borr_poiss_mean ; val = 10
pos = 22 ; key = fl_z_wage_mu ; val = 0
pos = 23 ; key = fl_z_wage_rho ; val = 0.8
pos = 24 ; key = fl_z_wage_sig ; val = 0.2
pos = 25 ; key = it_a_n ; val = 75
pos = 26 ; key = it_maxiter_dist ; val = 1000
pos = 27 ; key = it_maxiter_val ; val = 1000
pos = 28 ; key = it_tol_pol_nochange ; val = 25
pos = 29 ; key = it_trans_power_dist ; val = 1000
pos = 30 ; key = it_z_n ; val = 15
pos = 31 ; key = it_z_wage_n ; val = 5
pos = 32 ; key = st_analytical_stationary_type ; val = eigenvector
pos = 33 ; key = st_model ; val = abz
pos = 34 ; key = st_z_r_borr_drv_ele_type ; val = unif
pos = 35 ; key = st_z_r_borr_drv_prb_type ; val = poiss
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Scalars in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                              i     idx    value 
                              __    ___    ______

    bl_b_is_principle          1     1          1
    bl_default                 2     2          1
    bl_loglin                  3     3          0
    fl_a_max                   4     4         50
    fl_a_min                   5     5          0
    fl_b_bd                    6     6        -20
    fl_beta                    7     7       0.94
    fl_c_min                   8     8       0.01
    fl_crra                    9     9        1.5
    fl_default_aprime         10    10          0
    fl_loglin_threshold       11    11          1
    fl_nan_replace            12    12     -99999
    fl_r_save                 13    13      0.025
    fl_tol_dist               14    14      1e-05
    fl_tol_pol                15    15      1e-05
    fl_tol_val                16    16      1e-05
    fl_w                      17    17       1.28
    fl_z_r_borr_max           18    18      0.095
    fl_z_r_borr_min           19    19      0.025
    fl_z_r_borr_n             20    20          3
    fl_z_r_borr_poiss_mean    21    21         10
    fl_z_wage_mu              22    22          0
    fl_z_wage_rho             23    23        0.8
    fl_z_wage_sig             24    24        0.2
    it_a_n                    25    25         75
    it_maxiter_dist           26    26       1000
    it_maxiter_val            27    27       1000
    it_tol_pol_nochange       28    28         25
    it_trans_power_dist       29    29       1000
    it_z_n                    30    30         15
    it_z_wage_n               31    31          5

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Strings in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                                     i    idx
                                     _    ___

    st_analytical_stationary_type    1    32 
    st_model                         2    33 
    st_z_r_borr_drv_ele_type         3    34 
    st_z_r_borr_drv_prb_type         4    35 

----------------------------------------
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Begin: Show all key and value pairs from container
CONTAINER NAME: SUPPORT_MAP
----------------------------------------
  Map with properties:

        Count: 40
      KeyType: char
    ValueType: any

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
----------------------------------------
----------------------------------------
pos = 1 ; key = bl_display ; val = false
pos = 2 ; key = bl_display_defparam ; val = true
pos = 3 ; key = bl_display_dist ; val = false
pos = 4 ; key = bl_display_final ; val = true
pos = 5 ; key = bl_display_final_dist ; val = false
pos = 6 ; key = bl_display_final_dist_detail ; val = false
pos = 7 ; key = bl_display_funcgrids ; val = false
pos = 8 ; key = bl_graph ; val = true
pos = 9 ; key = bl_graph_coh_t_coh ; val = true
pos = 10 ; key = bl_graph_funcgrids ; val = false
pos = 11 ; key = bl_graph_onebyones ; val = true
pos = 12 ; key = bl_graph_pol_lvl ; val = true
pos = 13 ; key = bl_graph_pol_pct ; val = true
pos = 14 ; key = bl_graph_val ; val = true
pos = 15 ; key = bl_img_save ; val = false
pos = 16 ; key = bl_mat ; val = false
pos = 17 ; key = bl_post ; val = true
pos = 18 ; key = bl_profile ; val = false
pos = 19 ; key = bl_profile_dist ; val = false
pos = 20 ; key = bl_time ; val = true
pos = 21 ; key = it_display_every ; val = 5
pos = 22 ; key = it_display_final_colmax ; val = 15
pos = 23 ; key = it_display_final_rowmax ; val = 100
pos = 24 ; key = it_display_summmat_colmax ; val = 5
pos = 25 ; key = it_display_summmat_rowmax ; val = 5
pos = 26 ; key = st_img_name_main ; val = ff_abz_vf_default
pos = 27 ; key = st_img_path ; val = C:/Users/fan/CodeDynaAsset//m_abz//solve/img/
pos = 28 ; key = st_img_prefix ; val = 
pos = 29 ; key = st_img_suffix ; val = _p4.png
pos = 30 ; key = st_mat_name_main ; val = ff_abz_vf_default
pos = 31 ; key = st_mat_path ; val = C:/Users/fan/CodeDynaAsset//m_abz//solve/mat/
pos = 32 ; key = st_mat_prefix ; val = 
pos = 33 ; key = st_mat_suffix ; val = _p4
pos = 34 ; key = st_mat_test_path ; val = C:/Users/fan/CodeDynaAsset//m_abz//test/ff_az_ds_vecsv/mat/
pos = 35 ; key = st_matimg_path_root ; val = C:/Users/fan/CodeDynaAsset//m_abz/
pos = 36 ; key = st_profile_name_main ; val = ff_abz_vf_default
pos = 37 ; key = st_profile_path ; val = C:/Users/fan/CodeDynaAsset//m_abz//solve/profile/
pos = 38 ; key = st_profile_prefix ; val = 
pos = 39 ; key = st_profile_suffix ; val = _p4
pos = 40 ; key = st_title_prefix ; val = 
----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Scalars in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                                    i     idx    value
                                    __    ___    _____

    bl_display                       1     1        0 
    bl_display_defparam              2     2        1 
    bl_display_dist                  3     3        0 
    bl_display_final                 4     4        1 
    bl_display_final_dist            5     5        0 
    bl_display_final_dist_detail     6     6        0 
    bl_display_funcgrids             7     7        0 
    bl_graph                         8     8        1 
    bl_graph_coh_t_coh               9     9        1 
    bl_graph_funcgrids              10    10        0 
    bl_graph_onebyones              11    11        1 
    bl_graph_pol_lvl                12    12        1 
    bl_graph_pol_pct                13    13        1 
    bl_graph_val                    14    14        1 
    bl_img_save                     15    15        0 
    bl_mat                          16    16        0 
    bl_post                         17    17        1 
    bl_profile                      18    18        0 
    bl_profile_dist                 19    19        0 
    bl_time                         20    20        1 
    it_display_every                21    21        5 
    it_display_final_colmax         22    22       15 
    it_display_final_rowmax         23    23      100 
    it_display_summmat_colmax       24    24        5 
    it_display_summmat_rowmax       25    25        5 

----------------------------------------
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Strings in Container and Sizes and Basic Statistics
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                            i     idx
                            __    ___

    st_img_name_main         1    26 
    st_img_path              2    27 
    st_img_prefix            3    28 
    st_img_suffix            4    29 
    st_mat_name_main         5    30 
    st_mat_path              6    31 
    st_mat_prefix            7    32 
    st_mat_suffix            8    33 
    st_mat_test_path         9    34 
    st_matimg_path_root     10    35 
    st_profile_name_main    11    36 
    st_profile_path         12    37 
    st_profile_prefix       13    38 
    st_profile_suffix       14    39 
    st_title_prefix         15    40 

</pre><h2 id="7">Initialize Output Matrixes</h2><pre class="codeinput">mt_val_cur = zeros(length(ar_a),it_z_n);
mt_val = mt_val_cur - 1;
mt_pol_a = zeros(length(ar_a),it_z_n);
mt_pol_a_cur = mt_pol_a - 1;
</pre><h2 id="8">Initialize Convergence Conditions</h2><pre class="codeinput">bl_vfi_continue = true;
it_iter = 0;
ar_val_diff_norm = zeros([it_maxiter_val, 1]);
ar_pol_diff_norm = zeros([it_maxiter_val, 1]);
mt_pol_perc_change = zeros([it_maxiter_val, it_z_n]);
</pre><h2 id="9">Iterate Value Function</h2><p>Loop solution with 4 nested loops</p><div><ol><li>loop 1: over exogenous states</li><li>loop 2: over endogenous states</li><li>loop 3: over choices</li><li>loop 4: add future utility, integration--loop over future shocks</li></ol></div><pre class="codeinput"><span class="comment">% Start Profile</span>
<span class="keyword">if</span> (bl_profile)
    close <span class="string">all</span>;
    profile <span class="string">off</span>;
    profile <span class="string">on</span>;
<span class="keyword">end</span>

<span class="comment">% Start Timer</span>
<span class="keyword">if</span> (bl_time)
    tic;
<span class="keyword">end</span>

<span class="comment">% Utility at-Default/at-limiting-case-when-nodefault</span>
<span class="keyword">if</span> (fl_crra == 1)
    fl_u_cmin = f_util_log(fl_c_min);
<span class="keyword">else</span>
    fl_u_cmin = f_util_crra(fl_c_min);
<span class="keyword">end</span>


<span class="comment">% Value Function Iteration</span>
<span class="keyword">while</span> bl_vfi_continue
</pre><pre class="codeinput">    it_iter = it_iter + 1;
</pre><h2 id="11">Iterate over a and z states</h2><p>Solve Problem if Default: coh &lt; borr_bound, then: u(c_min) + EV(a'=0,z') these are the values for defaulter if do not borrow enough to pay debt: a'=0 if save more than what you have: a'=0 if borrowing, possible that all ar_val_cur values are u(cmin), when that is the case, utility equal to c_min, this means given current choice set, can only default, get utility at c_min level, and a' go to 0. See maximization over loop 3 choices for loop 1+2 states. see <a href="https://fanwangecon.github.io/CodeDynaAsset/docs/README_cminymin_borrsave.html">README_cminymin_borrsave</a> for additional discussions.</p><p>when default is not allowed, there should be exactly one element of the state space where we enter this condition. That is at a_min and z_min. At this point, the natural borrowing constraint when fully used up leads to c = 0. When default is not allowed, this is the limiting case. We solve the limiting case as if default is possible. see the figure here: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ffs_abz_get_funcgrid/test_borr/html/ffs_abz_get_funcgrid_nodefault.html">ffs_abz_get_funcgrid_nodefault</a>. For the figure under section <b>Generate Borrowing A Grid with Default</b>, there are no points to the lower right of the red horizontal and verticle lines, because no default is allowed. But the intersection of the two red lines is this limiting case where c = 0.</p><p>when default is allowed. See again <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ffs_abz_get_funcgrid/test_borr/html/ffs_abz_get_funcgrid_nodefault.html">ffs_abz_get_funcgrid_nodefault</a>. Again under section <b>Generate Borrowing A Grid with Default</b>, see that there is an area to the right bottom of the two blue horizontal and vertical lines. For all points in that area, the household has to default, they can not borrow even at max to get positive consumption. At other points higher than the blue horizontal line, it is also possible for defaulting to be the optimal choice.</p><pre class="codeinput">    <span class="comment">% loop 1: over exogenous states</span>
    <span class="keyword">for</span> it_z_i = 1:it_z_n

        <span class="comment">% Current Shock</span>
        fl_z_r_borr = ar_z_r_borr_mesh_wage(it_z_i);
        fl_z_wage = ar_z_wage_mesh_r_borr(it_z_i);

        <span class="comment">% loop 2: over endogenous states</span>
        <span class="keyword">for</span> it_a_j = 1:length(ar_a)
</pre><pre class="codeinput">            fl_a = ar_a(it_a_j);
            ar_val_cur = zeros(size(ar_a));

            <span class="comment">% calculate cash on hand</span>
            fl_coh = f_coh(fl_z_r_borr, fl_z_wage, fl_a);

            <span class="comment">% loop 3: over choices</span>
            <span class="keyword">for</span> it_ap_k = 1:length(ar_a)

                <span class="comment">% get next period asset choice</span>
                fl_ap = ar_a(it_ap_k);

                <span class="comment">% calculate consumption</span>
                fl_c = f_cons_coh(fl_coh, fl_ap);

                <span class="comment">% assign u(c)</span>
                <span class="keyword">if</span> (fl_c &lt;= fl_c_min)
                    <span class="keyword">if</span> (bl_default)
                        <span class="comment">% defaults</span>
                        <span class="comment">% current utility: only today u(cmin)</span>
                        ar_val_cur(it_ap_k) = fl_u_cmin;
                        <span class="comment">% transition out next period, debt wiped out</span>
                        <span class="keyword">for</span> it_az_q = 1:it_z_n
                            ar_val_cur(it_ap_k) = ar_val_cur(it_ap_k) + <span class="keyword">...</span>
                                fl_beta*mt_z_trans(it_z_i, it_az_q)*mt_val_cur((ar_a == fl_default_aprime), it_az_q);
                        <span class="keyword">end</span>
                    <span class="keyword">else</span>
                        <span class="comment">% if default is not allowed: v = fl_nan_replace</span>
                        ar_val_cur(it_ap_k) = fl_nan_replace;
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    <span class="comment">% Solve Optimization Problem: max_{a'} u(c(a,a',z)) + beta*EV(a',z')</span>
                    <span class="comment">% borrowed enough to pay debt (and borrowing limit not exceeded)</span>
                    <span class="comment">% saved only the coh available.</span>
                    <span class="comment">% current utility</span>
                    <span class="keyword">if</span> (fl_crra == 1)
                        ar_val_cur(it_ap_k) = f_util_log(fl_c);
                    <span class="keyword">else</span>
                        ar_val_cur(it_ap_k) = f_util_crra(fl_c);
                    <span class="keyword">end</span>
                    <span class="comment">% loop 4: add future utility, integration--loop over future shocks</span>
                    <span class="keyword">for</span> it_az_q = 1:it_z_n
                        ar_val_cur(it_ap_k) = ar_val_cur(it_ap_k) + <span class="keyword">...</span>
                            fl_beta*mt_z_trans(it_z_i, it_az_q)*mt_val_cur(it_ap_k, it_az_q);
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>

            <span class="comment">% optimal choice value</span>
            [fl_opti_val_z, fl_opti_idx_z] = max(ar_val_cur);
            fl_opti_aprime_z = ar_a(fl_opti_idx_z);
            fl_opti_c_z = f_cons_coh(fl_coh, fl_opti_aprime_z);

            <span class="comment">% Handle Default is optimal or not</span>
            <span class="keyword">if</span> (fl_opti_c_z &lt;= fl_c_min)
                <span class="keyword">if</span> (bl_default)
                    <span class="comment">% if defaulting is optimal choice, at these states, not required</span>
                    <span class="comment">% to default, non-default possible, but default could be optimal</span>
                    fl_opti_aprime_z = fl_default_aprime;
                <span class="keyword">else</span>
                    <span class="comment">% if default is not allowed, then next period same state as now</span>
                    <span class="comment">% this is absorbing state, this is the limiting case, single</span>
                    <span class="comment">% state space point, lowest a and lowest shock has this.</span>
                    fl_opti_aprime_z = fl_a;
                <span class="keyword">end</span>
            <span class="keyword">end</span>
</pre><h2 id="13">Store Optimal Choices and Value Given(a,z)</h2><pre class="codeinput">            mt_val(it_a_j,it_z_i) = fl_opti_val_z;
            mt_pol_a(it_a_j,it_z_i) = fl_opti_aprime_z;
</pre><pre class="codeinput">        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="15">Check Tolerance and Continuation</h2><pre class="codeinput">    <span class="comment">% Difference across iterations</span>
    ar_val_diff_norm(it_iter) = norm(mt_val - mt_val_cur);
    ar_pol_diff_norm(it_iter) = norm(mt_pol_a - mt_pol_a_cur);
    mt_pol_perc_change(it_iter, :) = sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n);

    <span class="comment">% Update</span>
    mt_val_cur = mt_val;
    mt_pol_a_cur = mt_pol_a;

    <span class="comment">% Print Iteration Results</span>
    <span class="keyword">if</span> (bl_display &amp;&amp; (rem(it_iter, it_display_every)==0))
        fprintf(<span class="string">'VAL it_iter:%d, fl_diff:%d, fl_diff_pol:%d\n'</span>, <span class="keyword">...</span>
            it_iter, ar_val_diff_norm(it_iter), ar_pol_diff_norm(it_iter));
        tb_valpol_iter = array2table([mean(mt_val_cur,1); mean(mt_pol_a_cur,1); <span class="keyword">...</span>
            mt_val_cur(it_a_n,:); mt_pol_a_cur(it_a_n,:)]);
        tb_valpol_iter.Properties.VariableNames = strcat(<span class="string">'z'</span>, string((1:size(mt_val_cur,2))));
        tb_valpol_iter.Properties.RowNames = {<span class="string">'mval'</span>, <span class="string">'map'</span>, <span class="string">'Hval'</span>, <span class="string">'Hap'</span>};
        disp(<span class="string">'mval = mean(mt_val_cur,1), average value over a'</span>)
        disp(<span class="string">'map  = mean(mt_pol_a_cur,1), average choice over a'</span>)
        disp(<span class="string">'Hval = mt_val_cur(it_a_n,:), highest a state val'</span>)
        disp(<span class="string">'Hap = mt_pol_a_cur(it_a_n,:), highest a state choice'</span>)
        disp(tb_valpol_iter);
    <span class="keyword">end</span>

    <span class="comment">% Continuation Conditions:</span>
    <span class="comment">% 1. if value function convergence criteria reached</span>
    <span class="comment">% 2. if policy function variation over iterations is less than</span>
    <span class="comment">% threshold</span>
    <span class="keyword">if</span> (it_iter == (it_maxiter_val + 1))
        bl_vfi_continue = false;
    <span class="keyword">elseif</span> ((it_iter == it_maxiter_val) || <span class="keyword">...</span>
            (ar_val_diff_norm(it_iter) &lt; fl_tol_val) || <span class="keyword">...</span>
            (sum(ar_pol_diff_norm(max(1, it_iter-it_tol_pol_nochange):it_iter)) &lt; fl_tol_pol))
        <span class="comment">% Fix to max, run again to save results if needed</span>
        it_iter_last = it_iter;
        it_iter = it_maxiter_val;
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>

<span class="comment">% End Timer</span>
<span class="keyword">if</span> (bl_time)
    toc;
<span class="keyword">end</span>

<span class="comment">% End Profile</span>
<span class="keyword">if</span> (bl_profile)
    profile <span class="string">off</span>
    profile <span class="string">viewer</span>
    st_file_name = [st_profile_prefix st_profile_name_main st_profile_suffix];
    profsave(profile(<span class="string">'info'</span>), strcat(st_profile_path, st_file_name));
<span class="keyword">end</span>
</pre><pre class="codeoutput">Elapsed time is 1084.251210 seconds.
</pre><h2 id="17">Process Optimal Choices</h2><pre class="codeinput">result_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
result_map(<span class="string">'mt_val'</span>) = mt_val;

result_map(<span class="string">'cl_mt_coh'</span>) = {f_coh(ar_z_r_borr_mesh_wage, ar_z_wage_mesh_r_borr, ar_a'), zeros(1)};
result_map(<span class="string">'cl_mt_pol_a'</span>) = {mt_pol_a, zeros(1)};
result_map(<span class="string">'cl_mt_pol_c'</span>) = {f_cons_checkcmin(ar_z_r_borr_mesh_wage, ar_z_wage_mesh_r_borr, ar_a', mt_pol_a), zeros(1)};
result_map(<span class="string">'ar_st_pol_names'</span>) = [<span class="string">"cl_mt_pol_a"</span>, <span class="string">"cl_mt_coh"</span>, <span class="string">"cl_mt_pol_c"</span>];

<span class="keyword">if</span> (bl_post)
    bl_input_override = true;
    result_map(<span class="string">'ar_val_diff_norm'</span>) = ar_val_diff_norm(1:it_iter_last);
    result_map(<span class="string">'ar_pol_diff_norm'</span>) = ar_pol_diff_norm(1:it_iter_last);
    result_map(<span class="string">'mt_pol_perc_change'</span>) = mt_pol_perc_change(1:it_iter_last, :);
    result_map = ff_az_vf_post(param_map, support_map, armt_map, func_map, result_map, bl_input_override);
<span class="keyword">end</span>
</pre><pre class="codeoutput">valgap = norm(mt_val - mt_val_cur): value function difference across iterations
polgap = norm(mt_pol_a - mt_pol_a_cur): policy function difference across iterations
z1 = z1 perc change: sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n): percentage of state space points conditional on shock where the policy function is changing across iterations
                valgap     polgap    zi1_zr_0_025_zw_0_33942    zi2_zr_0_025_zw_0_5596    zi3_zr_0_025_zw_0_92263    zi4_zr_0_025_zw_1_5212    zi5_zr_0_025_zw_2_508    zi6_zr_0_06_zw_0_33942    zi7_zr_0_06_zw_0_5596    zi8_zr_0_06_zw_0_92263    zi9_zr_0_06_zw_1_5212    zi10_zr_0_06_zw_2_508    zi11_zr_0_095_zw_0_33942    zi12_zr_0_095_zw_0_5596    zi13_zr_0_095_zw_0_92263    zi14_zr_0_095_zw_1_5212    zi15_zr_0_095_zw_2_508
               ________    ______    _______________________    ______________________    _______________________    ______________________    _____________________    ______________________    _____________________    ______________________    _____________________    _____________________    ________________________    _______________________    ________________________    _______________________    ______________________

    iter=1       67.943    633.02                  1                          1                         1                          1                        1                         1                        1                         1                        1                        1                          1                          1                           1                          1                          1       
    iter=2       56.856    680.51            0.98667                          1                   0.98667                          1                        1                   0.98667                  0.98667                   0.98667                  0.98667                        1                    0.97333                    0.97333                     0.98667                    0.98667                          1       
    iter=3       44.275    229.65               0.96                    0.97333                   0.97333                    0.98667                  0.98667                   0.97333                     0.96                   0.97333                     0.96                  0.97333                    0.94667                       0.96                     0.94667                    0.97333                    0.98667       
    iter=4       35.386    115.93               0.92                    0.93333                   0.93333                    0.93333                     0.96                      0.92                     0.92                      0.96                  0.93333                     0.96                    0.90667                    0.93333                        0.92                    0.93333                    0.94667       
    iter=5       29.311    68.447            0.86667                       0.88                   0.85333                       0.88                  0.90667                   0.85333                  0.86667                   0.90667                     0.88                  0.90667                    0.86667                    0.86667                     0.86667                    0.89333                    0.90667       
    iter=6       24.894    46.869            0.82667                    0.82667                       0.8                       0.84                  0.86667                   0.82667                  0.81333                       0.8                  0.81333                     0.84                    0.81333                    0.81333                     0.78667                    0.82667                       0.84       
    iter=7       21.502    34.579            0.70667                    0.74667                      0.76                       0.72                  0.74667                   0.69333                     0.72                   0.73333                     0.72                  0.74667                    0.70667                    0.73333                     0.73333                       0.72                       0.76       
    iter=8       18.762    25.146                0.6                    0.57333                   0.62667                    0.65333                  0.70667                      0.56                  0.58667                      0.64                     0.64                  0.69333                       0.56                       0.56                     0.62667                    0.66667                       0.72       
    iter=9       16.419    19.262            0.49333                    0.49333                   0.49333                    0.53333                  0.53333                   0.50667                     0.48                      0.52                  0.50667                  0.53333                    0.50667                    0.49333                        0.48                    0.50667                    0.53333       
    iter=10      14.453    21.144                0.4                    0.38667                   0.41333                    0.41333                  0.46667                   0.37333                  0.38667                   0.42667                      0.4                  0.45333                    0.38667                    0.38667                         0.4                    0.42667                       0.48       
    iter=11      12.785    13.462            0.34667                    0.33333                      0.32                    0.33333                  0.38667                   0.34667                  0.30667                      0.32                  0.30667                  0.37333                    0.33333                       0.32                     0.29333                       0.32                    0.38667       
    iter=12       11.33    11.691            0.29333                    0.29333                   0.29333                       0.28                     0.32                   0.26667                  0.26667                      0.28                  0.26667                  0.30667                    0.25333                       0.28                     0.29333                       0.28                       0.32       
    iter=13       10.02    9.3798            0.21333                    0.21333                       0.2                    0.21333                     0.24                      0.16                  0.18667                   0.21333                      0.2                  0.25333                    0.18667                    0.18667                     0.21333                        0.2                    0.25333       
    iter=14      8.8382    9.5885               0.24                    0.18667                   0.18667                    0.21333                  0.17333                   0.21333                      0.2                       0.2                  0.18667                  0.18667                    0.21333                    0.18667                         0.2                        0.2                       0.16       
    iter=15      7.7983    8.9079               0.16                       0.16                   0.17333                    0.18667                  0.22667                      0.16                     0.16                   0.17333                  0.18667                  0.25333                       0.16                    0.13333                     0.18667                    0.17333                    0.21333       
    iter=16      6.9092    6.8436            0.14667                    0.13333                   0.14667                    0.13333                     0.16                  0.093333                  0.14667                   0.17333                  0.13333                     0.16                    0.10667                       0.12                        0.16                    0.13333                       0.16       
    iter=17      6.1369    7.3892            0.13333                    0.14667                      0.12                    0.14667                     0.16                      0.12                  0.14667                      0.12                  0.14667                  0.14667                       0.12                       0.12                     0.13333                    0.13333                    0.13333       
    iter=18      5.5012    6.7121           0.093333                       0.12                      0.08                       0.12                  0.13333                  0.093333                  0.13333                      0.08                     0.12                  0.13333                   0.093333                       0.12                     0.10667                   0.093333                       0.12       
    iter=19      4.9599    6.9751               0.08                    0.10667                   0.10667                    0.10667                     0.12                      0.08                  0.10667                  0.093333                  0.10667                  0.14667                   0.093333                       0.12                    0.093333                    0.10667                       0.12       
    iter=20      4.5197    5.6267               0.08                       0.08                  0.093333                       0.08                 0.093333                      0.08                 0.093333                      0.08                 0.066667                     0.08                       0.08                       0.08                        0.08                   0.066667                       0.08       
    iter=21      4.1284    5.3153               0.04                       0.08                   0.10667                       0.08                 0.053333                      0.04                     0.08                  0.093333                 0.093333                 0.066667                       0.04                   0.066667                     0.10667                   0.066667                   0.053333       
    iter=22      3.7743     5.361               0.08                   0.026667                  0.093333                   0.053333                     0.08                  0.066667                 0.053333                  0.093333                     0.08                     0.08                       0.08                       0.04                    0.093333                   0.066667                   0.066667       
    iter=23      3.4529    4.5598               0.04                   0.066667                  0.053333                   0.066667                     0.08                  0.053333                 0.066667                  0.053333                 0.066667                 0.093333                       0.04                   0.066667                    0.053333                   0.053333                   0.066667       
    iter=24      3.1698    4.4744               0.04                   0.053333                      0.04                   0.053333                 0.053333                      0.04                 0.066667                  0.053333                 0.053333                 0.053333                       0.04                   0.066667                        0.04                   0.066667                   0.053333       
    iter=25      2.9145    4.5583               0.04                   0.066667                      0.04                       0.04                 0.066667                  0.053333                 0.053333                      0.04                     0.04                 0.066667                       0.04                   0.053333                        0.04                   0.053333                    0.10667       
    iter=26      2.6839    3.7356               0.04                   0.026667                  0.026667                       0.04                     0.04                      0.04                 0.026667                  0.026667                     0.04                     0.04                       0.04                   0.026667                    0.026667                   0.053333                   0.053333       
    iter=27      2.4782    4.3575               0.04                   0.053333                      0.04                   0.053333                 0.053333                      0.04                 0.053333                  0.053333                 0.053333                 0.053333                       0.04                   0.053333                    0.053333                   0.053333                   0.053333       
    iter=28      2.2918    4.1123           0.053333                   0.013333                      0.04                   0.053333                 0.026667                  0.053333                 0.013333                      0.04                 0.053333                 0.026667                   0.053333                   0.013333                        0.04                       0.04                   0.026667       
    iter=29       2.127    2.8767           0.026667                   0.013333                  0.013333                   0.026667                 0.013333                  0.026667                 0.013333                  0.013333                 0.026667                 0.026667                   0.026667                   0.013333                    0.013333                   0.026667                   0.013333       
    iter=30      1.9832    3.1966           0.013333                   0.013333                  0.026667                   0.013333                 0.026667                  0.013333                 0.013333                  0.026667                 0.013333                 0.026667                   0.013333                   0.013333                    0.026667                   0.026667                       0.04       
    iter=31      1.8545    2.9061           0.013333                   0.026667                      0.04                   0.013333                 0.026667                  0.013333                 0.026667                      0.04                 0.013333                 0.026667                   0.013333                   0.026667                        0.04                   0.013333                       0.04       
    iter=32      1.7407    2.6873           0.013333                   0.026667                  0.013333                   0.026667                 0.013333                  0.013333                 0.026667                  0.013333                 0.026667                 0.013333                   0.013333                   0.026667                    0.013333                   0.026667                   0.013333       
    iter=33      1.6388    2.6873           0.013333                   0.013333                  0.026667                   0.013333                 0.026667                  0.013333                 0.013333                  0.026667                 0.013333                 0.026667                   0.013333                   0.013333                    0.026667                   0.013333                   0.026667       
    iter=34       1.547    2.8767           0.013333                   0.013333                      0.04                   0.026667                 0.026667                  0.013333                 0.013333                      0.04                 0.026667                 0.026667                   0.013333                   0.013333                        0.04                   0.026667                   0.026667       
    iter=35      1.4626    1.6609           0.013333                   0.013333                  0.013333                          0                        0                  0.013333                 0.013333                  0.013333                        0                        0                   0.013333                   0.013333                    0.013333                          0                          0       
    iter=36       1.385    2.6873                  0                   0.013333                  0.013333                   0.013333                 0.026667                         0                 0.013333                  0.013333                 0.013333                 0.026667                          0                   0.013333                    0.013333                   0.013333                   0.026667       
    iter=37      1.3129    2.3488           0.026667                   0.013333                  0.013333                   0.026667                 0.013333                  0.026667                 0.013333                  0.013333                 0.026667                 0.013333                   0.026667                   0.013333                    0.013333                   0.026667                   0.013333       
    iter=38      1.2459    2.3488                  0                   0.013333                  0.026667                          0                 0.013333                         0                 0.013333                  0.026667                        0                 0.013333                          0                   0.013333                    0.026667                          0                   0.013333       
    iter=39      1.1832    2.3488           0.013333                   0.013333                  0.026667                   0.013333                 0.013333                  0.013333                 0.013333                  0.026667                 0.013333                 0.013333                   0.013333                   0.013333                    0.026667                   0.013333                   0.013333       
    iter=40      1.1245    2.6873           0.013333                   0.013333                         0                   0.013333                 0.026667                  0.013333                 0.013333                         0                 0.013333                 0.026667                   0.013333                   0.013333                           0                   0.013333                   0.026667       
    iter=41      1.0691    2.3488                  0                   0.013333                  0.026667                   0.026667                        0                         0                 0.013333                  0.026667                 0.013333                        0                          0                   0.013333                    0.026667                   0.013333                          0       
    iter=42      1.0169    1.6609           0.013333                          0                         0                   0.013333                 0.013333                  0.013333                        0                         0                 0.013333                 0.013333                   0.013333                          0                           0                   0.013333                   0.013333       
    iter=43      0.9677    1.6609                  0                   0.013333                         0                          0                 0.013333                         0                 0.013333                         0                        0                 0.013333                          0                   0.013333                           0                          0                   0.013333       
    iter=44       0.921    1.6609           0.013333                          0                  0.013333                   0.013333                 0.013333                  0.013333                        0                  0.013333                 0.013333                 0.013333                   0.013333                          0                    0.013333                   0.013333                   0.013333       
    iter=45     0.87676    1.6609                  0                   0.013333                         0                   0.013333                        0                         0                 0.013333                         0                 0.013333                        0                          0                   0.013333                           0                   0.013333                          0       
    iter=46     0.83476    1.6609           0.013333                          0                         0                          0                 0.013333                  0.013333                        0                         0                        0                 0.013333                   0.013333                          0                           0                          0                   0.013333       
    iter=47     0.79473    1.6609                  0                   0.013333                  0.013333                   0.013333                        0                         0                 0.013333                  0.013333                 0.013333                        0                          0                   0.013333                    0.013333                   0.013333                          0       
    iter=48     0.75657    2.3488                  0                          0                         0                          0                 0.026667                         0                        0                         0                        0                 0.026667                          0                          0                           0                          0                   0.026667       
    iter=49     0.72009    1.6609           0.013333                   0.013333                         0                   0.013333                        0                  0.013333                 0.013333                         0                 0.013333                        0                   0.013333                   0.013333                           0                   0.013333                          0       
    iter=50      0.6852    1.6609                  0                          0                         0                          0                 0.013333                         0                        0                         0                        0                 0.013333                          0                          0                           0                          0                   0.013333       
    iter=51     0.65182    1.6609                  0                   0.013333                         0                          0                        0                         0                 0.013333                         0                        0                        0                          0                   0.013333                           0                          0                          0       
    iter=52     0.61976    1.6609           0.013333                   0.013333                  0.013333                   0.013333                        0                  0.013333                 0.013333                  0.013333                 0.013333                        0                   0.013333                   0.013333                    0.013333                   0.013333                          0       
    iter=53     0.58897    1.6609                  0                          0                         0                          0                 0.013333                         0                        0                         0                        0                 0.013333                          0                          0                           0                          0                   0.013333       
    iter=54     0.55942    1.6609                  0                   0.013333                         0                   0.013333                        0                         0                 0.013333                         0                 0.013333                        0                          0                   0.013333                           0                   0.013333                          0       
    iter=55     0.53101    1.6609                  0                          0                         0                          0                 0.013333                         0                        0                         0                        0                 0.013333                          0                          0                           0                          0                   0.013333       
    iter=56     0.50373    1.6609           0.013333                          0                         0                          0                        0                  0.013333                        0                         0                        0                        0                   0.013333                          0                           0                          0                          0       
    iter=57     0.47757         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=58     0.45245    1.6609                  0                   0.013333                         0                   0.013333                 0.013333                         0                 0.013333                         0                 0.013333                 0.013333                          0                   0.013333                           0                   0.013333                   0.013333       
    iter=59     0.42839         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=60     0.40537         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=61     0.38337         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=62     0.36238         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=63     0.34235    1.6609                  0                          0                         0                   0.013333                 0.013333                         0                        0                         0                 0.013333                 0.013333                          0                          0                           0                   0.013333                   0.013333       
    iter=64     0.32328         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=65     0.30516    1.6609                  0                   0.013333                         0                          0                        0                         0                 0.013333                         0                        0                        0                          0                   0.013333                           0                          0                          0       
    iter=66     0.28795         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=67     0.27162         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=68     0.25614         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=69     0.24148         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=70      0.2276         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=71     0.21447         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=72     0.20206         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=73     0.19033         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=74     0.17925         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=75      0.1688         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=76     0.15893         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=77     0.14961         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=78     0.14083         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=79     0.13255         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=80     0.12474         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=81     0.11739         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=82     0.11045         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=83     0.10392         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=84    0.097771         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=85    0.091978         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=86    0.086523         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=87    0.081387         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=88    0.076553         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=89    0.072002         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=90    0.067719         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       
    iter=91    0.063688         0                  0                          0                         0                          0                        0                         0                        0                         0                        0                        0                          0                          0                           0                          0                          0       

tb_val: V(a,z) value at each state space point
                     zi1_zr_0_025_zw_0_33942    zi2_zr_0_025_zw_0_5596    zi3_zr_0_025_zw_0_92263    zi4_zr_0_025_zw_1_5212    zi5_zr_0_025_zw_2_508    zi6_zr_0_06_zw_0_33942    zi7_zr_0_06_zw_0_5596    zi8_zr_0_06_zw_0_92263    zi9_zr_0_06_zw_1_5212    zi10_zr_0_06_zw_2_508    zi11_zr_0_095_zw_0_33942    zi12_zr_0_095_zw_0_5596    zi13_zr_0_095_zw_0_92263    zi14_zr_0_095_zw_1_5212    zi15_zr_0_095_zw_2_508
                     _______________________    ______________________    _______________________    ______________________    _____________________    ______________________    _____________________    ______________________    _____________________    _____________________    ________________________    _______________________    ________________________    _______________________    ______________________

    a1=-20                    -18.77                   -17.396                    -15.312                    -13.345                  -10.656                    -18.77                  -17.396                   -15.844                   -13.996                 -11.096                     -18.77                    -17.396                     -15.844                    -14.411                     -11.65       
    a2=-19.0411              -17.208                   -15.896                    -14.439                    -12.703                  -9.9081                    -18.77                  -16.809                   -14.891                   -13.188                  -10.35                     -18.77                    -17.396                     -15.844                    -13.592                    -10.835       
    a3=-18.0822               -16.57                   -15.423                    -13.982                     -11.93                  -9.1455                   -16.896                  -15.676                   -14.298                   -12.449                 -9.5464                     -17.63                    -16.159                     -14.591                    -12.889                    -10.087       
    a4=-17.1233              -15.935                   -14.618                    -13.168                    -11.224                  -8.3053                   -16.443                  -15.312                   -13.536                   -11.687                 -8.7716                    -16.661                    -15.496                     -14.171                    -12.063                    -9.2839       
    a5=-16.1644              -15.183                   -14.041                    -12.616                    -10.474                  -7.4752                   -15.601                  -14.378                   -12.989                   -10.887                 -7.9208                    -16.113                    -14.736                     -13.239                     -11.31                    -8.5093       
    a6=-15.2055              -14.525                   -13.276                    -11.854                    -9.7584                  -6.6329                   -14.839                  -13.791                   -12.152                   -10.127                 -7.0816                    -15.272                      -14.1                     -12.695                    -10.518                    -7.5799       
    a7=-14.2466              -13.801                   -12.668                    -11.221                     -9.021                  -5.7632                   -14.173                  -13.018                   -11.529                    -9.349                 -6.2314                     -14.54                    -13.286                     -11.861                    -9.7658                    -6.6496       
    a8=-13.2877              -13.069                   -11.902                    -10.507                    -8.2908                  -4.8267                   -13.441                   -12.31                   -10.745                   -8.5821                 -5.3548                    -13.752                    -12.635                     -11.154                    -8.9954                    -5.7073       
    a9=-12.3288               -12.36                   -11.247                    -9.7625                    -7.5539                  -3.8859                   -12.703                  -11.604                   -10.034                   -7.8118                 -4.4124                    -12.968                    -11.829                     -10.376                    -8.2354                    -4.7101       
    a10=-11.3699             -11.606                   -10.498                    -8.9748                     -6.623                  -2.9569                   -11.988                  -10.809                   -9.2781                    -6.909                 -3.4665                    -12.213                    -11.141                     -9.5644                    -7.2787                    -3.7179       
    a11=-10.411              -10.898                   -9.7968                    -8.1578                    -5.7034                  -2.0367                   -11.229                  -10.067                   -8.4875                   -5.9784                 -2.5156                     -11.42                    -10.361                     -8.7271                    -6.2825                    -2.7451       
    a12=-9.45205             -10.144                   -9.0441                    -7.3308                    -4.8028                  -1.1116                   -10.485                  -9.2768                   -7.6682                   -5.0618                 -1.5139                    -10.677                    -9.6333                     -7.8681                    -5.3119                    -1.7872       
    a13=-8.49315             -9.4284                   -8.3118                    -6.4961                     -3.914                 -0.15751                   -9.7155                  -8.5107                   -6.8395                   -4.1644                -0.49356                    -9.8938                    -8.8045                     -7.0053                    -4.3693                   -0.82956       
    a14=-7.53425             -8.6626                   -7.5233                    -5.6548                    -3.0235                  0.81206                   -8.9021                  -7.6915                   -5.9899                   -3.2792                 0.53376                    -9.1514                    -7.9249                     -6.1399                    -3.4458                    0.15295       
    a15=-6.57534             -7.8927                   -6.6997                    -4.8026                    -2.0712                     1.77                   -8.0898                  -6.8398                   -5.0742                   -2.3923                  1.5424                    -8.3623                    -7.0238                     -5.2721                    -2.5263                     1.2056       
    a16=-5.61644             -7.0929                   -5.8559                    -3.9357                   -0.94528                   2.6664                   -7.2521                  -5.9704                    -4.152                   -1.2515                  2.4837                    -7.4631                    -6.1133                      -4.397                    -1.5498                     2.2339       
    a17=-4.65753             -6.2362                   -4.9996                    -2.8532                    0.19568                   3.4437                   -6.3613                  -5.0906                   -3.0212                 -0.037933                  3.3009                    -6.5173                    -5.1991                     -3.2421                   -0.36961                     3.1186       
    a18=-3.69863             -5.3503                   -4.0513                    -1.6708                     1.2186                    4.135                   -5.4447                  -4.1509                   -1.7961                     1.047                  4.0278                    -5.5561                    -4.2301                     -1.9496                    0.82555                     3.8991       
    a19=-2.73973             -4.4338                   -3.0079                   -0.56627                     2.1402                   4.7173                   -4.5004                  -3.1463                  -0.65368                    2.0222                  4.6421                    -4.5751                    -3.2005                    -0.75442                     1.8815                     4.5565       
    a20=-1.78082             -3.4828                   -1.9685                    0.46408                     2.9705                   5.2193                   -3.5241                  -2.0903                   0.41041                     2.899                  5.1797                    -3.5684                    -2.1527                     0.35186                     2.8194                     5.1391       
    a21=-0.821918            -2.5087                   -0.7956                     1.4933                      3.686                    5.625                   -2.5268                 -0.84676                    1.4698                    3.6607                  5.6163                    -2.5456                   -0.90135                      1.4454                     3.6344                     5.6074       
    a22=0                    -1.5426                   0.24052                     2.3153                     4.1648                   5.9549                   -1.5426                  0.24052                    2.3153                    4.1648                  5.9549                    -1.5426                    0.24052                      2.3153                     4.1648                     5.9549       
    a23=0.136986             -1.4077                   0.44284                     2.4242                     4.2193                   5.9984                   -1.4077                  0.44284                    2.4242                    4.2193                  5.9984                    -1.4077                    0.44284                      2.4242                     4.2193                     5.9984       
    a24=1.09589             -0.29588                    1.2386                     2.9723                     4.6661                   6.3492                  -0.29588                   1.2386                    2.9723                    4.6661                  6.3492                   -0.29588                     1.2386                      2.9723                     4.6661                     6.3492       
    a25=2.05479               0.6433                    1.9563                     3.4754                     5.0794                   6.6827                    0.6433                   1.9563                    3.4754                    5.0794                  6.6827                     0.6433                     1.9563                      3.4754                     5.0794                     6.6827       
    a26=3.0137                1.4556                    2.6041                     3.9384                     5.4634                   7.0052                    1.4556                   2.6041                    3.9384                    5.4634                  7.0052                     1.4556                     2.6041                      3.9384                     5.4634                     7.0052       
    a27=3.9726                2.1699                      3.19                     4.3862                      5.835                   7.3166                    2.1699                     3.19                    4.3862                     5.835                  7.3166                     2.1699                       3.19                      4.3862                      5.835                     7.3166       
    a28=4.93151               2.8055                    3.7261                     4.8204                     6.1953                   7.6162                    2.8055                   3.7261                    4.8204                    6.1953                  7.6162                     2.8055                     3.7261                      4.8204                     6.1953                     7.6162       
    a29=5.89041               3.3779                    4.2219                     5.2383                     6.5425                   7.9037                    3.3779                   4.2219                    5.2383                    6.5425                  7.9037                     3.3779                     4.2219                      5.2383                     6.5425                     7.9037       
    a30=6.84932               3.8992                    4.6839                     5.6387                     6.8759                   8.1794                    3.8992                   4.6839                    5.6387                    6.8759                  8.1794                     3.8992                     4.6839                      5.6387                     6.8759                     8.1794       
    a31=7.80822               4.3788                    5.1167                     6.0213                     7.1951                   8.4434                    4.3788                   5.1167                    6.0213                    7.1951                  8.4434                     4.3788                     5.1167                      6.0213                     7.1951                     8.4434       
    a32=8.76712               4.8237                    5.5238                     6.3864                     7.5006                   8.6964                    4.8237                   5.5238                    6.3864                    7.5006                  8.6964                     4.8237                     5.5238                      6.3864                     7.5006                     8.6964       
    a33=9.72603               5.2391                    5.9081                     6.7343                     7.7926                   8.9389                    5.2391                   5.9081                    6.7343                    7.7926                  8.9389                     5.2391                     5.9081                      6.7343                     7.7926                     8.9389       
    a34=10.6849                5.629                    6.2716                     7.0659                     8.0718                   9.1715                     5.629                   6.2716                    7.0659                    8.0718                  9.1715                      5.629                     6.2716                      7.0659                     8.0718                     9.1715       
    a35=11.6438               5.9966                    6.6163                      7.382                     8.3388                   9.3947                    5.9966                   6.6163                     7.382                    8.3388                  9.3947                     5.9966                     6.6163                       7.382                     8.3388                     9.3947       
    a36=12.6027               6.3442                    6.9436                     7.6833                     8.5944                   9.6093                    6.3442                   6.9436                    7.6833                    8.5944                  9.6093                     6.3442                     6.9436                      7.6833                     8.5944                     9.6093       
    a37=13.5616               6.6739                     7.255                     7.9707                     8.8391                   9.8159                    6.6739                    7.255                    7.9707                    8.8391                  9.8159                     6.6739                      7.255                      7.9707                     8.8391                     9.8159       
    a38=14.5205               6.9872                    7.5515                     8.2452                     9.0736                   10.015                    6.9872                   7.5515                    8.2452                    9.0736                  10.015                     6.9872                     7.5515                      8.2452                     9.0736                     10.015       
    a39=15.4795               7.2879                    7.8344                     8.5074                     9.2987                   10.209                    7.2879                   7.8344                    8.5074                    9.2987                  10.209                     7.2879                     7.8344                      8.5074                     9.2987                     10.209       
    a40=16.4384               7.5813                    8.1045                     8.7582                     9.5149                   10.397                    7.5813                   8.1045                    8.7582                    9.5149                  10.397                     7.5813                     8.1045                      8.7582                     9.5149                     10.397       
    a41=17.3973               7.8624                    8.3631                     8.9982                     9.7232                   10.582                    7.8624                   8.3631                    8.9982                    9.7232                  10.582                     7.8624                     8.3631                      8.9982                     9.7232                     10.582       
    a42=18.3562               8.1345                    8.6108                     9.2283                     9.9287                   10.763                    8.1345                   8.6108                    9.2283                    9.9287                  10.763                     8.1345                     8.6108                      9.2283                     9.9287                     10.763       
    a43=19.3151               8.3952                    8.8484                     9.4496                      10.13                    10.94                    8.3952                   8.8484                    9.4496                     10.13                   10.94                     8.3952                     8.8484                      9.4496                      10.13                      10.94       
    a44=20.274                8.6467                    9.0813                     9.6629                     10.327                   11.113                    8.6467                   9.0813                    9.6629                    10.327                  11.113                     8.6467                     9.0813                      9.6629                     10.327                     11.113       
    a45=21.2329               8.8879                    9.3063                     9.8691                     10.518                   11.283                    8.8879                   9.3063                    9.8691                    10.518                  11.283                     8.8879                     9.3063                      9.8691                     10.518                     11.283       
    a46=22.1918               9.1221                     9.526                     10.069                     10.704                   11.451                    9.1221                    9.526                    10.069                    10.704                  11.451                     9.1221                      9.526                      10.069                     10.704                     11.451       
    a47=23.1507               9.3475                    9.7383                     10.263                     10.884                   11.615                    9.3475                   9.7383                    10.263                    10.884                  11.615                     9.3475                     9.7383                      10.263                     10.884                     11.615       
    a48=24.1096               9.5669                    9.9453                     10.451                      11.06                   11.774                    9.5669                   9.9453                    10.451                     11.06                  11.774                     9.5669                     9.9453                      10.451                      11.06                     11.774       
    a49=25.0685               9.7785                    10.145                     10.633                     11.231                   11.929                    9.7785                   10.145                    10.633                    11.231                  11.929                     9.7785                     10.145                      10.633                     11.231                     11.929       
    a50=26.0274               9.9846                     10.34                     10.811                     11.397                   12.079                    9.9846                    10.34                    10.811                    11.397                  12.079                     9.9846                      10.34                      10.811                     11.397                     12.079       
    a51=26.9863               10.184                    10.529                     10.983                     11.558                   12.226                    10.184                   10.529                    10.983                    11.558                  12.226                     10.184                     10.529                      10.983                     11.558                     12.226       
    a52=27.9452               10.378                    10.713                     11.151                     11.715                   12.369                    10.378                   10.713                    11.151                    11.715                  12.369                     10.378                     10.713                      11.151                     11.715                     12.369       
    a53=28.9041               10.565                    10.892                     11.315                     11.868                   12.508                    10.565                   10.892                    11.315                    11.868                  12.508                     10.565                     10.892                      11.315                     11.868                     12.508       
    a54=29.863                10.748                    11.065                     11.476                     12.017                   12.643                    10.748                   11.065                    11.476                    12.017                  12.643                     10.748                     11.065                      11.476                     12.017                     12.643       
    a55=30.8219               10.926                    11.234                     11.634                     12.163                   12.776                    10.926                   11.234                    11.634                    12.163                  12.776                     10.926                     11.234                      11.634                     12.163                     12.776       
    a56=31.7808               11.098                    11.399                     11.789                     12.305                   12.906                    11.098                   11.399                    11.789                    12.305                  12.906                     11.098                     11.399                      11.789                     12.305                     12.906       
    a57=32.7397               11.266                    11.559                      11.94                     12.445                   13.033                    11.266                   11.559                     11.94                    12.445                  13.033                     11.266                     11.559                       11.94                     12.445                     13.033       
    a58=33.6986                11.43                    11.716                     12.088                     12.581                   13.157                     11.43                   11.716                    12.088                    12.581                  13.157                      11.43                     11.716                      12.088                     12.581                     13.157       
    a59=34.6575               11.589                    11.869                     12.233                     12.715                   13.279                    11.589                   11.869                    12.233                    12.715                  13.279                     11.589                     11.869                      12.233                     12.715                     13.279       
    a60=35.6164               11.744                    12.018                     12.375                     12.845                   13.399                    11.744                   12.018                    12.375                    12.845                  13.399                     11.744                     12.018                      12.375                     12.845                     13.399       
    a61=36.5753               11.895                    12.164                     12.514                     12.974                   13.516                    11.895                   12.164                    12.514                    12.974                  13.516                     11.895                     12.164                      12.514                     12.974                     13.516       
    a62=37.5342               12.043                    12.306                      12.65                     13.099                   13.631                    12.043                   12.306                     12.65                    13.099                  13.631                     12.043                     12.306                       12.65                     13.099                     13.631       
    a63=38.4932               12.187                    12.446                     12.783                     13.222                   13.744                    12.187                   12.446                    12.783                    13.222                  13.744                     12.187                     12.446                      12.783                     13.222                     13.744       
    a64=39.4521               12.328                    12.582                     12.914                     13.343                   13.854                    12.328                   12.582                    12.914                    13.343                  13.854                     12.328                     12.582                      12.914                     13.343                     13.854       
    a65=40.411                12.465                    12.715                     13.041                     13.461                   13.962                    12.465                   12.715                    13.041                    13.461                  13.962                     12.465                     12.715                      13.041                     13.461                     13.962       
    a66=41.3699                 12.6                    12.846                     13.167                     13.577                   14.069                      12.6                   12.846                    13.167                    13.577                  14.069                       12.6                     12.846                      13.167                     13.577                     14.069       
    a67=42.3288               12.731                    12.974                     13.289                      13.69                   14.173                    12.731                   12.974                    13.289                     13.69                  14.173                     12.731                     12.974                      13.289                      13.69                     14.173       
    a68=43.2877                12.86                    13.099                     13.409                     13.801                   14.275                     12.86                   13.099                    13.409                    13.801                  14.275                      12.86                     13.099                      13.409                     13.801                     14.275       
    a69=44.2466               12.988                    13.221                     13.526                     13.911                   14.376                    12.988                   13.221                    13.526                    13.911                  14.376                     12.988                     13.221                      13.526                     13.911                     14.376       
    a70=45.2055               13.112                    13.341                     13.642                     14.018                   14.474                    13.112                   13.341                    13.642                    14.018                  14.474                     13.112                     13.341                      13.642                     14.018                     14.474       
    a71=46.1644               13.235                    13.458                     13.755                     14.123                   14.571                    13.235                   13.458                    13.755                    14.123                  14.571                     13.235                     13.458                      13.755                     14.123                     14.571       
    a72=47.1233               13.355                    13.573                     13.865                     14.226                   14.666                    13.355                   13.573                    13.865                    14.226                  14.666                     13.355                     13.573                      13.865                     14.226                     14.666       
    a73=48.0822               13.473                    13.686                     13.974                     14.327                   14.759                    13.473                   13.686                    13.974                    14.327                  14.759                     13.473                     13.686                      13.974                     14.327                     14.759       
    a74=49.0411               13.588                    13.797                      14.08                     14.427                   14.851                    13.588                   13.797                     14.08                    14.427                  14.851                     13.588                     13.797                       14.08                     14.427                     14.851       
    a75=50                    13.702                    13.906                     14.184                     14.525                   14.942                    13.702                   13.906                    14.184                    14.525                  14.942                     13.702                     13.906                      14.184                     14.525                     14.942       

tb_pol_a: optimal asset choice for each state space point
                     zi1_zr_0_025_zw_0_33942    zi2_zr_0_025_zw_0_5596    zi3_zr_0_025_zw_0_92263    zi4_zr_0_025_zw_1_5212    zi5_zr_0_025_zw_2_508    zi6_zr_0_06_zw_0_33942    zi7_zr_0_06_zw_0_5596    zi8_zr_0_06_zw_0_92263    zi9_zr_0_06_zw_1_5212    zi10_zr_0_06_zw_2_508    zi11_zr_0_095_zw_0_33942    zi12_zr_0_095_zw_0_5596    zi13_zr_0_095_zw_0_92263    zi14_zr_0_095_zw_1_5212    zi15_zr_0_095_zw_2_508
                     _______________________    ______________________    _______________________    ______________________    _____________________    ______________________    _____________________    ______________________    _____________________    _____________________    ________________________    _______________________    ________________________    _______________________    ______________________

    a1=-20                         0                          0                       -20                        -20                  -19.041                         0                        0                         0                      -20                  -19.041                          0                          0                           0                          0                        -20       
    a2=-19.0411                  -20                        -20                       -20                    -19.041                  -17.123                         0                      -20                       -20                      -20                  -18.082                          0                          0                           0                        -20                    -19.041       
    a3=-18.0822                  -20                        -20                   -18.082                    -18.082                  -16.164                       -20                      -20                       -20                  -18.082                  -17.123                        -20                        -20                         -20                    -19.041                    -18.082       
    a4=-17.1233              -18.082                    -18.082                   -18.082                    -17.123                  -15.205                       -20                  -18.082                   -18.082                  -17.123                  -16.164                        -20                        -20                         -20                    -18.082                    -17.123       
    a5=-16.1644              -17.123                    -17.123                   -16.164                    -16.164                  -14.247                   -18.082                  -18.082                   -17.123                  -16.164                  -15.205                    -18.082                    -18.082                     -18.082                    -17.123                    -16.164       
    a6=-15.2055              -16.164                    -16.164                   -16.164                    -15.205                  -13.288                   -17.123                  -17.123                   -16.164                  -15.205                  -14.247                    -17.123                    -17.123                     -17.123                    -16.164                    -14.247       
    a7=-14.2466              -15.205                    -15.205                   -14.247                    -14.247                  -12.329                   -16.164                  -16.164                   -15.205                  -14.247                  -13.288                    -16.164                    -16.164                     -16.164                    -15.205                    -13.288       
    a8=-13.2877              -14.247                    -14.247                   -14.247                    -13.288                   -11.37                   -15.205                  -14.247                   -14.247                  -13.288                  -12.329                    -15.205                    -15.205                     -14.247                    -14.247                    -12.329       
    a9=-12.3288              -13.288                    -13.288                   -12.329                    -12.329                  -10.411                   -14.247                  -13.288                   -13.288                  -12.329                   -11.37                    -14.247                    -14.247                     -13.288                    -13.288                     -11.37       
    a10=-11.3699             -12.329                    -12.329                    -11.37                    -10.411                  -9.4521                   -13.288                  -12.329                   -12.329                   -11.37                  -10.411                    -13.288                    -13.288                     -12.329                     -11.37                    -10.411       
    a11=-10.411               -11.37                     -11.37                   -10.411                    -9.4521                  -8.4932                   -12.329                   -11.37                    -11.37                  -10.411                  -8.4932                    -12.329                    -12.329                      -11.37                    -10.411                    -9.4521       
    a12=-9.45205             -10.411                    -10.411                   -9.4521                    -8.4932                  -7.5342                   -10.411                  -10.411                   -10.411                  -9.4521                  -7.5342                     -11.37                     -11.37                     -10.411                    -9.4521                    -8.4932       
    a13=-8.49315             -9.4521                    -9.4521                   -8.4932                    -7.5342                  -6.5753                   -9.4521                  -9.4521                   -9.4521                  -8.4932                  -6.5753                    -10.411                    -9.4521                     -9.4521                    -8.4932                    -7.5342       
    a14=-7.53425             -8.4932                    -8.4932                   -7.5342                    -6.5753                  -5.6164                   -8.4932                  -8.4932                   -7.5342                  -7.5342                  -5.6164                    -9.4521                    -8.4932                     -8.4932                    -7.5342                    -6.5753       
    a15=-6.57534             -7.5342                    -7.5342                   -6.5753                    -5.6164                  -4.6575                   -7.5342                  -7.5342                   -6.5753                  -6.5753                  -4.6575                    -8.4932                    -7.5342                     -7.5342                    -6.5753                    -4.6575       
    a16=-5.61644             -6.5753                    -6.5753                   -5.6164                    -4.6575                  -3.6986                   -6.5753                  -6.5753                   -5.6164                  -4.6575                  -3.6986                    -6.5753                    -6.5753                     -6.5753                    -5.6164                    -3.6986       
    a17=-4.65753             -5.6164                    -5.6164                   -4.6575                    -3.6986                  -2.7397                   -5.6164                  -5.6164                   -4.6575                  -3.6986                  -2.7397                    -5.6164                    -5.6164                     -4.6575                    -3.6986                    -2.7397       
    a18=-3.69863             -4.6575                    -3.6986                   -3.6986                    -2.7397                  -1.7808                   -4.6575                  -4.6575                   -3.6986                  -2.7397                  -1.7808                    -4.6575                    -4.6575                     -3.6986                    -2.7397                    -1.7808       
    a19=-2.73973             -3.6986                    -2.7397                   -2.7397                    -1.7808                 -0.82192                   -3.6986                  -3.6986                   -2.7397                  -1.7808                 -0.82192                    -3.6986                    -3.6986                     -2.7397                    -1.7808                   -0.82192       
    a20=-1.78082             -2.7397                    -1.7808                   -1.7808                   -0.82192                        0                   -2.7397                  -1.7808                   -1.7808                 -0.82192                        0                    -2.7397                    -2.7397                     -1.7808                   -0.82192                   -0.82192       
    a21=-0.821918            -1.7808                   -0.82192                  -0.82192                          0                  0.13699                   -1.7808                 -0.82192                  -0.82192                        0                  0.13699                    -1.7808                   -0.82192                    -0.82192                          0                    0.13699       
    a22=0                   -0.82192                          0                         0                    0.13699                   1.0959                  -0.82192                        0                         0                  0.13699                   1.0959                   -0.82192                          0                           0                    0.13699                     1.0959       
    a23=0.136986                   0                          0                   0.13699                    0.13699                   1.0959                         0                        0                   0.13699                  0.13699                   1.0959                          0                          0                     0.13699                    0.13699                     1.0959       
    a24=1.09589              0.13699                    0.13699                    1.0959                     1.0959                   2.0548                   0.13699                  0.13699                    1.0959                   1.0959                   2.0548                    0.13699                    0.13699                      1.0959                     1.0959                     2.0548       
    a25=2.05479               1.0959                     1.0959                    2.0548                     2.0548                   3.0137                    1.0959                   1.0959                    2.0548                   2.0548                   3.0137                     1.0959                     1.0959                      2.0548                     2.0548                     3.0137       
    a26=3.0137                2.0548                     2.0548                    3.0137                     3.0137                   3.9726                    2.0548                   2.0548                    3.0137                   3.0137                   3.9726                     2.0548                     2.0548                      3.0137                     3.0137                     3.9726       
    a27=3.9726                3.0137                     3.0137                    3.0137                     3.9726                   4.9315                    3.0137                   3.0137                    3.0137                   3.9726                   4.9315                     3.0137                     3.0137                      3.0137                     3.9726                     4.9315       
    a28=4.93151               3.9726                     3.9726                    3.9726                     4.9315                   5.8904                    3.9726                   3.9726                    3.9726                   4.9315                   5.8904                     3.9726                     3.9726                      3.9726                     4.9315                     5.8904       
    a29=5.89041               4.9315                     4.9315                    4.9315                     5.8904                   6.8493                    4.9315                   4.9315                    4.9315                   5.8904                   6.8493                     4.9315                     4.9315                      4.9315                     5.8904                     6.8493       
    a30=6.84932               5.8904                     5.8904                    5.8904                     6.8493                   7.8082                    5.8904                   5.8904                    5.8904                   6.8493                   7.8082                     5.8904                     5.8904                      5.8904                     6.8493                     7.8082       
    a31=7.80822               6.8493                     6.8493                    6.8493                     7.8082                   8.7671                    6.8493                   6.8493                    6.8493                   7.8082                   8.7671                     6.8493                     6.8493                      6.8493                     7.8082                     8.7671       
    a32=8.76712               7.8082                     7.8082                    7.8082                     8.7671                    9.726                    7.8082                   7.8082                    7.8082                   8.7671                    9.726                     7.8082                     7.8082                      7.8082                     8.7671                      9.726       
    a33=9.72603               8.7671                     8.7671                    8.7671                      9.726                   10.685                    8.7671                   8.7671                    8.7671                    9.726                   10.685                     8.7671                     8.7671                      8.7671                      9.726                     10.685       
    a34=10.6849                9.726                      9.726                     9.726                     10.685                   11.644                     9.726                    9.726                     9.726                   10.685                   11.644                      9.726                      9.726                       9.726                     10.685                     11.644       
    a35=11.6438               10.685                     10.685                    10.685                     11.644                   12.603                    10.685                   10.685                    10.685                   11.644                   12.603                     10.685                     10.685                      10.685                     11.644                     12.603       
    a36=12.6027               11.644                     11.644                    11.644                     12.603                   13.562                    11.644                   11.644                    11.644                   12.603                   13.562                     11.644                     11.644                      11.644                     12.603                     13.562       
    a37=13.5616               12.603                     12.603                    12.603                     13.562                   14.521                    12.603                   12.603                    12.603                   13.562                   14.521                     12.603                     12.603                      12.603                     13.562                     14.521       
    a38=14.5205               13.562                     13.562                    13.562                     14.521                   15.479                    13.562                   13.562                    13.562                   14.521                   15.479                     13.562                     13.562                      13.562                     14.521                     15.479       
    a39=15.4795               13.562                     14.521                    14.521                     15.479                   16.438                    13.562                   14.521                    14.521                   15.479                   16.438                     13.562                     14.521                      14.521                     15.479                     16.438       
    a40=16.4384               14.521                     15.479                    15.479                     16.438                   17.397                    14.521                   15.479                    15.479                   16.438                   17.397                     14.521                     15.479                      15.479                     16.438                     17.397       
    a41=17.3973               15.479                     16.438                    16.438                     16.438                   18.356                    15.479                   16.438                    16.438                   16.438                   18.356                     15.479                     16.438                      16.438                     16.438                     18.356       
    a42=18.3562               16.438                     17.397                    17.397                     17.397                   19.315                    16.438                   17.397                    17.397                   17.397                   19.315                     16.438                     17.397                      17.397                     17.397                     19.315       
    a43=19.3151               17.397                     18.356                    18.356                     18.356                   20.274                    17.397                   18.356                    18.356                   18.356                   20.274                     17.397                     18.356                      18.356                     18.356                     20.274       
    a44=20.274                18.356                     18.356                    19.315                     19.315                   21.233                    18.356                   18.356                    19.315                   19.315                   21.233                     18.356                     18.356                      19.315                     19.315                     21.233       
    a45=21.2329               19.315                     19.315                    20.274                     20.274                   21.233                    19.315                   19.315                    20.274                   20.274                   21.233                     19.315                     19.315                      20.274                     20.274                     21.233       
    a46=22.1918               20.274                     20.274                    21.233                     21.233                   22.192                    20.274                   20.274                    21.233                   21.233                   22.192                     20.274                     20.274                      21.233                     21.233                     22.192       
    a47=23.1507               21.233                     21.233                    22.192                     22.192                   23.151                    21.233                   21.233                    22.192                   22.192                   23.151                     21.233                     21.233                      22.192                     22.192                     23.151       
    a48=24.1096               22.192                     22.192                    23.151                     23.151                    24.11                    22.192                   22.192                    23.151                   23.151                    24.11                     22.192                     22.192                      23.151                     23.151                      24.11       
    a49=25.0685               23.151                     23.151                     24.11                      24.11                   25.068                    23.151                   23.151                     24.11                    24.11                   25.068                     23.151                     23.151                       24.11                      24.11                     25.068       
    a50=26.0274                24.11                      24.11                    25.068                     25.068                   26.027                     24.11                    24.11                    25.068                   25.068                   26.027                      24.11                      24.11                      25.068                     25.068                     26.027       
    a51=26.9863               25.068                     25.068                    26.027                     26.027                   26.986                    25.068                   25.068                    26.027                   26.027                   26.986                     25.068                     25.068                      26.027                     26.027                     26.986       
    a52=27.9452               26.027                     26.027                    26.986                     26.986                   27.945                    26.027                   26.027                    26.986                   26.986                   27.945                     26.027                     26.027                      26.986                     26.986                     27.945       
    a53=28.9041               26.986                     26.986                    26.986                     27.945                   28.904                    26.986                   26.986                    26.986                   27.945                   28.904                     26.986                     26.986                      26.986                     27.945                     28.904       
    a54=29.863                27.945                     27.945                    27.945                     28.904                   29.863                    27.945                   27.945                    27.945                   28.904                   29.863                     27.945                     27.945                      27.945                     28.904                     29.863       
    a55=30.8219               28.904                     28.904                    28.904                     29.863                   30.822                    28.904                   28.904                    28.904                   29.863                   30.822                     28.904                     28.904                      28.904                     29.863                     30.822       
    a56=31.7808               29.863                     29.863                    29.863                     30.822                   31.781                    29.863                   29.863                    29.863                   30.822                   31.781                     29.863                     29.863                      29.863                     30.822                     31.781       
    a57=32.7397               30.822                     30.822                    30.822                     31.781                    32.74                    30.822                   30.822                    30.822                   31.781                    32.74                     30.822                     30.822                      30.822                     31.781                      32.74       
    a58=33.6986               31.781                     31.781                    31.781                      32.74                   33.699                    31.781                   31.781                    31.781                    32.74                   33.699                     31.781                     31.781                      31.781                      32.74                     33.699       
    a59=34.6575                32.74                      32.74                     32.74                     33.699                   34.658                     32.74                    32.74                     32.74                   33.699                   34.658                      32.74                      32.74                       32.74                     33.699                     34.658       
    a60=35.6164               33.699                     33.699                    33.699                     34.658                   35.616                    33.699                   33.699                    33.699                   34.658                   35.616                     33.699                     33.699                      33.699                     34.658                     35.616       
    a61=36.5753               34.658                     34.658                    34.658                     35.616                   36.575                    34.658                   34.658                    34.658                   35.616                   36.575                     34.658                     34.658                      34.658                     35.616                     36.575       
    a62=37.5342               35.616                     35.616                    35.616                     36.575                   37.534                    35.616                   35.616                    35.616                   36.575                   37.534                     35.616                     35.616                      35.616                     36.575                     37.534       
    a63=38.4932               36.575                     36.575                    36.575                     37.534                   38.493                    36.575                   36.575                    36.575                   37.534                   38.493                     36.575                     36.575                      36.575                     37.534                     38.493       
    a64=39.4521               37.534                     37.534                    37.534                     38.493                   39.452                    37.534                   37.534                    37.534                   38.493                   39.452                     37.534                     37.534                      37.534                     38.493                     39.452       
    a65=40.411                38.493                     38.493                    38.493                     39.452                   40.411                    38.493                   38.493                    38.493                   39.452                   40.411                     38.493                     38.493                      38.493                     39.452                     40.411       
    a66=41.3699               39.452                     39.452                    39.452                     40.411                    41.37                    39.452                   39.452                    39.452                   40.411                    41.37                     39.452                     39.452                      39.452                     40.411                      41.37       
    a67=42.3288               40.411                     40.411                    40.411                      41.37                   42.329                    40.411                   40.411                    40.411                    41.37                   42.329                     40.411                     40.411                      40.411                      41.37                     42.329       
    a68=43.2877                41.37                      41.37                     41.37                     42.329                   43.288                     41.37                    41.37                     41.37                   42.329                   43.288                      41.37                      41.37                       41.37                     42.329                     43.288       
    a69=44.2466                41.37                     42.329                    42.329                     43.288                   44.247                     41.37                   42.329                    42.329                   43.288                   44.247                      41.37                     42.329                      42.329                     43.288                     44.247       
    a70=45.2055               42.329                     43.288                    43.288                     44.247                   45.205                    42.329                   43.288                    43.288                   44.247                   45.205                     42.329                     43.288                      43.288                     44.247                     45.205       
    a71=46.1644               43.288                     44.247                    44.247                     45.205                   46.164                    43.288                   44.247                    44.247                   45.205                   46.164                     43.288                     44.247                      44.247                     45.205                     46.164       
    a72=47.1233               44.247                     45.205                    45.205                     46.164                   47.123                    44.247                   45.205                    45.205                   46.164                   47.123                     44.247                     45.205                      45.205                     46.164                     47.123       
    a73=48.0822               45.205                     46.164                    46.164                     46.164                   48.082                    45.205                   46.164                    46.164                   46.164                   48.082                     45.205                     46.164                      46.164                     46.164                     48.082       
    a74=49.0411               46.164                     47.123                    47.123                     47.123                   49.041                    46.164                   47.123                    47.123                   47.123                   49.041                     46.164                     47.123                      47.123                     47.123                     49.041       
    a75=50                    47.123                     47.123                    48.082                     48.082                       50                    47.123                   47.123                    48.082                   48.082                       50                     47.123                     47.123                      48.082                     48.082                         50       

</pre><img vspace="5" hspace="5" src="ff_abz_vf_01.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_02.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_03.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_04.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_05.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_06.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_07.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_08.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_09.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_10.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_11.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_12.png" alt=""> <pre class="codeinput"><span class="keyword">end</span>
</pre><pre class="codeoutput">
ans = 

  Map with properties:

        Count: 11
      KeyType: char
    ValueType: any

</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Solve Save + Borr Dynamic Programming Problem (Loop)
% *back to <https://fanwangecon.github.io Fan>'s
% <https://fanwangecon.github.io/CodeDynaAsset/ Dynamic Assets Repository>
% Table of Content.*

%%
function result_map = ff_abz_vf(varargin)
%% FF_ABZ_VF solve infinite horizon exo shock + endo asset problem
% This program solves the infinite horizon dynamic single asset and single
% shock problem with loops. This file contains codes that processes
% borrowing.
%
% The borrowing problem is very similar to the savings problem. The code
% could be identical if one does not have to deal with default. The main
% addition here in comparison to the savings only code
% <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html
% ff_az_vf> is the ability to deal with default. 
%
% @param param_map container parameter container
%
% @param support_map container support container
%
% @param armt_map container container with states, choices and shocks
% grids that are inputs for grid based solution algorithm
%
% @param func_map container container with function handles for
% consumption cash-on-hand etc.
%
% @return result_map container contains policy function matrix, value
% function matrix, iteration results, and policy function, value function
% and iteration results tables.
%
% keys included in result_map:
%
% * mt_val matrix states_n by shock_n matrix of converged value function grid
% * mt_pol_a matrix states_n by shock_n matrix of converged policy function grid
% * ar_val_diff_norm array if bl_post = true it_iter_last by 1 val function
% difference between iteration
% * ar_pol_diff_norm array if bl_post = true it_iter_last by 1 policy
% function difference between iterations
% * mt_pol_perc_change matrix if bl_post = true it_iter_last by shock_n the
% proportion of grid points at which policy function changed between
% current and last iteration for each element of shock
%
% @example
%
%    % Get Default Parameters
%    it_param_set = 2;
%    [param_map, support_map] = ffs_abz_set_default_param(it_param_set);
%    % Chnage param_map keys for borrowing
%    param_map('fl_b_bd') = -20; % borrow bound
%    param_map('bl_default') = false; % true if allow for default
%    param_map('fl_c_min') = 0.0001; % u(c_min) when default
%    % Change Keys in param_map
%    param_map('it_a_n') = 500;
%    param_map('fl_z_r_borr_n') = 5;
%    param_map('it_z_wage_n') = 15;
%    param_map('it_z_n') = param_map('it_z_wage_n') * param_map('fl_z_r_borr_n');
%    param_map('fl_a_max') = 100;
%    param_map('fl_w') = 1.3;
%    % Change Keys support_map
%    support_map('bl_display') = false;
%    support_map('bl_post') = true;
%    support_map('bl_display_final') = false;
%    % Call Program with external parameters that override defaults.
%    ff_abz_vf(param_map, support_map);
%
% @include
%
% * <https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html ffs_abz_set_default_param>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_get_funcgrid.html ffs_abz_get_funcgrid>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post.html ff_az_vf_post>
%
% @seealso
%
% * save loop: <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html ff_az_vf>
% * save vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vec.html ff_az_vf_vec>
% * save optimized-vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html ff_az_vf_vecsv>
% * save + borr loop: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html ff_abz_vf>
% * save + borr vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html ff_abz_vf_vec>
% * save + borr optimized-vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vecsv.html ff_abz_vf_vecsv>
%

%% Default
% * it_param_set = 1: quick test
% * it_param_set = 2: benchmark run
% * it_param_set = 3: benchmark profile
% * it_param_set = 4: press publish button

it_param_set = 4;
bl_input_override = true;
[param_map, support_map] = ffs_abz_set_default_param(it_param_set);

% Note: param_map and support_map can be adjusted here or outside to override defaults
param_map('it_a_n') = 75;
param_map('fl_z_r_borr_n') = 3;
param_map('it_z_wage_n') = 5;
param_map('it_z_n') = param_map('it_z_wage_n') * param_map('fl_z_r_borr_n');
% param_map('fl_r_save') = 0.025;
% param_map('fl_r_borr') = 0.035;

[armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override); % 1 for override
default_params = {param_map support_map armt_map func_map};

%% Parse Parameters 1

% if varargin only has param_map and support_map,
params_len = length(varargin);
[default_params{1:params_len}] = varargin{:};
param_map = [param_map; default_params{1}];
support_map = [support_map; default_params{2}];
if params_len >= 1 && params_len <= 2
    % If override param_map, re-generate armt and func if they are not
    % provided
    bl_input_override = true;
    [armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override);
else
    % Override all
    armt_map = [armt_map; default_params{3}];
    func_map = [func_map; default_params{4}];
end

% append function name
st_func_name = 'ff_abz_vf';
support_map('st_profile_name_main') = [st_func_name support_map('st_profile_name_main')];
support_map('st_mat_name_main') = [st_func_name support_map('st_mat_name_main')];
support_map('st_img_name_main') = [st_func_name support_map('st_img_name_main')];

%% Parse Parameters 2

% armt_map
params_group = values(armt_map, {'ar_a', 'mt_z_trans', 'ar_z_r_borr_mesh_wage', 'ar_z_wage_mesh_r_borr'});
[ar_a, mt_z_trans, ar_z_r_borr_mesh_wage, ar_z_wage_mesh_r_borr] = params_group{:};

% func_map
params_group = values(func_map, {'f_util_log', 'f_util_crra', 'f_cons_checkcmin', 'f_coh', 'f_cons_coh'});
[f_util_log, f_util_crra, f_cons_checkcmin, f_coh, f_cons_coh] = params_group{:};

% param_map
params_group = values(param_map, {'it_a_n', 'it_z_n', 'fl_crra', 'fl_beta', 'fl_c_min',...
    'fl_nan_replace', 'bl_default', 'fl_default_aprime'});
[it_a_n, it_z_n, fl_crra, fl_beta, fl_c_min, ...
    fl_nan_replace, bl_default, fl_default_aprime] = params_group{:};
params_group = values(param_map, {'it_maxiter_val', 'fl_tol_val', 'fl_tol_pol', 'it_tol_pol_nochange'});
[it_maxiter_val, fl_tol_val, fl_tol_pol, it_tol_pol_nochange] = params_group{:};

% support_map
params_group = values(support_map, {'bl_profile', 'st_profile_path', ...
    'st_profile_prefix', 'st_profile_name_main', 'st_profile_suffix',...
    'bl_time', 'bl_display_defparam', 'bl_display', 'it_display_every', 'bl_post'});
[bl_profile, st_profile_path, ...
    st_profile_prefix, st_profile_name_main, st_profile_suffix, ...
    bl_time, bl_display_defparam, bl_display, it_display_every, bl_post] = params_group{:};

%% Display Parameters

if(bl_display_defparam)
    fft_container_map_display(param_map);
    fft_container_map_display(support_map);
end

%% Initialize Output Matrixes

mt_val_cur = zeros(length(ar_a),it_z_n);
mt_val = mt_val_cur - 1;
mt_pol_a = zeros(length(ar_a),it_z_n);
mt_pol_a_cur = mt_pol_a - 1;

%% Initialize Convergence Conditions

bl_vfi_continue = true;
it_iter = 0;
ar_val_diff_norm = zeros([it_maxiter_val, 1]);
ar_pol_diff_norm = zeros([it_maxiter_val, 1]);
mt_pol_perc_change = zeros([it_maxiter_val, it_z_n]);

%% Iterate Value Function
% Loop solution with 4 nested loops
%
% # loop 1: over exogenous states
% # loop 2: over endogenous states
% # loop 3: over choices
% # loop 4: add future utility, integrationREPLACE_WITH_DASH_DASHloop over future shocks
%

% Start Profile
if (bl_profile)
    close all;
    profile off;
    profile on;
end

% Start Timer
if (bl_time)
    tic;
end

% Utility at-Default/at-limiting-case-when-nodefault
if (fl_crra == 1)
    fl_u_cmin = f_util_log(fl_c_min);
else
    fl_u_cmin = f_util_crra(fl_c_min);
end


% Value Function Iteration
while bl_vfi_continue
    it_iter = it_iter + 1;

    %% Iterate over a and z states
    % Solve Problem if Default: coh < borr_bound, then: u(c_min) + EV(a'=0,z')
    % these are the values for defaulter
    % if do not borrow enough to pay debt: a'=0
    % if save more than what you have: a'=0
    % if borrowing, possible that all ar_val_cur values are
    % u(cmin), when that is the case, utility equal to
    % c_min, this means given current choice set, can only default,
    % get utility at c_min level, and a' go to 0. See
    % maximization over loop 3 choices for loop 1+2 states. see
    % <https://fanwangecon.github.io/CodeDynaAsset/docs/README_cminymin_borrsave.html
    % README_cminymin_borrsave> for additional discussions.
    %
    % when default is not allowed, there should be exactly one
    % element of the state space where we enter this condition.
    % That is at a_min and z_min. At this point, the natural
    % borrowing constraint when fully used up leads to c = 0.
    % When default is not allowed, this is the limiting case.
    % We solve the limiting case as if default is possible. see
    % the figure here:
    % <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ffs_abz_get_funcgrid/test_borr/html/ffs_abz_get_funcgrid_nodefault.html
    % ffs_abz_get_funcgrid_nodefault>. For the figure under
    % section *Generate Borrowing A Grid with Default*, there are
    % no points to the lower right of the red horizontal and
    % verticle lines, because no default is allowed. But the
    % intersection of the two red lines is this limiting case
    % where c = 0.
    %
    % when default is allowed. See again
    % <https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ffs_abz_get_funcgrid/test_borr/html/ffs_abz_get_funcgrid_nodefault.html
    % ffs_abz_get_funcgrid_nodefault>. Again under section
    % *Generate Borrowing A Grid with Default*, see that there
    % is an area to the right bottom of the two blue horizontal
    % and vertical lines. For all points in that area, the
    % household has to default, they can not borrow even at max
    % to get positive consumption. At other points higher than
    % the blue horizontal line, it is also possible for
    % defaulting to be the optimal choice.

    % loop 1: over exogenous states
    for it_z_i = 1:it_z_n
        
        % Current Shock
        fl_z_r_borr = ar_z_r_borr_mesh_wage(it_z_i);
        fl_z_wage = ar_z_wage_mesh_r_borr(it_z_i);

        % loop 2: over endogenous states
        for it_a_j = 1:length(ar_a)
            fl_a = ar_a(it_a_j);
            ar_val_cur = zeros(size(ar_a));

            % calculate cash on hand
            fl_coh = f_coh(fl_z_r_borr, fl_z_wage, fl_a);
            
            % loop 3: over choices
            for it_ap_k = 1:length(ar_a)

                % get next period asset choice
                fl_ap = ar_a(it_ap_k);

                % calculate consumption
                fl_c = f_cons_coh(fl_coh, fl_ap);

                % assign u(c)
                if (fl_c <= fl_c_min)
                    if (bl_default)
                        % defaults
                        % current utility: only today u(cmin)
                        ar_val_cur(it_ap_k) = fl_u_cmin;
                        % transition out next period, debt wiped out
                        for it_az_q = 1:it_z_n
                            ar_val_cur(it_ap_k) = ar_val_cur(it_ap_k) + ...
                                fl_beta*mt_z_trans(it_z_i, it_az_q)*mt_val_cur((ar_a == fl_default_aprime), it_az_q);
                        end
                    else
                        % if default is not allowed: v = fl_nan_replace
                        ar_val_cur(it_ap_k) = fl_nan_replace;
                    end
                else
                    % Solve Optimization Problem: max_{a'} u(c(a,a',z)) + beta*EV(a',z')
                    % borrowed enough to pay debt (and borrowing limit not exceeded)
                    % saved only the coh available.
                    % current utility
                    if (fl_crra == 1)
                        ar_val_cur(it_ap_k) = f_util_log(fl_c);
                    else
                        ar_val_cur(it_ap_k) = f_util_crra(fl_c);
                    end
                    % loop 4: add future utility, integrationREPLACE_WITH_DASH_DASHloop over future shocks
                    for it_az_q = 1:it_z_n
                        ar_val_cur(it_ap_k) = ar_val_cur(it_ap_k) + ...
                            fl_beta*mt_z_trans(it_z_i, it_az_q)*mt_val_cur(it_ap_k, it_az_q);
                    end
                end
            end

            % optimal choice value
            [fl_opti_val_z, fl_opti_idx_z] = max(ar_val_cur);
            fl_opti_aprime_z = ar_a(fl_opti_idx_z);
            fl_opti_c_z = f_cons_coh(fl_coh, fl_opti_aprime_z);

            % Handle Default is optimal or not
            if (fl_opti_c_z <= fl_c_min)
                if (bl_default)
                    % if defaulting is optimal choice, at these states, not required
                    % to default, non-default possible, but default could be optimal
                    fl_opti_aprime_z = fl_default_aprime;
                else
                    % if default is not allowed, then next period same state as now
                    % this is absorbing state, this is the limiting case, single
                    % state space point, lowest a and lowest shock has this.
                    fl_opti_aprime_z = fl_a;
                end
            end

            %% Store Optimal Choices and Value Given(a,z)
            mt_val(it_a_j,it_z_i) = fl_opti_val_z;
            mt_pol_a(it_a_j,it_z_i) = fl_opti_aprime_z;

        end
    end

    %% Check Tolerance and Continuation

    % Difference across iterations
    ar_val_diff_norm(it_iter) = norm(mt_val - mt_val_cur);
    ar_pol_diff_norm(it_iter) = norm(mt_pol_a - mt_pol_a_cur);
    mt_pol_perc_change(it_iter, :) = sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n);

    % Update
    mt_val_cur = mt_val;
    mt_pol_a_cur = mt_pol_a;

    % Print Iteration Results
    if (bl_display && (rem(it_iter, it_display_every)==0))
        fprintf('VAL it_iter:%d, fl_diff:%d, fl_diff_pol:%d\n', ...
            it_iter, ar_val_diff_norm(it_iter), ar_pol_diff_norm(it_iter));
        tb_valpol_iter = array2table([mean(mt_val_cur,1); mean(mt_pol_a_cur,1); ...
            mt_val_cur(it_a_n,:); mt_pol_a_cur(it_a_n,:)]);
        tb_valpol_iter.Properties.VariableNames = strcat('z', string((1:size(mt_val_cur,2))));
        tb_valpol_iter.Properties.RowNames = {'mval', 'map', 'Hval', 'Hap'};
        disp('mval = mean(mt_val_cur,1), average value over a')
        disp('map  = mean(mt_pol_a_cur,1), average choice over a')
        disp('Hval = mt_val_cur(it_a_n,:), highest a state val')
        disp('Hap = mt_pol_a_cur(it_a_n,:), highest a state choice')
        disp(tb_valpol_iter);
    end

    % Continuation Conditions:
    % 1. if value function convergence criteria reached
    % 2. if policy function variation over iterations is less than
    % threshold
    if (it_iter == (it_maxiter_val + 1))
        bl_vfi_continue = false;
    elseif ((it_iter == it_maxiter_val) || ...
            (ar_val_diff_norm(it_iter) < fl_tol_val) || ...
            (sum(ar_pol_diff_norm(max(1, it_iter-it_tol_pol_nochange):it_iter)) < fl_tol_pol))
        % Fix to max, run again to save results if needed
        it_iter_last = it_iter;
        it_iter = it_maxiter_val;
    end

end

% End Timer
if (bl_time)
    toc;
end

% End Profile
if (bl_profile)
    profile off
    profile viewer
    st_file_name = [st_profile_prefix st_profile_name_main st_profile_suffix];
    profsave(profile('info'), strcat(st_profile_path, st_file_name));
end

%% Process Optimal Choices

result_map = containers.Map('KeyType','char', 'ValueType','any');
result_map('mt_val') = mt_val;

result_map('cl_mt_coh') = {f_coh(ar_z_r_borr_mesh_wage, ar_z_wage_mesh_r_borr, ar_a'), zeros(1)};
result_map('cl_mt_pol_a') = {mt_pol_a, zeros(1)};
result_map('cl_mt_pol_c') = {f_cons_checkcmin(ar_z_r_borr_mesh_wage, ar_z_wage_mesh_r_borr, ar_a', mt_pol_a), zeros(1)};
result_map('ar_st_pol_names') = ["cl_mt_pol_a", "cl_mt_coh", "cl_mt_pol_c"];

if (bl_post)
    bl_input_override = true;
    result_map('ar_val_diff_norm') = ar_val_diff_norm(1:it_iter_last);
    result_map('ar_pol_diff_norm') = ar_pol_diff_norm(1:it_iter_last);
    result_map('mt_pol_perc_change') = mt_pol_perc_change(1:it_iter_last, :);
    result_map = ff_az_vf_post(param_map, support_map, armt_map, func_map, result_map, bl_input_override);
end

end

##### SOURCE END #####
--></body></html>