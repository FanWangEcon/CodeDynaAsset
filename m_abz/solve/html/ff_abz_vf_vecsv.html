
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Solve Save + Borr Dynamic Programming Problem (Optimized-Vectorized)</title><meta name="generator" content="MATLAB 9.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-07-05"><meta name="DC.source" content="ff_abz_vf_vecsv.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Solve Save + Borr Dynamic Programming Problem (Optimized-Vectorized)</h1><!--introduction--><p><b>back to <a href="https://fanwangecon.github.io">Fan</a>'s <a href="https://fanwangecon.github.io/CodeDynaAsset/">Dynamic Assets Repository</a> Table of Content.</b></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">FF_ABZ_VF_VECSV solve infinite horizon exo shock + endo asset problem</a></li><li><a href="#3">Default</a></li><li><a href="#4">Parse Parameters 1</a></li><li><a href="#5">Parse Parameters 2</a></li><li><a href="#6">Initialize Output Matrixes</a></li><li><a href="#7">Initialize Convergence Conditions</a></li><li><a href="#8">Iterate Value Function</a></li><li><a href="#10">Solve Optimization Problem Current Iteration</a></li><li><a href="#11">Check Tolerance and Continuation</a></li><li><a href="#13">Process Optimal Choices</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> result_map = ff_abz_vf_vecsv(varargin)
</pre><h2 id="2">FF_ABZ_VF_VECSV solve infinite horizon exo shock + endo asset problem</h2><p>This program solves the infinite horizon dynamic single asset and single shock problem with vectorized codes. <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html">ff_abz_vf</a> shows looped codes. <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html">ff_abz_vf_vec</a> shows vectorized codes. This file shows vectorized codes that is faster but is more memory intensive.</p><p>The borrowing problem is very similar to the savings problem. The code could be identical if one does not have to deal with default. The main addition here in comparison to the savings only code <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html">ff_az_vf_vec</a> is the ability to deal with default.</p><p>See <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html">ff_az_vf_vec</a> how vectorization works within this structure.</p><p>This <i>optimized-vectorized</i> solution method provides very large speed improvements for this infinite horizon problem because the u(c(z,a,a')) calculation within each iteration is identical. Generally the idea is to identify inside iteration whether the model is infinite horizon or life-cycle based where repeat calculations are taking place. If such calculations can be identified, then potentially they could be stored and retrieved during future iterations/periods rather than recomputed every time. This saves time.</p><p>@param param_map container parameter container</p><p>@param support_map container support container</p><p>@param armt_map container container with states, choices and shocks grids that are inputs for grid based solution algorithm</p><p>@param func_map container container with function handles for consumption cash-on-hand etc.</p><p>@return result_map container contains policy function matrix, value function matrix, iteration results, and policy function, value function and iteration results tables.</p><p>keys included in result_map:</p><div><ul><li>mt_val matrix states_n by shock_n matrix of converged value function grid</li><li>mt_pol_a matrix states_n by shock_n matrix of converged policy function grid</li><li>ar_val_diff_norm array if bl_post = true it_iter_last by 1 val function difference between iteration</li><li>ar_pol_diff_norm array if bl_post = true it_iter_last by 1 policy function difference between iterations</li><li>mt_pol_perc_change matrix if bl_post = true it_iter_last by shock_n the proportion of grid points at which policy function changed between current and last iteration for each element of shock</li></ul></div><p>@example</p><pre>  % Get Default Parameters
  it_param_set = 2;
  [param_map, support_map] = ffs_abz_set_default_param(it_param_set);
  % Chnage param_map keys for borrowing
  param_map('fl_b_bd') = -20; % borrow bound
  param_map('bl_default') = false; % true if allow for default
  param_map('fl_c_min') = 0.0001; % u(c_min) when default
  % Change Keys in param_map
  param_map('it_a_n') = 500;
  param_map('it_z_n') = 11;
  param_map('fl_a_max') = 100;
  param_map('fl_w') = 1.3;
  % Change Keys support_map
  support_map('bl_display') = false;
  support_map('bl_post') = true;
  support_map('bl_display_final') = false;
  % Call Program with external parameters that override defaults.
  ff_abz_vf_vecsv(param_map, support_map);</pre><p>@include</p><div><ul><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html">ffs_abz_set_default_param</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_get_funcgrid.html">ffs_abz_get_funcgrid</a></li><li><a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post.html">ff_az_vf_post</a></li></ul></div><p>@seealso</p><div><ul><li>save loop: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html">ff_az_vf</a></li><li>save vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vec.html">ff_az_vf_vec</a></li><li>save optimized-vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html">ff_az_vf_vecsv</a></li><li>save + borr loop: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html">ff_abz_vf</a></li><li>save + borr vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html">ff_abz_vf_vec</a></li><li>save + borr optimized-vectorized: <a href="https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vecsv.html">ff_abz_vf_vecsv</a></li></ul></div><h2 id="3">Default</h2><div><ul><li>it_param_set = 1: quick test</li><li>it_param_set = 2: benchmark run</li><li>it_param_set = 3: benchmark profile</li><li>it_param_set = 4: press publish button</li></ul></div><pre class="codeinput">it_param_set = 4;
bl_input_override = true;
[param_map, support_map] = ffs_abz_set_default_param(it_param_set);

<span class="comment">% Note: param_map and support_map can be adjusted here or outside to override defaults</span>
<span class="comment">% param_map('it_a_n') = 750;</span>
<span class="comment">% param_map('it_z_n') = 15;</span>
<span class="comment">% param_map('fl_r_save') = 0.025;</span>
<span class="comment">% param_map('fl_r_borr') = 0.035;</span>

[armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override); <span class="comment">% 1 for override</span>
default_params = {param_map support_map armt_map func_map};
</pre><h2 id="4">Parse Parameters 1</h2><pre class="codeinput"><span class="comment">% if varargin only has param_map and support_map,</span>
params_len = length(varargin);
[default_params{1:params_len}] = varargin{:};
param_map = [param_map; default_params{1}];
support_map = [support_map; default_params{2}];
<span class="keyword">if</span> params_len &gt;= 1 &amp;&amp; params_len &lt;= 2
    <span class="comment">% If override param_map, re-generate armt and func if they are not</span>
    <span class="comment">% provided</span>
    bl_input_override = true;
    [armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override);
<span class="keyword">else</span>
    <span class="comment">% Override all</span>
    armt_map = [armt_map; default_params{3}];
    func_map = [func_map; default_params{4}];
<span class="keyword">end</span>

<span class="comment">% append function name</span>
st_func_name = <span class="string">'ff_abz_vf_vecsv'</span>;
support_map(<span class="string">'st_profile_name_main'</span>) = [st_func_name support_map(<span class="string">'st_profile_name_main'</span>)];
support_map(<span class="string">'st_mat_name_main'</span>) = [st_func_name support_map(<span class="string">'st_mat_name_main'</span>)];
support_map(<span class="string">'st_img_name_main'</span>) = [st_func_name support_map(<span class="string">'st_img_name_main'</span>)];
</pre><h2 id="5">Parse Parameters 2</h2><pre class="codeinput"><span class="comment">% armt_map</span>
params_group = values(armt_map, {<span class="string">'ar_a'</span>, <span class="string">'mt_z_trans'</span>, <span class="string">'ar_z'</span>});
[ar_a, mt_z_trans, ar_z] = params_group{:};

<span class="comment">% func_map</span>
params_group = values(func_map, {<span class="string">'f_util_log'</span>, <span class="string">'f_util_crra'</span>, <span class="string">'f_cons_checkcmin'</span>, <span class="string">'f_coh'</span>, <span class="string">'f_cons_coh'</span>});
[f_util_log, f_util_crra, f_cons_checkcmin, f_coh, f_cons_coh] = params_group{:};

<span class="comment">% param_map</span>
params_group = values(param_map, {<span class="string">'it_a_n'</span>, <span class="string">'it_z_n'</span>, <span class="string">'fl_crra'</span>, <span class="string">'fl_beta'</span>, <span class="string">'fl_c_min'</span>,<span class="keyword">...</span>
    <span class="string">'fl_nan_replace'</span>, <span class="string">'bl_default'</span>, <span class="string">'fl_default_aprime'</span>});
[it_a_n, it_z_n, fl_crra, fl_beta, fl_c_min, <span class="keyword">...</span>
    fl_nan_replace, bl_default, fl_default_aprime] = params_group{:};
params_group = values(param_map, {<span class="string">'it_maxiter_val'</span>, <span class="string">'fl_tol_val'</span>, <span class="string">'fl_tol_pol'</span>, <span class="string">'it_tol_pol_nochange'</span>});
[it_maxiter_val, fl_tol_val, fl_tol_pol, it_tol_pol_nochange] = params_group{:};

<span class="comment">% support_map</span>
params_group = values(support_map, {<span class="string">'bl_profile'</span>, <span class="string">'st_profile_path'</span>, <span class="keyword">...</span>
    <span class="string">'st_profile_prefix'</span>, <span class="string">'st_profile_name_main'</span>, <span class="string">'st_profile_suffix'</span>,<span class="keyword">...</span>
    <span class="string">'bl_time'</span>, <span class="string">'bl_display'</span>, <span class="string">'it_display_every'</span>, <span class="string">'bl_post'</span>});
[bl_profile, st_profile_path, <span class="keyword">...</span>
    st_profile_prefix, st_profile_name_main, st_profile_suffix, <span class="keyword">...</span>
    bl_time, bl_display, it_display_every, bl_post] = params_group{:};
</pre><h2 id="6">Initialize Output Matrixes</h2><p>include mt_pol_idx which we did not have in looped code</p><pre class="codeinput">mt_val_cur = zeros(length(ar_a),length(ar_z));
mt_val = mt_val_cur - 1;
mt_pol_a = zeros(length(ar_a),length(ar_z));
mt_pol_a_cur = mt_pol_a - 1;
mt_pol_idx = zeros(length(ar_a),length(ar_z));

<span class="comment">% We did not need these in ff_abz_vf or ff_abz_vf_vec</span>
<span class="comment">% see</span>
<span class="comment">% &lt;https://fanwangecon.github.io/M4Econ/support/speed/partupdate/fs_u_c_partrepeat_main.html</span>
<span class="comment">% fs_u_c_partrepeat_main&gt; for why store using cells.</span>
cl_u_c_store = cell([it_z_n, 1]);
cl_c_valid_idx = cell([it_z_n, 1]);
</pre><h2 id="7">Initialize Convergence Conditions</h2><pre class="codeinput">bl_vfi_continue = true;
it_iter = 0;
ar_val_diff_norm = zeros([it_maxiter_val, 1]);
ar_pol_diff_norm = zeros([it_maxiter_val, 1]);
mt_pol_perc_change = zeros([it_maxiter_val, it_z_n]);
</pre><h2 id="8">Iterate Value Function</h2><p>Loop solution with 4 nested loops</p><div><ol><li>loop 1: over exogenous states</li><li>loop 2: over endogenous states</li><li>loop 3: over choices</li><li>loop 4: add future utility, integration--loop over future shocks</li></ol></div><pre class="codeinput"><span class="comment">% Start Profile</span>
<span class="keyword">if</span> (bl_profile)
    close <span class="string">all</span>;
    profile <span class="string">off</span>;
    profile <span class="string">on</span>;
<span class="keyword">end</span>

<span class="comment">% Start Timer</span>
<span class="keyword">if</span> (bl_time)
    tic;
<span class="keyword">end</span>

<span class="comment">% Value Function Iteration</span>
<span class="keyword">while</span> bl_vfi_continue
</pre><pre class="codeinput">    it_iter = it_iter + 1;
</pre><h2 id="10">Solve Optimization Problem Current Iteration</h2><p>Only this segment of code differs between ff_abz_vf and ff_abz_vf_vec Store in cells results and retrieve, this is more memory intensive than ff_abz_vf_vec.</p><pre class="codeinput">    <span class="comment">% loop 1: over exogenous states</span>
    <span class="keyword">for</span> it_z_i = 1:length(ar_z)

        <span class="comment">% Current Shock</span>
        fl_z = ar_z(it_z_i);

        <span class="comment">% cash-on-hand</span>
        ar_coh = f_coh(fl_z, ar_a);

        <span class="comment">% Consumption and u(c) only need to be evaluated once</span>
        <span class="keyword">if</span> (it_iter == 1)

            <span class="comment">% Consumption: fl_z = 1 by 1, ar_a = 1 by N, ar_a' = N by 1</span>
            <span class="comment">% mt_c is N by N: matrix broadcasting, expand to matrix from arrays</span>
            mt_c = f_cons_coh(ar_coh, ar_a');

            <span class="comment">% EVAL current utility: N by N, f_util defined earlier</span>
            <span class="comment">% slightly faster to explicitly write function</span>
            <span class="keyword">if</span> (fl_crra == 1)
                mt_utility = log(mt_c);
                fl_u_cmin = f_util_log(fl_c_min);
            <span class="keyword">else</span>
                <span class="comment">% slightly faster if write function here directly, but</span>
                <span class="comment">% speed gain is very small, more important to have single</span>
                <span class="comment">% location control of functions.</span>
                mt_utility = f_util_crra(mt_c);
                fl_u_cmin = f_util_crra(fl_c_min);
            <span class="keyword">end</span>

            <span class="comment">% Eliminate Complex Numbers</span>
            mt_it_c_valid_idx = (mt_c &lt;= fl_c_min);
            mt_utility(mt_it_c_valid_idx) = fl_u_cmin;

            <span class="comment">% Store in cells</span>
            cl_u_c_store{it_z_i} = mt_utility;
            cl_c_valid_idx{it_z_i} = mt_it_c_valid_idx;

        <span class="keyword">end</span>

        <span class="comment">% f(z'|z)</span>
        ar_z_trans_condi = mt_z_trans(it_z_i,:);

        <span class="comment">% EVAL EV((A',K'),Z'|Z) = V((A',K'),Z') x p(z'|z)', (N by Z) x (Z by 1) = N by 1</span>
        <span class="comment">% Note: transpose ar_z_trans_condi from 1 by Z to Z by 1</span>
        <span class="comment">% Note: matrix multiply not dot multiply</span>
        mt_evzp_condi_z = mt_val_cur * ar_z_trans_condi';

        <span class="comment">% EVAL add on future utility, N by N + N by 1</span>
        mt_utility = cl_u_c_store{it_z_i} + fl_beta*mt_evzp_condi_z;

        <span class="comment">% Index update</span>
        <span class="comment">% using the method below is much faster than index replace</span>
        <span class="comment">% see &lt;https://fanwangecon.github.io/M4Econ/support/speed/index/fs_subscript.html fs_subscript&gt;</span>
        mt_it_c_valid_idx = cl_c_valid_idx{it_z_i};
        <span class="comment">% Default or Not Utility Handling</span>
        <span class="keyword">if</span> (bl_default)
            <span class="comment">% if default: only today u(cmin), transition out next period, debt wiped out</span>
            fl_v_default = fl_u_cmin + fl_beta*mt_evzp_condi_z(ar_a == fl_default_aprime);
            mt_utility = mt_utility.*(~mt_it_c_valid_idx) + fl_v_default*(mt_it_c_valid_idx);
        <span class="keyword">else</span>
            <span class="comment">% if default is not allowed: v = u(cmin)</span>
            mt_utility = mt_utility.*(~mt_it_c_valid_idx) + fl_nan_replace*(mt_it_c_valid_idx);
        <span class="keyword">end</span>

        <span class="comment">% Optimization: remember matlab is column major, rows must be</span>
        <span class="comment">% choices, columns must be states</span>
        <span class="comment">% &lt;https://en.wikipedia.org/wiki/Row-_and_column-major_order COLUMN-MAJOR&gt;</span>
        <span class="comment">% mt_utility is N by N, rows are choices, cols are states.</span>
        [ar_opti_val_z, ar_opti_idx_z] = max(mt_utility);
        ar_opti_aprime_z = ar_a(ar_opti_idx_z);
        ar_opti_c_z = f_cons_coh(ar_coh, ar_opti_aprime_z);

        <span class="comment">% Handle Default is optimal or not</span>
        <span class="keyword">if</span> (bl_default)
            <span class="comment">% if defaulting is optimal choice, at these states, not required</span>
            <span class="comment">% to default, non-default possible, but default could be optimal</span>
            ar_opti_aprime_z(ar_opti_c_z &lt;= fl_c_min) = fl_default_aprime;
            ar_opti_idx_z(ar_opti_c_z &lt;= fl_c_min) = find(ar_a == fl_default_aprime);
        <span class="keyword">else</span>
            <span class="comment">% if default is not allowed, then next period same state as now</span>
            <span class="comment">% this is absorbing state, this is the limiting case, single</span>
            <span class="comment">% state space point, lowest a and lowest shock has this.</span>
            ar_opti_aprime_z(ar_opti_c_z &lt;= fl_c_min) = ar_a(ar_opti_c_z &lt;= fl_c_min);
        <span class="keyword">end</span>

        <span class="comment">% store optimal values</span>
        mt_val(:,it_z_i) = ar_opti_val_z;
        mt_pol_a(:,it_z_i) = ar_opti_aprime_z;

        <span class="keyword">if</span> (it_iter == (it_maxiter_val + 1))
            mt_pol_idx(:,it_z_i) = ar_opti_idx_z;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="11">Check Tolerance and Continuation</h2><pre class="codeinput">    <span class="comment">% Difference across iterations</span>
    ar_val_diff_norm(it_iter) = norm(mt_val - mt_val_cur);
    ar_pol_diff_norm(it_iter) = norm(mt_pol_a - mt_pol_a_cur);
    mt_pol_perc_change(it_iter, :) = sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n);

    <span class="comment">% Update</span>
    mt_val_cur = mt_val;
    mt_pol_a_cur = mt_pol_a;

    <span class="comment">% Print Iteration Results</span>
    <span class="keyword">if</span> (bl_display &amp;&amp; (rem(it_iter, it_display_every)==0))
        fprintf(<span class="string">'VAL it_iter:%d, fl_diff:%d, fl_diff_pol:%d\n'</span>, <span class="keyword">...</span>
            it_iter, ar_val_diff_norm(it_iter), ar_pol_diff_norm(it_iter));
        tb_valpol_iter = array2table([mean(mt_val_cur,1); mean(mt_pol_a_cur,1); <span class="keyword">...</span>
            mt_val_cur(it_a_n,:); mt_pol_a_cur(it_a_n,:)]);
        tb_valpol_iter.Properties.VariableNames = strcat(<span class="string">'z'</span>, string((1:size(mt_val_cur,2))));
        tb_valpol_iter.Properties.RowNames = {<span class="string">'mval'</span>, <span class="string">'map'</span>, <span class="string">'Hval'</span>, <span class="string">'Hap'</span>};
        disp(<span class="string">'mval = mean(mt_val_cur,1), average value over a'</span>)
        disp(<span class="string">'map  = mean(mt_pol_a_cur,1), average choice over a'</span>)
        disp(<span class="string">'Hval = mt_val_cur(it_a_n,:), highest a state val'</span>)
        disp(<span class="string">'Hap = mt_pol_a_cur(it_a_n,:), highest a state choice'</span>)
        disp(tb_valpol_iter);
    <span class="keyword">end</span>

    <span class="comment">% Continuation Conditions:</span>
    <span class="comment">% 1. if value function convergence criteria reached</span>
    <span class="comment">% 2. if policy function variation over iterations is less than</span>
    <span class="comment">% threshold</span>
    <span class="keyword">if</span> (it_iter == (it_maxiter_val + 1))
        bl_vfi_continue = false;
    <span class="keyword">elseif</span> ((it_iter == it_maxiter_val) || <span class="keyword">...</span>
            (ar_val_diff_norm(it_iter) &lt; fl_tol_val) || <span class="keyword">...</span>
            (sum(ar_pol_diff_norm(max(1, it_iter-it_tol_pol_nochange):it_iter)) &lt; fl_tol_pol))
        <span class="comment">% Fix to max, run again to save results if needed</span>
        it_iter_last = it_iter;
        it_iter = it_maxiter_val;
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>

<span class="comment">% End Timer</span>
<span class="keyword">if</span> (bl_time)
    toc;
<span class="keyword">end</span>

<span class="comment">% End Profile</span>
<span class="keyword">if</span> (bl_profile)
    profile <span class="string">off</span>
    profile <span class="string">viewer</span>
    st_file_name = [st_profile_prefix st_profile_name_main st_profile_suffix];
    profsave(profile(<span class="string">'info'</span>), strcat(st_profile_path, st_file_name));
<span class="keyword">end</span>
</pre><pre class="codeoutput">Elapsed time is 2.975347 seconds.
</pre><h2 id="13">Process Optimal Choices</h2><pre class="codeinput">result_map = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>, <span class="string">'ValueType'</span>,<span class="string">'any'</span>);
result_map(<span class="string">'mt_val'</span>) = mt_val;
result_map(<span class="string">'mt_pol_idx'</span>) = mt_pol_idx;

result_map(<span class="string">'cl_mt_pol_a'</span>) = {mt_pol_a, zeros(1)};
result_map(<span class="string">'cl_mt_pol_coh'</span>) = {f_coh(ar_z, ar_a'), zeros(1)};
result_map(<span class="string">'cl_mt_pol_c'</span>) = {f_cons_checkcmin(ar_z, ar_a', mt_pol_a), zeros(1)};
result_map(<span class="string">'ar_st_pol_names'</span>) = [<span class="string">"cl_mt_pol_a"</span>, <span class="string">"cl_mt_pol_coh"</span>, <span class="string">"cl_mt_pol_c"</span>];

<span class="keyword">if</span> (bl_post)
    bl_input_override = true;
    result_map(<span class="string">'ar_val_diff_norm'</span>) = ar_val_diff_norm(1:it_iter_last);
    result_map(<span class="string">'ar_pol_diff_norm'</span>) = ar_pol_diff_norm(1:it_iter_last);
    result_map(<span class="string">'mt_pol_perc_change'</span>) = mt_pol_perc_change(1:it_iter_last, :);
    result_map = ff_az_vf_post(param_map, support_map, armt_map, func_map, result_map, bl_input_override);
<span class="keyword">end</span>
</pre><pre class="codeoutput">Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
Warning: Using only the real component of complex data. 
valgap = norm(mt_val - mt_val_cur): value function difference across iterations
polgap = norm(mt_pol_a - mt_pol_a_cur): policy function difference across iterations
z1 = z1 perc change: sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n): percentage of state space points conditional on shock where the policy function is changing across iterations
                 valgap      polgap        z1          z2           z3           z4           z5           z6           z7           z8           z9           z10          z11          z12          z13          z14          z15   
                ________    ________    ________    _________    _________    _________    _________    _________    _________    _________    _________    _________    _________    _________    _________    _________    _________

    iter=1        197.72      2001.2           1            1            1            1            1            1            1            1            1            1            1            1            1            1            1
    iter=2        151.13      2162.9        0.98      0.98133      0.98267      0.98267        0.984      0.98667        0.988      0.99067        0.992      0.99467      0.99867            1            1            1            1
    iter=3        122.26       730.7     0.96267        0.964      0.96533        0.968      0.97067      0.97333        0.976         0.98        0.984      0.98933      0.99333        0.996        0.996            1            1
    iter=4        100.95      368.55     0.94933      0.95067      0.95467      0.95733      0.96133      0.96533        0.968      0.97333      0.97333      0.97733      0.98667        0.996      0.99467        0.996            1
    iter=5         85.32      216.95       0.928        0.932        0.936      0.93867         0.94      0.94533        0.952        0.956      0.96533        0.968      0.97867      0.98933      0.99733      0.99733      0.99067
    iter=6        73.002      146.16     0.91733      0.91733      0.91867      0.92267        0.928      0.93067      0.93467        0.944        0.948         0.96      0.96933      0.97333      0.99333        0.996        0.988
    iter=7        62.736      105.21     0.90133      0.90533        0.908      0.91333      0.91867        0.928        0.932      0.93467      0.93867        0.944      0.95733      0.95867         0.98      0.98667        0.996
    iter=8         54.32      77.714       0.884      0.88667      0.89333        0.892          0.9      0.90533      0.91467      0.92933      0.94133      0.94533      0.94667         0.96        0.964      0.97333      0.99067
    iter=9        47.136       60.29     0.87333      0.87867         0.88      0.88933      0.89733          0.9      0.90267      0.91733         0.92      0.94133        0.952        0.956        0.964      0.97333         0.98
    iter=10       41.045      47.623     0.85733         0.86      0.86667      0.87333         0.88      0.88533          0.9      0.90533        0.916      0.91733        0.932      0.94267      0.95867      0.96933      0.98267
    iter=11       35.762      39.681     0.85733      0.85867      0.86533      0.86667      0.87467      0.87867      0.88667        0.904        0.908        0.924      0.92667      0.94133      0.94267      0.96133        0.964
    iter=12       31.218      33.948       0.832      0.83867      0.84667        0.864         0.86      0.87733      0.88133      0.88133      0.89867      0.90667        0.916      0.92133      0.94533      0.95067      0.96267
    iter=13       27.295      28.519     0.83333      0.83733      0.83867      0.84667        0.856        0.852      0.86667      0.89067      0.88933      0.89333      0.90267        0.916         0.92        0.924      0.94933
    iter=14       23.904       22.23     0.80533        0.812      0.83333        0.832      0.83867      0.85333      0.86933      0.85733        0.876         0.88      0.89467      0.89333         0.92      0.93067        0.924
    iter=15       20.965      23.589     0.79333      0.80267      0.79733      0.81067         0.82        0.828      0.82267        0.856      0.85867        0.856      0.85067      0.87333      0.88133      0.88667        0.916
    iter=16       18.428      21.137     0.77867      0.78133        0.796      0.79733      0.79867          0.8         0.82      0.81467      0.81333        0.828      0.85067      0.84133      0.86133        0.876      0.86267
    iter=17       16.249      21.108     0.73867      0.74933      0.75867        0.772      0.76533      0.78533      0.77867      0.77867        0.804      0.78933      0.78933      0.80267        0.828      0.82533      0.86667
    iter=18       14.378      12.556       0.736      0.72267      0.73467        0.732      0.75333        0.748      0.75067      0.76933      0.76933      0.77333        0.796      0.80133        0.768      0.80533      0.81067
    iter=19       12.769      11.002     0.67333        0.692      0.69467      0.68933      0.69733      0.71467      0.71333      0.72133      0.70533        0.732        0.744      0.74133      0.77733      0.77733      0.76933
    iter=20       11.396      20.422     0.63867        0.668      0.65867      0.67467      0.65867      0.64933      0.66133        0.652      0.71467      0.68667         0.68      0.70533      0.70267      0.70933      0.75333
    iter=21       10.224      20.173     0.61467      0.61333        0.628        0.612        0.636      0.64933      0.67067        0.672      0.64133         0.68        0.676      0.67733      0.67467        0.704        0.684
    iter=22       9.2237      20.129       0.576        0.556        0.584      0.57467      0.57867      0.58533         0.58      0.59067      0.58267      0.59467      0.62133      0.61333      0.64933      0.65067      0.67067
    iter=23       8.3702      20.124       0.512      0.52933      0.52267      0.55733      0.54667      0.54267      0.53867      0.53733      0.58267      0.56133      0.56267        0.576        0.588        0.596        0.636
    iter=24       7.6408      6.2194        0.48      0.48533      0.47733        0.492        0.504          0.5      0.49333        0.528      0.51067      0.53467      0.50933      0.55867      0.53867        0.552      0.56267
    iter=25       7.0116      5.6041     0.43867        0.428        0.428        0.428        0.436      0.45067        0.468      0.44667      0.45467      0.47067      0.50267      0.48533      0.49467      0.53067      0.52267
    iter=26       6.4616      5.0871     0.36933      0.38667      0.38667      0.38667        0.388      0.39467        0.396      0.41333      0.41333      0.42267      0.42667        0.436      0.46533      0.47333        0.476
    iter=27       5.9721      4.7642     0.34133      0.33867      0.33867      0.35067      0.35067      0.36133      0.36267      0.35733      0.36933      0.37333        0.392        0.396      0.41067      0.42133        0.444
    iter=28       5.5318      4.2977     0.30533        0.308          0.3        0.304      0.30667        0.308      0.31867      0.32533        0.336      0.33867        0.344      0.36133      0.37067      0.37467      0.39867
    iter=29        5.135      20.058     0.27067        0.272      0.28267      0.27733      0.28267      0.28667      0.28933      0.29467      0.30133      0.30667      0.31467      0.31733         0.34      0.35067        0.364
    iter=30       4.7772      3.7269        0.24         0.26         0.24      0.25733         0.26      0.25467      0.26267        0.264      0.27867      0.27467      0.28267      0.29333      0.29733      0.32133      0.31867
    iter=31       4.4547      3.4177     0.21467      0.21333        0.228        0.216      0.21867      0.23067      0.23333      0.24533      0.24133        0.252      0.25867        0.256      0.26667      0.27467      0.28133
    iter=32       4.1635      3.1889     0.18933        0.208          0.2      0.20267      0.20533        0.208      0.21333        0.208      0.21867      0.22667      0.23467        0.244        0.256      0.25867        0.272
    iter=33       3.9004      2.8822     0.18267        0.176      0.18133        0.184      0.19333      0.18933        0.196      0.20133      0.20533      0.20133      0.20667      0.21733      0.21867        0.236      0.23733
    iter=34       3.6622      2.6491     0.16133         0.16      0.15733      0.16533      0.16133      0.16667      0.16933      0.18267         0.18      0.19067      0.19867      0.19333        0.208      0.20667      0.22133
    iter=35        3.446      2.5175     0.14667      0.14267      0.14933        0.152        0.156      0.15733      0.15867        0.156      0.16667        0.164        0.168         0.18        0.184        0.192        0.204
    iter=36       3.2493       2.196     0.12533      0.13733      0.13333      0.13467      0.13333        0.136      0.14267        0.144        0.152        0.152         0.16      0.16933      0.16667         0.18      0.19733
    iter=37       3.0698      2.0006       0.116        0.116        0.116         0.12        0.128        0.128      0.13067        0.136      0.13867         0.14        0.144        0.148        0.156      0.15467      0.16533
    iter=38       2.9054      1.8256     0.10667        0.104        0.112      0.11333      0.10933      0.11867         0.12      0.12133        0.124      0.12533      0.12533      0.13467         0.14        0.152      0.15867
    iter=39       2.7543      1.6879       0.096      0.10267        0.096     0.098667     0.098667        0.104      0.10533        0.104      0.11333        0.116        0.124      0.12133      0.13733      0.12667        0.136
    iter=40       2.6147      1.5665    0.089333     0.085333     0.082667     0.094667     0.094667        0.088          0.1        0.104      0.10267        0.108        0.108      0.11067        0.116         0.12      0.12933
    iter=41       2.4854      1.4983       0.076     0.082667        0.088        0.076     0.086667        0.088     0.086667     0.089333        0.092     0.089333     0.094667      0.10267      0.10133        0.116      0.11867
    iter=42       2.3648      1.4004    0.073333     0.069333     0.077333     0.074667     0.073333        0.084     0.078667     0.073333        0.088     0.090667     0.089333      0.10133        0.096          0.1      0.10667
    iter=43        2.252      1.2551       0.068     0.061333     0.069333        0.072     0.066667     0.061333     0.070667     0.074667     0.077333     0.078667        0.084         0.08     0.089333     0.086667     0.093333
    iter=44       2.1459      1.1621       0.056        0.056     0.057333     0.061333     0.061333     0.065333     0.065333     0.069333     0.066667     0.070667     0.073333     0.074667     0.078667     0.086667     0.089333
    iter=45       2.0457      1.0772    0.046667         0.06     0.049333     0.058667        0.056     0.058667     0.057333     0.066667        0.064     0.062667     0.069333        0.068     0.074667        0.076         0.08
    iter=46       1.9506      1.0446    0.045333     0.050667        0.052        0.044        0.052     0.053333        0.056        0.052     0.053333         0.06     0.057333        0.068     0.066667     0.069333     0.073333
    iter=47       1.8602      1.0151       0.044        0.036        0.044        0.044     0.050667        0.048     0.049333     0.042667     0.054667     0.050667     0.050667     0.057333     0.065333     0.065333     0.070667
    iter=48       1.7739     0.86835    0.041333         0.04     0.038667     0.041333     0.037333     0.041333     0.042667        0.048     0.049333     0.049333     0.053333        0.052     0.054667     0.057333     0.054667
    iter=49       1.6913     0.85714       0.032     0.034667         0.04     0.033333     0.034667     0.038667     0.038667     0.042667     0.042667     0.046667     0.049333     0.046667     0.045333     0.046667        0.052
    iter=50       1.6122     0.81398    0.029333     0.029333        0.032        0.032     0.034667     0.030667     0.034667     0.033333     0.037333     0.042667         0.04     0.042667        0.044     0.049333        0.052
    iter=76      0.38598    0.093458           0    0.0013333            0            0            0            0            0    0.0013333            0    0.0013333            0    0.0013333            0            0    0.0013333
    iter=77      0.36319     0.13217           0            0            0    0.0013333            0    0.0013333            0    0.0013333            0            0    0.0013333    0.0013333    0.0013333    0.0013333    0.0026667
    iter=78      0.34169    0.093458           0    0.0013333            0            0            0    0.0013333            0            0            0            0            0            0            0            0            0
    iter=79      0.32142    0.093458           0            0            0            0    0.0013333            0            0            0            0            0            0    0.0013333            0            0            0
    iter=80      0.30232    0.093458           0            0            0            0            0            0            0            0            0            0            0            0            0    0.0013333    0.0013333
    iter=81      0.28433    0.093458           0            0    0.0013333            0    0.0013333            0            0            0            0            0    0.0013333            0            0            0    0.0013333
    iter=82       0.2674    0.093458           0            0    0.0013333            0            0            0    0.0013333            0            0            0            0            0            0    0.0013333            0
    iter=83      0.25146    0.093458           0            0            0            0            0            0            0            0            0            0            0            0            0            0    0.0013333
    iter=84      0.23646    0.093458           0            0            0            0    0.0013333            0            0            0            0            0            0            0            0            0            0
    iter=85      0.22235    0.093458           0            0            0            0            0            0            0            0    0.0013333            0            0            0            0            0            0
    iter=86      0.20908    0.093458           0            0            0            0            0    0.0013333            0    0.0013333    0.0013333    0.0013333            0            0            0            0            0
    iter=87      0.19659           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=88      0.18484           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=89       0.1738           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=90      0.16341           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=91      0.15364           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=92      0.14445           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=93       0.1358           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=94      0.12768           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=95      0.12003           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=96      0.11284    0.093458           0            0            0    0.0013333            0            0            0            0            0            0            0            0            0            0            0
    iter=97      0.10609           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=98     0.099731    0.093458           0            0            0    0.0013333            0            0            0            0            0            0            0            0            0            0            0
    iter=99     0.093756    0.093458           0            0            0            0            0            0            0            0    0.0013333            0            0            0            0            0            0
    iter=100    0.088137           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=101    0.082854           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=102    0.077888           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=103    0.073218           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=104    0.068828           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=105    0.064701           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=106    0.060821           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=107    0.057173           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=108    0.053744           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=109     0.05052           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=110     0.04749           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=111    0.044642           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=112    0.041964           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=113    0.039446           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=114     0.03708           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=115    0.034856           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=116    0.032765           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=117    0.030799           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=118    0.028952           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=119    0.027215           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=120    0.025582           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=121    0.024047           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=122    0.022604           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=123    0.021248           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=124    0.019974           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0
    iter=125    0.018775           0           0            0            0            0            0            0            0            0            0            0            0            0            0            0            0

tb_val: V(a,z) value at each state space point
                    z1_0_34741    z2_0_40076    z3_0_4623    z4_0_5333    z5_0_61519    z6_0_70966    z10_1_2567    z11_1_4496    z12_1_6723    z13_1_9291    z14_2_2253    z15_2_567
                    __________    __________    _________    _________    __________    __________    __________    __________    __________    __________    __________    _________

    a1=-20           -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266       -7.7598       -7.3961       -7.0428       -6.4272 
    a2=-19.9065      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266       -7.7598       -7.3961       -6.9596       -6.3677 
    a3=-19.8131      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266       -7.7598       -7.3961        -6.871       -6.3141 
    a4=-19.7196      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266       -7.7598       -7.3961       -6.7934       -6.2654 
    a5=-19.6262      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266       -7.7598       -7.3125       -6.7248        -6.221 
    a6=-19.5327      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266       -7.7598       -7.2144       -6.6636       -6.1802 
    a7=-19.4393      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266        -7.733       -7.1294       -6.6085       -6.1413 
    a8=-19.3458      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1266       -7.6141       -7.0547       -6.5585       -6.0793 
    a9=-19.2523      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -8.1189       -7.5128       -6.9884        -6.513       -6.0149 
    a10=-19.1589     -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4942       -7.9821       -7.4252        -6.929       -6.4712        -5.954 
    a11=-19.0654     -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.4592       -7.8674       -7.3485       -6.8755       -6.4327       -5.8952 
    a12=-18.972      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.3111       -7.7693       -7.2806       -6.8269       -6.3971       -5.8401 
    a13=-18.8785     -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405        -8.188       -7.6843       -7.2199       -6.7826       -6.3641       -5.7862 
    a14=-18.785      -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -8.0836       -7.6097       -7.1652       -6.7418       -6.3052       -5.7336 
    a15=-18.6916     -11.422       -11.183       -10.908      -10.605      -10.281       -9.9405       -7.9936       -7.5434       -7.1156       -6.7042        -6.242       -5.6789 
    a16=-18.5981     -11.422       -11.183       -10.908      -10.605      -10.281       -9.9152       -7.9149       -7.4841       -7.0704       -6.6694       -6.1804       -5.6264 
    a17=-18.5047     -11.422       -11.183       -10.908      -10.605      -10.221       -9.6909       -7.8454       -7.4306        -7.029       -6.6371       -6.1227        -5.575 
    a18=-18.4112     -11.422       -11.183       -10.908      -10.476      -9.9854       -9.5144       -7.7833        -7.382       -6.9907       -6.6069       -6.0644       -5.5265 
    a19=-18.3178     -11.422       -11.132       -10.684       -10.24      -9.8016       -9.3708       -7.7276       -7.3377       -6.9554       -6.5706       -6.0087       -5.4795 
    a20=-18.2243     -11.221       -10.846       -10.454      -10.055      -9.6528       -9.2511        -7.677       -7.2969       -6.9225       -6.5039       -5.9547       -5.4306 
    a21=-18.1308     -10.962       -10.629       -10.274      -9.9052      -9.5293       -9.1492        -7.631       -7.2594       -6.8919       -6.4386       -5.9032       -5.3777 
    a22=-18.0374     -10.763       -10.458       -10.127      -9.7811      -9.4244       -9.0611       -7.5888       -7.2246       -6.8633       -6.3773       -5.8546       -5.3276 
    a23=-17.9439     -10.603       -10.318       -10.006      -9.6759      -9.3341        -8.984         -7.55       -7.1922       -6.8364       -6.3193        -5.807       -5.2781 
    a24=-17.8505     -10.472       -10.201       -9.9024      -9.5853      -9.2552       -8.9157       -7.5141       -7.1621       -6.7891       -6.2638       -5.7619       -5.2294 
    a25=-17.757      -10.361       -10.101       -9.8131      -9.5061      -9.1855       -8.8548       -7.4808       -7.1338       -6.7229       -6.2119       -5.7132       -5.1761 
    a26=-17.6636     -10.266       -10.015       -9.7351      -9.4362      -9.1233       -8.7999       -7.4498       -7.1074       -6.6581       -6.1614       -5.6633       -5.1234 
    a27=-17.5701     -10.183       -9.9389       -9.6661      -9.3738      -9.0674       -8.7501       -7.4208       -7.0824       -6.5993       -6.1144       -5.6163        -5.074 
    a28=-17.4766      -10.11       -9.8717       -9.6045      -9.3178      -9.0167       -8.7048       -7.3936       -7.0362       -6.5414       -6.0679         -5.57       -5.0227 
    a29=-17.3832     -10.046       -9.8117       -9.5491       -9.267      -8.9706       -8.6631        -7.368       -6.9661       -6.4886         -6.02       -5.5208       -4.9705 
    a30=-17.2897     -9.9878       -9.7575       -9.4989      -9.2208      -8.9284       -8.6248        -7.344       -6.9027       -6.4365       -5.9732       -5.4692       -4.9195 
    a31=-17.1963     -9.9354       -9.7084       -9.4531      -9.1784      -8.8895       -8.5893       -7.3145       -6.8406       -6.3876       -5.9278       -5.4201       -4.8694 
    a32=-17.1028     -9.8878       -9.6636       -9.4112      -9.1395      -8.8535       -8.5564       -7.2404        -6.784       -6.3386       -5.8842       -5.3709       -4.8188 
    a33=-17.0093     -9.8443       -9.6224       -9.3726      -9.1034      -8.8201       -8.5257       -7.1732       -6.7281       -6.2919       -5.8415       -5.3181       -4.7676 
    a34=-16.9159     -9.8042       -9.5845       -9.3368        -9.07       -8.789        -8.497       -7.1081       -6.6754       -6.2464       -5.7932       -5.2663       -4.7175 
    a35=-16.8224     -9.7673       -9.5494       -9.3037      -9.0389        -8.76       -8.4701       -7.0478       -6.6252        -6.204       -5.7454       -5.2161       -4.6676 
    a36=-16.729      -9.7331       -9.5168       -9.2728      -9.0098      -8.7328       -8.4448       -6.9899       -6.5771        -6.162       -5.6983       -5.1654       -4.6171 
    a37=-16.6355     -9.7012       -9.4864       -9.2439      -8.9825      -8.7072       -8.4209       -6.9357       -6.5317        -6.122        -5.647       -5.1147       -4.5663 
    a38=-16.5421     -9.6715       -9.4579       -9.2168      -8.9569      -8.6831       -8.3984       -6.8839       -6.4876       -6.0772       -5.5963       -5.0641       -4.5159 
    a39=-16.4486     -9.6436       -9.4312       -9.1914      -8.9327      -8.6603       -8.3771       -6.8347       -6.4463       -6.0339       -5.5444       -5.0146       -4.4656 
    a40=-16.3551     -9.6175       -9.4062       -9.1674        -8.91      -8.6388       -8.3368       -6.7879       -6.4056       -5.9905        -5.493       -4.9656       -4.4141 
    a41=-16.2617     -9.5929       -9.3825       -9.1448      -8.8884      -8.6184       -8.2502       -6.7431       -6.3639       -5.9426       -5.4412       -4.9157       -4.3627 
    a42=-16.1682     -9.5697       -9.3601       -9.1233       -8.868      -8.5387       -8.1713       -6.7003       -6.3235       -5.8925       -5.3905       -4.8663       -4.3112 
    a43=-16.0748     -9.5477        -9.339        -9.103      -8.8053      -8.4524       -8.0956       -6.6581       -6.2842       -5.8405       -5.3409       -4.8172       -4.2594 
    a44=-15.9813     -9.5269       -9.3189       -9.0461      -8.7135      -8.3726       -8.0266       -6.6172       -6.2448       -5.7879       -5.2917       -4.7668       -4.2078 
    a45=-15.8879     -9.5072       -9.2599       -8.9517      -8.6288      -8.2971       -7.9595       -6.5786       -6.2021        -5.735       -5.2421       -4.7167       -4.1564 
    a46=-15.7944     -9.4323       -9.1601       -8.8624      -8.5496      -8.2273       -7.8985       -6.5405       -6.1533       -5.6837       -5.1937       -4.6666       -4.1044 
    a47=-15.7009     -9.3344         -9.07       -8.7803      -8.4753      -8.1604       -7.8386       -6.5051       -6.1005        -5.633       -5.1458       -4.6164       -4.0526 
    a48=-15.6075     -9.2405       -8.9845       -8.7031       -8.406      -8.0988       -7.7842       -6.4661       -6.0468       -5.5824       -5.0968       -4.5656       -4.0007 
    a49=-15.514      -9.1556       -8.9058       -8.6308      -8.3401       -8.039       -7.7303       -6.4284        -5.993       -5.5335       -5.0481       -4.5145       -3.9485 
    a50=-15.4206     -9.0748       -8.8316       -8.5631      -8.2789      -7.9841       -7.6809       -6.3797       -5.9397       -5.4853       -4.9995       -4.4628       -3.8962 
    a701=45.4206      13.325        13.377        13.437       13.502       13.572        13.647        14.004         14.11        14.222        14.341        14.466        14.591 
    a702=45.514       13.336        13.389        13.448       13.513       13.583        13.658        14.014         14.12        14.232        14.351        14.475          14.6 
    a703=45.6075      13.347          13.4        13.459       13.524       13.594        13.669        14.025         14.13        14.242        14.361        14.485         14.61 
    a704=45.7009      13.359        13.411        13.471       13.536       13.605         13.68        14.035         14.14        14.252         14.37        14.494        14.619 
    a705=45.7944       13.37        13.423        13.482       13.547       13.616        13.691        14.045         14.15        14.262         14.38        14.504        14.628 
    a706=45.8879      13.382        13.434        13.493       13.558       13.627        13.702        14.055         14.16        14.271         14.39        14.513        14.638 
    a707=45.9813      13.393        13.445        13.504       13.569       13.638        13.713        14.066         14.17        14.281        14.399        14.523        14.647 
    a708=46.0748      13.404        13.456        13.515        13.58       13.649        13.723        14.076         14.18        14.291        14.409        14.532        14.656 
    a709=46.1682      13.416        13.468        13.527       13.591        13.66        13.734        14.086         14.19        14.301        14.419        14.542        14.665 
    a710=46.2617      13.427        13.479        13.538       13.602       13.671        13.745        14.096          14.2        14.311        14.428        14.551        14.674 
    a711=46.3551      13.438         13.49        13.549       13.613       13.682        13.756        14.106         14.21         14.32        14.438         14.56        14.684 
    a712=46.4486       13.45        13.501         13.56       13.624       13.693        13.766        14.116         14.22         14.33        14.447         14.57        14.693 
    a713=46.5421      13.461        13.513        13.571       13.635       13.703        13.777        14.126         14.23         14.34        14.457        14.579        14.702 
    a714=46.6355      13.472        13.524        13.582       13.646       13.714        13.788        14.136         14.24         14.35        14.467        14.588        14.711 
    a715=46.729       13.483        13.535        13.593       13.657       13.725        13.798        14.147        14.249        14.359        14.476        14.598         14.72 
    a716=46.8224      13.495        13.546        13.604       13.668       13.736        13.809        14.157        14.259        14.369        14.486        14.607        14.729 
    a717=46.9159      13.506        13.557        13.615       13.678       13.747         13.82        14.167        14.269        14.379        14.495        14.616        14.738 
    a718=47.0093      13.517        13.568        13.626       13.689       13.757         13.83        14.177        14.279        14.388        14.504        14.626        14.748 
    a719=47.1028      13.528        13.579        13.637         13.7       13.768        13.841        14.187        14.289        14.398        14.514        14.635        14.757 
    a720=47.1963      13.539         13.59        13.648       13.711       13.779        13.851        14.197        14.299        14.408        14.523        14.644        14.766 
    a721=47.2897       13.55        13.601        13.659       13.722       13.789        13.862        14.207        14.308        14.417        14.533        14.653        14.775 
    a722=47.3832      13.561        13.612         13.67       13.732         13.8        13.872        14.216        14.318        14.427        14.542        14.663        14.784 
    a723=47.4766      13.572        13.623         13.68       13.743       13.811        13.883        14.226        14.328        14.436        14.552        14.672        14.793 
    a724=47.5701      13.583        13.634        13.691       13.754       13.821        13.893        14.236        14.338        14.446        14.561        14.681        14.802 
    a725=47.6636      13.594        13.645        13.702       13.765       13.832        13.904        14.246        14.347        14.456         14.57         14.69        14.811 
    a726=47.757       13.605        13.656        13.713       13.775       13.842        13.914        14.256        14.357        14.465         14.58        14.699         14.82 
    a727=47.8505      13.616        13.667        13.724       13.786       13.853        13.925        14.266        14.367        14.475        14.589        14.708        14.829 
    a728=47.9439      13.627        13.678        13.734       13.797       13.864        13.935        14.276        14.376        14.484        14.598        14.718        14.838 
    a729=48.0374      13.638        13.688        13.745       13.807       13.874        13.946        14.286        14.386        14.494        14.608        14.727        14.847 
    a730=48.1308      13.649        13.699        13.756       13.818       13.885        13.956        14.295        14.396        14.503        14.617        14.736        14.856 
    a731=48.2243       13.66         13.71        13.767       13.828       13.895        13.966        14.305        14.405        14.512        14.626        14.745        14.864 
    a732=48.3178      13.671        13.721        13.777       13.839       13.905        13.977        14.315        14.415        14.522        14.635        14.754        14.873 
    a733=48.4112      13.682        13.732        13.788        13.85       13.916        13.987        14.325        14.425        14.531        14.645        14.763        14.882 
    a734=48.5047      13.693        13.742        13.799        13.86       13.926        13.997        14.334        14.434        14.541        14.654        14.772        14.891 
    a735=48.5981      13.704        13.753        13.809       13.871       13.937        14.008        14.344        14.444         14.55        14.663        14.781          14.9 
    a736=48.6916      13.714        13.764         13.82       13.881       13.947        14.018        14.354        14.453         14.56        14.672         14.79        14.909 
    a737=48.785       13.725        13.774        13.831       13.892       13.958        14.028        14.364        14.463        14.569        14.682        14.799        14.918 
    a738=48.8785      13.736        13.785        13.841       13.902       13.968        14.038        14.373        14.472        14.578        14.691        14.808        14.926 
    a739=48.972       13.747        13.796        13.852       13.913       13.978        14.049        14.383        14.482        14.588          14.7        14.817        14.935 
    a740=49.0654      13.757        13.806        13.862       13.923       13.989        14.059        14.393        14.491        14.597        14.709        14.826        14.944 
    a741=49.1589      13.768        13.817        13.873       13.933       13.999        14.069        14.402        14.501        14.606        14.718        14.835        14.953 
    a742=49.2523      13.779        13.828        13.883       13.944       14.009        14.079        14.412         14.51        14.616        14.727        14.844        14.961 
    a743=49.3458      13.789        13.838        13.894       13.954       14.019        14.089        14.421         14.52        14.625        14.736        14.853         14.97 
    a744=49.4393        13.8        13.849        13.904       13.965        14.03        14.099        14.431        14.529        14.634        14.745        14.862        14.979 
    a745=49.5327      13.811        13.859        13.915       13.975        14.04        14.109        14.441        14.539        14.643        14.755        14.871        14.988 
    a746=49.6262      13.821         13.87        13.925       13.985        14.05         14.12         14.45        14.548        14.653        14.764         14.88        14.996 
    a747=49.7196      13.832         13.88        13.935       13.996        14.06         14.13         14.46        14.557        14.662        14.773        14.888        15.005 
    a748=49.8131      13.842        13.891        13.946       14.006       14.071         14.14        14.469        14.567        14.671        14.782        14.897        15.014 
    a749=49.9065      13.853        13.901        13.956       14.016       14.081         14.15        14.479        14.576         14.68        14.791        14.906        15.022 
    a750=50           13.863        13.912        13.967       14.026       14.091         14.16        14.488        14.585        14.689          14.8        14.915        15.031 

tb_pol_a: optimal asset choice for each state space point
                    z1_0_34741    z2_0_40076    z3_0_4623    z4_0_5333    z5_0_61519    z6_0_70966    z10_1_2567    z11_1_4496    z12_1_6723    z13_1_9291    z14_2_2253    z15_2_567
                    __________    __________    _________    _________    __________    __________    __________    __________    __________    __________    __________    _________

    a1=-20                 0             0             0            0            0             0             0             0             0             0             0           -20 
    a2=-19.9065            0             0             0            0            0             0             0             0             0             0           -20           -20 
    a3=-19.8131            0             0             0            0            0             0             0             0             0             0           -20           -20 
    a4=-19.7196            0             0             0            0            0             0             0             0             0             0           -20           -20 
    a5=-19.6262            0             0             0            0            0             0             0             0             0           -20           -20           -20 
    a6=-19.5327            0             0             0            0            0             0             0             0             0           -20           -20           -20 
    a7=-19.4393            0             0             0            0            0             0             0             0           -20           -20           -20       -19.907 
    a8=-19.3458            0             0             0            0            0             0             0             0           -20           -20           -20       -19.252 
    a9=-19.2523            0             0             0            0            0             0             0           -20           -20           -20           -20       -19.159 
    a10=-19.1589           0             0             0            0            0             0             0           -20           -20           -20           -20       -19.159 
    a11=-19.0654           0             0             0            0            0             0           -20           -20           -20           -20           -20       -19.065 
    a12=-18.972            0             0             0            0            0             0           -20           -20           -20           -20           -20       -18.972 
    a13=-18.8785           0             0             0            0            0             0           -20           -20           -20           -20           -20       -18.972 
    a14=-18.785            0             0             0            0            0             0           -20           -20           -20           -20       -19.065       -18.785 
    a15=-18.6916           0             0             0            0            0             0           -20           -20           -20           -20       -18.972       -18.692 
    a16=-18.5981           0             0             0            0            0           -20           -20           -20           -20           -20       -18.972       -18.692 
    a17=-18.5047           0             0             0            0          -20           -20           -20           -20           -20           -20       -18.879       -18.598 
    a18=-18.4112           0             0             0          -20          -20           -20           -20           -20           -20           -20       -18.785       -18.505 
    a19=-18.3178           0           -20           -20          -20          -20           -20           -20           -20           -20       -18.879       -18.692       -18.505 
    a20=-18.2243         -20           -20           -20          -20          -20           -20           -20           -20           -20       -18.785       -18.692       -18.224 
    a21=-18.1308         -20           -20           -20          -20          -20           -20           -20           -20           -20       -18.785       -18.598       -18.131 
    a22=-18.0374         -20           -20           -20          -20          -20           -20           -20           -20           -20       -18.692       -18.598       -18.037 
    a23=-17.9439         -20           -20           -20          -20          -20           -20           -20           -20           -20       -18.692       -18.505       -18.037 
    a24=-17.8505         -20           -20           -20          -20          -20           -20           -20           -20       -18.692       -18.598       -18.411       -17.757 
    a25=-17.757          -20           -20           -20          -20          -20           -20           -20           -20       -18.692       -18.598       -18.224       -17.664 
    a26=-17.6636         -20           -20           -20          -20          -20           -20           -20           -20       -18.598       -18.505       -18.131       -17.664 
    a27=-17.5701         -20           -20           -20          -20          -20           -20           -20           -20       -18.598       -18.411       -18.037        -17.57 
    a28=-17.4766         -20           -20           -20          -20          -20           -20           -20       -18.598       -18.505       -18.411       -18.037       -17.383 
    a29=-17.3832         -20           -20           -20          -20          -20           -20           -20       -18.505       -18.411       -18.224       -17.757        -17.29 
    a30=-17.2897         -20           -20           -20          -20          -20           -20           -20       -18.505       -18.411       -18.131       -17.664        -17.29 
    a31=-17.1963         -20           -20           -20          -20          -20           -20       -18.411       -18.411       -18.318       -18.131       -17.664       -17.196 
    a32=-17.1028         -20           -20           -20          -20          -20           -20       -18.411       -18.318       -18.224       -18.037       -17.477       -17.009 
    a33=-17.0093         -20           -20           -20          -20          -20           -20       -18.318       -18.318       -18.224       -17.757       -17.383       -16.916 
    a34=-16.9159         -20           -20           -20          -20          -20           -20       -18.318       -18.224       -18.131       -17.664        -17.29       -16.822 
    a35=-16.8224         -20           -20           -20          -20          -20           -20       -18.224       -18.224       -18.131       -17.664       -17.196       -16.729 
    a36=-16.729          -20           -20           -20          -20          -20           -20       -18.224       -18.131       -18.037       -17.383       -17.103       -16.636 
    a37=-16.6355         -20           -20           -20          -20          -20           -20       -18.131       -18.131       -17.757       -17.383       -16.916       -16.542 
    a38=-16.5421         -20           -20           -20          -20          -20           -20       -18.131       -18.037       -17.757        -17.29       -16.916       -16.449 
    a39=-16.4486         -20           -20           -20          -20          -20           -20       -18.037       -18.037       -17.664       -17.103       -16.822       -16.262 
    a40=-16.3551         -20           -20           -20          -20          -20       -18.131       -18.037        -17.85       -17.383       -17.009       -16.729       -16.168 
    a41=-16.2617         -20           -20           -20          -20          -20       -18.037       -17.944       -17.757        -17.29       -16.916       -16.542       -16.075 
    a42=-16.1682         -20           -20           -20          -20      -18.037       -18.037        -17.85       -17.757       -17.103       -16.822       -16.449       -15.981 
    a43=-16.0748         -20           -20           -20      -17.944      -17.944       -17.944        -17.85       -17.664       -17.009       -16.729       -16.355       -15.888 
    a44=-15.9813         -20           -20       -17.944      -17.944      -17.944       -17.944       -17.757       -17.383       -16.916       -16.636       -16.262       -15.794 
    a45=-15.8879         -20        -17.85        -17.85       -17.85       -17.85        -17.85       -17.757       -17.383       -16.822       -16.542       -16.168       -15.701 
    a46=-15.7944      -17.85        -17.85        -17.85       -17.85       -17.85        -17.85       -17.664       -17.009       -16.729       -16.449       -16.075       -15.607 
    a47=-15.7009     -17.757       -17.757       -17.757      -17.757      -17.757       -17.757        -17.57       -16.822       -16.636       -16.355       -15.981       -15.514 
    a48=-15.6075     -17.757       -17.757       -17.757      -17.757      -17.757       -17.757       -17.383       -16.822       -16.542       -16.262       -15.794       -15.421 
    a49=-15.514      -17.664       -17.664       -17.664      -17.664      -17.664       -17.664       -17.103       -16.636       -16.449       -16.168       -15.701       -15.234 
    a50=-15.4206     -17.664       -17.664       -17.664      -17.664      -17.664        -17.57       -16.822       -16.542       -16.449       -16.075       -15.607        -15.14 
    a701=45.4206      42.897        42.897        42.991       43.084       43.084        43.178        43.738        43.925        44.206        44.393        44.766         45.14 
    a702=45.514       42.991        42.991        43.084       43.178       43.178        43.271        43.832        44.019        44.299        44.486         44.86        45.234 
    a703=45.6075      43.084        43.084        43.178       43.271       43.271        43.364        43.925        44.112        44.299        44.579        44.953        45.327 
    a704=45.7009      43.178        43.178        43.271       43.364       43.364        43.458        44.019        44.206        44.393        44.673        45.047        45.421 
    a705=45.7944      43.271        43.271        43.364       43.458       43.458        43.551        44.112        44.299        44.486        44.766         45.14        45.514 
    a706=45.8879      43.364        43.364        43.458       43.458       43.551        43.645        44.206        44.393        44.579         44.86        45.234        45.607 
    a707=45.9813      43.458        43.458        43.551       43.551       43.645        43.738        44.299        44.486        44.673        44.953        45.327        45.701 
    a708=46.0748      43.551        43.551        43.645       43.645       43.738        43.832        44.393        44.579        44.766        45.047        45.421        45.794 
    a709=46.1682      43.645        43.645        43.738       43.738       43.832        43.925        44.486        44.673         44.86         45.14        45.514        45.888 
    a710=46.2617      43.738        43.738        43.832       43.832       43.925        44.019        44.579        44.766        44.953        45.234        45.607        45.888 
    a711=46.3551      43.832        43.832        43.925       43.925       44.019        44.112        44.673         44.86        45.047        45.327        45.607        45.981 
    a712=46.4486      43.925        43.925        44.019       44.019       44.112        44.206        44.766        44.953         45.14        45.421        45.701        46.075 
    a713=46.5421      44.019        44.019        44.112       44.112       44.206        44.299         44.86        45.047        45.234        45.514        45.794        46.168 
    a714=46.6355      44.112        44.112        44.206       44.206       44.299        44.393        44.953         45.14        45.327        45.607        45.888        46.262 
    a715=46.729       44.206        44.206        44.299       44.299       44.393        44.486        45.047        45.234        45.421        45.701        45.981        46.355 
    a716=46.8224      44.206        44.299        44.393       44.393       44.486        44.579         45.14        45.327        45.514        45.794        46.075        46.449 
    a717=46.9159      44.299        44.393        44.486       44.486       44.579        44.673        45.234        45.421        45.607        45.888        46.168        46.542 
    a718=47.0093      44.393        44.486        44.486       44.579       44.673        44.766        45.327        45.514        45.701        45.981        46.262        46.636 
    a719=47.1028      44.486        44.579        44.579       44.673       44.766         44.86        45.327        45.607        45.794        46.075        46.355        46.729 
    a720=47.1963      44.579        44.673        44.673       44.766        44.86        44.953        45.421        45.701        45.888        46.168        46.449        46.822 
    a721=47.2897      44.673        44.766        44.766        44.86       44.953        45.047        45.514        45.794        45.981        46.262        46.542        46.916 
    a722=47.3832      44.766         44.86         44.86       44.953       45.047         45.14        45.607        45.794        46.075        46.355        46.636        47.009 
    a723=47.4766       44.86        44.953        44.953       45.047        45.14        45.234        45.701        45.888        46.168        46.449        46.729        47.103 
    a724=47.5701      44.953        45.047        45.047        45.14       45.234        45.327        45.794        45.981        46.262        46.542        46.822        47.196 
    a725=47.6636      45.047         45.14         45.14       45.234       45.327        45.421        45.888        46.075        46.355        46.636        46.916         47.29 
    a726=47.757        45.14        45.234        45.234       45.327       45.421        45.514        45.981        46.168        46.449        46.729        47.009        47.383 
    a727=47.8505      45.234        45.327        45.327       45.421       45.514        45.607        46.075        46.262        46.542        46.822        47.103        47.477 
    a728=47.9439      45.327        45.421        45.421       45.514       45.607        45.701        46.168        46.355        46.636        46.916        47.196         47.57 
    a729=48.0374      45.421        45.514        45.514       45.607       45.701        45.794        46.262        46.449        46.729        47.009         47.29        47.664 
    a730=48.1308      45.514        45.607        45.607       45.701       45.794        45.794        46.355        46.542        46.822        47.103        47.383        47.757 
    a731=48.2243      45.607        45.701        45.701       45.794       45.888        45.888        46.449        46.636        46.916        47.196        47.477         47.85 
    a732=48.3178      45.701        45.701        45.794       45.888       45.981        45.981        46.542        46.729        47.009         47.29         47.57        47.944 
    a733=48.4112      45.794        45.794        45.888       45.981       45.981        46.075        46.636        46.822        47.103         47.29        47.664        48.037 
    a734=48.5047      45.888        45.888        45.981       46.075       46.075        46.168        46.729        46.916        47.196        47.383        47.757        48.131 
    a735=48.5981      45.981        45.981        46.075       46.168       46.168        46.262        46.822        47.009         47.29        47.477         47.85        48.224 
    a736=48.6916      46.075        46.075        46.168       46.262       46.262        46.355        46.916        47.103        47.383         47.57        47.944        48.318 
    a737=48.785       46.168        46.168        46.262       46.355       46.355        46.449        47.009        47.196        47.477        47.664        48.037        48.411 
    a738=48.8785      46.262        46.262        46.355       46.449       46.449        46.542        47.103         47.29        47.477        47.757        48.131        48.505 
    a739=48.972       46.355        46.355        46.449       46.542       46.542        46.636        47.196        47.383         47.57         47.85        48.224        48.598 
    a740=49.0654      46.449        46.449        46.542       46.542       46.636        46.729         47.29        47.477        47.664        47.944        48.318        48.692 
    a741=49.1589      46.542        46.542        46.636       46.636       46.729        46.822        47.383         47.57        47.757        48.037        48.411        48.785 
    a742=49.2523      46.636        46.636        46.729       46.729       46.822        46.916        47.477        47.664         47.85        48.131        48.505        48.879 
    a743=49.3458      46.729        46.729        46.822       46.822       46.916        47.009         47.57        47.757        47.944        48.224        48.598        48.972 
    a744=49.4393      46.822        46.822        46.916       46.916       47.009        47.103        47.664         47.85        48.037        48.318        48.692        49.065 
    a745=49.5327      46.916        46.916        47.009       47.009       47.103        47.196        47.757        47.944        48.131        48.411        48.785        49.065 
    a746=49.6262      47.009        47.009        47.103       47.103       47.196         47.29         47.85        48.037        48.224        48.505        48.785        49.159 
    a747=49.7196      47.103        47.103        47.196       47.196        47.29        47.383        47.944        48.131        48.318        48.598        48.879        49.252 
    a748=49.8131      47.196        47.196         47.29        47.29       47.383        47.477        48.037        48.224        48.411        48.692        48.972        49.346 
    a749=49.9065       47.29         47.29        47.383       47.383       47.477         47.57        48.131        48.318        48.505        48.785        49.065        49.439 
    a750=50            47.29        47.383        47.477       47.477        47.57        47.664        48.224        48.411        48.598        48.879        49.159        49.533 

</pre><img vspace="5" hspace="5" src="ff_abz_vf_vecsv_01.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_02.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_03.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_04.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_05.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_06.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_07.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_08.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_09.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_10.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_11.png" alt=""> <img vspace="5" hspace="5" src="ff_abz_vf_vecsv_12.png" alt=""> <pre class="codeinput"><span class="keyword">end</span>
</pre><pre class="codeoutput">
ans = 

  Map with properties:

        Count: 13
      KeyType: char
    ValueType: any

</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Solve Save + Borr Dynamic Programming Problem (Optimized-Vectorized)
% *back to <https://fanwangecon.github.io Fan>'s
% <https://fanwangecon.github.io/CodeDynaAsset/ Dynamic Assets Repository>
% Table of Content.*

%%
function result_map = ff_abz_vf_vecsv(varargin)
%% FF_ABZ_VF_VECSV solve infinite horizon exo shock + endo asset problem
% This program solves the infinite horizon dynamic single asset and single
% shock problem with vectorized codes.
% <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html
% ff_abz_vf> shows looped codes.
% <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html
% ff_abz_vf_vec> shows vectorized codes. This file shows vectorized codes
% that is faster but is more memory intensive.
%
% The borrowing problem is very similar to the savings problem. The code
% could be identical if one does not have to deal with default. The main
% addition here in comparison to the savings only code
% <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html
% ff_az_vf_vec> is the ability to deal with default. 
%
% See
% <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html
% ff_az_vf_vec> how vectorization works within this structure.
%
% This _optimized-vectorized_ solution method provides very large speed
% improvements for this infinite horizon problem because the u(c(z,a,a'))
% calculation within each iteration is identical. Generally the idea is to
% identify inside iteration whether the model is infinite horizon or
% life-cycle based where repeat calculations are taking place. If such
% calculations can be identified, then potentially they could be stored and
% retrieved during future iterations/periods rather than recomputed every
% time. This saves time. 
%
% @param param_map container parameter container
%
% @param support_map container support container
%
% @param armt_map container container with states, choices and shocks
% grids that are inputs for grid based solution algorithm
%
% @param func_map container container with function handles for
% consumption cash-on-hand etc.
%
% @return result_map container contains policy function matrix, value
% function matrix, iteration results, and policy function, value function
% and iteration results tables.
%
% keys included in result_map:
%
% * mt_val matrix states_n by shock_n matrix of converged value function grid
% * mt_pol_a matrix states_n by shock_n matrix of converged policy function grid
% * ar_val_diff_norm array if bl_post = true it_iter_last by 1 val function
% difference between iteration
% * ar_pol_diff_norm array if bl_post = true it_iter_last by 1 policy
% function difference between iterations
% * mt_pol_perc_change matrix if bl_post = true it_iter_last by shock_n the
% proportion of grid points at which policy function changed between
% current and last iteration for each element of shock
%
% @example
%
%    % Get Default Parameters
%    it_param_set = 2;
%    [param_map, support_map] = ffs_abz_set_default_param(it_param_set);
%    % Chnage param_map keys for borrowing
%    param_map('fl_b_bd') = -20; % borrow bound
%    param_map('bl_default') = false; % true if allow for default
%    param_map('fl_c_min') = 0.0001; % u(c_min) when default
%    % Change Keys in param_map
%    param_map('it_a_n') = 500;
%    param_map('it_z_n') = 11;
%    param_map('fl_a_max') = 100;
%    param_map('fl_w') = 1.3;
%    % Change Keys support_map
%    support_map('bl_display') = false;
%    support_map('bl_post') = true;
%    support_map('bl_display_final') = false;
%    % Call Program with external parameters that override defaults.
%    ff_abz_vf_vecsv(param_map, support_map);
%
% @include
%
% * <https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html ffs_abz_set_default_param>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_get_funcgrid.html ffs_abz_get_funcgrid>
% * <https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post.html ff_az_vf_post>
%
% @seealso
%
% * save loop: <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html ff_az_vf>
% * save vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vec.html ff_az_vf_vec>
% * save optimized-vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html ff_az_vf_vecsv>
% * save + borr loop: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html ff_abz_vf>
% * save + borr vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html ff_abz_vf_vec>
% * save + borr optimized-vectorized: <https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vecsv.html ff_abz_vf_vecsv>
%

%% Default
%
% * it_param_set = 1: quick test
% * it_param_set = 2: benchmark run
% * it_param_set = 3: benchmark profile
% * it_param_set = 4: press publish button
%

it_param_set = 4;
bl_input_override = true;
[param_map, support_map] = ffs_abz_set_default_param(it_param_set);

% Note: param_map and support_map can be adjusted here or outside to override defaults
% param_map('it_a_n') = 750;
% param_map('it_z_n') = 15;
% param_map('fl_r_save') = 0.025;
% param_map('fl_r_borr') = 0.035;

[armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override); % 1 for override
default_params = {param_map support_map armt_map func_map};

%% Parse Parameters 1

% if varargin only has param_map and support_map,
params_len = length(varargin);
[default_params{1:params_len}] = varargin{:};
param_map = [param_map; default_params{1}];
support_map = [support_map; default_params{2}];
if params_len >= 1 && params_len <= 2
    % If override param_map, re-generate armt and func if they are not
    % provided
    bl_input_override = true;
    [armt_map, func_map] = ffs_abz_get_funcgrid(param_map, support_map, bl_input_override);
else
    % Override all
    armt_map = [armt_map; default_params{3}];
    func_map = [func_map; default_params{4}];
end

% append function name
st_func_name = 'ff_abz_vf_vecsv';
support_map('st_profile_name_main') = [st_func_name support_map('st_profile_name_main')];
support_map('st_mat_name_main') = [st_func_name support_map('st_mat_name_main')];
support_map('st_img_name_main') = [st_func_name support_map('st_img_name_main')];

%% Parse Parameters 2

% armt_map
params_group = values(armt_map, {'ar_a', 'mt_z_trans', 'ar_z'});
[ar_a, mt_z_trans, ar_z] = params_group{:};

% func_map
params_group = values(func_map, {'f_util_log', 'f_util_crra', 'f_cons_checkcmin', 'f_coh', 'f_cons_coh'});
[f_util_log, f_util_crra, f_cons_checkcmin, f_coh, f_cons_coh] = params_group{:};

% param_map
params_group = values(param_map, {'it_a_n', 'it_z_n', 'fl_crra', 'fl_beta', 'fl_c_min',...
    'fl_nan_replace', 'bl_default', 'fl_default_aprime'});
[it_a_n, it_z_n, fl_crra, fl_beta, fl_c_min, ...
    fl_nan_replace, bl_default, fl_default_aprime] = params_group{:};
params_group = values(param_map, {'it_maxiter_val', 'fl_tol_val', 'fl_tol_pol', 'it_tol_pol_nochange'});
[it_maxiter_val, fl_tol_val, fl_tol_pol, it_tol_pol_nochange] = params_group{:};

% support_map
params_group = values(support_map, {'bl_profile', 'st_profile_path', ...
    'st_profile_prefix', 'st_profile_name_main', 'st_profile_suffix',...
    'bl_time', 'bl_display', 'it_display_every', 'bl_post'});
[bl_profile, st_profile_path, ...
    st_profile_prefix, st_profile_name_main, st_profile_suffix, ...
    bl_time, bl_display, it_display_every, bl_post] = params_group{:};

%% Initialize Output Matrixes
% include mt_pol_idx which we did not have in looped code

mt_val_cur = zeros(length(ar_a),length(ar_z));
mt_val = mt_val_cur - 1;
mt_pol_a = zeros(length(ar_a),length(ar_z));
mt_pol_a_cur = mt_pol_a - 1;
mt_pol_idx = zeros(length(ar_a),length(ar_z));

% We did not need these in ff_abz_vf or ff_abz_vf_vec
% see
% <https://fanwangecon.github.io/M4Econ/support/speed/partupdate/fs_u_c_partrepeat_main.html
% fs_u_c_partrepeat_main> for why store using cells.
cl_u_c_store = cell([it_z_n, 1]);
cl_c_valid_idx = cell([it_z_n, 1]);

%% Initialize Convergence Conditions

bl_vfi_continue = true;
it_iter = 0;
ar_val_diff_norm = zeros([it_maxiter_val, 1]);
ar_pol_diff_norm = zeros([it_maxiter_val, 1]);
mt_pol_perc_change = zeros([it_maxiter_val, it_z_n]);

%% Iterate Value Function
% Loop solution with 4 nested loops
%
% # loop 1: over exogenous states
% # loop 2: over endogenous states
% # loop 3: over choices
% # loop 4: add future utility, integrationREPLACE_WITH_DASH_DASHloop over future shocks
%

% Start Profile
if (bl_profile)
    close all;
    profile off;
    profile on;
end

% Start Timer
if (bl_time)
    tic;
end

% Value Function Iteration
while bl_vfi_continue
    it_iter = it_iter + 1;

    %% Solve Optimization Problem Current Iteration
    % Only this segment of code differs between ff_abz_vf and ff_abz_vf_vec
    % Store in cells results and retrieve, this is more memory intensive
    % than ff_abz_vf_vec.

    % loop 1: over exogenous states
    for it_z_i = 1:length(ar_z)

        % Current Shock
        fl_z = ar_z(it_z_i);

        % cash-on-hand
        ar_coh = f_coh(fl_z, ar_a);

        % Consumption and u(c) only need to be evaluated once
        if (it_iter == 1)

            % Consumption: fl_z = 1 by 1, ar_a = 1 by N, ar_a' = N by 1
            % mt_c is N by N: matrix broadcasting, expand to matrix from arrays
            mt_c = f_cons_coh(ar_coh, ar_a');

            % EVAL current utility: N by N, f_util defined earlier
            % slightly faster to explicitly write function
            if (fl_crra == 1)
                mt_utility = log(mt_c);
                fl_u_cmin = f_util_log(fl_c_min);
            else
                % slightly faster if write function here directly, but
                % speed gain is very small, more important to have single
                % location control of functions.
                mt_utility = f_util_crra(mt_c);
                fl_u_cmin = f_util_crra(fl_c_min);
            end

            % Eliminate Complex Numbers
            mt_it_c_valid_idx = (mt_c <= fl_c_min);
            mt_utility(mt_it_c_valid_idx) = fl_u_cmin;

            % Store in cells
            cl_u_c_store{it_z_i} = mt_utility;
            cl_c_valid_idx{it_z_i} = mt_it_c_valid_idx;

        end

        % f(z'|z)
        ar_z_trans_condi = mt_z_trans(it_z_i,:);

        % EVAL EV((A',K'),Z'|Z) = V((A',K'),Z') x p(z'|z)', (N by Z) x (Z by 1) = N by 1
        % Note: transpose ar_z_trans_condi from 1 by Z to Z by 1
        % Note: matrix multiply not dot multiply        
        mt_evzp_condi_z = mt_val_cur * ar_z_trans_condi';

        % EVAL add on future utility, N by N + N by 1
        mt_utility = cl_u_c_store{it_z_i} + fl_beta*mt_evzp_condi_z;

        % Index update
        % using the method below is much faster than index replace
        % see <https://fanwangecon.github.io/M4Econ/support/speed/index/fs_subscript.html fs_subscript>
        mt_it_c_valid_idx = cl_c_valid_idx{it_z_i};
        % Default or Not Utility Handling
        if (bl_default)
            % if default: only today u(cmin), transition out next period, debt wiped out
            fl_v_default = fl_u_cmin + fl_beta*mt_evzp_condi_z(ar_a == fl_default_aprime);
            mt_utility = mt_utility.*(~mt_it_c_valid_idx) + fl_v_default*(mt_it_c_valid_idx);
        else
            % if default is not allowed: v = u(cmin)
            mt_utility = mt_utility.*(~mt_it_c_valid_idx) + fl_nan_replace*(mt_it_c_valid_idx);
        end

        % Optimization: remember matlab is column major, rows must be
        % choices, columns must be states
        % <https://en.wikipedia.org/wiki/Row-_and_column-major_order COLUMN-MAJOR>
        % mt_utility is N by N, rows are choices, cols are states.                 
        [ar_opti_val_z, ar_opti_idx_z] = max(mt_utility);
        ar_opti_aprime_z = ar_a(ar_opti_idx_z);
        ar_opti_c_z = f_cons_coh(ar_coh, ar_opti_aprime_z);

        % Handle Default is optimal or not
        if (bl_default)
            % if defaulting is optimal choice, at these states, not required
            % to default, non-default possible, but default could be optimal
            ar_opti_aprime_z(ar_opti_c_z <= fl_c_min) = fl_default_aprime;
            ar_opti_idx_z(ar_opti_c_z <= fl_c_min) = find(ar_a == fl_default_aprime);
        else
            % if default is not allowed, then next period same state as now
            % this is absorbing state, this is the limiting case, single
            % state space point, lowest a and lowest shock has this.
            ar_opti_aprime_z(ar_opti_c_z <= fl_c_min) = ar_a(ar_opti_c_z <= fl_c_min);
        end

        % store optimal values
        mt_val(:,it_z_i) = ar_opti_val_z;
        mt_pol_a(:,it_z_i) = ar_opti_aprime_z;

        if (it_iter == (it_maxiter_val + 1))
            mt_pol_idx(:,it_z_i) = ar_opti_idx_z;
        end
    end

    %% Check Tolerance and Continuation

    % Difference across iterations
    ar_val_diff_norm(it_iter) = norm(mt_val - mt_val_cur);
    ar_pol_diff_norm(it_iter) = norm(mt_pol_a - mt_pol_a_cur);
    mt_pol_perc_change(it_iter, :) = sum((mt_pol_a ~= mt_pol_a_cur))/(it_a_n);

    % Update
    mt_val_cur = mt_val;
    mt_pol_a_cur = mt_pol_a;

    % Print Iteration Results
    if (bl_display && (rem(it_iter, it_display_every)==0))
        fprintf('VAL it_iter:%d, fl_diff:%d, fl_diff_pol:%d\n', ...
            it_iter, ar_val_diff_norm(it_iter), ar_pol_diff_norm(it_iter));
        tb_valpol_iter = array2table([mean(mt_val_cur,1); mean(mt_pol_a_cur,1); ...
            mt_val_cur(it_a_n,:); mt_pol_a_cur(it_a_n,:)]);
        tb_valpol_iter.Properties.VariableNames = strcat('z', string((1:size(mt_val_cur,2))));
        tb_valpol_iter.Properties.RowNames = {'mval', 'map', 'Hval', 'Hap'};
        disp('mval = mean(mt_val_cur,1), average value over a')
        disp('map  = mean(mt_pol_a_cur,1), average choice over a')
        disp('Hval = mt_val_cur(it_a_n,:), highest a state val')
        disp('Hap = mt_pol_a_cur(it_a_n,:), highest a state choice')
        disp(tb_valpol_iter);
    end

    % Continuation Conditions:
    % 1. if value function convergence criteria reached
    % 2. if policy function variation over iterations is less than
    % threshold
    if (it_iter == (it_maxiter_val + 1))
        bl_vfi_continue = false;
    elseif ((it_iter == it_maxiter_val) || ...
            (ar_val_diff_norm(it_iter) < fl_tol_val) || ...
            (sum(ar_pol_diff_norm(max(1, it_iter-it_tol_pol_nochange):it_iter)) < fl_tol_pol))
        % Fix to max, run again to save results if needed
        it_iter_last = it_iter;
        it_iter = it_maxiter_val;
    end

end

% End Timer
if (bl_time)
    toc;
end

% End Profile
if (bl_profile)
    profile off
    profile viewer
    st_file_name = [st_profile_prefix st_profile_name_main st_profile_suffix];
    profsave(profile('info'), strcat(st_profile_path, st_file_name));
end

%% Process Optimal Choices

result_map = containers.Map('KeyType','char', 'ValueType','any');
result_map('mt_val') = mt_val;
result_map('mt_pol_idx') = mt_pol_idx;

result_map('cl_mt_pol_a') = {mt_pol_a, zeros(1)};
result_map('cl_mt_pol_coh') = {f_coh(ar_z, ar_a'), zeros(1)};
result_map('cl_mt_pol_c') = {f_cons_checkcmin(ar_z, ar_a', mt_pol_a), zeros(1)};
result_map('ar_st_pol_names') = ["cl_mt_pol_a", "cl_mt_pol_coh", "cl_mt_pol_c"];

if (bl_post)
    bl_input_override = true;
    result_map('ar_val_diff_norm') = ar_val_diff_norm(1:it_iter_last);
    result_map('ar_pol_diff_norm') = ar_pol_diff_norm(1:it_iter_last);
    result_map('mt_pol_perc_change') = mt_pol_perc_change(1:it_iter_last, :);
    result_map = ff_az_vf_post(param_map, support_map, armt_map, func_map, result_map, bl_input_override);
end

end

##### SOURCE END #####
--></body></html>