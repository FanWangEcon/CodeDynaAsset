<!-- Solves infinite-horizon exogenously-incomplete dynamic programming asset problems in discrete-time. Household-side problem of the Bewley Aiyagari type heterogeneous agent model. Models with savings, borrowing (default), safe and risky asset choices, and formal and informal choices. -->


<!-- Issues:
1. consumption when borrowing not calculated correctly when households default.
-->

This is a work-in-progress (*updated: 2019-07-04*) [website](https://fanwangecon.github.io/CodeDynaAsset/) for solving several infinite-horizon exogenously-incomplete dynamic assets models in discrete-time. Section **(1)** solves the [savings problem](https://fanwangecon.github.io/CodeDynaAsset/#1-the-savings-problem-az). Section **(2)** solves the [borrowing and savings problem](https://fanwangecon.github.io/CodeDynaAsset/#2-the-savings--borrowing-problem-abz). Section **(3)** solve the [risky and safe asset problem (risky entrepreneur)](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1). Section **(4)** solves the same problem as (3) with [percentage choice grids and interpolation](https://fanwangecon.github.io/CodeDynaAsset/#4-the-risky--safe-asset-problem-part-2). Section **(5) and (6)** is an application/extension of the earlier models: models from (1) through (4) are augmented following [*A Choice Amongst Many: Household Borrowing in a Setting with Multiple Providers*](https://fanwangecon.github.io/CodeDynaAsset/#5-one-asset-formal--informal) ([**Robert M. Townsend**](http://www.robertmtownsend.net/) and [**Fan Wang**](https://fanwangecon.github.io/) 2019).

Key elements for solution algorithms from (1) through (5) are described and developed in [**Wang (2019)**](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3316939). Generally, looped, vectorized, and optimized-vectorized implementations of the same solution algorithm with tabular, graphical and profiling results are shown. Separate subsections show files that solve policy functions and derive asset distributions. Looped codes are shown for clarity, vectorized codes are shown for speed. Codes are designed to not require special hardware or explicit parallelization. Codes are tested on Windows 10 with [Matlab 2019a](https://www.mathworks.com/company/newsroom/mathworks-announces-release-2019a-of-matlab-and-simulink.html) for replicability. The algorithms here are platform agnostic and could be implemented in alternative languages, but speed variations across languages is generally small for the algorithms described here. Please contact [FanWangEcon](https://fanwangecon.github.io/) for problems.

Functions are written with default parameters and are directly callable. See [**Set-Up Instructions**](docs/README_folders.md) for instructions and folder descriptions. On this webpage, there are three types of files:

1. **m**: matlab m file
2. **publish html**: html files generated by matlab publish
3. **profile**: html files generated by profiling the m file with timing results

For an introduction to savings and borrowing problems, see [Fan](https://fanwangecon.github.io)'s [Intro Math for Econ](https://fanwangecon.github.io/Math4Econ/).

# 1. The Savings Problem (AZ)

> *Files for this section are in the [/m_az/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_az) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository. links: (1) [savings problem](https://fanwangecon.github.io/CodeDynaAsset/#1-the-savings-problem-az) (2) [borrowing and savings problem](https://fanwangecon.github.io/CodeDynaAsset/#2-the-savings--borrowing-problem-abz) (3) [risky and safe asset problem (risky entrepreneur)](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1) (4) [percentage choice grids and interpolation](https://fanwangecon.github.io/CodeDynaAsset/#4-the-risky--safe-asset-problem-part-2) (5) [Townsend and Wang 2019 Single Asset](https://fanwangecon.github.io/CodeDynaAsset/#5-one-asset-formal--informal) (6) [Townsend and Wang 2019 Safe + Risky Asset](https://fanwangecon.github.io/CodeDynaAsset/#6-two-assets-formal--informal).*


This section solves the standard household-side problem of the [Bewley](https://en.wikipedia.org/wiki/Truman_Bewley)/[Aiyagari](https://en.wikipedia.org/wiki/S._Rao_Aiyagari) type [heterogeneous agent](https://en.wikipedia.org/wiki/Heterogeneity_in_economics) model. The supply of credit in [Aiygari (1994)](https://www.jstor.org/stable/2118417#metadata_info_tab_contents) can be derived by invoking *1.1* and *1.2* with different interest rates.

## 1.1 Dynamic Programming Files (AZ)

Price (wage and interest rate) taking households arrive in a period with accumulated savings and a possibly persistent income shock. Households decide on optimal savings to carry forward to the next period in order to smooth consumption given rational expectation of the income process. Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html), for the benchmark simulation:

- savings only with minimum income
- **750** grid points for asset states/choices
- **15** grid points for the AR1 shock
- [other parameters](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html)

Algorithms below provide identical solutions:

1. *az* model [looped solution](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solve/ff_az_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/profile/ff_az_vf_default_p3/file0.html)
    * speed: **8634.5** seconds
    * loops: 1 for VFI, 1 for shocks, 1 for asset state, 1 for asset choice, 1 for future shocks
2. *az* model [vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solve/ff_az_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/profile/ff_az_vf_vec_default_p3/file0.html)    
    * speed: **32.3** seconds
    * loops: 1 for VFI, 1 for shocks, vectorize remaining 3 loops
3. *az* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solve/ff_az_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/profile/ff_az_vf_vecsv_default_p3/file0.html)    
    * speed: **1.3** seconds
    * loops: 1 for VFI, 1 for shocks, vectorize remaining 3 loops, reuse u(c)
    * reuse u(c) in cells, speed improvements described [here](https://fanwangecon.github.io/M4Econ/)

## 1.2 Asset Distributions (AZ)

### 1.2.a Deriving Asset Distributions

Solve for the stationary probability mass function over states using *non-simulation* methods. The first two methods below involve *iteration*, the third is *semi-analytical and iteration-free* (see appendix in [Wang 2019](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3316939) for details). The semi-analytical approach has three implementations, **eigenvector** or **projection** or **nth-power**. The **eigenvector** approach, when implemented with sparse matrix, is potentially fast. The codes compute, with [benchmark parameters](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html) and after invoking the *optimized-vectorized* code from above, for each outcome *y*:

- joint and marginal probability mass functions: *P(y,z)*, *P(y,a)* and *P(y)*
- *E(Y)*, *var(Y)*, *P(Y=0)*, *P(Y=max(Y))*, etc
- percentiles and fraction of *y* held by households up to percentiles

Algorithms 1 and 2 approximate 3 (speed does not include *1.1* speed), the vectorized and semi-analytical programs work for the risky and safe asset problems in section [*3.1 and 3.2*](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1) as well:

1. *az* asset distribution [looped](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solve/ff_az_ds.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/profile/ff_az_ds_default_p7/file0.html)
    * speed: **5.0** seconds
    * loops: 1 for pmf iteration, 1 for shocks, 1 for asset state, 1 for future shocks
2. *az+akz+wkz* asset distribution [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solve/ff_az_ds_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/profile/ff_az_ds_vec_default_p7/file0.html)
    * speed: **0.8** seconds
    * loops: 1 for pmf iteration, 1 for shocks, policy index match
3. *az+akz+wkz* asset distribution [semi-analytical](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solve/ff_az_ds_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/profile/ff_az_ds_vecsv_default_p7/file0.html)
    * speed: **0.2** seconds **sparse eigenvector approach**
    * iteration free, construct full-states markov, sparse matrix, eigenvector/projection/Nth-power


### 1.2.b Statistics Support Functions

Deriving asset distributions relies on two functions from the [/tools/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/tools) folder for computing pmf for choice/outcome as well as distributional statistics based on pmf which apply to all models in later sections as well:

1. all model [f(y) from f(a,z) and y(a,z)](https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/tools/fft_disc_rand_var_mass2outcomes.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_mass2outcomes.html)
    * from pmf *f(a,z)* and outcome/policy *y(a,z)*, derive *f(y,z)*, *f(y,a)* and *f(y)*
2. all model [distributional statistics](https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/tools/fft_disc_rand_var_stats.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/tools/html/fft_disc_rand_var_stats.html)
    * table: mean, sd, percentiles, fraction of outcome/asset held by household up to x percentile
3. all model [store statistics to container](https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_ds_post_stats.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solvepost/ff_az_ds_post_stats.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_ds_post_stats.html)
    * This is a manager file for (1) and (2). Add statistics from (1) and (2) to results container for each model choice/outcome


## 1.3 Solution Support (AZ)

**Parameters and Function Definitions**:
1. *az* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/paramfunc/ffs_az_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_default_param.html)
    * param_map: container map for carrying parameters across functions
    * support_map: container map for carrying programming instructions etc across functions
2. *az* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/paramfunc/ffs_az_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_set_functions.html)
    * functions: centrally define functions as function handles
3. *az* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/paramfunc/ffs_az_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/paramfunc/html/ffs_az_get_funcgrid.html)
    * func_map: container map containing all function handles
    * armt_map: container map containing matrixes for states and choices.

**Output Analysis**:
1.  *az* model [solution results processing](https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solvepost/ff_az_vf_post.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post.html)
    * table: value and policy function by states and shocks
    * table: iteration convergence and percentage policy function change by shock
    * graph: value + policy functions with levels, logged levels and percentages
    * mat: store all workspace matrixes, arrays, scalar values to matrixes
2. *az* model [solution results graphing](https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post_graph.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/solvepost/ff_az_vf_post_graph.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/solvepost/html/ff_az_vf_post_graph.html)
    * graph: value function by asset and shock
    * graph: consumption and asset choice levels
    * graph: consumption and asset logged levels
    * graph: consumption and asset as percentages of coh and assets

## 1.4 Parameter Testing (AZ)

We analyze model features by adjusting parameters.

1. *az* model **value and policy** functions precision
    * [adjust state/choice grid points](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_vf_vecsv/test_precision/html/fsi_az_vf_vecsv_a_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/test/ff_az_vf_vecsv/test_precision/fsi_az_vf_vecsv_a_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_vf_vecsv/test_precision/html/fsi_az_vf_vecsv_a_n.html)
    * [adjust shock grid points](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_vf_vecsv/test_precision/html/fsi_az_vf_vecsv_z_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/test/ff_az_vf_vecsv/test_precision/fsi_az_vf_vecsv_z_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_vf_vecsv/test_precision/html/fsi_az_vf_vecsv_z_n.html)
    * [benchmark vs high-precision](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_vf_vecsv/test_precision/html/fsi_az_vf_vecsv_main.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/test/ff_az_vf_vecsv/test_precision/fsi_az_vf_vecsv_main.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_vf_vecsv/test_precision/html/fsi_az_vf_vecsv_main.html)
2. *az* model overall speed test for **asset distribution** simulation
    * 1.9 seconds for [benchmark simulation](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_speed/html/fsi_az_ds_vecsv_speed.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/test/ff_az_ds_vecsv/test_speed/fsi_az_ds_vecsv_speed.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_speed/html/fsi_az_ds_vecsv_speed.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_speed/profile/fsi_az_ds_vecsv_speedff_az_ds_vecsv_default_p9/file0.html)    
3. *az* preference parameters and **asset distributions**
    * [adjust discount and risk aversion](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_pref/html/fsi_az_ds_vecsv_pref.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/test/ff_az_ds_vecsv/test_pref/fsi_az_ds_vecsv_pref.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_pref/html/fsi_az_ds_vecsv_pref.html)
4. *az* model shock process and **asset distributions**
    * [adjust shock persistence and variance](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_shock/html/fsi_az_ds_vecsv_shock.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_az/test/ff_az_ds_vecsv/test_shock/fsi_az_ds_vecsv_shock.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_az/test/ff_az_ds_vecsv/test_shock/html/fsi_az_ds_vecsv_shock.html)

# 2. The Savings + Borrowing Problem (ABZ)

> *Files for this section are in the [/m_abz/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_abz) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository. links: (1) [savings problem](https://fanwangecon.github.io/CodeDynaAsset/#1-the-savings-problem-az) (2) [borrowing and savings problem](https://fanwangecon.github.io/CodeDynaAsset/#2-the-savings--borrowing-problem-abz) (3) [risky and safe asset problem (risky entrepreneur)](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1) (4) [percentage choice grids and interpolation](https://fanwangecon.github.io/CodeDynaAsset/#4-the-risky--safe-asset-problem-part-2) (5) [Townsend and Wang 2019 Single Asset](https://fanwangecon.github.io/CodeDynaAsset/#5-one-asset-formal--informal) (6) [Townsend and Wang 2019 Safe + Risky Asset](https://fanwangecon.github.io/CodeDynaAsset/#6-two-assets-formal--informal).*

Codes from *1.1-1.3* are adjusted slightly to deal with both savings as well as borrowing with default. Additionally, there is an additional shock for interest rate.

## 2.1 Dynamic Programming Files (ABZ)

Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html), for the benchmark simulation:

- savings and borrowing (with default) with minimum income
- **750** grid points for asset states/choices
- **75** grid points for shocks: **15** wage, **5** borrow interest
- [other parameters](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html)

Using three algorithm that provide identical solutions:

1. *abz* model [looped solution](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/solve/ff_abz_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/profile/ff_abz_vf_default_p3/file0.html)
    * small grid demonstration
2. *abz* model [vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/solve/ff_abz_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/profile/ff_abz_vf_vec_default_p3/file0.html)    
    * speed: **281.0** seconds
3. *abz* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/solve/ff_abz_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/profile/ff_abz_vf_vecsv_default_p3/file0.html)    
    * speed: **14.0** seconds

## 2.2 Asset Distributions (ABZ)

This is the wrapper file for *abz* that invokes the [looped](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds.html), [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vec.html), and [semi-analytical](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vecsv.html) distributional programs from *1.2*:

* *abz* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/solve/ff_abz_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/html/ff_abz_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/solve/profile/ff_abz_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **17.5** seconds

## 2.3 Solution Support (ABZ)

Add parameters [*bl_default*](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html) and [*fl_default_aprime*](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html), which control if default is allowed and next period asset level for defaulters.

**Parameters and Function Definitions**:

1. *abz* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/paramfunc/ffs_abz_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_default_param.html)
2. *abz* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/paramfunc/ffs_abz_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_set_functions.html)
3. *abz* model [borrowing and savings grid](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_gen_borrsave_grid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/paramfunc/ffs_abz_gen_borrsave_grid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_gen_borrsave_grid.html)
4. *abz* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/paramfunc/ffs_abz_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/paramfunc/html/ffs_abz_get_funcgrid.html)

**Output Analysis**: shared files with *az*.

## 2.4 Parameter Testing (ABZ)

We solved the exogenously incomplete borrowing and savings problem in *1.4*. Now we analyze model features by adjusting parameters.

**Policy Function Testing**

1. *abz* borrowing and savings choice grid with default
    * [choice grid](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ffs_abz_get_funcgrid/test_borr/html/ffs_abz_get_funcgrid_defnodfalt.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ffs_abz_get_funcgrid/test_borr/html/ffs_abz_get_funcgrid_defnodfalt.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ffs_abz_get_funcgrid/test_borr/html/ffs_abz_get_funcgrid_defnodfalt.html)
2. *abz* model solution precision
   * [adjust state/choice grid points](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_precision/html/fsi_abz_vf_vecsv_a_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_abz_vf_vecsv/test_precision/fsi_abz_vf_vecsv_a_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_precision/html/fsi_abz_vf_vecsv_a_n.html)
   * [adjust shock grid points](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_precision/html/fsi_abz_vf_vecsv_z_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_abz_vf_vecsv/test_precision/fsi_abz_vf_vecsv_z_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_precision/html/fsi_abz_vf_vecsv_z_n.html)
   * [benchmark vs high-precision](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_precision/html/fsi_abz_vf_vecsv_main.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_abz_vf_vecsv/test_precision/fsi_abz_vf_vecsv_main.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_precision/html/fsi_abz_vf_vecsv_main.html)
3. *abz* model compare saving vs borrowing with and without default
   * [tabular small grid testing](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_borr/html/ff_abz_vf_vecsv_default_small.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_abz_vf_vecsv/test_borr/ff_abz_vf_vecsv_default_small.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_borr/html/ff_abz_vf_vecsv_default_small.html)
   * [tabular and graphical large grid testing](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_borr/html/ff_abz_vf_vecsv_default_large.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_abz_vf_vecsv/test_borr/ff_abz_vf_vecsv_default_large.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_abz_vf_vecsv/test_borr/html/ff_abz_vf_vecsv_default_large.html)

**Asset Distribution Testing**

1. *abz* borrowing interest rates, bounds, and minimum c
   * [no default](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_borr/fsi_abz_ds_vecsv_nbc.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_nbc.html)
   * [default](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_borr/fsi_abz_ds_vecsv_default.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_borr/html/fsi_abz_ds_vecsv_default.html)
2. *abz* preference parameters and **asset distributions**
   * [no default](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_nbc.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_pref/fsi_abz_ds_vecsv_pref_nbc.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_nbc.html)
   * [default](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_pref/fsi_abz_ds_vecsv_pref_default.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/fsi_abz_ds_vecsv_pref_default/html/fsi_abz_ds_vecsv_pref.html)
   * [default (low min c)](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default_lowcmin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_pref/fsi_abz_ds_vecsv_pref_default_lowcmin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_pref/html/fsi_abz_ds_vecsv_pref_default_lowcmin.html)   
3. *abz* model shock process and **asset distributions**
    * [no default](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_nbc.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_shock/fsi_abz_ds_vecsv_shk_nbc.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_nbc.html)
    * [default](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_shock/fsi_abz_ds_vecsv_shk_default.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default.html)
    * [default (low min c)](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default_lowcmin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_abz/test/ff_az_ds_vecsv/test_shock/fsi_abz_ds_vecsv_shk_default_lowcmin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_abz/test/ff_az_ds_vecsv/test_shock/html/fsi_abz_ds_vecsv_shk_default_lowcmin.html)


# 3. The Risky + Safe Asset Problem (Part 1)

> *Files for this section are in the [/m_akz/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_akz) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository. links: (1) [savings problem](https://fanwangecon.github.io/CodeDynaAsset/#1-the-savings-problem-az) (2) [borrowing and savings problem](https://fanwangecon.github.io/CodeDynaAsset/#2-the-savings--borrowing-problem-abz) (3) [risky and safe asset problem (risky entrepreneur)](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1) (4) [percentage choice grids and interpolation](https://fanwangecon.github.io/CodeDynaAsset/#4-the-risky--safe-asset-problem-part-2) (5) [Townsend and Wang 2019 Single Asset](https://fanwangecon.github.io/CodeDynaAsset/#5-one-asset-formal--informal) (6) [Townsend and Wang 2019 Safe + Risky Asset](https://fanwangecon.github.io/CodeDynaAsset/#6-two-assets-formal--informal).*

Two endogenous assets, one safe one risky. Risky asset could be stocks with constant return to scale, or physical capital investment with depreciation and decreasing return to scale (risky entrepreneur). The risky asset choice is made ex-ante the realization of the shock for that risky asset, hence risky. This contrasts with a firm's within period optimal physical capital choice problem, which is made after the realization of shocks. Note that the utility function is CRRA, however, households do not have constant share of risky investment for any wealth (cash-on-hand) levels when risky asset has decreasing return to scale and/or shock is persistent and/or there is minimum income.

There are more analytical ways of solving the basic version of this problem. Here we stick to using this grid based solution algorithm which allows for flexibly solving non-differentiable and non-continuous problems. The grid based solution algorithm now with 2 endogenous choices and states requires exponentially more computation time than the *az* model. Here I provide three sets of solution algorithms at increasing speeds:

- In **3.1**, solve the problem with the two asset choice concurrently
- In **3.2**, solve the problem in two stages
- In **3.3**, two stage solution with interpolation

## 3.1 Concurrent Dynamic Programming (AKZ)

> *Files for this section have the **akz** in file names and are in the [/m_akz/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_akz) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository.*

The *akz* problem. Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html), for the benchmark simulation:

- savings problem with alternative safe and risky assets and minimum income
- **50** aggregate savings grid points, **50** risky investment grid points, **1274** valid choice combinations in [upper triangle](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_get_funcgrid.html). Note that the benchmark parameters for the *az* model has *750* grid points of choices/states, the benchmark problem here is larger and hence takes more time.
- **15** grid points for the AR1 shock
- [other parameters](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html)

1. *akz* model [looped solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_akz_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_akz_vf_default_p3/file0.html)    
    * speed: **32764.7** seconds
    * loops: 1 for VFI, 1 for shocks, 1 for coh(b,k,z), 1 for (b',k') choices, 1 for future shocks
2. *akz* model [vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_akz_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_akz_vf_vec_default_p3/file0.html)    
    * speed: **93.2** seconds
    * loops: 1 for VFI, 1 for shocks, vectorize remaining
3. *akz* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_akz_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_akz_vf_vecsv_default_p3/file0.html)    
    * speed: **2.7** seconds
    * loops: 1 for VFI, 1 for shocks, vectorize remaining
    * reuse u(c) in cells, speed improvements described [here](https://fanwangecon.github.io/M4Econ/)

## 3.2 Two-Stage Dynamic Programming (WKZ)

> *Files for this section have the **wkz** in file names and are in the [/m_akz/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_akz) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository.*

The *wkz* problem, w=k'+b'. Takes significantly less time than *3.1*, produces identical results. Rather than solving the two asset problem in one shot. We can separate the problem into two stages. In the second stage, we find the optimal k' choice given w=k'+b': max_{k'}(E(V(coh(k',b'=w-k'),z')) given w and z. The second stage optimal risky asset allocation problem is not a function of cash-on-hand in the current period conditional on the aggregate savings choice w=k'+b'. In the first stage, households optimized only over aggregate savings. This significantly reduces the dimensionality of the problem.

Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html), for the benchmark simulation, same grid sizes as *3.1*.

1. *wkz* model [2nd stage solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_evf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_wkz_evf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_evf.html)
    * solving for k(w,z) = argmax_{k'}(E(V(coh(k',b'=w-k'),z')) given z and w.
2. *wkz* model [looped solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_wkz_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_wkz_vf_default_p3/file0.html)    
    * speed: **581.0** seconds
    * loops: 1 for VFI, 1 for shocks, 1 for coh(b,k,z), 1 for w(z)=k'+b'
3. *wkz* model [vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_wkz_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_wkz_vf_vec_default_p3/file0.html)    
    * speed: **5.6** seconds
    * loops: 1 for VFI, 1 for shocks, vectorize remaining
4. *wkz* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_wkz_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_wkz_vf_vecsv_default_p3/file0.html)    
    * speed: **0.9** seconds
    * Step One solve k(w,z); Step Two solve w(z,coh(b,k,z)) given k(w,z)
    * loops: 1 for VFI, 1 for shocks, vectorize remaining
    * store u(c) in cells, update when k*(w,z) changes, speed improvements described [here](https://fanwangecon.github.io/M4Econ/)

## 3.3 Two-Stage DP with Interpolation (iWKZ)

> *Files for this section have the **iwkz** in file names and are in the [/m_akz/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_akz) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository.*

**Algorithm Description**

The *iwkz* problem, interpolated version of 2.2. Takes significantly less time than *3.2* at larger choice grids, produces approximately identical results as *3.2*. Simulations below are at the same grid points as *3.2* and *3.1* for comparison, but at these low accuracy grid points, *iwkz* is not necessarily faster than *3.2*.

The reason that *iWKZ* is faster then *3.2* is that when we increase aggregate savings grid points, we do not need to reduce the two interpolation grid gaps. COH is the endogenous state, and its size is determined by the *cash-on-hand interpolation grid gap*. The choice grid increases in size as we increase aggregate savings grid points, but since we are solving in two stages, the dimensionality of the problem increases proportionally (but not exponentially). The total number of safe and risky asset choice is determined by assuming equi-distance grid gap for aggregate savings as well as both risky and safe investments. Speed up achieved via interpolation as described [here](https://fanwangecon.github.io/M4Econ/).

In section *3.6* below, I show how solution results change for *iwkz* as we increase aggregate savings grid points, shock grid points, reduce the interpolation gaps, or change production function parameters from decreasing to constant return to scale.

**Algorithm Implementation**

Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html), for the benchmark simulation, same grid size parameters as *3.1* and *3.2*, but we introduce two additional measures of precision:

- **0.0001** consumption interpolation grid gap
- **0.1** value function cash-on-hand interpolation grid gap
- [other parameters](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html)

1. Use same *wkz* [2nd stage solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_wkz_evf.html) as in *3.2*
2. *iwkz* model [looped solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_iwkz_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_iwkz_vf_default_p3/file0.html)    
    * speed: **577.8** seconds
    * loops: 1 for VFI, 1 for shocks, 1 for coh(b,k,z), 1 for w(z)=k'+b'    
3. *iwkz* model [vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_iwkz_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_iwkz_vf_vec_default_p3/file0.html)    
    * speed: **2.3** seconds
    * loops: 1 for VFI, 1 for shocks, vectorize remaining
4. *iwkz* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_iwkz_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_iwkz_vf_vecsv_default_p3/file0.html)    
    * speed: **0.8** seconds
    * Step One solve k(w,z); Step Two solve w(z,coh(b,k,z)) given k(w,z)
    * loops: 1 for VFI, 1 for shocks, vectorize remaining
    * interpolate u(c), interpolate v(coh,z)
    * store u(c) in cells, update when k*(w,z) changes

## 3.4 Asset Distributions

### 3.4.a Distributions for AKZ and WKZ models

Solve for the stationary probability mass function over states using *non-simulation* methods. The algorithms in this section works for situations where (1) state-space grid is identical to the choice-space grid, and (2) the endogenous element of the state-space are last period choices. The second point means that we are interested in f(y,z), where y'(y,z), but not y'(y,z,z').

The looped program is new but very similar to the looped code from *1.2.a* earlier. The vectorized and semi-analytical programs invoke the corresponding programs from *1.2.a*. The codes compute, with [benchmark parameters](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html) and after invoking the *optimized-vecotrized* dynamic programming code from above for *akz* or *wkz*, for each outcome y various distributional statistics of interest, including: *P(y,z)*, *P(y)*, etc.

Algorithms 1 and 2 approximate 3 (speed does not include 3.1 and 3.2 speed):

1. *akz+wkz* asset distribution [looped](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_ds.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_akz_ds.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_ds.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_akz_ds_default_p7/file0.html)
    * speed: **18.8** seconds
2. *akz+wkz* asset distribution [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_ds_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_akz_ds_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_ds_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_akz_ds_vec_default_p7/file0.html)
    * speed: **1.9** seconds
3. *akz+wkz* asset distribution [semi-analytical](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_ds_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_akz_ds_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_akz_ds_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_akz_ds_vecsv_default_p7/file0.html)
    * speed: **0.9** seconds **sparse eigenvector approach**

### 3.4.b Distributions for iWKZ model

Solve for the stationary probability mass function over states using *non-simulation* methods. The algorithms in this section works for *ikwz* from *3.3*. For this problem, we are interested in f(y,z), where y'(y,z,z'). Unlike for *3.4.a*, here, *z'* also matters.

The programs here are significantly different from programs from *1.2* and *3.4.a* above. The codes compute, with [benchmark parameters](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html) and after invoking the *optimized-vecotrized* dynamic programming code from above for *iwkz*, for each outcome y various distributional statistics of interest, including: *P(y,z)*, *P(y)*, etc.

Algorithms 1 and 2 approximate 3 (speed does not include 3.3 speed):

1. *iwkz* asset distribution [looped](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_iwkz_ds.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_iwkz_ds_default_p7/file0.html)
    * speed: **104.4** seconds
2. *iwkz* asset distribution [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_iwkz_ds_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_iwkz_ds_vec_default_p7/file0.html)
    * speed: **0.8** seconds
3. *iwkz* asset distribution [semi-analytical](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solve/ff_iwkz_ds_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/profile/ff_iwkz_ds_vecsv_default_p7/file0.html)
    * speed: **0.4** seconds **sparse eigenvector approach**    

## 3.5 Solution Support

All solution algorithms share the same support files.

**Parameters and Function Definitions**:
1. *akz+wkz+iwkz* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/paramfunc/ffs_akz_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_default_param.html)
2. *akz+wkz+iwkz* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/paramfunc/ffs_akz_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_set_functions.html)
3. *akz+wkz+iwkz* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/paramfunc/ffs_akz_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/paramfunc/html/ffs_akz_get_funcgrid.html)

**Output Analysis**:
1. *akz+wkz+iwkz* model [solution results processing](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solvepost/ff_akz_vf_post.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post.html)
2. *akz+wkz+iwkz* model [solution results graphing](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post_graph.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/solvepost/ff_akz_vf_post_graph.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post_graph.html)


## 3.6 Parameter Testing (iWKZ)

We solve the joint asset choice problem using the *optimized-vectorized* method for *iwkz* algorithm from *3.3*. Now we analyze model features by adjusting parameters.

1. *iwkz* model solution precision
    * [adjust choice grid points](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_w_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/test/ff_iwkz_vf_vecsv/test_precision/fsi_iwkz_vf_vecsv_w_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_w_n.html)
    * [adjust shock grid points](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_z_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/test/ff_iwkz_vf_vecsv/test_precision/fsi_iwkz_vf_vecsv_z_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_z_n.html)
    * [adjust cash-on-hand interpolation grid gap](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_coh_interp_grid_gap.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/test/ff_iwkz_vf_vecsv/test_precision/fsi_iwkz_vf_vecsv_coh_interp_grid_gap.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_coh_interp_grid_gap.html)
    * [benchmark vs high-precision](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_main.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/test/ff_iwkz_vf_vecsv/test_precision/fsi_iwkz_vf_vecsv_main.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_precision/html/fsi_iwkz_vf_vecsv_main.html)
2. *iwkz* model shift minimum income
    * [decreasing (physical investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_prod/html/fsi_iwkz_vf_vecsv_drs_ymin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/test/ff_iwkz_vf_vecsv/test_prod/fsi_iwkz_vf_vecsv_drs_ymin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_prod/html/fsi_iwkz_vf_vecsv_drs_ymin.html)
    * [constant (financial investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_prod/html/fsi_iwkz_vf_vecsv_crs_ymin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/test/ff_iwkz_vf_vecsv/test_prod/fsi_iwkz_vf_vecsv_crs_ymin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_prod/html/fsi_iwkz_vf_vecsv_crs_ymin.html)
3. *iwkz* model shift shock persistence
    * [constant (financial investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_prod/html/fsi_iwkz_vf_vecsv_crs.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_akz/test/ff_iwkz_vf_vecsv/test_prod/fsi_iwkz_vf_vecsv_crs.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_akz/test/ff_iwkz_vf_vecsv/test_prod/html/fsi_iwkz_vf_vecsv_crs.html)


# 4. The Risky + Safe Asset Problem (Part 2)

> *Files for this section are in the [/m_ipwkz/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_ipwkz) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository. links: (1) [savings problem](https://fanwangecon.github.io/CodeDynaAsset/#1-the-savings-problem-az) (2) [borrowing and savings problem](https://fanwangecon.github.io/CodeDynaAsset/#2-the-savings--borrowing-problem-abz) (3) [risky and safe asset problem (risky entrepreneur)](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1) (4) [percentage choice grids and interpolation](https://fanwangecon.github.io/CodeDynaAsset/#4-the-risky--safe-asset-problem-part-2) (5) [Townsend and Wang 2019 Single Asset](https://fanwangecon.github.io/CodeDynaAsset/#5-one-asset-formal--informal) (6) [Townsend and Wang 2019 Safe + Risky Asset](https://fanwangecon.github.io/CodeDynaAsset/#6-two-assets-formal--informal).*

In Section 3, we solved the two asset problem in levels. Here, the same model is solved, but using an alternative algorithm. Now the model is solved in percentages. Households choose the percentage of cash-on-hand to allocate to aggregate savings, and then given that the percentage of total savings to allocate to safe vs risky asset.


### 4.1 Two Stage Percentage Interpolation Algorithm Description

In the levels solution above, households at different state space points face the same choice set, but almost half of the choice points are invalid because they would lead to negative consumption today. Solving the problem in percentages allow all households to have the same choice grid in terms of percentage levels. This potentially offers much more precise solutions under some model parameters combinations. One could compare testing results from *3.6* above and *4.4* below. Additionally, the levels based grid solution might lead to degenerate steady state asset distributions. This is because at low levels of cash-on-hand, if the risky asset's lowest level of choice is invalid, then an individual could be stuck in that state. (see appendix in [Wang 2019](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3316939) for details)

This is the *ipWKZ* problem: *i* stands for interpolation, *p* stands for percentage, *wk* stand for two stage w=k'+b' first then k' given w. For the *ipWKZ* model, while there is still very substantial gains from the looped to the vectorized algorithm implementation, the speed improvements from moving to the efficient-vectorized implementation is much less substantial. For the small benchmark grids, the speed is actually slower when we use the efficient-vectorized implementation.

We have three sets of interpolations now:
- **interpolate 1**: As before, we interpolate over u(c).
- **interpolate 2**: As before, interpolation of the value function over cash-on-hand and shocks is needed because the solution grid for cash-on-hand in the first stage is not the same as the reachable cash-on-hand levels given percentage second stage choices.
- **interpolate 3**: In addition to before, interpolation of the optimal 2nd stage risky investment choice over aggregate savings and shocks is needed because the 2nd stage solution grid for aggregate-savings in the second stage is the not the same as the percentage based first stage aggregate-savings choices. The second interpolation makes the efficiency gain from reusing u(c) through cells when k*(w,z) does not change much less substantial.

In section 3.4 below, I show how solution results change for *ipwkz* as we increase aggregate savings grid points, shock grid points, reduce the interpolation gaps, or change production function parameters from decreasing to constant return to scale.

## 4.2 Perc. Interp. Savings DP (IPWKZ)

Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_set_default_param.html), for the benchmark simulation, same as *3.3*, but we introduce several additional measures of precision:

- savings problem with alternative safe and risky assets
- **50** aggregate savings *percentage* grid points, **50** risky investment *percentage* grid points, **2500** valid choice combinations in [triangular choice matrix](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_get_funcgrid.html)
- **15** grid points for the AR1 shock
- interpolate 1: **0.0001** consumption interpolation grid gap
- interpolate 2: **0.1** value function cash-on-hand interpolation grid gap
- interpolate 3: **0.1** expected value function aggregate savings interpolation grid gap
- [other parameters](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_set_default_param.html)

1. Use again *ipwkz* [2nd stage solution](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_evf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/solve/ff_ipwkz_evf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_evf.html)
    * solving for kperc(w,z) = argmax_{kperc'}(E(V(coh(kperc',b'=w-w*kperc'),z')) given z and w.
2. *ipwkz* model [loop](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/solve/ff_ipwkz_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/profile/ff_ipwkz_vf_default_p3/file0.html)    
    * small grid demonstration
3. *ipwkz* model [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/solve/ff_ipwkz_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/profile/ff_ipwkz_vf_vec_default_p3/file0.html)    
    * speed: **4.2** seconds
4. *ipwkz* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/solve/ff_ipwkz_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/profile/ff_ipwkz_vf_vecsv_default_p3/file0.html)    
    * speed: **1.6** seconds
    * Step One solve kperc(w,z); Step Two solve wperc(z,coh(b,k,z)) given kperc(w,z)
    * loops: 1 for VFI, 1 for shocks, vectorize remaining
    * interpolate u(c), interpolate v(coh,z), interpolate EV(w,z)
    * store u(c) in cells, update when k*(w,z) changes

## 4.3 Perc. Interp. Save + Borrow DP (IPWKBZ)

The code from *4.1* are modified to allow for default. Set up for default is the same as in the *abz* model discussed in section *2*. Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/paramfunc/html/ffs_ipwkbz_set_default_param.html), for the benchmark simulation, same parameters as *4.1*.

1. Second Stage with borrowing *ipwkbz* [2nd stage solution](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/html/ff_ipwkbz_evf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/solve/ff_ipwkbz_evf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/html/ff_ipwkbz_evf.html)
2. *ipwkbz* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/html/ff_ipwkbz_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/solve/ff_ipwkbz_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/html/ff_ipwkbz_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/profile/ff_ipwkbz_vf_vecsv_default_p3/file0.html)    
    * speed: **2.5** seconds

## 4.4 Perc. Interp. Borrow R Shock DP (IPWKBZR)

The code from *4.2* are modified to allow for interest rate shock for borrowing. Set up for default and interest rate shock is the same as in the *abz* model discussed in section *2*. Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/paramfunc/html/ffs_ipwkbzr_set_default_param.html), for the benchmark simulation, same parameters as *4.1*.

- **75** grid points for shocks: **15** wage, **5** borrow interest

1. Second Stage with borrowing *ipwkbzr* [2nd stage solution](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/html/ff_ipwkbzr_evf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbzr/solve/ff_ipwkbzr_evf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/html/ff_ipwkbzr_evf.html)
2. *ipwkbzr* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/html/ff_ipwkbzr_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbzr/solve/ff_ipwkbzr_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/html/ff_ipwkbzr_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/profile/ff_ipwkbzr_vf_vecsv_default_p3/file0.html)    
    * speed: **54.4** seconds

## 4.5 Asset Distributions

This is the wrapper file for *abz* that invokes the [looped](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds.html), [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vec.html), and [semi-analytical](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vecsv.html) distributional programs from *3.4.b*:

1. *ipWKZ* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/solve/ff_ipwkz_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/html/ff_ipwkz_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/solve/profile/ff_ipwkz_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **2.5** seconds
2. *ipWKBZ* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/html/ff_ipwkbz_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/solve/ff_ipwkbz_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/html/ff_ipwkbz_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/solve/profile/ff_ipwkbz_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **4.2** seconds  
3. *ipWKBZR* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/html/ff_ipwkbzr_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbzr/solve/ff_ipwkbzr_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/html/ff_ipwkbzr_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/solve/profile/ff_ipwkbzr_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **73.6** seconds  

## 4.6 Solution Support (ipWKZ + ipWKBZ + ipWKBZR)

All solution algorithms share the same support files.

**Parameters and Function Definitions (ipwkz)**:
1. *ipwkz* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/paramfunc/ffs_ipwkz_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_set_default_param.html)
2. *ipwkz* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/paramfunc/ffs_ipwkz_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_set_functions.html)
3. *ipwkz* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/paramfunc/ffs_ipwkz_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/paramfunc/html/ffs_ipwkz_get_funcgrid.html)

**Parameters and Function Definitions (ipwkbz)**:
1. *ipwkbz* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/paramfunc/html/ffs_ipwkbz_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/paramfunc/ffs_ipwkbz_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/paramfunc/html/ffs_ipwkbz_set_default_param.html)
2. *ipwkbz* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/paramfunc/html/ffs_ipwkbz_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/paramfunc/ffs_ipwkbz_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/paramfunc/html/ffs_ipwkbz_set_functions.html)
3. *ipwkbz* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/paramfunc/html/ffs_ipwkbz_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/paramfunc/ffs_ipwkbz_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/paramfunc/html/ffs_ipwkbz_get_funcgrid.html)

**Parameters and Function Definitions (ipwkbzr)**:
1. *ipwkbzr* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/paramfunc/html/ffs_ipwkbzr_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbzr/paramfunc/ffs_ipwkbzr_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/paramfunc/html/ffs_ipwkbzr_set_default_param.html)
2. *ipwkbzr* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/paramfunc/html/ffs_ipwkbzr_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbzr/paramfunc/ffs_ipwkbzr_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/paramfunc/html/ffs_ipwkbzr_set_functions.html)
3. *ipwkbzr* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/paramfunc/html/ffs_ipwkbzr_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbzr/paramfunc/ffs_ipwkbzr_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbzr/paramfunc/html/ffs_ipwkbzr_get_funcgrid.html)


**Output Analysis**:
1. *ipwkz+ipwkbz+ipwkbzr* shares with *akz+wkz+iwkz* models [solution results processing](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post.html) codes.
2. *ipwkz+ipwkbz+ipwkbzr* shares with *akz+wkz+iwkz* models [solution results graphing](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post_graph.html) codes.

## 4.7 Parameter Testing (ipWKZ + ipWKBZ)

**Savings Testing (ipWKZ)**

We solve the joint asset choice problem using the *optimized-vectorized* method for *ipwkz* algorithm from *3.3*. Now we analyze model features by adjusting parameters.

1. *ipwkz* 2nd stage optimal k given w percentage vs level
    * [risky physical capital (drs) investments](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_evf/test_prod/html/fsi_ipwkz_evf_drs.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_evf/test_prod/html/fsi_ipwkz_evf_drs.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_evf/test_prod/html/fsi_ipwkz_evf_drs.html)
    * [risky financial investment (crs)](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_evf/test_prod/html/fsi_ipwkz_evf_crs.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_evf/test_prod/html/fsi_ipwkz_evf_crs.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_evf/test_prod/html/fsi_ipwkz_evf_crs.html)
2. *ipwkz* model solution precision
    * [adjust choice grid points](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_w_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/fsi_ipwkz_vf_vecsv_w_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_w_n.html)
    * [adjust shock grid points](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_z_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/fsi_ipwkz_vf_vecsv_z_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_z_n.html)
    * [adjust cash-on-hand interpolation grid gap](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_coh_interp_grid_gap.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/fsi_ipwkz_vf_vecsv_coh_interp_grid_gap.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_coh_interp_grid_gap.html)
    * [benchmark vs high-precision](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_main.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/fsi_ipwkz_vf_vecsv_main.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_precision/html/fsi_ipwkz_vf_vecsv_main.html)
3. *ipwkz* model shift minimum income    
    * [decreasing (physical investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/html/fsi_ipwkz_vf_vecsv_drs_ymin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/fsi_ipwkz_vf_vecsv_drs_ymin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/html/fsi_ipwkz_vf_vecsv_drs_ymin.html)
    * [constant (financial investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/html/fsi_ipwkz_vf_vecsv_crs_ymin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/fsi_ipwkz_vf_vecsv_crs_ymin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/html/fsi_ipwkz_vf_vecsv_crs_ymin.html)
4. *ipwkz* model shift shock persistence
    * [constant (financial investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/html/fsi_ipwkz_vf_vecsv_crs.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/fsi_ipwkz_vf_vecsv_crs.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkz/test/ff_ipwkz_vf_vecsv/test_prod/html/fsi_ipwkz_vf_vecsv_crs.html)

**Savings + Borrowing Testing (ipWKBZ)**

We solve the joint asset choice problem using the *optimized-vectorized* method for *ipwkbz* algorithm from *3.3*. Now we analyze model features by adjusting parameters.

1. *ipwkbz* borrowing and savings grid
    * [varying borrowing bounds](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ffs_ipwkbz_get_funcgrid/test_borr/html/ffs_ipwkbz_get_funcgrid_borr.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ffs_ipwkbz_get_funcgrid/test_borr/html/ffs_ipwkbz_get_funcgrid_borr.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/ffs_ipwkbz_get_funcgrid/test_borr/html/ffs_ipwkbz_get_funcgrid_borr.html)    
2. *ipwkbz* model solution precision
    * [adjust choice grid points](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_w_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/fsi_ipwkbz_vf_vecsv_w_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_w_n.html)
    * [adjust shock grid points](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_z_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/fsi_ipwkbz_vf_vecsv_z_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_z_n.html)
    * [adjust cash-on-hand interpolation grid gap](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_coh_interp_grid_gap.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/fsi_ipwkbz_vf_vecsv_coh_interp_grid_gap.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_coh_interp_grid_gap.html)
    * [benchmark vs high-precision](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_main.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/fsi_ipwkbz_vf_vecsv_main.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_precision/html/fsi_ipwkbz_vf_vecsv_main.html)
3. *ipwkbz* model shift minimum income    
    * [decreasing (physical investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/html/fsi_ipwkbz_vf_vecsv_drs_ymin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/fsi_ipwkbz_vf_vecsv_drs_ymin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/html/fsi_ipwkbz_vf_vecsv_drs_ymin.html)
    * [constant (financial investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/html/fsi_ipwkbz_vf_vecsv_crs_ymin.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/fsi_ipwkbz_vf_vecsv_crs_ymin.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/html/fsi_ipwkbz_vf_vecsv_crs_ymin.html)
4. *ipwkbz* model shift shock persistence
    * [constant (financial investment) return to scale](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/html/fsi_ipwkbz_vf_vecsv_crs.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/fsi_ipwkbz_vf_vecsv_crs.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_ipwkbz/test/ff_ipwkbz_vf_vecsv/test_prod/html/fsi_ipwkbz_vf_vecsv_crs.html)


# 5. One Asset Formal + Informal

> *Files for this section are in the [/m_fibs/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_fibs) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository. links: (1) [savings problem](https://fanwangecon.github.io/CodeDynaAsset/#1-the-savings-problem-az) (2) [borrowing and savings problem](https://fanwangecon.github.io/CodeDynaAsset/#2-the-savings--borrowing-problem-abz) (3) [risky and safe asset problem (risky entrepreneur)](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1) (4) [percentage choice grids and interpolation](https://fanwangecon.github.io/CodeDynaAsset/#4-the-risky--safe-asset-problem-part-2) (5) [Townsend and Wang 2019 Single Asset](https://fanwangecon.github.io/CodeDynaAsset/#5-one-asset-formal--informal) (6) [Townsend and Wang 2019 Safe + Risky Asset](https://fanwangecon.github.io/CodeDynaAsset/#6-two-assets-formal--informal).*

An application of the codes developed in sections (1) through (5) is the paper: *A Choice Amongst Many: Household Borrowing in a Setting with Multiple Providers* ([**Robert M. Townsend**](http://www.robertmtownsend.net/) and [**Fan Wang**](https://fanwangecon.github.io/) 2019). Below, earlier models are augmented to allow for (a) formal borrowing choice menu, (b) bridge loans, and (c) defaults. This section solves the model in the single asset setting.

## 5.1 Formal and Informal Choices (ABZ+FIBS)

We have a sequence of files that are specific to solving the joint formal and informal problem.

**Choice Generation**

1. [Formal Borrowing Grid](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_for_br_block_gen.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/paramfunc_fibs/ffs_for_br_block_gen.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_for_br_block_gen.html)
    * A menu of formal borrowing choices
2. [Informal Interest Rates](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_r_inf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/paramfunc_fibs/ffs_r_inf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_r_inf.html)
    * Append onto shock Z interest rate shock representing informal interest rate shocks

**Formal and Informal Optimization**

1. [Match Borrowing to Formal Grid](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_for_br_block_match.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/paramfunc_fibs/ffs_for_br_block_match.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_for_br_block_match.html)
    * Given a level of borrowing, what items on the formal borrowing menu are the closest to it
2. [Optimize Formal and Informal, Borrowing and Savings Joint Choices](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_min_c_cost.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/paramfunc_fibs/ffs_fibs_min_c_cost.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_min_c_cost.html)
    * Given interest rates, choose among: formal + informal borrowing, formal borrowing + savings, informal borrowing only, formal borrowing only.
3. [Bridge Loan](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_inf_bridge.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/paramfunc_fibs/ffs_fibs_inf_bridge.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_inf_bridge.html)
    * When cash-on-hand is insufficient for loan repayment, households resort to informal lenders for bridge loans
4. [Overall Optimization](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_min_c_cost_bridge.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/paramfunc_fibs/ffs_fibs_min_c_cost_bridge.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_min_c_cost_bridge.html)
    * Overall optimization over joint options, combines *ffs_fibs_inf_bridge.m* and *ffs_fibs_min_c_cost.m*.

**Results Processing**

1. [Discrete Choices](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_identify_discrete.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/paramfunc_fibs/ffs_fibs_identify_discrete.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/paramfunc_fibs/html/ffs_fibs_identify_discrete.html)
    * Discrete choice categories from continuous choices: (1) informal only (ignore bridge loan) (2) formal only (ignore bridge loan) (3) formal + informal borrowing (ignore bridge loan) (4) formal borrowing + savings (ignore bridge loan) (5) informal only (with bridge loan) (6) formal + informal (include bridge loan) (7) formal borrowing + informal borrowing + savings (include bridge loan) (8) No borrowing or savings

## 5.2 Dynamic Programming (ABZ+FIBS)

Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_set_default_param.html), for the benchmark simulation, similar to the *abz* model:

- savings and borrowing (with default) with minimum income
- **750** grid points for asset states/choices
- **15** grid points for the AR1 shock
- benchmark simulation with formal menu
- [other parameters](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_set_default_param.html)

Using three algorithm that provide identical solutions:

1. *abz fibs* model [looped solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_solve/ff_abz_fibs_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/profile/ff_abz_fibs_vf_default_p3/file0.html)
    * small grid demonstration
2. *abz fibs* model [vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_solve/ff_abz_fibs_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/profile/ff_abz_fibs_vf_vec_default_p3/file0.html)    
    * speed: **275.2** seconds
3. *abz fibs* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_solve/ff_abz_fibs_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/profile/ff_abz_fibs_vf_vecsv_default_p3/file0.html)    
    * speed: **2.5** seconds

## 5.3 Dynamic Programming with R Shock (ABZR+FIBS)

Same as *5.2*, but now include interest rate shock. Parameters can be adjusted [here](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_paramfunc/html/ffs_abzr_fibs_set_default_param.html), for the benchmark simulation, similar to the *abz+fibs* model, except:

- **75** grid points for shocks: **15** wage, **5** borrow interest

Using three algorithm that provide identical solutions:

1. *abz fibs* model [looped solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_vf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abzr_solve/ff_abzr_fibs_vf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_vf.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/profile/ff_abzr_fibs_vf_default_p3/file0.html)
    * small grid demonstration
2. *abz fibs* model [vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_vf_vec.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abzr_solve/ff_abzr_fibs_vf_vec.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_vf_vec.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/profile/ff_abzr_fibs_vf_vec_default_p3/file0.html)    
    * speed: **275.2** seconds
3. *abz fibs* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abzr_solve/ff_abzr_fibs_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/profile/ff_abzr_fibs_vf_vecsv_default_p3/file0.html)    
    * speed: **11.2** seconds

## 5.4 Asset Distributions

This are the wrapper files for *abz+fibs* and *abzr+fibs* that invokes the [looped](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds.html), [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vec.html), and [semi-analytical](https://fanwangecon.github.io/CodeDynaAsset/m_az/solve/html/ff_az_ds_vecsv.html) distributional programs from *1.2*:

* *abz+fibs* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_solve/ff_abz_fibs_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/html/ff_abz_fibs_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_solve/profile/ff_abz_fibs_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **17.5** seconds
* *abzr+fibs* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abzr_solve/ff_abzr_fibs_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/html/ff_abzr_fibs_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_solve/profile/ff_abzr_fibs_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **17.5** seconds

## 5.5 Solution Support (ABZ+FIBS)

**Parameters and Function Definition (abz+fibs)**:

1. *abz fibs* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_paramfunc/ffs_abz_fibs_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_set_default_param.html)
2. *abz fibs* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_paramfunc/ffs_abz_fibs_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_set_functions.html)
3. *abz fibs* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_paramfunc/ffs_abz_fibs_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_paramfunc/html/ffs_abz_fibs_get_funcgrid.html)

**Parameters and Function Definitions (abzr+fibs)**:

1. *abzr fibs* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_paramfunc/html/ffs_abzr_fibs_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abzr_paramfunc/ffs_abzr_fibs_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_paramfunc/html/ffs_abzr_fibs_set_default_param.html)
2. *abzr fibs* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_paramfunc/html/ffs_abzr_fibs_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abzr_paramfunc/ffs_abzr_fibs_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_paramfunc/html/ffs_abzr_fibs_set_functions.html)
3. *abzr fibs* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_paramfunc/html/ffs_abzr_fibs_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abzr_paramfunc/ffs_abzr_fibs_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abzr_paramfunc/html/ffs_abzr_fibs_get_funcgrid.html)

**Output Analysis**:
1.  *abz fibs* model [solution results processing](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/solvepost_fibs/html/ff_az_fibs_vf_post.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/solvepost_fibs/ff_az_fibs_vf_post.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/solvepost_fibs/html/ff_az_fibs_vf_post.html)
    * formal and informal choices policy functions
2. *abz fibs* model [solution results graphing](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/solvepost_fibs/html/ff_az_fibs_vf_post_graph.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/solvepost_fibs/ff_az_fibs_vf_post_graph.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/solvepost_fibs/html/ff_az_fibs_vf_post_graph.html)
    * formal and informal choices levels, logged levels, and percentages

## 5.6 Parameter Testing (ABZ+FIBS)

We solved the exogenously incomplete borrowing and savings problem in *1.4*. Now we analyze model features by adjusting parameters.

**Policy Function Testing**

1. *abz fibs* model solution precision
   * [adjust state/choice grid points](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/html/fsi_abz_fibs_vf_vecsv_a_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/fsi_abz_fibs_vf_vecsv_a_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/html/fsi_abz_fibs_vf_vecsv_a_n.html)
   * [adjust shock grid points](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/html/fsi_abz_fibs_vf_vecsv_z_n.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/fsi_abz_fibs_vf_vecsv_z_n.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/html/fsi_abz_fibs_vf_vecsv_z_n.html)
   * [benchmark vs high-precision](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/html/fsi_abz_fibs_vf_vecsv_main.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/fsi_abz_fibs_vf_vecsv_main.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_precision/html/fsi_abz_fibs_vf_vecsv_main.html)
2. *abz fibs* model compare saving vs borrowing with and without default
   * [tabular small grid testing](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_borr/html/ff_abz_fibs_vf_vecsv_default_small.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_borr/ff_abz_fibs_vf_vecsv_default_small.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_borr/html/ff_abz_fibs_vf_vecsv_default_small.html)
   * [tabular and graphical large grid testing](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_borr/html/ff_abz_fibs_vf_vecsv_default_large.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_borr/ff_abz_fibs_vf_vecsv_default_large.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_abz_fibs_vf_vecsv/test_borr/html/ff_abz_fibs_vf_vecsv_default_large.html)

**Asset Distribution Testing**

1. *abz fibs* borrowing interest rates, bounds, and minimum c
    * [no default](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_borr/html/fsi_abz_fibs_ds_vecsv_nbc.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_az_ds_vecsv/test_borr/fsi_abz_fibs_ds_vecsv_nbc.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_borr/html/fsi_abz_fibs_ds_vecsv_nbc.html)
    * [default](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_borr/html/fsi_abz_fibs_ds_vecsv_default.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_az_ds_vecsv/test_borr/fsi_abz_fibs_ds_vecsv_default.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_borr/html/fsi_abz_fibs_ds_vecsv_default.html)
2. *abz fibs* preference parameters and **asset distributions**
    * [no default](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_pref/html/fsi_abz_fibs_ds_vecsv_pref_nbc.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_az_ds_vecsv/test_pref/fsi_abz_fibs_ds_vecsv_pref_nbc.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_pref/html/fsi_abz_fibs_ds_vecsv_pref_nbc.html)
    * [default](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_pref/html/fsi_abz_fibs_ds_vecsv_pref_default.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_az_ds_vecsv/test_pref/fsi_abz_fibs_ds_vecsv_pref_default.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/fsi_abz_fibs_ds_vecsv_pref_default/html/fsi_abz_fibs_ds_vecsv_pref.html)
3. *abz fibs* model shock process and **asset distributions**
    * [no default](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_shock/html/fsi_abz_fibs_ds_vecsv_shk_nbc.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_az_ds_vecsv/test_shock/fsi_abz_fibs_ds_vecsv_shk_nbc.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_shock/html/fsi_abz_fibs_ds_vecsv_shk_nbc.html)
    * [default](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_shock/html/fsi_abz_fibs_ds_vecsv_shk_default.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_abz_test/ff_az_ds_vecsv/test_shock/fsi_abz_fibs_ds_vecsv_shk_default.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_abz_test/ff_az_ds_vecsv/test_shock/html/fsi_abz_fibs_ds_vecsv_shk_default.html)


# 6. Two Assets Formal + Informal

> *Files for this section are in the [/m_fibs/](https://github.com/FanWangEcon/CodeDynaAsset/tree/master/m_fibs) folder in the [CodeDynaAsset](https://github.com/FanWangEcon/CodeDynaAsset) repository. links: (1) [savings problem](https://fanwangecon.github.io/CodeDynaAsset/#1-the-savings-problem-az) (2) [borrowing and savings problem](https://fanwangecon.github.io/CodeDynaAsset/#2-the-savings--borrowing-problem-abz) (3) [risky and safe asset problem (risky entrepreneur)](https://fanwangecon.github.io/CodeDynaAsset/#3-the-risky--safe-asset-problem-part-1) (4) [percentage choice grids and interpolation](https://fanwangecon.github.io/CodeDynaAsset/#4-the-risky--safe-asset-problem-part-2) (5) [Townsend and Wang 2019 Single Asset](https://fanwangecon.github.io/CodeDynaAsset/#5-one-asset-formal--informal) (6) [Townsend and Wang 2019 Safe + Risky Asset](https://fanwangecon.github.io/CodeDynaAsset/#6-two-assets-formal--informal).*

An application of the codes developed in sections (1) through (5) is the paper: *A Choice Amongst Many: Household Borrowing in a Setting with Multiple Providers* ([**Robert M. Townsend**](http://www.robertmtownsend.net/) and [**Fan Wang**](https://fanwangecon.github.io/) 2019). Below, earlier models are augmented to allow for (a) formal borrowing choice menu, (b) bridge loans, and (c) defaults. We do this in the context of the safe and risky asset setting. We use the formal and informal choice codes developed in section *5* above here again.

## 6.1 Two Assets Formal Informal (ipWKBZ+FIBS)

1. Use *ipwkbz+fibs* [2nd stage solution with Formal Informal and Bridge](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/html/ff_ipwkbz_fibs_evf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbz_solve/ff_ipwkbz_fibs_evf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/html/ff_ipwkbz_fibs_evf.html)
2. *ipwkbz* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/html/ff_ipwkbz_fibs_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbz_solve/ff_ipwkbz_fibs_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/html/ff_ipwkbz_fibs_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/profile/ff_ipwkbz_fibs_vf_vecsv_default_p3/file0.html)    
    * speed: **20.0** seconds

## 6.2 Two Assets For+Inf+R Shock (ipWKBZR+FIBS)

- **75** grid points for shocks: **15** wage, **5** borrow interest

1. Use *ipwkbzr+fibs* [2nd stage solution with Formal Informal and Bridge](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/html/ff_ipwkbzr_fibs_evf.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbzr_solve/ff_ipwkbzr_fibs_evf.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/html/ff_ipwkbzr_fibs_evf.html)    
2. *ipwkbzr* model [optimized vectorized solution](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/html/ff_ipwkbzr_fibs_vf_vecsv.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbzr_solve/ff_ipwkbzr_fibs_vf_vecsv.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/html/ff_ipwkbzr_fibs_vf_vecsv.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/profile/ff_ipwkbzr_fibs_vf_vecsv_default_p3/file0.html)    
    * speed: **603.1** seconds

## 6.2 Asset Distributions (ipWKBZ+FIBS)

This are the wrapper files for *ipwkbz+fibs* and *ipwkbzr+fibs* that invokes the [looped](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds.html), [vectorized](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vec.html), and [semi-analytical](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solve/html/ff_iwkz_ds_vecsv.html) distributional programs from *3.4.b*:

* *ipwkbz+fibs* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/html/ff_ipwkbz_fibs_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbz_solve/ff_ipwkbz_fibs_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/html/ff_ipwkbz_fibs_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_solve/profile/ff_ipwkbz_fibs_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **23.0** seconds
* *ipwkbzr+fibs* distributional [wrapper](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/html/ff_ipwkbzr_fibs_ds_wrapper.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbzr_solve/ff_ipwkbzr_fibs_ds_wrapper.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/html/ff_ipwkbzr_fibs_ds_wrapper.html) \| [**profile**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_solve/profile/ff_ipwkbzr_fibs_ds_wrapper_default_p7/file0.html)   
    * speed (dynamic programming + distribution): **644.0** seconds

## 6.4 Solution Support (ipWKBZ+FIBS)

All solution algorithms share the same support files.

**Parameters and Function Definitions (ipwkbz+fibs)**:
1. *ipwkbz+fibs* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_paramfunc/html/ffs_ipwkbz_fibs_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbz_paramfunc/ffs_ipwkbz_fibs_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_paramfunc/html/ffs_ipwkbz_fibs_set_default_param.html)
2. *ipwkbz+fibs* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_paramfunc/html/ffs_ipwkbz_fibs_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbz_paramfunc/ffs_ipwkbz_fibs_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_paramfunc/html/ffs_ipwkbz_fibs_set_functions.html)
3. *ipwkbz+fibs* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_paramfunc/html/ffs_ipwkbz_fibs_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbz_paramfunc/ffs_ipwkbz_fibs_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbz_paramfunc/html/ffs_ipwkbz_fibs_get_funcgrid.html)

**Parameters and Function Definitions (ipwkbzr+fibs)**:
1. *ipwkbzr+fibs* model [set default parameters](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_paramfunc/html/ffs_ipwkbzr_fibs_set_default_param.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbzr_paramfunc/ffs_ipwkbzr_fibs_set_default_param.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_paramfunc/html/ffs_ipwkbzr_fibs_set_default_param.html)
2. *ipwkbzr+fibs* model [set functions](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_paramfunc/html/ffs_ipwkbzr_fibs_set_functions.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbzr_paramfunc/ffs_ipwkbzr_fibs_set_functions.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_paramfunc/html/ffs_ipwkbzr_fibs_set_functions.html)
3. *ipwkbzr+fibs* model [generate states, choices, and shocks grids](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_paramfunc/html/ffs_ipwkbzr_fibs_get_funcgrid.html): [**m**](https://github.com/FanWangEcon/CodeDynaAsset/blob/master/m_fibs/m_ipwkbzr_paramfunc/ffs_ipwkbzr_fibs_get_funcgrid.m) \| [**publish html**](https://fanwangecon.github.io/CodeDynaAsset/m_fibs/m_ipwkbzr_paramfunc/html/ffs_ipwkbzr_fibs_get_funcgrid.html)


**Output Analysis**:
1. *ipwkbz+fibs* shares with *akz+wkz+iwkz* models [solution results processing](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post.html) codes.
2. *ipwkbz+fibs* shares with *akz+wkz+iwkz* models [solution results graphing](https://fanwangecon.github.io/CodeDynaAsset/m_akz/solvepost/html/ff_akz_vf_post_graph.html) codes.
